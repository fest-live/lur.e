# Документация по модулю HTML-шаблонов

## Описание

Этот модуль реализует легковесный шаблонизатор для создания и связывания DOM-элементов на основе шаблонных строк (template literals) с поддержкой реактивных данных, пользовательских атрибутов и событий. Он предназначен для динамического построения DOM-деревьев с возможностью интеграции с реактивными массивами и функциями.

---

## Импортируемые зависимости

- **observableArray** из `"fest/object"` — реактивный массив.
- **getNode** из `./DOM` — функция для получения DOM-узла из значения.
- **E, M** из `./Element` — функции для создания и связывания элементов.

---

## Внутренние структуры и функции

### 1. `EMap: WeakMap`

Карта для хранения соответствия между DOM-элементами и их расширенными представлениями, созданными функцией `E`.

---

### 2. `parseTag(str: string): { tag, id, className }`

Парсит строку вида `"div#id.class1.class2"` и возвращает объект с полями:

- `tag` — имя тега (по умолчанию `"div"`),
- `id` — id элемента,
- `className` — строка классов через пробел.

---

### 3. `findIterator(element, psh)`

Проверяет, содержит ли элемент единственный комментарий вида `<!--o:N-->`, и если да — возвращает функцию-итератор из массива `psh` по индексу `N`.

---

### 4. `connectElement(el, atb, psh, mapped, cmdBuffer)`

Связывает DOM-элемент с реактивными/пользовательскими атрибутами, событиями и итераторами:

- Обрабатывает все атрибуты элемента, поддерживает специальные префиксы (`@`, `on:`, `prop:`, `ctrl:`).
- Удаляет кастомные атрибуты после обработки.
- Добавляет функцию в `cmdBuffer` для создания расширенного элемента через `E`.
- Возвращает сам элемент.

---

## Основные экспортируемые функции

### 1. `html(strings, ...values)`

Шорткат для вызова `htmlBuilder()` без параметров. Используется как теговая функция для шаблонных строк:

```js
const el = html`<div>${content}</div>`;
```

---

### 2. `htmlBuilder({ createElement = null } = {})`

Возвращает функцию для сборки DOM-дерева из шаблонной строки и значений:

- Собирает строку HTML с плейсхолдерами для значений.
- Парсит HTML через `DOMParser`.
- Обходит дерево, связывает элементы через `connectElement`.
- Обрабатывает комментарии вида `<!--o:N-->` для вставки реактивных данных или массивов.
- Возвращает готовый DOM-узел или фрагмент.

**Параметры:**

- `createElement` — опциональная функция для создания элементов (не используется по умолчанию).

---

### 3. `H(str, ...values)`

Универсальная функция для создания DOM-узлов:

- Если `str` — строка, парсит как HTML или возвращает текстовый узел.
- Если функция — вызывает и обрабатывает результат.
- Если массив — вызывает `html`.
- Если DOM-узел — возвращает его.
- В остальных случаях — возвращает `null`.

---

## Пример использования

```js
const name = "World";
const el = html`<div class="greeting">Hello, ${name}!</div>`;
document.body.appendChild(el);
```

---

## Особенности

- Поддержка реактивных массивов и функций для динамического рендеринга.
- Гибкая работа с атрибутами, событиями, свойствами и контроллерами через специальные префиксы.
- Возможность интеграции с другими фреймворками через совместимые атрибуты.

---

## Краткое описание архитектуры

- **Парсинг шаблона**: строка разбивается на части, значения вставляются как комментарии или специальные плейсхолдеры.
- **Построение DOM**: через `DOMParser` создаётся дерево, затем оно связывается с реактивными данными.
- **Реактивность**: поддержка функций и массивов для динамического обновления DOM.

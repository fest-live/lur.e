import { numberRef, addToCallChain } from "fest/object";
import { addEvent, handleStyleChange } from "fest/dom";
import { vector2Ref, bindWith, rectCenter, rectArea, rectContainsPoint, rectIntersects, clampPointToRect, pointToRectDistance } from "fest/lure";
import { CSSBinder, CSSUnitUtils } from "fest/lure";
import { ReactiveElementSize } from "../css-ref/Utils";
//
export function boundingBoxAnchorRef(anchor, options) {
    if (!anchor)
        return () => { };
    // Create reactive vectors for position and size
    const position = vector2Ref(0, 0); // x, y
    const size = vector2Ref(0, 0); // width, height
    const area = [
        position.x, position.y, // x, y
        size.x, size.y, // width, height
        numberRef(0), numberRef(0) // to right, to bottom (computed)
    ];
    // Reactive rectangle representation
    const rect = { position, size };
    const center = rectCenter(rect);
    const reactiveArea = rectArea(rect);
    const { root = anchor?.offsetParent ?? document.documentElement, iterateResize = true, iterateMutations = false } = options || {};
    // Reactive element size tracker
    const elementSize = new ReactiveElementSize(anchor);
    //
    function updateArea() {
        const rect = anchor?.getBoundingClientRect?.() ?? {};
        position.x.value = rect?.left; // x
        position.y.value = rect?.top; // y
        size.x.value = rect?.right - rect?.left; // width
        size.y.value = rect?.bottom - rect?.top; // height
        area[4].value = rect?.right; // to right
        area[5].value = rect?.bottom; // to bottom
    }
    //
    const listening = [
        addEvent(root, "scroll", updateArea, { capture: true }),
        addEvent(window, "resize", updateArea),
        addEvent(window, "scroll", updateArea, { capture: true })
    ];
    //
    let resizeObs;
    if (observeResize && "ResizeObserver" in window && typeof ResizeObserver != "undefined") {
        resizeObs = typeof ResizeObserver != "undefined" ? new ResizeObserver(updateArea) : undefined;
        resizeObs?.observe(anchor);
    }
    //
    let mutationObs;
    if (observeMutations) {
        mutationObs = typeof MutationObserver != "undefined" ? new MutationObserver(updateArea) : undefined;
        mutationObs?.observe(anchor, { attributes: true, childList: true, subtree: true });
    }
    //
    updateArea();
    function destroy() {
        listening.forEach(ub => ub?.());
        resizeObs?.disconnect?.();
        mutationObs?.disconnect?.();
    }
    //
    if (destroy) {
        area.forEach(ub => addToCallChain(ub, Symbol.dispose, destroy));
    }
    // Return enhanced area with vector, rectangle, and CSS operations
    const enhancedArea = Object.assign(area, {
        position, // Vector2D for x, y
        size, // Vector2D for width, height
        rect, // Rect2D interface
        center, // Reactive center point
        area: reactiveArea, // Reactive area calculation
        elementSize, // ReactiveElementSize instance
        // Rectangle operations
        containsPoint: (point) => rectContainsPoint(rect, point),
        intersects: (otherRect) => rectIntersects(rect, otherRect),
        clampPoint: (point) => clampPointToRect(point, rect),
        distanceToPoint: (point) => pointToRectDistance(point, rect),
        // CSS binding utilities
        bindPosition: (element) => CSSBinder.bindPosition(element, position),
        bindSize: (element) => CSSBinder.bindSize(element, size),
        bindCenter: (element) => CSSBinder.bindPosition(element, center),
        destroy: () => {
            elementSize.destroy();
            destroy();
        }
    });
    return enhancedArea;
}
//
// Unit conversion utilities now imported from CSSUnitUtils
//
export const bindWithRect = (anchor, area, options) => {
    if (!anchor)
        return () => { };
    //
    if (area?.connectElement) {
        return area?.connectElement?.(anchor, options || {});
    }
    //
    const [left, top, width, height, right, bottom] = area;
    const usb = [];
    //
    if (options?.placement == "fill") {
        usb.push(bindWith(anchor, "inset-block-start", CSSUnitUtils.asPx(left), handleStyleChange));
        usb.push(bindWith(anchor, "inset-inline-start", CSSUnitUtils.asPx(top), handleStyleChange));
        usb.push(bindWith(anchor, "inset-block-end", CSSUnitUtils.asPx(right), handleStyleChange));
        usb.push(bindWith(anchor, "inset-inline-end", CSSUnitUtils.asPx(bottom), handleStyleChange));
        usb.push(bindWith(anchor, "inline-size", CSSUnitUtils.asPx(width), handleStyleChange));
        usb.push(bindWith(anchor, "block-size", CSSUnitUtils.asPx(height), handleStyleChange));
    }
    else if (options?.placement == "bottom") {
        usb.push(bindWith(anchor, "inset-block-start", CSSUnitUtils.asPx(bottom), handleStyleChange));
        usb.push(bindWith(anchor, "inset-inline-start", CSSUnitUtils.asPx(left), handleStyleChange));
        usb.push(bindWith(anchor, "inline-size", CSSUnitUtils.asPx(width), handleStyleChange));
    }
    else if (options?.placement == "top") {
        usb.push(bindWith(anchor, "inset-block-end", CSSUnitUtils.asPx(top), handleStyleChange));
        usb.push(bindWith(anchor, "inset-inline-start", CSSUnitUtils.asPx(left), handleStyleChange));
        usb.push(bindWith(anchor, "inline-size", CSSUnitUtils.asPx(width), handleStyleChange));
    }
    else if (options?.placement == "left") {
        usb.push(bindWith(anchor, "inset-inline-end", CSSUnitUtils.asPx(right), handleStyleChange));
        usb.push(bindWith(anchor, "inset-block-start", CSSUnitUtils.asPx(top), handleStyleChange));
        usb.push(bindWith(anchor, "block-size", CSSUnitUtils.asPx(height), handleStyleChange));
    }
    else if (options?.placement == "right") {
        usb.push(bindWith(anchor, "inset-inline-start", CSSUnitUtils.asPx(left), handleStyleChange));
        usb.push(bindWith(anchor, "inset-block-start", CSSUnitUtils.asPx(top), handleStyleChange));
        usb.push(bindWith(anchor, "block-size", CSSUnitUtils.asPx(height), handleStyleChange));
    }
    else if (options?.placement == "center") {
        usb.push(bindWith(anchor, "inset-inline-start", CSSUnitUtils.asPx(left), handleStyleChange));
        usb.push(bindWith(anchor, "inset-block-start", CSSUnitUtils.asPx(top), handleStyleChange));
        usb.push(bindWith(anchor, "inline-size", CSSUnitUtils.asPx(width), handleStyleChange));
        usb.push(bindWith(anchor, "block-size", CSSUnitUtils.asPx(height), handleStyleChange));
    }
    return () => { usb?.forEach?.(ub => ub?.()); };
};
// Enhanced binding for scrollbar positioning with intersection support
export const bindScrollbarPosition = (scrollbar, anchorBox, axis, options) => {
    const { useIntersection = false, zIndexShift = 1 } = options || {};
    const usb = [];
    //
    if (anchorBox?.connectElement) {
        return anchorBox?.connectElement?.(scrollbar, Object.assign(options || {}, {
            placement: axis == "horizontal" ? "bottom" : "right"
        }));
    }
    //
    scrollbar.style.position = useIntersection ? 'fixed' : 'absolute';
    scrollbar.style.zIndex = `${zIndexShift}`;
    if (useIntersection) {
        // Intersection box: [ix, iy, iwidth, iheight, iright, ibottom, ax, ay, awidth, aheight, rx, ry, rwidth, rheight]
        if (axis === 'horizontal') {
            // Position at bottom of intersection area
            usb.push(bindWith(scrollbar, "left", CSSUnitUtils.asPx(anchorBox[0]), handleStyleChange)); // intersection x
            usb.push(bindWith(scrollbar, "top", CSSUnitUtils.asPx(anchorBox[5]), handleStyleChange)); // intersection bottom
            usb.push(bindWith(scrollbar, "width", CSSUnitUtils.asPx(anchorBox[2]), handleStyleChange)); // intersection width
        }
        else {
            // Position at right of intersection area
            usb.push(bindWith(scrollbar, "left", CSSUnitUtils.asPx(anchorBox[4]), handleStyleChange)); // intersection right
            usb.push(bindWith(scrollbar, "top", CSSUnitUtils.asPx(anchorBox[1]), handleStyleChange)); // intersection y
            usb.push(bindWith(scrollbar, "height", CSSUnitUtils.asPx(anchorBox[3]), handleStyleChange)); // intersection height
        }
    }
    else {
        // Regular bounding box: [x, y, width, height, right, bottom]
        if (axis === 'horizontal') {
            // Position at bottom of content area
            usb.push(bindWith(scrollbar, "left", CSSUnitUtils.asPx(anchorBox[0]), handleStyleChange)); // x
            usb.push(bindWith(scrollbar, "top", CSSUnitUtils.asPx(anchorBox[5]), handleStyleChange)); // bottom
            usb.push(bindWith(scrollbar, "width", CSSUnitUtils.asPx(anchorBox[2]), handleStyleChange)); // width
        }
        else {
            // Position at right of content area
            usb.push(bindWith(scrollbar, "left", CSSUnitUtils.asPx(anchorBox[4]), handleStyleChange)); // right
            usb.push(bindWith(scrollbar, "top", CSSUnitUtils.asPx(anchorBox[1]), handleStyleChange)); // y
            usb.push(bindWith(scrollbar, "height", CSSUnitUtils.asPx(anchorBox[3]), handleStyleChange)); // height
        }
    }
    return () => { usb?.forEach?.(ub => ub?.()); };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQkJveEFuY2hvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkJCb3hBbmNob3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxjQUFjLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN2RCxPQUFPLEVBQ0gsVUFBVSxFQUFFLFFBQVEsRUFDcEIsVUFBVSxFQUFFLFFBQVEsRUFBVSxpQkFBaUIsRUFBRSxjQUFjLEVBQy9ELGdCQUFnQixFQUFFLG1CQUFtQixFQUN4QyxNQUFNLFdBQVcsQ0FBQztBQUNuQixPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUV2RCxFQUFFO0FBQ0YsTUFBTSxVQUFVLG9CQUFvQixDQUFDLE1BQW1CLEVBQUUsT0FJekQ7SUFDRyxJQUFJLENBQUMsTUFBTTtRQUFFLE9BQU8sR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBRTlCLGdEQUFnRDtJQUNoRCxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTztJQUMxQyxNQUFNLElBQUksR0FBRyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUssZ0JBQWdCO0lBQ25ELE1BQU0sSUFBSSxHQUFHO1FBQ1QsUUFBUSxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQyxFQUFFLE9BQU87UUFDL0IsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFVLGdCQUFnQjtRQUN4QyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLGlDQUFpQztLQUMvRCxDQUFDO0lBRUYsb0NBQW9DO0lBQ3BDLE1BQU0s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dCB7IG51bWJlclJlZiwgYWRkVG9DYWxsQ2hhaW4gfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7IGFkZEV2ZW50LCBoYW5kbGVTdHlsZUNoYW5nZSB9IGZyb20gXCJmZXN0L2RvbVwiO1xuaW1wb3J0IHtcbiAgICB2ZWN0b3IyUmVmLCBiaW5kV2l0aCwgVmVjdG9yMkQsXG4gICAgcmVjdENlbnRlciwgcmVjdEFyZWEsIFJlY3QyRCwgcmVjdENvbnRhaW5zUG9pbnQsIHJlY3RJbnRlcnNlY3RzLFxuICAgIGNsYW1wUG9pbnRUb1JlY3QsIHBvaW50VG9SZWN0RGlzdGFuY2Vcbn0gZnJvbSBcImZlc3QvbHVyZVwiO1xuaW1wb3J0IHsgQ1NTQmluZGVyLCBDU1NVbml0VXRpbHMgfSBmcm9tIFwiZmVzdC9sdXJlXCI7XG5pbXBvcnQgeyBSZWFjdGl2ZUVsZW1lbnRTaXplIH0gZnJvbSBcIi4uL2Nzcy1yZWYvVXRpbHNcIjtcblxuLy9cbmV4cG9ydCBmdW5jdGlvbiBib3VuZGluZ0JveEFuY2hvclJlZihhbmNob3I6IEhUTUxFbGVtZW50LCBvcHRpb25zPzoge1xuICAgIHJvb3Q/OiBIVE1MRWxlbWVudCxcbiAgICBvYnNlcnZlUmVzaXplPzogYm9vbGVhbixcbiAgICBvYnNlcnZlTXV0YXRpb25zPzogYm9vbGVhbixcbn0pIHtcbiAgICBpZiAoIWFuY2hvcikgcmV0dXJuICgpID0+IHsgfTtcblxuICAgIC8vIENyZWF0ZSByZWFjdGl2ZSB2ZWN0b3JzIGZvciBwb3NpdGlvbiBhbmQgc2l6ZVxuICAgIGNvbnN0IHBvc2l0aW9uID0gdmVjdG9yMlJlZigwLCAwKTsgLy8geCwgeVxuICAgIGNvbnN0IHNpemUgPSB2ZWN0b3IyUmVmKDAsIDApOyAgICAgLy8gd2lkdGgsIGhlaWdodFxuICAgIGNvbnN0IGFyZWEgPSBbXG4gICAgICAgIHBvc2l0aW9uLngsIHBvc2l0aW9uLnksIC8vIHgsIHlcbiAgICAgICAgc2l6ZS54LCBzaXplLnksICAgICAgICAgLy8gd2lkdGgsIGhlaWdodFxuICAgICAgICBudW1iZXJSZWYoMCksIG51bWJlclJlZigwKSAvLyB0byByaWdodCwgdG8gYm90dG9tIChjb21wdXRlZClcbiAgICBdO1xuXG4gICAgLy8gUmVhY3RpdmUgcmVjdGFuZ2xlIHJlcHJlc2VudGF0aW9uXG4gICAgY29uc3QgcmVjdDogUmVjdDJEID0geyBwb3NpdGlvbiwgc2l6ZSB9O1xuICAgIGNvbnN0IGNlbnRlciA9IHJlY3RDZW50ZXIocmVjdCk7XG4gICAgY29uc3QgcmVhY3RpdmVBcmVhID0gcmVjdEFyZWEocmVjdCk7XG5cbiAgICBjb25zdCB7IHJvb3QgPSBhbmNob3I/Lm9mZnNldFBhcmVudCA/PyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsIGl0ZXJhdGVSZXNpemUgPSB0cnVlLCBpdGVyYXRlTXV0YXRpb25zID0gZmFsc2UgfSA9IG9wdGlvbnMgfHwge307XG5cbiAgICAvLyBSZWFjdGl2ZSBlbGVtZW50IHNpemUgdHJhY2tlclxuICAgIGNvbnN0IGVsZW1lbnRTaXplID0gbmV3IFJlYWN0aXZlRWxlbWVudFNpemUoYW5jaG9yKTtcblxuICAgIC8vXG4gICAgZnVuY3Rpb24gdXBkYXRlQXJlYSgpIHtcbiAgICAgICAgY29uc3QgcmVjdCAgPSBhbmNob3I/LmdldEJvdW5kaW5nQ2xpZW50UmVjdD8uKCkgPz8ge307XG4gICAgICAgIHBvc2l0aW9uLngudmFsdWUgPSByZWN0Py5sZWZ0OyAvLyB4XG4gICAgICAgIHBvc2l0aW9uLnkudmFsdWUgPSByZWN0Py50b3A7ICAvLyB5XG4gICAgICAgIHNpemUueC52YWx1ZSA9IHJlY3Q/LnJpZ2h0IC0gcmVjdD8ubGVmdDsgLy8gd2lkdGhcbiAgICAgICAgc2l6ZS55LnZhbHVlID0gcmVjdD8uYm90dG9tIC0gcmVjdD8udG9wOyAvLyBoZWlnaHRcbiAgICAgICAgYXJlYVs0XS52YWx1ZSA9IHJlY3Q/LnJpZ2h0OyAgLy8gdG8gcmlnaHRcbiAgICAgICAgYXJlYVs1XS52YWx1ZSA9IHJlY3Q/LmJvdHRvbTsgLy8gdG8gYm90dG9tXG4gICAgfVxuXG4gICAgLy9cbiAgICBjb25zdCBsaXN0ZW5pbmcgPSBbXG4gICAgICAgIGFkZEV2ZW50KHJvb3QsIFwic2Nyb2xsXCIsIHVwZGF0ZUFyZWEsIHsgY2FwdHVyZTogdHJ1ZSB9KSxcbiAgICAgICAgYWRkRXZlbnQod2luZG93LCBcInJlc2l6ZVwiLCB1cGRhdGVBcmVhKSxcbiAgICAgICAgYWRkRXZlbnQod2luZG93LCBcInNjcm9sbFwiLCB1cGRhdGVBcmVhLCB7IGNhcHR1cmU6IHRydWUgfSlcbiAgICBdO1xuXG4gICAgLy9cbiAgICBsZXQgcmVzaXplT2JzOiBSZXNpemVPYnNlcnZlciB8IHVuZGVmaW5lZDtcbiAgICBpZiAob2JzZXJ2ZVJlc2l6ZSAmJiBcIlJlc2l6ZU9ic2VydmVyXCIgaW4gd2luZG93ICYmIHR5cGVvZiBSZXNpemVPYnNlcnZlciAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgIHJlc2l6ZU9icyA9IHR5cGVvZiBSZXNpemVPYnNlcnZlciAhPSBcInVuZGVmaW5lZFwiID8gbmV3IFJlc2l6ZU9ic2VydmVyKHVwZGF0ZUFyZWEpIDogdW5kZWZpbmVkO1xuICAgICAgICByZXNpemVPYnM/Lm9ic2VydmUoYW5jaG9yKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGxldCBtdXRhdGlvbk9iczogTXV0YXRpb25PYnNlcnZlciB8IHVuZGVmaW5lZDtcbiAgICBpZiAob2JzZXJ2ZU11dGF0aW9ucykge1xuICAgICAgICBtdXRhdGlvbk9icyA9IHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyICE9IFwidW5kZWZpbmVkXCIgPyBuZXcgTXV0YXRpb25PYnNlcnZlcih1cGRhdGVBcmVhKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgbXV0YXRpb25PYnM/Lm9ic2VydmUoYW5jaG9yLCB7IGF0dHJpYnV0ZXM6IHRydWUsIGNoaWxkTGlzdDogdHJ1ZSwgc3VidHJlZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICAvL1xuICAgIHVwZGF0ZUFyZWEoKTtcbiAgICBmdW5jdGlvbiBkZXN0cm95KCkge1xuICAgICAgICBsaXN0ZW5pbmcuZm9yRWFjaCh1Yj0+dWI/LigpKTtcbiAgICAgICAgcmVzaXplT2JzPy5kaXNjb25uZWN0Py4oKTtcbiAgICAgICAgbXV0YXRpb25PYnM/LmRpc2Nvbm5lY3Q/LigpO1xuICAgIH1cblxuICAgIC8vXG4gICAgaWYgKGRlc3Ryb3kpIHtcbiAgICAgICAgYXJlYS5mb3JFYWNoKHViPT5hZGRUb0NhbGxDaGFpbih1YiwgU3ltYm9sLmRpc3Bvc2UsIGRlc3Ryb3kpKTtcbiAgICB9XG5cbiAgICAvLyBSZXR1cm4gZW5oYW5jZWQgYXJlYSB3aXRoIHZlY3RvciwgcmVjdGFuZ2xlLCBhbmQgQ1NTIG9wZXJhdGlvbnNcbiAgICBjb25zdCBlbmhhbmNlZEFyZWEgPSBPYmplY3QuYXNzaWduKGFyZWEsIHtcbiAgICAgICAgcG9zaXRpb24sICAgICAgIC8vIFZlY3RvcjJEIGZvciB4LCB5XG4gICAgICAgIHNpemUsICAgICAgICAgIC8vIFZlY3RvcjJEIGZvciB3aWR0aCwgaGVpZ2h0XG4gICAgICAgIHJlY3QsICAgICAgICAgIC8vIFJlY3QyRCBpbnRlcmZhY2VcbiAgICAgICAgY2VudGVyLCAgICAgICAgLy8gUmVhY3RpdmUgY2VudGVyIHBvaW50XG4gICAgICAgIGFyZWE6IHJlYWN0aXZlQXJlYSwgLy8gUmVhY3RpdmUgYXJlYSBjYWxjdWxhdGlvblxuICAgICAgICBlbGVtZW50U2l6ZSwgICAvLyBSZWFjdGl2ZUVsZW1lbnRTaXplIGluc3RhbmNlXG5cbiAgICAgICAgLy8gUmVjdGFuZ2xlIG9wZXJhdGlvbnNcbiAgICAgICAgY29udGFpbnNQb2ludDogKHBvaW50OiBWZWN0b3IyRCkgPT4gcmVjdENvbnRhaW5zUG9pbnQocmVjdCwgcG9pbnQpLFxuICAgICAgICBpbnRlcnNlY3RzOiAob3RoZXJSZWN0OiBSZWN0MkQpID0+IHJlY3RJbnRlcnNlY3RzKHJlY3QsIG90aGVyUmVjdCksXG4gICAgICAgIGNsYW1wUG9pbnQ6IChwb2ludDogVmVjdG9yMkQpID0+IGNsYW1wUG9pbnRUb1JlY3QocG9pbnQsIHJlY3QpLFxuICAgICAgICBkaXN0YW5jZVRvUG9pbnQ6IChwb2ludDogVmVjdG9yMkQpID0+IHBvaW50VG9SZWN0RGlzdGFuY2UocG9pbnQsIHJlY3QpLFxuXG4gICAgICAgIC8vIENTUyBiaW5kaW5nIHV0aWxpdGllc1xuICAgICAgICBiaW5kUG9zaXRpb246IChlbGVtZW50OiBIVE1MRWxlbWVudCkgPT4gQ1NTQmluZGVyLmJpbmRQb3NpdGlvbihlbGVtZW50LCBwb3NpdGlvbiksXG4gICAgICAgIGJpbmRTaXplOiAoZWxlbWVudDogSFRNTEVsZW1lbnQpID0+IENTU0JpbmRlci5iaW5kU2l6ZShlbGVtZW50LCBzaXplKSxcbiAgICAgICAgYmluZENlbnRlcjogKGVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiBDU1NCaW5kZXIuYmluZFBvc2l0aW9uKGVsZW1lbnQsIGNlbnRlciksXG5cbiAgICAgICAgZGVzdHJveTogKCkgPT4ge1xuICAgICAgICAgICAgZWxlbWVudFNpemUuZGVzdHJveSgpO1xuICAgICAgICAgICAgZGVzdHJveSgpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gZW5oYW5jZWRBcmVhO1xufVxuXG4vL1xuLy8gVW5pdCBjb252ZXJzaW9uIHV0aWxpdGllcyBub3cgaW1wb3J0ZWQgZnJvbSBDU1NVbml0VXRpbHNcblxuLy9cbmV4cG9ydCBjb25zdCBiaW5kV2l0aFJlY3QgPSAoYW5jaG9yOiBIVE1MRWxlbWVudCwgYXJlYTogYW55fG51bGwsIG9wdGlvbnM/OiB7XG4gICAgcm9vdD86IEhUTUxFbGVtZW50LFxuICAgIG9ic2VydmVSZXNpemU/OiBib29sZWFuLFxuICAgIG9ic2VydmVNdXRhdGlvbnM/OiBib29sZWFuLFxuICAgIHBsYWNlbWVudD86IFwiZmlsbFwiIHwgXCJib3R0b21cIiB8IFwidG9wXCIgfCBcImxlZnRcIiB8IFwicmlnaHRcIiB8IFwiY2VudGVyXCIsXG59KSA9PiB7XG4gICAgaWYgKCFhbmNob3IpIHJldHVybiAoKSA9PiB7IH07XG5cbiAgICAvL1xuICAgIGlmIChhcmVhPy5jb25uZWN0RWxlbWVudCkge1xuICAgICAgICByZXR1cm4gYXJlYT8uY29ubmVjdEVsZW1lbnQ/LihhbmNob3IsIG9wdGlvbnMgfHwge30pO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3QgW2xlZnQsIHRvcCwgd2lkdGgsIGhlaWdodCwgcmlnaHQsIGJvdHRvbV0gPSBhcmVhO1xuICAgIGNvbnN0IHVzYjogYW55W10gPSBbXTtcblxuICAgIC8vXG4gICAgaWYgKG9wdGlvbnM/LnBsYWNlbWVudCA9PSBcImZpbGxcIikge1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiaW5zZXQtYmxvY2stc3RhcnRcIiwgQ1NTVW5pdFV0aWxzLmFzUHgobGVmdCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbnNldC1pbmxpbmUtc3RhcnRcIiwgQ1NTVW5pdFV0aWxzLmFzUHgodG9wKSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTtcbiAgICAgICAgdXNiLnB1c2goYmluZFdpdGgoYW5jaG9yLCBcImluc2V0LWJsb2NrLWVuZFwiLCBDU1NVbml0VXRpbHMuYXNQeChyaWdodCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbnNldC1pbmxpbmUtZW5kXCIsIENTU1VuaXRVdGlscy5hc1B4KGJvdHRvbSksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbmxpbmUtc2l6ZVwiLCBDU1NVbml0VXRpbHMuYXNQeCh3aWR0aCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJibG9jay1zaXplXCIsIENTU1VuaXRVdGlscy5hc1B4KGhlaWdodCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKG9wdGlvbnM/LnBsYWNlbWVudCA9PSBcImJvdHRvbVwiKSB7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbnNldC1ibG9jay1zdGFydFwiLCBDU1NVbml0VXRpbHMuYXNQeChib3R0b20pLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiaW5zZXQtaW5saW5lLXN0YXJ0XCIsIENTU1VuaXRVdGlscy5hc1B4KGxlZnQpLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiaW5saW5lLXNpemVcIiwgQ1NTVW5pdFV0aWxzLmFzUHgod2lkdGgpLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgIH1cbiAgICBlbHNlIGlmIChvcHRpb25zPy5wbGFjZW1lbnQgPT0gXCJ0b3BcIikge1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiaW5zZXQtYmxvY2stZW5kXCIsIENTU1VuaXRVdGlscy5hc1B4KHRvcCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbnNldC1pbmxpbmUtc3RhcnRcIiwgQ1NTVW5pdFV0aWxzLmFzUHgobGVmdCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbmxpbmUtc2l6ZVwiLCBDU1NVbml0VXRpbHMuYXNQeCh3aWR0aCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKG9wdGlvbnM/LnBsYWNlbWVudCA9PSBcImxlZnRcIikge1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiaW5zZXQtaW5saW5lLWVuZFwiLCBDU1NVbml0VXRpbHMuYXNQeChyaWdodCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbnNldC1ibG9jay1zdGFydFwiLCBDU1NVbml0VXRpbHMuYXNQeCh0b3ApLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiYmxvY2stc2l6ZVwiLCBDU1NVbml0VXRpbHMuYXNQeChoZWlnaHQpLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgIH1cbiAgICBlbHNlIGlmIChvcHRpb25zPy5wbGFjZW1lbnQgPT0gXCJyaWdodFwiKSB7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbnNldC1pbmxpbmUtc3RhcnRcIiwgQ1NTVW5pdFV0aWxzLmFzUHgobGVmdCksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7XG4gICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKGFuY2hvciwgXCJpbnNldC1ibG9jay1zdGFydFwiLCBDU1NVbml0VXRpbHMuYXNQeCh0b3ApLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiYmxvY2stc2l6ZVwiLCBDU1NVbml0VXRpbHMuYXNQeChoZWlnaHQpLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgIH1cbiAgICBlbHNlIGlmIChvcHRpb25zPy5wbGFjZW1lbnQgPT0gXCJjZW50ZXJcIikge1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiaW5zZXQtaW5saW5lLXN0YXJ0XCIsIENTU1VuaXRVdGlscy5hc1B4KGxlZnQpLCBoYW5kbGVTdHlsZUNoYW5nZSkpO1xuICAgICAgICB1c2IucHVzaChiaW5kV2l0aChhbmNob3IsIFwiaW5zZXQtYmxvY2stc3RhcnRcIiwgQ1NTVW5pdFV0aWxzLmFzUHgodG9wKSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTtcbiAgICAgICAgdXNiLnB1c2goYmluZFdpdGgoYW5jaG9yLCBcImlubGluZS1zaXplXCIsIENTU1VuaXRVdGlscy5hc1B4KHdpZHRoKSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTtcbiAgICAgICAgdXNiLnB1c2goYmluZFdpdGgoYW5jaG9yLCBcImJsb2NrLXNpemVcIiwgQ1NTVW5pdFV0aWxzLmFzUHgoaGVpZ2h0KSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTtcbiAgICB9XG4gICAgcmV0dXJuICgpID0+IHsgdXNiPy5mb3JFYWNoPy4odWI9PnViPy4oKSk7IH07XG59O1xuXG4vLyBFbmhhbmNlZCBiaW5kaW5nIGZvciBzY3JvbGxiYXIgcG9zaXRpb25pbmcgd2l0aCBpbnRlcnNlY3Rpb24gc3VwcG9ydFxuZXhwb3J0IGNvbnN0IGJpbmRTY3JvbGxiYXJQb3NpdGlvbiA9IChzY3JvbGxiYXI6IEhUTUxFbGVtZW50LCBhbmNob3JCb3g6IGFueVtdfGFueSwgYXhpczogJ2hvcml6b250YWwnIHwgJ3ZlcnRpY2FsJywgb3B0aW9ucz86IHtcbiAgICB1c2VJbnRlcnNlY3Rpb24/OiBib29sZWFuLFxuICAgIHpJbmRleFNoaWZ0PzogbnVtYmVyLFxufSkgPT4ge1xuICAgIGNvbnN0IHsgdXNlSW50ZXJzZWN0aW9uID0gZmFsc2UsIHpJbmRleFNoaWZ0ID0gMSB9ID0gb3B0aW9ucyB8fCB7fTtcbiAgICBjb25zdCB1c2I6IGFueVtdID0gW107XG5cbiAgICAvL1xuICAgIGlmIChhbmNob3JCb3g/LmNvbm5lY3RFbGVtZW50KSB7XG4gICAgICAgIHJldHVybiBhbmNob3JCb3g/LmNvbm5lY3RFbGVtZW50Py4oc2Nyb2xsYmFyLCBPYmplY3QuYXNzaWduKG9wdGlvbnMgfHwge30sIHtcbiAgICAgICAgICAgIHBsYWNlbWVudDogYXhpcyA9PSBcImhvcml6b250YWxcIiA/IFwiYm90dG9tXCIgOiBcInJpZ2h0XCJcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8vXG4gICAgc2Nyb2xsYmFyLnN0eWxlLnBvc2l0aW9uID0gdXNlSW50ZXJzZWN0aW9uID8gJ2ZpeGVkJyA6ICdhYnNvbHV0ZSc7XG4gICAgc2Nyb2xsYmFyLnN0eWxlLnpJbmRleCA9IGAke3pJbmRleFNoaWZ0fWA7XG5cbiAgICBpZiAodXNlSW50ZXJzZWN0aW9uKSB7XG4gICAgICAgIC8vIEludGVyc2VjdGlvbiBib3g6IFtpeCwgaXksIGl3aWR0aCwgaWhlaWdodCwgaXJpZ2h0LCBpYm90dG9tLCBheCwgYXksIGF3aWR0aCwgYWhlaWdodCwgcngsIHJ5LCByd2lkdGgsIHJoZWlnaHRdXG4gICAgICAgIGlmIChheGlzID09PSAnaG9yaXpvbnRhbCcpIHtcbiAgICAgICAgICAgIC8vIFBvc2l0aW9uIGF0IGJvdHRvbSBvZiBpbnRlcnNlY3Rpb24gYXJlYVxuICAgICAgICAgICAgdXNiLnB1c2goYmluZFdpdGgoc2Nyb2xsYmFyLCBcImxlZnRcIiwgQ1NTVW5pdFV0aWxzLmFzUHgoYW5jaG9yQm94WzBdKSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTsgICAgIC8vIGludGVyc2VjdGlvbiB4XG4gICAgICAgICAgICB1c2IucHVzaChiaW5kV2l0aChzY3JvbGxiYXIsIFwidG9wXCIsIENTU1VuaXRVdGlscy5hc1B4KGFuY2hvckJveFs1XSksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7ICAgICAvLyBpbnRlcnNlY3Rpb24gYm90dG9tXG4gICAgICAgICAgICB1c2IucHVzaChiaW5kV2l0aChzY3JvbGxiYXIsIFwid2lkdGhcIiwgQ1NTVW5pdFV0aWxzLmFzUHgoYW5jaG9yQm94WzJdKSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTsgIC8vIGludGVyc2VjdGlvbiB3aWR0aFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gUG9zaXRpb24gYXQgcmlnaHQgb2YgaW50ZXJzZWN0aW9uIGFyZWFcbiAgICAgICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKHNjcm9sbGJhciwgXCJsZWZ0XCIsIENTU1VuaXRVdGlscy5hc1B4KGFuY2hvckJveFs0XSksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7ICAgIC8vIGludGVyc2VjdGlvbiByaWdodFxuICAgICAgICAgICAgdXNiLnB1c2goYmluZFdpdGgoc2Nyb2xsYmFyLCBcInRvcFwiLCBDU1NVbml0VXRpbHMuYXNQeChhbmNob3JCb3hbMV0pLCBoYW5kbGVTdHlsZUNoYW5nZSkpOyAgICAgLy8gaW50ZXJzZWN0aW9uIHlcbiAgICAgICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKHNjcm9sbGJhciwgXCJoZWlnaHRcIiwgQ1NTVW5pdFV0aWxzLmFzUHgoYW5jaG9yQm94WzNdKSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTsgLy8gaW50ZXJzZWN0aW9uIGhlaWdodFxuICAgICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgICAgLy8gUmVndWxhciBib3VuZGluZyBib3g6IFt4LCB5LCB3aWR0aCwgaGVpZ2h0LCByaWdodCwgYm90dG9tXVxuICAgICAgICBpZiAoYXhpcyA9PT0gJ2hvcml6b250YWwnKSB7XG4gICAgICAgICAgICAvLyBQb3NpdGlvbiBhdCBib3R0b20gb2YgY29udGVudCBhcmVhXG4gICAgICAgICAgICB1c2IucHVzaChiaW5kV2l0aChzY3JvbGxiYXIsIFwibGVmdFwiLCBDU1NVbml0VXRpbHMuYXNQeChhbmNob3JCb3hbMF0pLCBoYW5kbGVTdHlsZUNoYW5nZSkpOyAgICAgLy8geFxuICAgICAgICAgICAgdXNiLnB1c2goYmluZFdpdGgoc2Nyb2xsYmFyLCBcInRvcFwiLCBDU1NVbml0VXRpbHMuYXNQeChhbmNob3JCb3hbNV0pLCBoYW5kbGVTdHlsZUNoYW5nZSkpOyAgICAgLy8gYm90dG9tXG4gICAgICAgICAgICB1c2IucHVzaChiaW5kV2l0aChzY3JvbGxiYXIsIFwid2lkdGhcIiwgQ1NTVW5pdFV0aWxzLmFzUHgoYW5jaG9yQm94WzJdKSwgaGFuZGxlU3R5bGVDaGFuZ2UpKTsgIC8vIHdpZHRoXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBQb3NpdGlvbiBhdCByaWdodCBvZiBjb250ZW50IGFyZWFcbiAgICAgICAgICAgIHVzYi5wdXNoKGJpbmRXaXRoKHNjcm9sbGJhciwgXCJsZWZ0XCIsIENTU1VuaXRVdGlscy5hc1B4KGFuY2hvckJveFs0XSksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7ICAgIC8vIHJpZ2h0XG4gICAgICAgICAgICB1c2IucHVzaChiaW5kV2l0aChzY3JvbGxiYXIsIFwidG9wXCIsIENTU1VuaXRVdGlscy5hc1B4KGFuY2hvckJveFsxXSksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7ICAgICAvLyB5XG4gICAgICAgICAgICB1c2IucHVzaChiaW5kV2l0aChzY3JvbGxiYXIsIFwiaGVpZ2h0XCIsIENTU1VuaXRVdGlscy5hc1B4KGFuY2hvckJveFszXSksIGhhbmRsZVN0eWxlQ2hhbmdlKSk7IC8vIGhlaWdodFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuICgpID0+IHsgdXNiPy5mb3JFYWNoPy4odWI9PnViPy4oKSk7IH07XG59O1xuIl19
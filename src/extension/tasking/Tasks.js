import { observe, $triggerLess } from "fest/object";
import { getBy, getFocused, registerTask } from "./Manager";
import { setIgnoreNextPopState } from "./BackNavigation";
//
export class Task {
    $active = false;
    $action;
    payload;
    taskId;
    list;
    _unregisterBack;
    //
    constructor(taskId, list, state = null, payload = {}, action) {
        this.taskId = taskId;
        this.list = list;
        this.payload = payload;
        Object.assign(this, state);
        this.$action = action ?? (() => {
            if ((location.hash != this.taskId) && this.taskId) {
                setIgnoreNextPopState(true);
                history.replaceState("", "", this.taskId || location.hash);
                setIgnoreNextPopState(false);
                return;
            }
        });
        this.addSelfToList(list, true);
    }
    //
    addSelfToList(list, doFocus = false) {
        if (list == null)
            return this;
        //
        const has = getBy(list, this);
        if (has != this) {
            if (!has) {
                list?.push(makeTask(this));
            }
            else {
                Object.assign(has, this);
            }
        }
        //
        this.list = list;
        //
        if (doFocus) {
            this.focus = true;
        }
        setIgnoreNextPopState(true);
        history.pushState({ backNav: true }, "", getFocused(list, false)?.taskId || location.hash);
        setIgnoreNextPopState(false);
        document.dispatchEvent(new CustomEvent("task-focus", { detail: this, bubbles: true, composed: true, cancelable: true }));
        //
        return this;
    }
    //
    get active() { return !!this.$active; }
    get order() { return this.list?.findIndex?.((t) => (t == this || (typeof t.taskId == "string" && t.taskId == this.taskId))) ?? -1; }
    get focus() {
        if (!this.taskId)
            return false;
        const task = this.list?.findLast?.((t) => t.active) ?? null;
        if (!task)
            return false;
        if (task?.taskId && task?.taskId == this.taskId) {
            return true;
        }
        ;
        return false;
    }
    //
    set active(activeStatus) {
        if (this != null && this?.$active != activeStatus) {
            this.$active = activeStatus;
            if (activeStatus) {
                this._unregisterBack = registerTask(this);
            }
            else {
                this._unregisterBack?.();
                this._unregisterBack = undefined;
            }
            document.dispatchEvent(new CustomEvent("task-focus", { detail: getFocused(this.list ?? [], false), bubbles: true, composed: true, cancelable: true }));
        }
    }
    //
    set focus(activeStatus) {
        if (activeStatus && (activeStatus != this.focus)) {
            const index = this.order;
            if (!this.focus && index >= 0) {
                const last = this.list?.findLastIndex?.((t) => t.focus) ?? -1;
                if (index < last || last < 0) {
                    // avoid remove and add reactive element triggering
                    if (this.list)
                        for (const task of this.list) {
                            if (task != this && task?.taskId != this.taskId) {
                                task.focus = false;
                            }
                        }
                    this.list?.[$triggerLess]?.(() => {
                        this.list?.splice?.(index, 1);
                        this.list?.push?.(makeTask(this));
                    });
                    document.dispatchEvent(new CustomEvent("task-focus", { detail: getFocused(this.list ?? [], false), bubbles: true, composed: true, cancelable: true }));
                }
                //
                this.takeAction();
            }
        }
    }
    //
    takeAction() {
        return this.$action?.call?.(this);
    }
    //
    removeFromList() {
        if (!this.list)
            return this;
        const index = this.list.indexOf(getBy(this.list, this) ?? makeTask(this)) ?? -1;
        if (index >= 0) {
            this.list.splice(index, 1);
        }
        const list = this.list;
        this.list = null;
        document.dispatchEvent(new CustomEvent("task-focus", { detail: getFocused(list ?? [], false), bubbles: true, composed: true, cancelable: true }));
        return this;
    }
}
//
export const makeTask = (taskId, list, state = null, payload = {}, action) => {
    if (taskId instanceof Task)
        return observe(taskId);
    const task = new Task(taskId, list, state, payload, action);
    return observe(task);
};
//
export const makeTasks = (createCb) => {
    const tasks = observe([]);
    const result = createCb(tasks);
    return tasks;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFza3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJUYXNrcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNwRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHNUQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFekQsRUFBRTtBQUNGLE1BQU0sT0FBTyxJQUFJO0lBQ2IsT0FBTyxHQUFZLEtBQUssQ0FBQztJQUN6QixPQUFPLENBQW1CO0lBQzFCLE9BQU8sQ0FBTTtJQUNiLE1BQU0sQ0FBUztJQUNmLElBQUksQ0FBZ0I7SUFDcEIsZUFBZSxDQUFjO0lBRTdCLEVBQUU7SUFDRixZQUFZLE1BQWMsRUFBRSxJQUFtQixFQUFFLFFBQTJCLElBQUksRUFBRSxVQUFlLEVBQUUsRUFBRSxNQUFZO1FBQzdHLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLEdBQUUsRUFBRTtZQUMxQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNoRCxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDNUIsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxNQUFNLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUMzRCxxQkFBcUIsQ0FB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QUMsS0FBSyxDQUFDLENBQUM7SUFDL0IsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgb2JzZXJ2ZSwgJHRyaWdnZXJMZXNzIH0gZnJvbSBcImZlc3Qvb2JqZWN0XCI7XG5pbXBvcnQgeyBnZXRCeSwgZ2V0Rm9jdXNlZCwgcmVnaXN0ZXJUYXNrIH0gZnJvbSBcIi4vTWFuYWdlclwiO1xuaW1wb3J0IHsgSVRhc2sgfSBmcm9tIFwiLi9UeXBlc1wiO1xuaW1wb3J0IHsgSVRhc2tPcHRpb25zIH0gZnJvbSBcIi4vVHlwZXNcIjtcbmltcG9ydCB7IHNldElnbm9yZU5leHRQb3BTdGF0ZSB9IGZyb20gXCIuL0JhY2tOYXZpZ2F0aW9uXCI7XG5cbi8vXG5leHBvcnQgY2xhc3MgVGFzayBpbXBsZW1lbnRzIElUYXNrIHtcbiAgICAkYWN0aXZlOiBib29sZWFuID0gZmFsc2U7XG4gICAgJGFjdGlvbjogKCk9PmJvb2xlYW58dm9pZDtcbiAgICBwYXlsb2FkOiBhbnk7XG4gICAgdGFza0lkOiBzdHJpbmc7XG4gICAgbGlzdD86IElUYXNrW118bnVsbDtcbiAgICBfdW5yZWdpc3RlckJhY2s/OiAoKSA9PiB2b2lkO1xuXG4gICAgLy9cbiAgICBjb25zdHJ1Y3Rvcih0YXNrSWQ6IHN0cmluZywgbGlzdD86IElUYXNrW118bnVsbCwgc3RhdGU6IElUYXNrT3B0aW9uc3xudWxsID0gbnVsbCwgcGF5bG9hZDogYW55ID0ge30sIGFjdGlvbj86IGFueSkge1xuICAgICAgICB0aGlzLnRhc2tJZCA9IHRhc2tJZDtcbiAgICAgICAgdGhpcy5saXN0ID0gbGlzdDsgdGhpcy5wYXlsb2FkID0gcGF5bG9hZDsgT2JqZWN0LmFzc2lnbih0aGlzLCBzdGF0ZSk7XG4gICAgICAgIHRoaXMuJGFjdGlvbiA9IGFjdGlvbiA/PyAoKCk9PntcbiAgICAgICAgICAgIGlmICgobG9jYXRpb24uaGFzaCAhPSB0aGlzLnRhc2tJZCkgJiYgdGhpcy50YXNrSWQpIHtcbiAgICAgICAgICAgICAgICBzZXRJZ25vcmVOZXh0UG9wU3RhdGUodHJ1ZSk7XG4gICAgICAgICAgICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUoXCJcIiwgXCJcIiwgdGhpcy50YXNrSWQgfHwgbG9jYXRpb24uaGFzaCk7XG4gICAgICAgICAgICAgICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlKGZhbHNlKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmFkZFNlbGZUb0xpc3QobGlzdCwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBhZGRTZWxmVG9MaXN0KGxpc3Q/OiBJVGFza1tdfG51bGwsIGRvRm9jdXM6IGJvb2xlYW4gPSBmYWxzZSk6IElUYXNrIHtcbiAgICAgICAgaWYgKGxpc3QgPT0gbnVsbCkgcmV0dXJuIHRoaXM7XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3QgaGFzID0gZ2V0QnkobGlzdCwgdGhpcyk7XG4gICAgICAgIGlmIChoYXMgIT0gdGhpcykge1xuICAgICAgICAgICAgaWYgKCFoYXMpIHsgbGlzdD8ucHVzaChtYWtlVGFzayh0aGlzKSBhcyBhbnkpOyB9IGVsc2UgeyBPYmplY3QuYXNzaWduKGhhcywgdGhpcyk7IH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIHRoaXMubGlzdCA9IGxpc3Q7XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKGRvRm9jdXMpIHsgdGhpcy5mb2N1cyA9IHRydWU7IH1cbiAgICAgICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlKHRydWUpO1xuICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZSh7IGJhY2tOYXY6IHRydWUgfSwgXCJcIiwgZ2V0Rm9jdXNlZChsaXN0LCBmYWxzZSk/LnRhc2tJZCB8fCBsb2NhdGlvbi5oYXNoKTtcbiAgICAgICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlKGZhbHNlKTtcbiAgICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoXCJ0YXNrLWZvY3VzXCIsIHsgZGV0YWlsOiB0aGlzLCBidWJibGVzOiB0cnVlLCBjb21wb3NlZDogdHJ1ZSwgY2FuY2VsYWJsZTogdHJ1ZSB9KSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXQgYWN0aXZlKCk6IGJvb2xlYW4geyByZXR1cm4gISF0aGlzLiRhY3RpdmU7IH1cbiAgICBnZXQgb3JkZXIoKTogbnVtYmVyIHsgcmV0dXJuIHRoaXMubGlzdD8uZmluZEluZGV4Py4oKHQpPT4odCA9PSB0aGlzIHx8ICh0eXBlb2YgdC50YXNrSWQgPT0gXCJzdHJpbmdcIiAmJiB0LnRhc2tJZCA9PSB0aGlzLnRhc2tJZCkpKSA/PyAtMTsgfVxuICAgIGdldCBmb2N1cygpOiBib29sZWFuIHtcbiAgICAgICAgaWYgKCF0aGlzLnRhc2tJZCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBjb25zdCB0YXNrID0gdGhpcy5saXN0Py5maW5kTGFzdD8uKCh0KT0+dC5hY3RpdmUpID8/IG51bGw7IGlmICghdGFzaykgcmV0dXJuIGZhbHNlO1xuICAgICAgICBpZiAodGFzaz8udGFza0lkICYmdGFzaz8udGFza0lkID09IHRoaXMudGFza0lkKSB7IHJldHVybiB0cnVlOyB9O1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy9cbiAgICBzZXQgYWN0aXZlKGFjdGl2ZVN0YXR1czogYm9vbGVhbikge1xuICAgICAgICBpZiAodGhpcyAhPSBudWxsICYmIHRoaXM/LiRhY3RpdmUgIT0gYWN0aXZlU3RhdHVzKSB7XG4gICAgICAgICAgICB0aGlzLiRhY3RpdmUgPSBhY3RpdmVTdGF0dXM7XG5cbiAgICAgICAgICAgIGlmIChhY3RpdmVTdGF0dXMpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl91bnJlZ2lzdGVyQmFjayA9IHJlZ2lzdGVyVGFzayh0aGlzKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fdW5yZWdpc3RlckJhY2s/LigpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3VucmVnaXN0ZXJCYWNrID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChcInRhc2stZm9jdXNcIiwgeyBkZXRhaWw6IGdldEZvY3VzZWQodGhpcy5saXN0ID8/IFtdLCBmYWxzZSksIGJ1YmJsZXM6IHRydWUsIGNvbXBvc2VkOiB0cnVlLCBjYW5jZWxhYmxlOiB0cnVlIH0pKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgc2V0IGZvY3VzKGFjdGl2ZVN0YXR1czogYm9vbGVhbikge1xuICAgICAgICBpZiAoYWN0aXZlU3RhdHVzICYmIChhY3RpdmVTdGF0dXMgIT0gdGhpcy5mb2N1cykpIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5vcmRlcjtcbiAgICAgICAgICAgIGlmICghdGhpcy5mb2N1cyAmJiBpbmRleCA+PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGFzdCA9IHRoaXMubGlzdD8uZmluZExhc3RJbmRleD8uKCh0KT0+dC5mb2N1cykgPz8gLTE7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgbGFzdCB8fCBsYXN0IDwgMClcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXZvaWQgcmVtb3ZlIGFuZCBhZGQgcmVhY3RpdmUgZWxlbWVudCB0cmlnZ2VyaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5saXN0KSBmb3IgKGNvbnN0IHRhc2sgb2YgdGhpcy5saXN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2sgIT0gdGhpcyAmJiB0YXNrPy50YXNrSWQgIT0gdGhpcy50YXNrSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5mb2N1cyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdD8uWyR0cmlnZ2VyTGVzc10/LigoKT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlzdD8uc3BsaWNlPy4oaW5kZXgsIDEpOyB0aGlzLmxpc3Q/LnB1c2g/LihtYWtlVGFzayh0aGlzKSBhcyBhbnkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmRpc3BhdGNoRXZlbnQobmV3IEN1c3RvbUV2ZW50KFwidGFzay1mb2N1c1wiLCB7IGRldGFpbDogZ2V0Rm9jdXNlZCh0aGlzLmxpc3QgPz8gW10sIGZhbHNlKSwgYnViYmxlczogdHJ1ZSwgY29tcG9zZWQ6IHRydWUsIGNhbmNlbGFibGU6IHRydWUgfSkpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL1xuICAgICAgICAgICAgICAgIHRoaXMudGFrZUFjdGlvbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9cbiAgICB0YWtlQWN0aW9uKCk6IGJvb2xlYW58dm9pZCB7XG4gICAgICAgIHJldHVybiB0aGlzLiRhY3Rpb24/LmNhbGw/Lih0aGlzKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIHJlbW92ZUZyb21MaXN0KCkge1xuICAgICAgICBpZiAoIXRoaXMubGlzdCkgcmV0dXJuIHRoaXM7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5saXN0LmluZGV4T2YoZ2V0QnkodGhpcy5saXN0LCB0aGlzKSA/PyBtYWtlVGFzayh0aGlzIGFzIGFueSkgYXMgYW55KSA/PyAtMTtcbiAgICAgICAgaWYgKGluZGV4ID49IDApIHsgdGhpcy5saXN0LnNwbGljZShpbmRleCwgMSk7IH1cbiAgICAgICAgY29uc3QgbGlzdCA9IHRoaXMubGlzdDsgdGhpcy5saXN0ID0gbnVsbDtcbiAgICAgICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoXCJ0YXNrLWZvY3VzXCIsIHsgZGV0YWlsOiBnZXRGb2N1c2VkKGxpc3QgPz8gW10sIGZhbHNlKSwgYnViYmxlczogdHJ1ZSwgY29tcG9zZWQ6IHRydWUsIGNhbmNlbGFibGU6IHRydWUgfSkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG59XG5cbi8vXG5leHBvcnQgY29uc3QgbWFrZVRhc2sgPSAodGFza0lkOiBzdHJpbmd8VGFzaywgbGlzdD86IElUYXNrW118bnVsbCwgc3RhdGU6IElUYXNrT3B0aW9uc3xudWxsID0gbnVsbCwgcGF5bG9hZDogYW55ID0ge30sIGFjdGlvbj86IGFueSk9PntcbiAgICBpZiAodGFza0lkIGluc3RhbmNlb2YgVGFzaykgcmV0dXJuIG9ic2VydmUodGFza0lkKTtcbiAgICBjb25zdCB0YXNrID0gbmV3IFRhc2sodGFza0lkLCBsaXN0LCBzdGF0ZSwgcGF5bG9hZCwgYWN0aW9uKTtcbiAgICByZXR1cm4gb2JzZXJ2ZSh0YXNrKTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBtYWtlVGFza3MgPSAoY3JlYXRlQ2I6IGFueSk9PntcbiAgICBjb25zdCB0YXNrcyA9IG9ic2VydmUoW10pO1xuICAgIGNvbnN0IHJlc3VsdCA9IGNyZWF0ZUNiKHRhc2tzKTtcbiAgICByZXR1cm4gdGFza3M7XG59XG4iXX0=
import { addEvent } from "fest/dom";
import { initBackNavigation, registerCloseable, ClosePriority, getIgnoreNextPopState, setIgnoreNextPopState } from "./BackNavigation";
//
export const getBy = (tasks = [], taskId) => {
    return tasks.find((t) => (taskId == t || (typeof t.taskId == "string" && t.taskId?.replace?.(/^#/, "") == (typeof taskId == "string" ? taskId?.replace?.(/^#/, "") : null))));
};
//
export const historyBack = (tasks = []) => {
    setIgnoreNextPopState(true);
    history?.back?.();
    const lastFocus = getFocused(tasks, false)?.taskId || "";
    if (location?.hash?.trim?.()?.replace?.(/^#/, "")?.trim?.() != lastFocus?.trim?.()?.replace?.(/^#/, "")?.trim?.()) {
        setIgnoreNextPopState(true);
        history?.replaceState?.("", "", lastFocus);
    }
    return tasks;
};
//
export const getFocused = (tasks = [], includeHash = true) => {
    return (tasks.findLast((t) => t.active) ?? (includeHash ? tasks?.find?.((t) => t.taskId?.replace?.(/^#/, "") == location.hash?.replace?.(/^#/, "")) : null));
};
/**
 * Register a task with the back navigation system
 * Tasks have lower priority than modals/menus and can be closed via back gesture
 */
export const registerTask = (task, onClose) => {
    return registerCloseable({
        id: `task-${task.taskId?.replace?.(/^#/, "") ?? task.taskId}`,
        priority: ClosePriority.TASK,
        group: "task",
        isActive: () => task.active === true,
        close: (view) => {
            task.active = false;
            return onClose?.() ?? false;
            // Return false to allow the back navigation to proceed (updating the URL)
            // since tasks are typically history-based
            //return false;
        }
    });
};
//
export const navigationEnable = (tasks, taskEnvAction) => {
    let processingHashChange = false;
    // Initialize centralized back navigation
    // We don't skip handler anymore, we rely on it
    initBackNavigation({
        preventDefaultNavigation: false,
        pushInitialState: false
    });
    // Register a general fallback closeable for taskEnvAction
    if (taskEnvAction) {
        registerCloseable({
            id: "task-env-manager",
            priority: ClosePriority.VIEW, // Low priority
            isActive: () => !!getFocused(tasks, true),
            close: () => {
                // If taskEnvAction returns true, it handled the close/action
                // and wants to cancel the back navigation (return true)
                const focused = getFocused(tasks, true);
                if (focused && taskEnvAction(focused)) {
                    return true;
                }
                return false;
            }
        });
    }
    // prevent behavior once...
    addEvent(window, "hashchange", (ev) => {
        if (processingHashChange || getIgnoreNextPopState())
            return;
        processingHashChange = true;
        try {
            const fc = getBy(tasks, location.hash);
            if (fc) {
                fc.focus = true;
            }
            else {
                const hash = getFocused(tasks, false)?.taskId || location.hash || "";
                if (location.hash?.trim?.()?.replace?.(/^#/, "")?.trim?.() != hash?.trim?.()?.replace?.(/^#/, "")?.trim?.()) {
                    setIgnoreNextPopState(true);
                    // Preserve existing state structure
                    const state = history.state || {};
                    history?.replaceState?.(state, "", hash);
                }
                ;
            }
            ;
        }
        finally {
            processingHashChange = false;
        }
    });
    // Ensure initial state
    if (!history.state?.backNav) {
        setIgnoreNextPopState(true);
        const state = history.state || {};
        history?.replaceState?.({ ...state, backNav: true, depth: history.length }, "", location.hash || "#");
        setIgnoreNextPopState(false);
    }
    //
    return tasks;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIk1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNwQyxPQUFPLEVBQ0gsa0JBQWtCLEVBQ2xCLGlCQUFpQixFQUdqQixhQUFhLEVBQ2IscUJBQXFCLEVBQ3JCLHFCQUFxQixFQUN4QixNQUFNLGtCQUFrQixDQUFDO0FBRTFCLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxRQUFpQixFQUFFLEVBQUUsTUFBd0IsRUFBQyxFQUFFO0lBQ2xFLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBQyxFQUFFLENBQUEsQ0FBQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxJQUFJLFFBQVEsSUFBSSxDQUFDLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sTUFBTSxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDaEwsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLFFBQWlCLEVBQUUsRUFBQyxFQUFFO0lBQzlDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDO0lBQUMsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsRUFBRSxNQUFNLElBQUksRUFBRSxDQUFDO0lBQzVFLElBQUksUUFBUSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLE9B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QUM7WUFDUCxvQkFBb0IsR0FBRyxLQUFLLENBQUM7UUFDakMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsdUJBQXVCO0lBQ3ZCLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxDQUFDO1FBQzFCLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQ2xDLE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQyxFQUFFLEdBQUcsS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztRQUN0RyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsRUFBRTtJQUNGLE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElUYXNrIH0gZnJvbSBcIi4vVHlwZXNcIjtcbmltcG9ydCB7IGFkZEV2ZW50IH0gZnJvbSBcImZlc3QvZG9tXCI7XG5pbXBvcnQge1xuICAgIGluaXRCYWNrTmF2aWdhdGlvbixcbiAgICByZWdpc3RlckNsb3NlYWJsZSxcbiAgICBjbG9zZUhpZ2hlc3RQcmlvcml0eSxcbiAgICBoYXNBY3RpdmVDbG9zZWFibGUsXG4gICAgQ2xvc2VQcmlvcml0eSxcbiAgICBnZXRJZ25vcmVOZXh0UG9wU3RhdGUsXG4gICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlXG59IGZyb20gXCIuL0JhY2tOYXZpZ2F0aW9uXCI7XG5cbi8vXG5leHBvcnQgY29uc3QgZ2V0QnkgPSAodGFza3M6IElUYXNrW10gPSBbXSwgdGFza0lkOiBJVGFza3xzdHJpbmd8YW55KT0+e1xuICAgIHJldHVybiB0YXNrcy5maW5kKCh0KT0+KHRhc2tJZCA9PSB0IHx8ICh0eXBlb2YgdC50YXNrSWQgPT0gXCJzdHJpbmdcIiAmJiB0LnRhc2tJZD8ucmVwbGFjZT8uKC9eIy8sIFwiXCIpID09ICh0eXBlb2YgdGFza0lkID09IFwic3RyaW5nXCIgPyB0YXNrSWQ/LnJlcGxhY2U/LigvXiMvLCBcIlwiKSA6IG51bGwpKSkpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGhpc3RvcnlCYWNrID0gKHRhc2tzOiBJVGFza1tdID0gW10pPT57XG4gICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlKHRydWUpO1xuICAgIGhpc3Rvcnk/LmJhY2s/LigpOyBjb25zdCBsYXN0Rm9jdXMgPSBnZXRGb2N1c2VkKHRhc2tzLCBmYWxzZSk/LnRhc2tJZCB8fCBcIlwiO1xuICAgIGlmIChsb2NhdGlvbj8uaGFzaD8udHJpbT8uKCk/LnJlcGxhY2U/LigvXiMvLCBcIlwiKT8udHJpbT8uKCkgIT0gbGFzdEZvY3VzPy50cmltPy4oKT8ucmVwbGFjZT8uKC9eIy8sIFwiXCIpPy50cmltPy4oKSkgeyBzZXRJZ25vcmVOZXh0UG9wU3RhdGUodHJ1ZSk7IGhpc3Rvcnk/LnJlcGxhY2VTdGF0ZT8uKFwiXCIsIFwiXCIsIGxhc3RGb2N1cyk7IH1cbiAgICByZXR1cm4gdGFza3M7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgZ2V0Rm9jdXNlZCA9ICh0YXNrczogSVRhc2tbXSA9IFtdLCBpbmNsdWRlSGFzaDogYm9vbGVhbiA9IHRydWUpPT57XG4gICAgcmV0dXJuICh0YXNrcy5maW5kTGFzdCgodCk9PnQuYWN0aXZlKSA/PyAoaW5jbHVkZUhhc2ggPyB0YXNrcz8uZmluZD8uKCh0KT0+dC50YXNrSWQ/LnJlcGxhY2U/LigvXiMvLCBcIlwiKSA9PSBsb2NhdGlvbi5oYXNoPy5yZXBsYWNlPy4oL14jLywgXCJcIikpIDogbnVsbCkpO1xufVxuXG4vKipcbiAqIFJlZ2lzdGVyIGEgdGFzayB3aXRoIHRoZSBiYWNrIG5hdmlnYXRpb24gc3lzdGVtXG4gKiBUYXNrcyBoYXZlIGxvd2VyIHByaW9yaXR5IHRoYW4gbW9kYWxzL21lbnVzIGFuZCBjYW4gYmUgY2xvc2VkIHZpYSBiYWNrIGdlc3R1cmVcbiAqL1xuZXhwb3J0IGNvbnN0IHJlZ2lzdGVyVGFzayA9ICh0YXNrOiBJVGFzaywgb25DbG9zZT86ICgpID0+IHZvaWQpOiAoKCkgPT4gdm9pZCkgPT4ge1xuICAgIHJldHVybiByZWdpc3RlckNsb3NlYWJsZSh7XG4gICAgICAgIGlkOiBgdGFzay0ke3Rhc2sudGFza0lkPy5yZXBsYWNlPy4oL14jLywgXCJcIikgPz8gdGFzay50YXNrSWR9YCxcbiAgICAgICAgcHJpb3JpdHk6IENsb3NlUHJpb3JpdHkuVEFTSyxcbiAgICAgICAgZ3JvdXA6IFwidGFza1wiLFxuICAgICAgICBpc0FjdGl2ZTogKCkgPT4gdGFzay5hY3RpdmUgPT09IHRydWUsXG4gICAgICAgIGNsb3NlOiAodmlldz86IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgdGFzay5hY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgICAgIHJldHVybiBvbkNsb3NlPy4oKSA/PyBmYWxzZTtcbiAgICAgICAgICAgIC8vIFJldHVybiBmYWxzZSB0byBhbGxvdyB0aGUgYmFjayBuYXZpZ2F0aW9uIHRvIHByb2NlZWQgKHVwZGF0aW5nIHRoZSBVUkwpXG4gICAgICAgICAgICAvLyBzaW5jZSB0YXNrcyBhcmUgdHlwaWNhbGx5IGhpc3RvcnktYmFzZWRcbiAgICAgICAgICAgIC8vcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfSkgYXMgKCgpID0+IHZvaWQpO1xufTtcblxuLy9cbmV4cG9ydCBjb25zdCBuYXZpZ2F0aW9uRW5hYmxlID0gKHRhc2tzOiBJVGFza1tdLCB0YXNrRW52QWN0aW9uPzogKHRhc2s/OiBJVGFza3xudWxsKT0+Ym9vbGVhbnx2b2lkKT0+e1xuICAgIGxldCBwcm9jZXNzaW5nSGFzaENoYW5nZSA9IGZhbHNlO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBjZW50cmFsaXplZCBiYWNrIG5hdmlnYXRpb25cbiAgICAvLyBXZSBkb24ndCBza2lwIGhhbmRsZXIgYW55bW9yZSwgd2UgcmVseSBvbiBpdFxuICAgIGluaXRCYWNrTmF2aWdhdGlvbih7XG4gICAgICAgIHByZXZlbnREZWZhdWx0TmF2aWdhdGlvbjogZmFsc2UsXG4gICAgICAgIHB1c2hJbml0aWFsU3RhdGU6IGZhbHNlXG4gICAgfSk7XG5cbiAgICAvLyBSZWdpc3RlciBhIGdlbmVyYWwgZmFsbGJhY2sgY2xvc2VhYmxlIGZvciB0YXNrRW52QWN0aW9uXG4gICAgaWYgKHRhc2tFbnZBY3Rpb24pIHtcbiAgICAgICAgcmVnaXN0ZXJDbG9zZWFibGUoe1xuICAgICAgICAgICAgaWQ6IFwidGFzay1lbnYtbWFuYWdlclwiLFxuICAgICAgICAgICAgcHJpb3JpdHk6IENsb3NlUHJpb3JpdHkuVklFVywgLy8gTG93IHByaW9yaXR5XG4gICAgICAgICAgICBpc0FjdGl2ZTogKCkgPT4gISFnZXRGb2N1c2VkKHRhc2tzLCB0cnVlKSxcbiAgICAgICAgICAgIGNsb3NlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gSWYgdGFza0VudkFjdGlvbiByZXR1cm5zIHRydWUsIGl0IGhhbmRsZWQgdGhlIGNsb3NlL2FjdGlvblxuICAgICAgICAgICAgICAgIC8vIGFuZCB3YW50cyB0byBjYW5jZWwgdGhlIGJhY2sgbmF2aWdhdGlvbiAocmV0dXJuIHRydWUpXG4gICAgICAgICAgICAgICAgY29uc3QgZm9jdXNlZCA9IGdldEZvY3VzZWQodGFza3MsIHRydWUpO1xuICAgICAgICAgICAgICAgIGlmIChmb2N1c2VkICYmIHRhc2tFbnZBY3Rpb24oZm9jdXNlZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gcHJldmVudCBiZWhhdmlvciBvbmNlLi4uXG4gICAgYWRkRXZlbnQod2luZG93LCBcImhhc2hjaGFuZ2VcIiwgKGV2KT0+e1xuICAgICAgICBpZiAocHJvY2Vzc2luZ0hhc2hDaGFuZ2UgfHwgZ2V0SWdub3JlTmV4dFBvcFN0YXRlKCkpIHJldHVybjtcbiAgICAgICAgcHJvY2Vzc2luZ0hhc2hDaGFuZ2UgPSB0cnVlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmMgPSBnZXRCeSh0YXNrcywgbG9jYXRpb24uaGFzaCk7XG4gICAgICAgICAgICBpZiAoZmMpIHsgZmMuZm9jdXMgPSB0cnVlOyB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnN0IGhhc2ggPSBnZXRGb2N1c2VkKHRhc2tzLCBmYWxzZSk/LnRhc2tJZCB8fCBsb2NhdGlvbi5oYXNoIHx8IFwiXCI7XG4gICAgICAgICAgICAgICAgaWYgKGxvY2F0aW9uLmhhc2g/LnRyaW0/LigpPy5yZXBsYWNlPy4oL14jLywgXCJcIik/LnRyaW0/LigpICE9IGhhc2g/LnRyaW0/LigpPy5yZXBsYWNlPy4oL14jLywgXCJcIik/LnRyaW0/LigpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldElnbm9yZU5leHRQb3BTdGF0ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gUHJlc2VydmUgZXhpc3Rpbmcgc3RhdGUgc3RydWN0dXJlXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gaGlzdG9yeS5zdGF0ZSB8fCB7fTtcbiAgICAgICAgICAgICAgICAgICAgaGlzdG9yeT8ucmVwbGFjZVN0YXRlPy4oc3RhdGUsIFwiXCIsIGhhc2gpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9O1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgcHJvY2Vzc2luZ0hhc2hDaGFuZ2UgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gRW5zdXJlIGluaXRpYWwgc3RhdGVcbiAgICBpZiAoIWhpc3Rvcnkuc3RhdGU/LmJhY2tOYXYpIHtcbiAgICAgICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlKHRydWUpO1xuICAgICAgICBjb25zdCBzdGF0ZSA9IGhpc3Rvcnkuc3RhdGUgfHwge307XG4gICAgICAgIGhpc3Rvcnk/LnJlcGxhY2VTdGF0ZT8uKHsgLi4uc3RhdGUsIGJhY2tOYXY6IHRydWUsIGRlcHRoOiBoaXN0b3J5Lmxlbmd0aCB9LCBcIlwiLCBsb2NhdGlvbi5oYXNoIHx8IFwiI1wiKTtcbiAgICAgICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlKGZhbHNlKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIHJldHVybiB0YXNrcztcbn1cbiJdfQ==
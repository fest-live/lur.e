//import { visibleRef, H, Q } from "fest/lure";
import { addEvent } from "fest/dom";
import { visibleRef } from "../../lure/core/Refs";
import { addProxiedEvent } from "../controllers/LazyEvents";
import { bindWhileConnected } from "../../lure/core/Binding";
//
import { registerContextMenu } from "../tasking/BackNavigation";
import Q from "../../lure/node/Queried";
import H from "../../lure/node/Syntax";
import { boundingBoxAnchorRef } from "../space-ref/BBoxAnchor";
import { makeInterruptTrigger } from "../controllers/Trigger";
import { withInsetWithPointer } from "../../lure/core/Binding";
//
export const itemClickHandle = (ev, ctxMenuDesc) => {
    const id = Q(`[data-id]`, ev?.target, 0, "parent")?.getAttribute?.("data-id");
    const item = ctxMenuDesc?.items
        ?.find?.((I) => I?.some?.((I) => I?.id == id))
        ?.find?.((I) => I?.id == id);
    (item?.action ?? ctxMenuDesc?.defaultAction)?.(ctxMenuDesc?.openedWith?.initiator, item, ctxMenuDesc?.openedWith?.event ?? ev);
    ctxMenuDesc?.openedWith?.close?.();
    const vr = getBoundVisibleRef(ctxMenuDesc?.openedWith?.element);
    if (vr != null)
        vr.value = false;
};
const visibleMap = new WeakMap();
// Proxied trigger handling: guarantees ONE real `contextmenu` listener on documentElement.
// preventDefault/stopImmediatePropagation ONLY when the handler returns truthy ("handled").
const registerCtxMenu = typeof document !== "undefined" && document?.documentElement
    ? addProxiedEvent(document.documentElement, "contextmenu", { capture: true, passive: false }, { strategy: "closest", preventDefault: "handled", stopImmediatePropagation: "handled" })
    : (_el, _handler) => () => { };
const getBoundVisibleRef = (menuElement) => {
    if (menuElement == null)
        return null; // @ts-ignore
    return visibleMap?.getOrInsertComputed?.(menuElement, () => visibleRef(menuElement, false));
};
export const bindMenuItemClickHandler = (menuElement, menuDesc) => {
    const handler = (ev) => { itemClickHandle(ev, menuDesc); };
    const listening = addEvent(menuElement, "click", handler, { composed: true });
    return () => listening?.();
};
export const getGlobalContextMenu = (parent = document) => {
    let menu = Q('ui-modal[type="contextmenu"]', parent);
    if (!menu) {
        menu = H `<ui-modal type="contextmenu"></ui-modal>`;
        (parent instanceof Document ? parent.body : parent).append(menu);
    }
    return menu;
};
export const makeMenuHandler = (triggerElement, placement, ctxMenuDesc, menuElement) => {
    return (ev) => {
        let handled = false;
        const menu = menuElement || getGlobalContextMenu();
        const visibleRef = getBoundVisibleRef(menu);
        const initiator = ev?.target ?? triggerElement ?? document.elementFromPoint(ev?.clientX || 0, ev?.clientY || 0);
        const details = { event: ev, initiator: initiator, trigger: triggerElement, menu: menu, ctxMenuDesc };
        ctxMenuDesc.context = details;
        if (ctxMenuDesc?.onBeforeOpen?.(details) === false) {
            return handled;
        }
        const builtItems = ctxMenuDesc?.buildItems?.(details);
        if (Array.isArray(builtItems) && builtItems.length) {
            ctxMenuDesc.items = builtItems;
        }
        if (visibleRef?.value && ev?.type !== "contextmenu") {
            visibleRef.value = false;
            ctxMenuDesc?.openedWith?.close?.();
            return handled;
        }
        if (initiator && visibleRef) {
            handled = true;
            // TODO: use reactive mapped ctx-menu element
            menu.innerHTML = "";
            visibleRef.value = true;
            menu?.append?.(...(ctxMenuDesc?.items
                ?.map?.((section, sIdx) => {
                const items = section?.map?.((item) => H `<li data-id=${item?.id || ""}><ui-icon icon=${item?.icon || ""}></ui-icon><span>${item?.label || ""}</span></li>`);
                const separator = (section?.length > 1 && sIdx !== ((ctxMenuDesc?.items?.length || 0) - 1))
                    ? H `<li class="ctx-menu-separator"></li>`
                    : null;
                return [...items, separator];
            })
                ?.flat?.()
                ?.filter?.((E) => !!E) || []));
            const where = withInsetWithPointer?.(menu, placement?.(ev, initiator));
            const unbindClick = bindMenuItemClickHandler(menu, ctxMenuDesc);
            // Close when interacting outside the menu.
            const untrigger = makeInterruptTrigger?.(menu, (e) => {
                const menuAny = menu;
                if (!(menu?.contains?.((e?.target ?? null)) || e?.target == (menuAny?.element ?? menuAny)) || !e?.target) {
                    ctxMenuDesc?.openedWith?.close?.();
                    const vr = getBoundVisibleRef(menu);
                    if (vr != null)
                        vr.value = false;
                }
            }, ["click", "pointerdown", "scroll"]);
            // While open: suppress native context menu on the menu element itself.
            const unmenuCtx = registerCtxMenu(menu, () => true);
            ctxMenuDesc.openedWith = {
                initiator: initiator,
                element: menu,
                event: ev,
                context: ctxMenuDesc?.context,
                close() {
                    visibleRef.value = false;
                    ctxMenuDesc.openedWith = null;
                    unbindClick?.();
                    where?.();
                    untrigger?.();
                    unmenuCtx?.();
                    // @ts-ignore
                    if (ctxMenuDesc._backUnreg) {
                        ctxMenuDesc._backUnreg();
                        ctxMenuDesc._backUnreg = null;
                    }
                },
            };
            // Register with back navigation
            // @ts-ignore
            if (!ctxMenuDesc._backUnreg && visibleRef) {
                // @ts-ignore
                ctxMenuDesc._backUnreg = registerContextMenu(menu, visibleRef, () => {
                    ctxMenuDesc?.openedWith?.close?.();
                });
            }
        }
        return handled;
    };
};
// use cursor as anchor based on contextmenu
export const ctxMenuTrigger = (triggerElement, ctxMenuDesc, menuElement) => {
    const evHandler = makeMenuHandler(triggerElement, (ev) => [ev?.clientX, ev?.clientY, 200], ctxMenuDesc, menuElement);
    // Activate trigger + global listener only when trigger element is actually connected.
    const unbindConnected = bindWhileConnected(triggerElement, () => {
        return registerCtxMenu(triggerElement, evHandler);
    });
    return () => {
        unbindConnected?.();
    };
};
// bit same as contextmenu, but different by anchor and trigger (from element drop-down)
export const dropMenuTrigger = (triggerElement, ctxMenuDesc, menuElement) => {
    const menu = menuElement || Q('ui-modal[type="menulist"]', document.body) || getGlobalContextMenu();
    const anchorElement = triggerElement; // @ts-ignore
    const evHandler = makeMenuHandler(triggerElement, (ev) => boundingBoxAnchorRef(anchorElement)?.slice?.(0, 3), ctxMenuDesc, menu);
    const untrigger = makeInterruptTrigger?.(menu, (ev) => {
        if (!(menu?.contains?.(ev?.target) || ev?.target == (triggerElement?.element ?? triggerElement)) || !ev?.target) {
            ctxMenuDesc?.openedWith?.close?.();
            const vr = getBoundVisibleRef(menu);
            if (vr != null)
                vr.value = false;
        }
    }, ["click", "pointerdown", "scroll"]);
    const listening = addEvent(triggerElement, "click", evHandler, { composed: true });
    return () => { untrigger?.(); listening?.(); };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3R4TWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkN0eE1lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsK0NBQStDO0FBQy9DLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDcEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU3RCxFQUFFO0FBQ0YsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDaEUsT0FBTyxDQUFDLE1BQU0seUJBQXlCLENBQUM7QUFDeEMsT0FBTyxDQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDOUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUEyQi9ELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsQ0FBQyxFQUFjLEVBQUUsV0FBd0IsRUFBRSxFQUFFO0lBQ3hFLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxFQUFFLE1BQXFCLEVBQUUsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxFQUFFLFlBQVksRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzdGLE1BQU0sSUFBSSxHQUF5QixXQUFXLEVBQUUsS0FBSztRQUNqRCxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFXLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7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RSxhQUFhLEVBQUUsUUFBUSxDQUFDLENBQ3JDLENBQUM7SUFFRixNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsY0FBYyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUNuRixPQUFPLEdBQUcsRUFBRSxHQUFHLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25ELENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vaW1wb3J0IHsgdmlzaWJsZVJlZiwgSCwgUSB9IGZyb20gXCJmZXN0L2x1cmVcIjtcbmltcG9ydCB7IGFkZEV2ZW50IH0gZnJvbSBcImZlc3QvZG9tXCI7XG5pbXBvcnQgeyB2aXNpYmxlUmVmIH0gZnJvbSBcIi4uLy4uL2x1cmUvY29yZS9SZWZzXCI7XG5pbXBvcnQgeyBhZGRQcm94aWVkRXZlbnQgfSBmcm9tIFwiLi4vY29udHJvbGxlcnMvTGF6eUV2ZW50c1wiO1xuaW1wb3J0IHsgYmluZFdoaWxlQ29ubmVjdGVkIH0gZnJvbSBcIi4uLy4uL2x1cmUvY29yZS9CaW5kaW5nXCI7XG5cbi8vXG5pbXBvcnQgeyByZWdpc3RlckNvbnRleHRNZW51IH0gZnJvbSBcIi4uL3Rhc2tpbmcvQmFja05hdmlnYXRpb25cIjtcbmltcG9ydCBRIGZyb20gXCIuLi8uLi9sdXJlL25vZGUvUXVlcmllZFwiO1xuaW1wb3J0IEggZnJvbSBcIi4uLy4uL2x1cmUvbm9kZS9TeW50YXhcIjtcbmltcG9ydCB7IGJvdW5kaW5nQm94QW5jaG9yUmVmIH0gZnJvbSBcIi4uL3NwYWNlLXJlZi9CQm94QW5jaG9yXCI7XG5pbXBvcnQgeyBtYWtlSW50ZXJydXB0VHJpZ2dlciB9IGZyb20gXCIuLi9jb250cm9sbGVycy9UcmlnZ2VyXCI7XG5pbXBvcnQgeyB3aXRoSW5zZXRXaXRoUG9pbnRlciB9IGZyb20gXCIuLi8uLi9sdXJlL2NvcmUvQmluZGluZ1wiO1xuXG4vL1xuZXhwb3J0IGludGVyZmFjZSBSZWZCb29sIHsgdmFsdWU/OiBib29sZWFuOyB9XG5leHBvcnQgaW50ZXJmYWNlIE1lbnVJdGVtIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIGxhYmVsOiBzdHJpbmc7XG4gICAgaWNvbjogc3RyaW5nO1xuICAgIGFjdGlvbj86IChpbml0aWF0b3I6IEhUTUxFbGVtZW50LCBpdGVtOiBNZW51SXRlbSwgZXY6IE1vdXNlRXZlbnQpID0+IHZvaWQ7XG59XG5cbi8vXG5leHBvcnQgaW50ZXJmYWNlIEN0eE1lbnVEZXNjIHtcbiAgICBpdGVtcz86IE1lbnVJdGVtW11bXTtcbiAgICBkZWZhdWx0QWN0aW9uPzogKGluaXRpYXRvcjogSFRNTEVsZW1lbnQsIGl0ZW06IE1lbnVJdGVtLCBldjogTW91c2VFdmVudCkgPT4gdm9pZDtcbiAgICBidWlsZEl0ZW1zPzogKGRldGFpbHM6IHsgZXZlbnQ6IE1vdXNlRXZlbnQ7IGluaXRpYXRvcjogSFRNTEVsZW1lbnQ7IHRyaWdnZXI6IEhUTUxFbGVtZW50OyBtZW51OiBIVE1MRWxlbWVudDsgY3R4TWVudURlc2M6IEN0eE1lbnVEZXNjIH0pID0+IE1lbnVJdGVtW11bXSB8IHZvaWQ7XG4gICAgb25CZWZvcmVPcGVuPzogKGRldGFpbHM6IHsgZXZlbnQ6IE1vdXNlRXZlbnQ7IGluaXRpYXRvcjogSFRNTEVsZW1lbnQ7IHRyaWdnZXI6IEhUTUxFbGVtZW50OyBtZW51OiBIVE1MRWxlbWVudDsgY3R4TWVudURlc2M6IEN0eE1lbnVEZXNjIH0pID0+IGJvb2xlYW4gfCB2b2lkO1xuICAgIGNvbnRleHQ/OiBhbnk7XG4gICAgb3BlbmVkV2l0aD86IHtcbiAgICAgICAgZXZlbnQ6IE1vdXNlRXZlbnQ7XG4gICAgICAgIGluaXRpYXRvcjogSFRNTEVsZW1lbnQ7XG4gICAgICAgIGVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICAgICAgICBjbG9zZTogKCkgPT4gdm9pZDtcbiAgICAgICAgY29udGV4dD86IGFueTtcbiAgICB9IHwgbnVsbDtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBpdGVtQ2xpY2tIYW5kbGUgPSAoZXY6IE1vdXNlRXZlbnQsIGN0eE1lbnVEZXNjOiBDdHhNZW51RGVzYykgPT4ge1xuICAgIGNvbnN0IGlkID0gUShgW2RhdGEtaWRdYCwgZXY/LnRhcmdldCBhcyBIVE1MRWxlbWVudCwgMCwgXCJwYXJlbnRcIik/LmdldEF0dHJpYnV0ZT8uKFwiZGF0YS1pZFwiKTtcbiAgICBjb25zdCBpdGVtOiBNZW51SXRlbSB8IHVuZGVmaW5lZCA9IGN0eE1lbnVEZXNjPy5pdGVtc1xuICAgICAgICA/LmZpbmQ/LigoST86IE1lbnVJdGVtW10pID0+IEk/LnNvbWU/LigoSTogTWVudUl0ZW0pID0+IEk/LmlkID09IGlkKSlcbiAgICAgICAgPy5maW5kPy4oKEk6IE1lbnVJdGVtKSA9PiBJPy5pZCA9PSBpZCk7XG5cbiAgICAoaXRlbT8uYWN0aW9uID8/IGN0eE1lbnVEZXNjPy5kZWZhdWx0QWN0aW9uKT8uKFxuICAgICAgICBjdHhNZW51RGVzYz8ub3BlbmVkV2l0aD8uaW5pdGlhdG9yIGFzIEhUTUxFbGVtZW50LFxuICAgICAgICBpdGVtIGFzIE1lbnVJdGVtLFxuICAgICAgICBjdHhNZW51RGVzYz8ub3BlbmVkV2l0aD8uZXZlbnQgPz8gZXZcbiAgICApO1xuXG4gICAgY3R4TWVudURlc2M/Lm9wZW5lZFdpdGg/LmNsb3NlPy4oKTtcblxuICAgIGNvbnN0IHZyID0gZ2V0Qm91bmRWaXNpYmxlUmVmKGN0eE1lbnVEZXNjPy5vcGVuZWRXaXRoPy5lbGVtZW50IGFzIEhUTUxFbGVtZW50KTtcbiAgICBpZiAodnIgIT0gbnVsbCkgdnIudmFsdWUgPSBmYWxzZTtcbn07XG5cbmNvbnN0IHZpc2libGVNYXAgPSBuZXcgV2Vha01hcDxIVE1MRWxlbWVudCwgUmVmQm9vbCB8IG51bGw+KCk7XG5cbi8vIFByb3hpZWQgdHJpZ2dlciBoYW5kbGluZzogZ3VhcmFudGVlcyBPTkUgcmVhbCBgY29udGV4dG1lbnVgIGxpc3RlbmVyIG9uIGRvY3VtZW50RWxlbWVudC5cbi8vIHByZXZlbnREZWZhdWx0L3N0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiBPTkxZIHdoZW4gdGhlIGhhbmRsZXIgcmV0dXJucyB0cnV0aHkgKFwiaGFuZGxlZFwiKS5cbmNvbnN0IHJlZ2lzdGVyQ3R4TWVudSA9IHR5cGVvZiBkb2N1bWVudCAhPT0gXCJ1bmRlZmluZWRcIiAmJiBkb2N1bWVudD8uZG9jdW1lbnRFbGVtZW50XG4gICAgPyBhZGRQcm94aWVkRXZlbnQ8TW91c2VFdmVudD4oXG4gICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCxcbiAgICAgICAgXCJjb250ZXh0bWVudVwiLFxuICAgICAgICB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IGZhbHNlIH0sXG4gICAgICAgIHsgc3RyYXRlZ3k6IFwiY2xvc2VzdFwiLCBwcmV2ZW50RGVmYXVsdDogXCJoYW5kbGVkXCIsIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogXCJoYW5kbGVkXCIgfVxuICAgIClcbiAgICA6IChfZWw6IGFueSwgX2hhbmRsZXI6IGFueSkgPT4gKCkgPT4geyB9O1xuXG5jb25zdCBnZXRCb3VuZFZpc2libGVSZWYgPSAobWVudUVsZW1lbnQ6IEhUTUxFbGVtZW50KTogUmVmQm9vbCB8IG51bGwgPT4ge1xuICAgIGlmIChtZW51RWxlbWVudCA9PSBudWxsKSByZXR1cm4gbnVsbDsgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiB2aXNpYmxlTWFwPy5nZXRPckluc2VydENvbXB1dGVkPy4obWVudUVsZW1lbnQsICgpID0+IHZpc2libGVSZWYobWVudUVsZW1lbnQsIGZhbHNlKSkgYXMgUmVmQm9vbDtcbn07XG5cbmV4cG9ydCBjb25zdCBiaW5kTWVudUl0ZW1DbGlja0hhbmRsZXIgPSAobWVudUVsZW1lbnQ6IEhUTUxFbGVtZW50LCBtZW51RGVzYzogQ3R4TWVudURlc2MpID0+IHtcbiAgICBjb25zdCBoYW5kbGVyID0gKGV2OiBNb3VzZUV2ZW50KSA9PiB7IGl0ZW1DbGlja0hhbmRsZShldiwgbWVudURlc2MpOyB9O1xuICAgIGNvbnN0IGxpc3RlbmluZyA9IGFkZEV2ZW50KG1lbnVFbGVtZW50LCBcImNsaWNrXCIsIGhhbmRsZXIsIHsgY29tcG9zZWQ6IHRydWUgfSk7XG4gICAgcmV0dXJuICgpID0+IGxpc3RlbmluZz8uKCk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0R2xvYmFsQ29udGV4dE1lbnUgPSAocGFyZW50OiBIVE1MRWxlbWVudCB8IERvY3VtZW50ID0gZG9jdW1lbnQpID0+IHtcbiAgICBsZXQgbWVudSA9IFEoJ3VpLW1vZGFsW3R5cGU9XCJjb250ZXh0bWVudVwiXScsIHBhcmVudCBhcyBIVE1MRWxlbWVudCk7XG4gICAgaWYgKCFtZW51KSB7XG4gICAgICAgIG1lbnUgPSBIYDx1aS1tb2RhbCB0eXBlPVwiY29udGV4dG1lbnVcIj48L3VpLW1vZGFsPmA7XG4gICAgICAgIChwYXJlbnQgaW5zdGFuY2VvZiBEb2N1bWVudCA/IHBhcmVudC5ib2R5IDogcGFyZW50KS5hcHBlbmQobWVudSk7XG4gICAgfVxuICAgIHJldHVybiBtZW51IGFzIEhUTUxFbGVtZW50O1xufTtcblxuZXhwb3J0IGNvbnN0IG1ha2VNZW51SGFuZGxlciA9IChcbiAgICB0cmlnZ2VyRWxlbWVudDogSFRNTEVsZW1lbnQsXG4gICAgcGxhY2VtZW50OiBhbnksXG4gICAgY3R4TWVudURlc2M6IEN0eE1lbnVEZXNjLFxuICAgIG1lbnVFbGVtZW50PzogSFRNTEVsZW1lbnRcbikgPT4ge1xuICAgIHJldHVybiAoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgbGV0IGhhbmRsZWQgPSBmYWxzZTtcblxuICAgICAgICBjb25zdCBtZW51ID0gbWVudUVsZW1lbnQgfHwgZ2V0R2xvYmFsQ29udGV4dE1lbnUoKTtcbiAgICAgICAgY29uc3QgdmlzaWJsZVJlZiA9IGdldEJvdW5kVmlzaWJsZVJlZihtZW51KTtcblxuICAgICAgICBjb25zdCBpbml0aWF0b3IgPSAoZXY/LnRhcmdldCBhcyBIVE1MRWxlbWVudCB8IG51bGwpID8/IHRyaWdnZXJFbGVtZW50ID8/IChkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KGV2Py5jbGllbnRYIHx8IDAsIGV2Py5jbGllbnRZIHx8IDApIGFzIEhUTUxFbGVtZW50KTtcbiAgICAgICAgY29uc3QgZGV0YWlscyA9IHsgZXZlbnQ6IGV2LCBpbml0aWF0b3I6IGluaXRpYXRvciBhcyBIVE1MRWxlbWVudCwgdHJpZ2dlcjogdHJpZ2dlckVsZW1lbnQsIG1lbnU6IG1lbnUsIGN0eE1lbnVEZXNjIH07XG4gICAgICAgIGN0eE1lbnVEZXNjLmNvbnRleHQgPSBkZXRhaWxzO1xuXG4gICAgICAgIGlmIChjdHhNZW51RGVzYz8ub25CZWZvcmVPcGVuPy4oZGV0YWlscykgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm4gaGFuZGxlZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJ1aWx0SXRlbXMgPSBjdHhNZW51RGVzYz8uYnVpbGRJdGVtcz8uKGRldGFpbHMpO1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShidWlsdEl0ZW1zKSAmJiBidWlsdEl0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgY3R4TWVudURlc2MuaXRlbXMgPSBidWlsdEl0ZW1zO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHZpc2libGVSZWY/LnZhbHVlICYmIGV2Py50eXBlICE9PSBcImNvbnRleHRtZW51XCIpIHtcbiAgICAgICAgICAgIHZpc2libGVSZWYudmFsdWUgPSBmYWxzZTtcbiAgICAgICAgICAgIGN0eE1lbnVEZXNjPy5vcGVuZWRXaXRoPy5jbG9zZT8uKCk7XG4gICAgICAgICAgICByZXR1cm4gaGFuZGxlZDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbml0aWF0b3IgJiYgdmlzaWJsZVJlZikge1xuICAgICAgICAgICAgaGFuZGxlZCA9IHRydWU7XG5cbiAgICAgICAgICAgIC8vIFRPRE86IHVzZSByZWFjdGl2ZSBtYXBwZWQgY3R4LW1lbnUgZWxlbWVudFxuICAgICAgICAgICAgbWVudS5pbm5lckhUTUwgPSBcIlwiO1xuICAgICAgICAgICAgdmlzaWJsZVJlZi52YWx1ZSA9IHRydWU7XG5cbiAgICAgICAgICAgIG1lbnU/LmFwcGVuZD8uKFxuICAgICAgICAgICAgICAgIC4uLihjdHhNZW51RGVzYz8uaXRlbXNcbiAgICAgICAgICAgICAgICAgICAgPy5tYXA/Ligoc2VjdGlvbiwgc0lkeCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBzZWN0aW9uPy5tYXA/LigoaXRlbSkgPT5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBIYDxsaSBkYXRhLWlkPSR7aXRlbT8uaWQgfHwgXCJcIn0+PHVpLWljb24gaWNvbj0ke2l0ZW0/Lmljb24gfHwgXCJcIn0+PC91aS1pY29uPjxzcGFuPiR7aXRlbT8ubGFiZWwgfHwgXCJcIn08L3NwYW4+PC9saT5gXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VwYXJhdG9yID0gKHNlY3Rpb24/Lmxlbmd0aCA+IDEgJiYgc0lkeCAhPT0gKChjdHhNZW51RGVzYz8uaXRlbXM/Lmxlbmd0aCB8fCAwKSAtIDEpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gSGA8bGkgY2xhc3M9XCJjdHgtbWVudS1zZXBhcmF0b3JcIj48L2xpPmBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWy4uLml0ZW1zLCBzZXBhcmF0b3JdO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICA/LmZsYXQ/LigpXG4gICAgICAgICAgICAgICAgICAgID8uZmlsdGVyPy4oKEUpID0+ICEhRSkgfHwgW10pXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBjb25zdCB3aGVyZSA9IHdpdGhJbnNldFdpdGhQb2ludGVyPy4obWVudSwgcGxhY2VtZW50Py4oZXYsIGluaXRpYXRvcikpO1xuICAgICAgICAgICAgY29uc3QgdW5iaW5kQ2xpY2sgPSBiaW5kTWVudUl0ZW1DbGlja0hhbmRsZXIobWVudSwgY3R4TWVudURlc2MpO1xuXG4gICAgICAgICAgICAvLyBDbG9zZSB3aGVuIGludGVyYWN0aW5nIG91dHNpZGUgdGhlIG1lbnUuXG4gICAgICAgICAgICBjb25zdCB1bnRyaWdnZXIgPSBtYWtlSW50ZXJydXB0VHJpZ2dlcj8uKFxuICAgICAgICAgICAgICAgIG1lbnUsXG4gICAgICAgICAgICAgICAgKGU6IE1vdXNlRXZlbnQpID0+IHsgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBtZW51QW55ID0gbWVudSBhcyBhbnk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghKG1lbnU/LmNvbnRhaW5zPy4oKGU/LnRhcmdldCA/PyBudWxsKSBhcyBhbnkpIHx8IGU/LnRhcmdldCA9PSAobWVudUFueT8uZWxlbWVudCA/PyBtZW51QW55KSkgfHwgIWU/LnRhcmdldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3R4TWVudURlc2M/Lm9wZW5lZFdpdGg/LmNsb3NlPy4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZyID0gZ2V0Qm91bmRWaXNpYmxlUmVmKG1lbnUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZyICE9IG51bGwpIHZyLnZhbHVlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIFtcImNsaWNrXCIsIFwicG9pbnRlcmRvd25cIiwgXCJzY3JvbGxcIl1cbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIC8vIFdoaWxlIG9wZW46IHN1cHByZXNzIG5hdGl2ZSBjb250ZXh0IG1lbnUgb24gdGhlIG1lbnUgZWxlbWVudCBpdHNlbGYuXG4gICAgICAgICAgICBjb25zdCB1bm1lbnVDdHggPSByZWdpc3RlckN0eE1lbnUobWVudSwgKCkgPT4gdHJ1ZSk7XG5cbiAgICAgICAgICAgIGN0eE1lbnVEZXNjLm9wZW5lZFdpdGggPSB7XG4gICAgICAgICAgICAgICAgaW5pdGlhdG9yOiBpbml0aWF0b3IgYXMgSFRNTEVsZW1lbnQsXG4gICAgICAgICAgICAgICAgZWxlbWVudDogbWVudSxcbiAgICAgICAgICAgICAgICBldmVudDogZXYsXG4gICAgICAgICAgICAgICAgY29udGV4dDogY3R4TWVudURlc2M/LmNvbnRleHQsXG4gICAgICAgICAgICAgICAgY2xvc2UoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpc2libGVSZWYudmFsdWUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgY3R4TWVudURlc2Mub3BlbmVkV2l0aCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHVuYmluZENsaWNrPy4oKTtcbiAgICAgICAgICAgICAgICAgICAgd2hlcmU/LigpO1xuICAgICAgICAgICAgICAgICAgICB1bnRyaWdnZXI/LigpO1xuICAgICAgICAgICAgICAgICAgICB1bm1lbnVDdHg/LigpO1xuICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdHhNZW51RGVzYy5fYmFja1VucmVnKSB7IGN0eE1lbnVEZXNjLl9iYWNrVW5yZWcoKTsgY3R4TWVudURlc2MuX2JhY2tVbnJlZyA9IG51bGw7IH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy8gUmVnaXN0ZXIgd2l0aCBiYWNrIG5hdmlnYXRpb25cbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIGlmICghY3R4TWVudURlc2MuX2JhY2tVbnJlZyAmJiB2aXNpYmxlUmVmKSB7XG4gICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgIGN0eE1lbnVEZXNjLl9iYWNrVW5yZWcgPSByZWdpc3RlckNvbnRleHRNZW51KG1lbnUsIHZpc2libGVSZWYsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY3R4TWVudURlc2M/Lm9wZW5lZFdpdGg/LmNsb3NlPy4oKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBoYW5kbGVkO1xuICAgIH07XG59O1xuXG4vLyB1c2UgY3Vyc29yIGFzIGFuY2hvciBiYXNlZCBvbiBjb250ZXh0bWVudVxuZXhwb3J0IGNvbnN0IGN0eE1lbnVUcmlnZ2VyID0gKHRyaWdnZXJFbGVtZW50OiBIVE1MRWxlbWVudCwgY3R4TWVudURlc2M6IEN0eE1lbnVEZXNjLCBtZW51RWxlbWVudD86IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgY29uc3QgZXZIYW5kbGVyID0gbWFrZU1lbnVIYW5kbGVyKHRyaWdnZXJFbGVtZW50LCAoZXYpID0+IFtldj8uY2xpZW50WCwgZXY/LmNsaWVudFksIDIwMF0sIGN0eE1lbnVEZXNjLCBtZW51RWxlbWVudCk7XG5cbiAgICAvLyBBY3RpdmF0ZSB0cmlnZ2VyICsgZ2xvYmFsIGxpc3RlbmVyIG9ubHkgd2hlbiB0cmlnZ2VyIGVsZW1lbnQgaXMgYWN0dWFsbHkgY29ubmVjdGVkLlxuICAgIGNvbnN0IHVuYmluZENvbm5lY3RlZCA9IGJpbmRXaGlsZUNvbm5lY3RlZCh0cmlnZ2VyRWxlbWVudCwgKCkgPT4ge1xuICAgICAgICByZXR1cm4gcmVnaXN0ZXJDdHhNZW51KHRyaWdnZXJFbGVtZW50LCBldkhhbmRsZXIgYXMgYW55KTtcbiAgICB9KTtcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIHVuYmluZENvbm5lY3RlZD8uKCk7XG4gICAgfTtcbn07XG5cbi8vIGJpdCBzYW1lIGFzIGNvbnRleHRtZW51LCBidXQgZGlmZmVyZW50IGJ5IGFuY2hvciBhbmQgdHJpZ2dlciAoZnJvbSBlbGVtZW50IGRyb3AtZG93bilcbmV4cG9ydCBjb25zdCBkcm9wTWVudVRyaWdnZXIgPSAodHJpZ2dlckVsZW1lbnQ6IEhUTUxFbGVtZW50LCBjdHhNZW51RGVzYzogQ3R4TWVudURlc2MsIG1lbnVFbGVtZW50PzogSFRNTEVsZW1lbnQpID0+IHtcbiAgICBjb25zdCBtZW51ID0gbWVudUVsZW1lbnQgfHwgUSgndWktbW9kYWxbdHlwZT1cIm1lbnVsaXN0XCJdJywgZG9jdW1lbnQuYm9keSkgfHwgZ2V0R2xvYmFsQ29udGV4dE1lbnUoKTtcblxuICAgIGNvbnN0IGFuY2hvckVsZW1lbnQgPSB0cmlnZ2VyRWxlbWVudDsgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IGV2SGFuZGxlciA9IG1ha2VNZW51SGFuZGxlcih0cmlnZ2VyRWxlbWVudCwgKGV2KSA9PiBib3VuZGluZ0JveEFuY2hvclJlZihhbmNob3JFbGVtZW50KT8uc2xpY2U/LigwLCAzKSwgY3R4TWVudURlc2MsIG1lbnUpO1xuICAgIGNvbnN0IHVudHJpZ2dlciA9IG1ha2VJbnRlcnJ1cHRUcmlnZ2VyPy4oXG4gICAgICAgIG1lbnUsXG4gICAgICAgIChldjogTW91c2VFdmVudCkgPT4geyAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBpZiAoIShtZW51Py5jb250YWlucz8uKGV2Py50YXJnZXQpIHx8IGV2Py50YXJnZXQgPT0gKHRyaWdnZXJFbGVtZW50Py5lbGVtZW50ID8/IHRyaWdnZXJFbGVtZW50KSkgfHwgIWV2Py50YXJnZXQpIHtcbiAgICAgICAgICAgICAgICBjdHhNZW51RGVzYz8ub3BlbmVkV2l0aD8uY2xvc2U/LigpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZyID0gZ2V0Qm91bmRWaXNpYmxlUmVmKG1lbnUpO1xuICAgICAgICAgICAgICAgIGlmICh2ciAhPSBudWxsKSB2ci52YWx1ZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBbXCJjbGlja1wiLCBcInBvaW50ZXJkb3duXCIsIFwic2Nyb2xsXCJdXG4gICAgKTtcblxuICAgIGNvbnN0IGxpc3RlbmluZyA9IGFkZEV2ZW50KHRyaWdnZXJFbGVtZW50LCBcImNsaWNrXCIsIGV2SGFuZGxlciwgeyBjb21wb3NlZDogdHJ1ZSB9KTtcbiAgICByZXR1cm4gKCkgPT4geyB1bnRyaWdnZXI/LigpOyBsaXN0ZW5pbmc/LigpOyB9O1xufTtcbiJdfQ==
import { addEvent, setChecked, handleStyleChange } from "fest/dom";
import { computed, conditional, numberRef } from "fest/object";
import { bindDraggable } from "../controllers/PointerAPI";
//
import { makeShiftTrigger } from "../controllers/Trigger";
import { bindWith, bindCtrl } from "../../lure/core/Binding";
// Enhanced reactive math and CSS integration
import { operated, CSSBinder } from "fest/lure";
import { ReactiveElementSize } from "../css-ref/Utils";
import { ReactiveTransform } from "../css-ref/Utils";
//
/* ***************************************************************************************** *
 * Here few version of value and coordinates                                                 *
 * #. [type]  : [components]:        , [relative_version], # commetary                       *
 * 1. value   : [value, min, max]    , value_shift       , # used for value                  *
 * 2. pointer : [x, y]               , pointer_shift     , # used from events                *
 * 3. inp_box : [offset, width, zoom],                   , # used for pointer                *
 * 4. clamped : [from 0 to 1]        ,                   , # used for styles, in conversions *
 * 5. dragging: [dx, dy]             ,                   , # relative from current offset    *
 * ***************************************************************************************** */
// Enhanced reactive utilities with CSS integration
export const boolDepIconRef = (cnd) => conditional(cnd, "badge-check", "badge");
export const indicationRef = (ref) => computed(ref, (v) => (parseFloat(v) || 0)?.toLocaleString?.('en-US', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 1
}));
// Reactive input position calculation with CSS integration
export const reactiveInputPosition = (input, container) => {
    const elementSize = container ? new ReactiveElementSize(container) : null;
    const value = clampedValueRef(input);
    return operated([value, elementSize?.width || numberRef(100)], () => {
        const containerWidth = elementSize?.width.value || 100;
        const percentage = value.value;
        return percentage * containerWidth;
    });
};
// Reactive input handle transform with CSS matrix support
export const reactiveInputHandleTransform = (input, container) => {
    const position = reactiveInputPosition(input, container);
    const transform = new ReactiveTransform();
    // Create reactive translate transform
    return operated([position], () => `translateX(${position.value}px)`);
};
// currently, unused
export const convertValueToPointer = (input) => {
    const $cmp = getInputValues(input);
    const [value, min, max] = $cmp;
    if (input?.type == "number" || input?.type == "range") {
        return (value - min) / (max - min);
    }
    else if (input?.type == "checkbox") {
        return value ? 1 : 0;
    }
    else if (input?.type == "radio") {
        const all = [...input?.parentNode?.querySelectorAll?.('input[type="radio"]')], len = all?.length, nth = all.indexOf(input);
        return nth / (len - 1);
    }
    return value;
};
// "relative"
export const convertPointerToValueShift = (input, shift, container) => {
    // relative pointer coordinate info [0, 1]
    const dec = (shift?.[0]?.value || 0) / (container?.offsetWidth || 1);
    const $cmp = getInputValues(input), [_, min, max] = $cmp;
    // compute value shift
    if (input?.type == "checkbox") {
        return Math.sign(shift?.[0]?.value);
    }
    else if (input?.type == "range" || input?.type == "number") {
        return dec * (max - min);
    }
    else if (input?.type == "radio") {
        return Math.round(dec * max);
    }
    return dec;
};
// get correct value for input types
export const correctValue = (input, val) => {
    if (input?.type == "number" || input?.type == "range") {
        return val;
    }
    else if (input?.type == "checkbox") {
        return val > 0.5 ? true : false;
    }
    else if (input?.type == "radio") {
        const all = [...input?.parentNode?.querySelectorAll?.('input[type="radio"]')], len = all?.length;
        return Math.max(Math.min(Math.round(val), len), 0);
    }
};
// "absolute"
export const convertPointerToValue = (input, relateFromCorner, container) => {
    const clamped = relateFromCorner / (container?.offsetWidth || 1); // [0, 1]);
    const $cmp = getInputValues(input), [_, min, max] = $cmp;
    const val = clamped * (max - min) + min;
    return correctValue(input, val);
};
//
export const getValueWithShift = (input, valueShift) => {
    const $cmp = getInputValues(input);
    return correctValue(input, $cmp?.[0] + valueShift);
};
//
export const setInputValue = (input, value) => {
    const $cmp = getInputValues(input), [_, min, max] = $cmp;
    if (input?.type == "number" || input?.type == "range") {
        if (value != input.valueAsNumber) {
            input.valueAsNumber = value;
            input?.dispatchEvent?.(new Event("change", { bubbles: true }));
        }
    }
    else if (input?.type == "checkbox") {
        setChecked(input, value > 0.5 ? true : false);
    }
    else if (input?.type == "radio") {
        const all = [...input?.parentNode?.querySelectorAll?.('input[type="radio"]')];
        if (value != 0) {
            setChecked(all[Math.max(Math.min(Math.round(value), max), min)], value);
        }
    }
};
// combined getValueWithShift with setValue
export const setValueByShift = (input, valueShift) => {
    return setInputValue(input, getValueWithShift(input, valueShift));
};
//
export const setValueByPointer = (input, pointer, container) => {
    return setInputValue(input, convertPointerToValue(input, pointer, container));
};
// TODO: support animation
export const resolveDragging = (input, dragging, container) => {
    // in case of input is HTMLInputElement
    setValueByShift(input, convertPointerToValueShift(input, dragging, container));
    // reset dragging coordinate
    try {
        dragging[0].value = 0, dragging[1].value = 0;
    }
    catch (e) { }
    ;
    return [0, 0];
};
//
export const getInputValues = (inp) => {
    if ((inp?.type == "number" || inp?.type == "range") && inp?.valueAsNumber != null) {
        return [(inp?.valueAsNumber || 0), parseFloat(inp?.min || 0), parseFloat(inp?.max || 0)];
    }
    else if (inp?.type == "checkbox") {
        return [inp?.checked ? 1 : 0, 0, 1];
    }
    else if (inp?.type == "radio") {
        const all = [...inp?.parentNode?.querySelectorAll?.('input[type="radio"]')];
        const len = all?.length, nth = all?.indexOf?.(inp) ?? -1;
        return [nth, 0, len - 1];
    }
    return [0, 0, 0];
};
//
export const progress = (value, min, max) => {
    return (value - min) / (max - min);
};
// get into [0, 1]
export const getClampedValue = (inp) => {
    return progress(...getInputValues(inp));
};
// reference of [0, 1]
export const clampedValueRef = (inp) => {
    const rf = numberRef(getClampedValue(inp));
    const ctr = (ev) => { rf.value = getClampedValue(ev?.target ?? inp); };
    bindCtrl?.(inp, ctr);
    return rf;
};
//
export const dragSlider = (thumb, handler, input) => {
    const usedPointer = { id: -1 };
    const correctOffset = () => { try {
        dragging[0].value = 0, dragging[1].value = 0;
    }
    catch (e) { } ; return [0, 0]; };
    const customTrigger = (doGrab) => {
        const $handler = makeShiftTrigger((ev) => {
            thumb?.setPointerCapture?.(usedPointer.id = ev?.pointerId);
            thumb?.setAttribute?.("data-dragging", "true");
            correctOffset();
            doGrab?.(ev, thumb);
        }, thumb);
        const ub = addEvent(handler, "pointerdown", $handler);
        const ubt = addEvent(thumb, "pointerdown", $handler);
        listening.push(ub, ubt);
        return ub;
    };
    //
    const listening = [
        addEvent(handler, "click", (ev) => {
            if (input?.type == "checkbox" || input?.type == "radio") {
                setChecked(input, input?.checked, ev);
            }
        }),
        addEvent(handler, "pointerdown", (ev) => {
            if (!(ev?.target?.matches?.(".ui-thumb") || ev?.target?.closest?.(".ui-thumb"))) {
                if (ev?.target == (handler?.element ?? handler) || handler.contains(ev?.target)) {
                    //correctOffset();
                    setValueByPointer(input, (ev?.layerX || 0), handler);
                }
            }
        })
    ];
    //
    const dragging = [numberRef(0), numberRef(0)];
    // Enhanced reactive binding with CSS transform matrices
    const dragTransform = operated([dragging[0]], () => `translateX(${dragging[0].value}px)`);
    const valuePosition = reactiveInputPosition(input, handler);
    // Bind reactive transforms and values
    CSSBinder.bindTransform(thumb, dragTransform);
    CSSBinder.bindTransform(handler, dragTransform);
    // Enhanced reactive value calculations
    const relativeValue = operated([dragging[0]], (dx) => convertPointerToValueShift(input, dragging, handler));
    const clampedValue = clampedValueRef(input);
    bindWith?.(handler, "--relate", relativeValue, handleStyleChange);
    bindWith?.(handler, "--value", clampedValue, handleStyleChange);
    const obj = bindDraggable(customTrigger, (dragging) => {
        thumb?.removeAttribute?.("data-dragging");
        if (usedPointer.id >= 0) {
            thumb?.releasePointerCapture?.(usedPointer.id);
            usedPointer.id = -1;
        }
        resolveDragging(input, dragging, handler);
    }, dragging, correctOffset);
    //addToCallChain(obj, Symbol.dispose, ()=>listening.forEach(ub=>ub?.()));
    return () => {
        listening.forEach(ub => ub?.());
        obj?.dispose?.();
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW5wdXRFeHQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJJbnB1dEV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNuRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQVksTUFBTSxhQUFhLENBQUM7QUFDekUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRTFELEVBQUU7QUFDRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTdELDZDQUE2QztBQUM3QyxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNoRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUVyRCxFQUFFO0FBQ0Y7Ozs7Ozs7OytGQVErRjtBQUUvRixtREFBbUQ7QUFDbkQsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQUMsR0FBRyxFQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUUvRSxNQUFNLENBQUMsTUFBTSxhQUFhLEdBQUcsQ0FBQyxHQUFHLEVBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUMsRUFBRSxDQUFBLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLGNBQWMsRUFBRSxDQUFDLE9BQU8sRUFBRTtJQUNwRyxxQkFBcUIsRUFBRSxDQUFDO0lBQ3hCLHFCQUFxQixFQUFFLENBQUM7Q0FDM0IsQ0FBQyxD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QUFpQixDQUFDLENBQUM7SUFDbEUsUUFBUSxFQUFFLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztJQUNoRSxNQUFNLEdBQUcsR0FBRyxhQUFhLENBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxFQUFDLEVBQUU7UUFDakQsS0FBSyxFQUFFLGVBQWUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQzFDLElBQUksV0FBVyxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQ25CLENBQUM7WUFBQyxLQUFLLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLENBQUM7WUFBQyxXQUFXLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQUMsQ0FBQztRQUM1RSxlQUFlLENBQUMsS0FBSyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUM5QyxDQUFDLEVBQUUsUUFBUSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQzVCLHlFQUF5RTtJQUN6RSxPQUFPLEdBQUUsRUFBRTtRQUNQLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFBLEVBQUUsQ0FBQSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDOUIsR0FBRyxFQUFFLE9BQU8sRUFBRSxFQUFFLENBQUM7SUFDckIsQ0FBQyxDQUFDO0FBQ04sQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWRkRXZlbnQsIHNldENoZWNrZWQsIGhhbmRsZVN0eWxlQ2hhbmdlIH0gZnJvbSBcImZlc3QvZG9tXCI7XG5pbXBvcnQgeyBjb21wdXRlZCwgY29uZGl0aW9uYWwsIG51bWJlclJlZiwgYWZmZWN0ZWQgfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7IGJpbmREcmFnZ2FibGUgfSBmcm9tIFwiLi4vY29udHJvbGxlcnMvUG9pbnRlckFQSVwiO1xuXG4vL1xuaW1wb3J0IHsgbWFrZVNoaWZ0VHJpZ2dlciB9IGZyb20gXCIuLi9jb250cm9sbGVycy9UcmlnZ2VyXCI7XG5pbXBvcnQgeyBiaW5kV2l0aCwgYmluZEN0cmwgfSBmcm9tIFwiLi4vLi4vbHVyZS9jb3JlL0JpbmRpbmdcIjtcblxuLy8gRW5oYW5jZWQgcmVhY3RpdmUgbWF0aCBhbmQgQ1NTIGludGVncmF0aW9uXG5pbXBvcnQgeyBvcGVyYXRlZCwgQ1NTQmluZGVyIH0gZnJvbSBcImZlc3QvbHVyZVwiO1xuaW1wb3J0IHsgUmVhY3RpdmVFbGVtZW50U2l6ZSB9IGZyb20gXCIuLi9jc3MtcmVmL1V0aWxzXCI7XG5pbXBvcnQgeyBSZWFjdGl2ZVRyYW5zZm9ybSB9IGZyb20gXCIuLi9jc3MtcmVmL1V0aWxzXCI7XG5cbi8vXG4vKiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiAqXG4gKiBIZXJlIGZldyB2ZXJzaW9uIG9mIHZhbHVlIGFuZCBjb29yZGluYXRlcyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAqXG4gKiAjLiBbdHlwZV0gIDogW2NvbXBvbmVudHNdOiAgICAgICAgLCBbcmVsYXRpdmVfdmVyc2lvbl0sICMgY29tbWV0YXJ5ICAgICAgICAgICAgICAgICAgICAgICAqXG4gKiAxLiB2YWx1ZSAgIDogW3ZhbHVlLCBtaW4sIG1heF0gICAgLCB2YWx1ZV9zaGlmdCAgICAgICAsICMgdXNlZCBmb3IgdmFsdWUgICAgICAgICAgICAgICAgICAqXG4gKiAyLiBwb2ludGVyIDogW3gsIHldICAgICAgICAgICAgICAgLCBwb2ludGVyX3NoaWZ0ICAgICAsICMgdXNlZCBmcm9tIGV2ZW50cyAgICAgICAgICAgICAgICAqXG4gKiAzLiBpbnBfYm94IDogW29mZnNldCwgd2lkdGgsIHpvb21dLCAgICAgICAgICAgICAgICAgICAsICMgdXNlZCBmb3IgcG9pbnRlciAgICAgICAgICAgICAgICAqXG4gKiA0LiBjbGFtcGVkIDogW2Zyb20gMCB0byAxXSAgICAgICAgLCAgICAgICAgICAgICAgICAgICAsICMgdXNlZCBmb3Igc3R5bGVzLCBpbiBjb252ZXJzaW9ucyAqXG4gKiA1LiBkcmFnZ2luZzogW2R4LCBkeV0gICAgICAgICAgICAgLCAgICAgICAgICAgICAgICAgICAsICMgcmVsYXRpdmUgZnJvbSBjdXJyZW50IG9mZnNldCAgICAqXG4gKiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiAqL1xuXG4vLyBFbmhhbmNlZCByZWFjdGl2ZSB1dGlsaXRpZXMgd2l0aCBDU1MgaW50ZWdyYXRpb25cbmV4cG9ydCBjb25zdCBib29sRGVwSWNvblJlZiA9IChjbmQpPT4gY29uZGl0aW9uYWwoY25kLCBcImJhZGdlLWNoZWNrXCIsIFwiYmFkZ2VcIik7XG5cbmV4cG9ydCBjb25zdCBpbmRpY2F0aW9uUmVmID0gKHJlZik9PiBjb21wdXRlZChyZWYsICh2KT0+KHBhcnNlRmxvYXQodikgfHwgMCk/LnRvTG9jYWxlU3RyaW5nPy4oJ2VuLVVTJywge1xuICAgIG1pbmltdW1GcmFjdGlvbkRpZ2l0czogMCxcbiAgICBtYXhpbXVtRnJhY3Rpb25EaWdpdHM6IDFcbn0pKTtcblxuLy8gUmVhY3RpdmUgaW5wdXQgcG9zaXRpb24gY2FsY3VsYXRpb24gd2l0aCBDU1MgaW50ZWdyYXRpb25cbmV4cG9ydCBjb25zdCByZWFjdGl2ZUlucHV0UG9zaXRpb24gPSAoaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQsIGNvbnRhaW5lcj86IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgY29uc3QgZWxlbWVudFNpemUgPSBjb250YWluZXIgPyBuZXcgUmVhY3RpdmVFbGVtZW50U2l6ZShjb250YWluZXIpIDogbnVsbDtcbiAgICBjb25zdCB2YWx1ZSA9IGNsYW1wZWRWYWx1ZVJlZihpbnB1dCk7XG5cbiAgICByZXR1cm4gb3BlcmF0ZWQoW3ZhbHVlLCBlbGVtZW50U2l6ZT8ud2lkdGggfHwgbnVtYmVyUmVmKDEwMCldLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbnRhaW5lcldpZHRoID0gZWxlbWVudFNpemU/LndpZHRoLnZhbHVlIHx8IDEwMDtcbiAgICAgICAgY29uc3QgcGVyY2VudGFnZSA9IHZhbHVlLnZhbHVlO1xuICAgICAgICByZXR1cm4gcGVyY2VudGFnZSAqIGNvbnRhaW5lcldpZHRoO1xuICAgIH0pO1xufTtcblxuLy8gUmVhY3RpdmUgaW5wdXQgaGFuZGxlIHRyYW5zZm9ybSB3aXRoIENTUyBtYXRyaXggc3VwcG9ydFxuZXhwb3J0IGNvbnN0IHJlYWN0aXZlSW5wdXRIYW5kbGVUcmFuc2Zvcm0gPSAoaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQsIGNvbnRhaW5lcj86IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgY29uc3QgcG9zaXRpb24gPSByZWFjdGl2ZUlucHV0UG9zaXRpb24oaW5wdXQsIGNvbnRhaW5lcik7XG4gICAgY29uc3QgdHJhbnNmb3JtID0gbmV3IFJlYWN0aXZlVHJhbnNmb3JtKCk7XG5cbiAgICAvLyBDcmVhdGUgcmVhY3RpdmUgdHJhbnNsYXRlIHRyYW5zZm9ybVxuICAgIHJldHVybiBvcGVyYXRlZChbcG9zaXRpb25dLCAoKSA9PiBgdHJhbnNsYXRlWCgke3Bvc2l0aW9uLnZhbHVlfXB4KWApO1xufTtcblxuLy8gY3VycmVudGx5LCB1bnVzZWRcbmV4cG9ydCBjb25zdCBjb252ZXJ0VmFsdWVUb1BvaW50ZXIgPSAoaW5wdXQpPT57XG4gICAgY29uc3QgJGNtcCA9IGdldElucHV0VmFsdWVzKGlucHV0KTtcbiAgICBjb25zdCBbdmFsdWUsIG1pbiwgbWF4XSA9ICRjbXA7XG4gICAgaWYgKGlucHV0Py50eXBlID09IFwibnVtYmVyXCIgfHwgaW5wdXQ/LnR5cGUgPT0gXCJyYW5nZVwiKSB7XG4gICAgICAgIHJldHVybiAodmFsdWUgLSBtaW4pIC8gKG1heCAtIG1pbik7XG4gICAgfSBlbHNlXG4gICAgaWYgKGlucHV0Py50eXBlID09IFwiY2hlY2tib3hcIikge1xuICAgICAgICByZXR1cm4gdmFsdWUgPyAxIDogMDtcbiAgICB9IGVsc2VcbiAgICBpZiAoaW5wdXQ/LnR5cGUgPT0gXCJyYWRpb1wiKSB7XG4gICAgICAgIGNvbnN0IGFsbCA9IFsuLi5pbnB1dD8ucGFyZW50Tm9kZT8ucXVlcnlTZWxlY3RvckFsbD8uKCdpbnB1dFt0eXBlPVwicmFkaW9cIl0nKV0sIGxlbiA9IGFsbD8ubGVuZ3RoLCBudGggPSBhbGwuaW5kZXhPZihpbnB1dCk7XG4gICAgICAgIHJldHVybiBudGggLyAobGVuIC0gMSk7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbn1cblxuLy8gXCJyZWxhdGl2ZVwiXG5leHBvcnQgY29uc3QgY29udmVydFBvaW50ZXJUb1ZhbHVlU2hpZnQgPSAoaW5wdXQsIHNoaWZ0LCBjb250YWluZXIpPT57XG4gICAgLy8gcmVsYXRpdmUgcG9pbnRlciBjb29yZGluYXRlIGluZm8gWzAsIDFdXG4gICAgY29uc3QgZGVjID0gKHNoaWZ0Py5bMF0/LnZhbHVlIHx8IDApIC8gKGNvbnRhaW5lcj8ub2Zmc2V0V2lkdGggfHwgMSk7XG4gICAgY29uc3QgJGNtcCA9IGdldElucHV0VmFsdWVzKGlucHV0KSwgW18sIG1pbiwgbWF4XSA9ICRjbXA7XG5cbiAgICAvLyBjb21wdXRlIHZhbHVlIHNoaWZ0XG4gICAgaWYgKGlucHV0Py50eXBlID09IFwiY2hlY2tib3hcIikgeyByZXR1cm4gTWF0aC5zaWduKHNoaWZ0Py5bMF0/LnZhbHVlKTsgfSBlbHNlXG4gICAgaWYgKGlucHV0Py50eXBlID09IFwicmFuZ2VcIiB8fCBpbnB1dD8udHlwZSA9PSBcIm51bWJlclwiKSB7IHJldHVybiBkZWMgKiAobWF4IC0gbWluKTsgfSBlbHNlXG4gICAgaWYgKGlucHV0Py50eXBlID09IFwicmFkaW9cIikgeyByZXR1cm4gTWF0aC5yb3VuZChkZWMgKiBtYXgpOyB9XG4gICAgcmV0dXJuIGRlYztcbn1cblxuLy8gZ2V0IGNvcnJlY3QgdmFsdWUgZm9yIGlucHV0IHR5cGVzXG5leHBvcnQgY29uc3QgY29ycmVjdFZhbHVlID0gKGlucHV0LCB2YWwpPT57XG4gICAgaWYgKGlucHV0Py50eXBlID09IFwibnVtYmVyXCIgfHwgaW5wdXQ/LnR5cGUgPT0gXCJyYW5nZVwiKVxuICAgICAgICB7IHJldHVybiB2YWw7IH0gZWxzZVxuICAgIGlmIChpbnB1dD8udHlwZSA9PSBcImNoZWNrYm94XCIpXG4gICAgICAgIHsgcmV0dXJuIHZhbCA+IDAuNSA/IHRydWUgOiBmYWxzZTtcbiAgICB9IGVsc2VcbiAgICBpZiAoaW5wdXQ/LnR5cGUgPT0gXCJyYWRpb1wiKSB7XG4gICAgICAgIGNvbnN0IGFsbCA9IFsuLi5pbnB1dD8ucGFyZW50Tm9kZT8ucXVlcnlTZWxlY3RvckFsbD8uKCdpbnB1dFt0eXBlPVwicmFkaW9cIl0nKV0sIGxlbiA9IGFsbD8ubGVuZ3RoO1xuICAgICAgICByZXR1cm4gTWF0aC5tYXgoTWF0aC5taW4oTWF0aC5yb3VuZCh2YWwpLCBsZW4pLCAwKTtcbiAgICB9XG59XG5cbi8vIFwiYWJzb2x1dGVcIlxuZXhwb3J0IGNvbnN0IGNvbnZlcnRQb2ludGVyVG9WYWx1ZSA9IChpbnB1dCwgcmVsYXRlRnJvbUNvcm5lciwgY29udGFpbmVyKT0+e1xuICAgIGNvbnN0IGNsYW1wZWQgPSByZWxhdGVGcm9tQ29ybmVyIC8gKGNvbnRhaW5lcj8ub2Zmc2V0V2lkdGggfHwgMSk7IC8vIFswLCAxXSk7XG4gICAgY29uc3QgJGNtcCA9IGdldElucHV0VmFsdWVzKGlucHV0KSwgW18sIG1pbiwgbWF4XSA9ICRjbXA7XG4gICAgY29uc3QgdmFsID0gY2xhbXBlZCAqIChtYXggLSBtaW4pICsgbWluO1xuICAgIHJldHVybiBjb3JyZWN0VmFsdWUoaW5wdXQsIHZhbCk7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgZ2V0VmFsdWVXaXRoU2hpZnQgPSAoaW5wdXQsIHZhbHVlU2hpZnQpPT57XG4gICAgY29uc3QgJGNtcCA9IGdldElucHV0VmFsdWVzKGlucHV0KTtcbiAgICByZXR1cm4gY29ycmVjdFZhbHVlKGlucHV0LCAkY21wPy5bMF0gKyB2YWx1ZVNoaWZ0KTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBzZXRJbnB1dFZhbHVlID0gKGlucHV0LCB2YWx1ZSk9PntcbiAgICBjb25zdCAkY21wID0gZ2V0SW5wdXRWYWx1ZXMoaW5wdXQpLCBbXywgbWluLCBtYXhdID0gJGNtcDtcbiAgICBpZiAoaW5wdXQ/LnR5cGUgPT0gXCJudW1iZXJcIiB8fCBpbnB1dD8udHlwZSA9PSBcInJhbmdlXCIpXG4gICAgICAgIHsgaWYgKHZhbHVlICE9IGlucHV0LnZhbHVlQXNOdW1iZXIpIHsgaW5wdXQudmFsdWVBc051bWJlciA9IHZhbHVlOyBpbnB1dD8uZGlzcGF0Y2hFdmVudD8uKG5ldyBFdmVudChcImNoYW5nZVwiLCB7IGJ1YmJsZXM6IHRydWUgfSkpOyB9IH0gZWxzZVxuICAgIGlmIChpbnB1dD8udHlwZSA9PSBcImNoZWNrYm94XCIpXG4gICAgICAgIHsgc2V0Q2hlY2tlZChpbnB1dCwgdmFsdWUgPiAwLjUgPyB0cnVlIDogZmFsc2UpOyB9IGVsc2VcbiAgICBpZiAoaW5wdXQ/LnR5cGUgPT0gXCJyYWRpb1wiKSB7XG4gICAgICAgIGNvbnN0IGFsbCA9IFsuLi5pbnB1dD8ucGFyZW50Tm9kZT8ucXVlcnlTZWxlY3RvckFsbD8uKCdpbnB1dFt0eXBlPVwicmFkaW9cIl0nKV07XG4gICAgICAgIGlmICh2YWx1ZSAhPSAwKSB7IHNldENoZWNrZWQoYWxsW01hdGgubWF4KE1hdGgubWluKE1hdGgucm91bmQodmFsdWUpLCBtYXgpLCBtaW4pXSwgdmFsdWUpOyB9XG4gICAgfVxufVxuXG5cblxuLy8gY29tYmluZWQgZ2V0VmFsdWVXaXRoU2hpZnQgd2l0aCBzZXRWYWx1ZVxuZXhwb3J0IGNvbnN0IHNldFZhbHVlQnlTaGlmdCA9IChpbnB1dCwgdmFsdWVTaGlmdCkgPT4ge1xuICAgIHJldHVybiBzZXRJbnB1dFZhbHVlKGlucHV0LCBnZXRWYWx1ZVdpdGhTaGlmdChpbnB1dCwgdmFsdWVTaGlmdCkpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHNldFZhbHVlQnlQb2ludGVyID0gKGlucHV0LCBwb2ludGVyLCBjb250YWluZXIpPT57XG4gICAgcmV0dXJuIHNldElucHV0VmFsdWUoaW5wdXQsIGNvbnZlcnRQb2ludGVyVG9WYWx1ZShpbnB1dCwgcG9pbnRlciwgY29udGFpbmVyKSk7XG59XG5cblxuXG4vLyBUT0RPOiBzdXBwb3J0IGFuaW1hdGlvblxuZXhwb3J0IGNvbnN0IHJlc29sdmVEcmFnZ2luZyA9IChpbnB1dCwgZHJhZ2dpbmcsIGNvbnRhaW5lcikgPT4ge1xuICAgIC8vIGluIGNhc2Ugb2YgaW5wdXQgaXMgSFRNTElucHV0RWxlbWVudFxuICAgIHNldFZhbHVlQnlTaGlmdChpbnB1dCwgY29udmVydFBvaW50ZXJUb1ZhbHVlU2hpZnQoaW5wdXQsIGRyYWdnaW5nLCBjb250YWluZXIpKTtcblxuXG4gICAgLy8gcmVzZXQgZHJhZ2dpbmcgY29vcmRpbmF0ZVxuICAgIHRyeSB7IGRyYWdnaW5nWzBdLnZhbHVlID0gMCwgZHJhZ2dpbmdbMV0udmFsdWUgPSAwOyB9IGNhdGNoKGUpIHt9O1xuICAgIHJldHVybiBbMCwgMF07XG59O1xuXG4vL1xuZXhwb3J0IGNvbnN0IGdldElucHV0VmFsdWVzID0gKGlucCk6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSA9PntcbiAgICBpZiAoKGlucD8udHlwZSA9PSBcIm51bWJlclwiIHx8IGlucD8udHlwZSA9PSBcInJhbmdlXCIpICYmIGlucD8udmFsdWVBc051bWJlciAhPSBudWxsKSB7IHJldHVybiBbKGlucD8udmFsdWVBc051bWJlciB8fCAwKSwgcGFyc2VGbG9hdChpbnA/Lm1pbiB8fCAwKSwgcGFyc2VGbG9hdChpbnA/Lm1heCB8fCAwKV07IH0gZWxzZVxuICAgIGlmIChpbnA/LnR5cGUgPT0gXCJjaGVja2JveFwiKSB7IHJldHVybiBbaW5wPy5jaGVja2VkID8gMSA6IDAsIDAsIDFdOyB9IGVsc2VcbiAgICBpZiAoaW5wPy50eXBlID09IFwicmFkaW9cIikge1xuICAgICAgICBjb25zdCBhbGwgPSBbLi4uaW5wPy5wYXJlbnROb2RlPy5xdWVyeVNlbGVjdG9yQWxsPy4oJ2lucHV0W3R5cGU9XCJyYWRpb1wiXScpXTtcbiAgICAgICAgY29uc3QgbGVuID0gYWxsPy5sZW5ndGgsIG50aCA9IGFsbD8uaW5kZXhPZj8uKGlucCkgPz8gLTE7XG4gICAgICAgIHJldHVybiBbbnRoLCAwLCBsZW4tMV07XG4gICAgfVxuICAgIHJldHVybiBbMCwgMCwgMF07XG59XG5cbi8vXG5leHBvcnQgY29uc3QgcHJvZ3Jlc3MgPSAodmFsdWUsIG1pbiwgbWF4KT0+e1xuICAgIHJldHVybiAodmFsdWUgLSBtaW4pIC8gKG1heCAtIG1pbik7XG59XG5cbi8vIGdldCBpbnRvIFswLCAxXVxuZXhwb3J0IGNvbnN0IGdldENsYW1wZWRWYWx1ZSA9IChpbnApPT57XG4gICAgcmV0dXJuIHByb2dyZXNzKC4uLmdldElucHV0VmFsdWVzKGlucCkpO1xufVxuXG4vLyByZWZlcmVuY2Ugb2YgWzAsIDFdXG5leHBvcnQgY29uc3QgY2xhbXBlZFZhbHVlUmVmID0gKGlucCk9PntcbiAgICBjb25zdCByZiA9IG51bWJlclJlZihnZXRDbGFtcGVkVmFsdWUoaW5wKSk7XG4gICAgY29uc3QgY3RyID0gKGV2KT0+eyByZi52YWx1ZSA9IGdldENsYW1wZWRWYWx1ZShldj8udGFyZ2V0ID8/IGlucCk7IH07XG4gICAgYmluZEN0cmw/LihpbnAsIGN0cik7IHJldHVybiByZjtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBkcmFnU2xpZGVyID0gKHRodW1iLCBoYW5kbGVyLCBpbnB1dCk9PnsgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IHVzZWRQb2ludGVyID0geyBpZDogLTEgfTtcbiAgICBjb25zdCBjb3JyZWN0T2Zmc2V0ID0gKCk9PnsgdHJ5IHsgZHJhZ2dpbmdbMF0udmFsdWUgPSAwLCBkcmFnZ2luZ1sxXS52YWx1ZSA9IDA7IH0gY2F0Y2goZSkge307IHJldHVybiBbMCwgMF07IH07XG4gICAgY29uc3QgY3VzdG9tVHJpZ2dlciA9IChkb0dyYWIpPT57XG4gICAgICAgIGNvbnN0ICRoYW5kbGVyID0gbWFrZVNoaWZ0VHJpZ2dlcigoZXYpPT57XG4gICAgICAgICAgICB0aHVtYj8uc2V0UG9pbnRlckNhcHR1cmU/Lih1c2VkUG9pbnRlci5pZCA9IGV2Py5wb2ludGVySWQpO1xuICAgICAgICAgICAgdGh1bWI/LnNldEF0dHJpYnV0ZT8uKFwiZGF0YS1kcmFnZ2luZ1wiLCBcInRydWVcIik7XG4gICAgICAgICAgICBjb3JyZWN0T2Zmc2V0KCk7IGRvR3JhYj8uKGV2LCB0aHVtYik7XG4gICAgICAgIH0sIHRodW1iKTtcblxuICAgICAgICBjb25zdCB1YiA9IGFkZEV2ZW50KGhhbmRsZXIsIFwicG9pbnRlcmRvd25cIiwgJGhhbmRsZXIpO1xuICAgICAgICBjb25zdCB1YnQgPSBhZGRFdmVudCh0aHVtYiwgXCJwb2ludGVyZG93blwiLCAkaGFuZGxlcik7XG4gICAgICAgIGxpc3RlbmluZy5wdXNoKHViLCB1YnQpO1xuICAgICAgICByZXR1cm4gdWI7XG4gICAgfTtcblxuICAgIC8vXG4gICAgY29uc3QgbGlzdGVuaW5nID0gW1xuICAgICAgICBhZGRFdmVudChoYW5kbGVyLCBcImNsaWNrXCIsIChldik9PntcbiAgICAgICAgICAgIGlmIChpbnB1dD8udHlwZSA9PSBcImNoZWNrYm94XCIgfHwgaW5wdXQ/LnR5cGUgPT0gXCJyYWRpb1wiKSB7IHNldENoZWNrZWQoaW5wdXQsIGlucHV0Py5jaGVja2VkLCBldik7IH1cbiAgICAgICAgfSksXG4gICAgICAgIGFkZEV2ZW50KGhhbmRsZXIsIFwicG9pbnRlcmRvd25cIiwgKGV2KT0+e1xuICAgICAgICAgICAgaWYgKCEoZXY/LnRhcmdldD8ubWF0Y2hlcz8uKFwiLnVpLXRodW1iXCIpIHx8IGV2Py50YXJnZXQ/LmNsb3Nlc3Q/LihcIi51aS10aHVtYlwiKSkpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXY/LnRhcmdldCA9PSAoaGFuZGxlcj8uZWxlbWVudCA/PyBoYW5kbGVyKSB8fCBoYW5kbGVyLmNvbnRhaW5zKGV2Py50YXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vY29ycmVjdE9mZnNldCgpO1xuICAgICAgICAgICAgICAgICAgICBzZXRWYWx1ZUJ5UG9pbnRlcihpbnB1dCwgKGV2Py5sYXllclggfHwgMCksIGhhbmRsZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICBdO1xuXG4gICAgLy9cbiAgICBjb25zdCBkcmFnZ2luZyA9IFsgbnVtYmVyUmVmKDApLCBudW1iZXJSZWYoMCkgXTtcblxuICAgIC8vIEVuaGFuY2VkIHJlYWN0aXZlIGJpbmRpbmcgd2l0aCBDU1MgdHJhbnNmb3JtIG1hdHJpY2VzXG4gICAgY29uc3QgZHJhZ1RyYW5zZm9ybSA9IG9wZXJhdGVkKFtkcmFnZ2luZ1swXV0sICgpID0+IGB0cmFuc2xhdGVYKCR7ZHJhZ2dpbmdbMF0udmFsdWV9cHgpYCk7XG4gICAgY29uc3QgdmFsdWVQb3NpdGlvbiA9IHJlYWN0aXZlSW5wdXRQb3NpdGlvbihpbnB1dCwgaGFuZGxlcik7XG5cbiAgICAvLyBCaW5kIHJlYWN0aXZlIHRyYW5zZm9ybXMgYW5kIHZhbHVlc1xuICAgIENTU0JpbmRlci5iaW5kVHJhbnNmb3JtKHRodW1iLCBkcmFnVHJhbnNmb3JtKTtcbiAgICBDU1NCaW5kZXIuYmluZFRyYW5zZm9ybShoYW5kbGVyLCBkcmFnVHJhbnNmb3JtKTtcblxuICAgIC8vIEVuaGFuY2VkIHJlYWN0aXZlIHZhbHVlIGNhbGN1bGF0aW9uc1xuICAgIGNvbnN0IHJlbGF0aXZlVmFsdWUgPSBvcGVyYXRlZChbZHJhZ2dpbmdbMF1dLCAoZHgpID0+XG4gICAgICAgIGNvbnZlcnRQb2ludGVyVG9WYWx1ZVNoaWZ0KGlucHV0LCBkcmFnZ2luZywgaGFuZGxlcilcbiAgICApO1xuICAgIGNvbnN0IGNsYW1wZWRWYWx1ZSA9IGNsYW1wZWRWYWx1ZVJlZihpbnB1dCk7XG5cbiAgICBiaW5kV2l0aD8uKGhhbmRsZXIsIFwiLS1yZWxhdGVcIiwgcmVsYXRpdmVWYWx1ZSwgaGFuZGxlU3R5bGVDaGFuZ2UpO1xuICAgIGJpbmRXaXRoPy4oaGFuZGxlciwgXCItLXZhbHVlXCIsIGNsYW1wZWRWYWx1ZSwgaGFuZGxlU3R5bGVDaGFuZ2UpO1xuICAgIGNvbnN0IG9iaiA9IGJpbmREcmFnZ2FibGUoY3VzdG9tVHJpZ2dlciwgKGRyYWdnaW5nKT0+e1xuICAgICAgICB0aHVtYj8ucmVtb3ZlQXR0cmlidXRlPy4oXCJkYXRhLWRyYWdnaW5nXCIpO1xuICAgICAgICBpZiAodXNlZFBvaW50ZXIuaWQgPj0gMClcbiAgICAgICAgICAgIHsgdGh1bWI/LnJlbGVhc2VQb2ludGVyQ2FwdHVyZT8uKHVzZWRQb2ludGVyLmlkKTsgdXNlZFBvaW50ZXIuaWQgPSAtMTsgfVxuICAgICAgICByZXNvbHZlRHJhZ2dpbmcoaW5wdXQsIGRyYWdnaW5nLCBoYW5kbGVyKTtcbiAgICB9LCBkcmFnZ2luZywgY29ycmVjdE9mZnNldCk7XG4gICAgLy9hZGRUb0NhbGxDaGFpbihvYmosIFN5bWJvbC5kaXNwb3NlLCAoKT0+bGlzdGVuaW5nLmZvckVhY2godWI9PnViPy4oKSkpO1xuICAgIHJldHVybiAoKT0+e1xuICAgICAgICBsaXN0ZW5pbmcuZm9yRWFjaCh1Yj0+dWI/LigpKTtcbiAgICAgICAgb2JqPy5kaXNwb3NlPy4oKTtcbiAgICB9O1xufTtcbiJdfQ==
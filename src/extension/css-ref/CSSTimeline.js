import { toRef } from "fest/core";
import { deref, computed, affected, $affected } from "fest/object";
import { getPadding } from "fest/dom";
import { scrollRef, sizeRef } from "fest/lure";
import { makeAnchorElement } from "./CSSAnchor";
//
export const $extract = Symbol.for("__extract");
export const $element = Symbol.for("__element");
//
export const timelineHandler = {
    [Symbol.for("__extract")](target) {
        return target.source;
    },
    get(target, prop, receiver) {
        if (prop in target) {
            return Reflect.get(target, prop, receiver ?? target);
        }
        if (prop == "value") {
            return (target?.currentTime ?? 0) / (target?.duration ?? 1);
        }
        // @ts-ignore
        if (prop == $affected && (target instanceof ScrollTimeline || target instanceof ViewTimeline)) {
            return (cb, prop) => {
                const $cb = () => { queueMicrotask(() => cb((target?.currentTime ?? 0) / (target?.duration ?? 1), "value")); };
                // @ts-ignore
                if (target instanceof ScrollTimeline) {
                    target?.source?.addEventListener?.("scroll", $cb);
                    const $observer = new ResizeObserver((entries) => entries.forEach((entry) => $cb?.()));
                    $observer.observe(target?.source, { box: "content-box" });
                    target?.source?.addEventListener?.("scroll", $cb);
                    return () => { $observer.disconnect(); target?.source?.removeEventListener?.("scroll", $cb); };
                }
                else // @ts-ignore
                 if (target instanceof ViewTimeline) {
                    const $observer = new IntersectionObserver((entries) => entries.forEach((entry) => $cb?.()), target?.observerOptions ?? { root: target?.source?.offsetParent ?? document.documentElement, rootMargin: "0px", threshold: [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0] });
                    $observer.observe(target?.source);
                    target?.source?.addEventListener?.("scroll", $cb);
                    return () => { $observer.disconnect(); target?.source?.removeEventListener?.("scroll", $cb); };
                }
            };
        }
        if (prop == $extract) {
            return target;
        }
        if (prop == $element || prop == "element") {
            return target.source?.element ?? target.source;
        }
        return Reflect.get(target.source, prop, receiver ?? target.source);
    },
    set(target, prop, value, receiver) {
        if (prop in target) {
            Reflect.set(target, prop, value, receiver ?? target);
        }
        else if (target.source) {
            // @ts-ignore
            Reflect.set(target.source, prop, value, receiver ?? target.source);
        }
        return true;
    },
    has(target, prop) {
        return Reflect.has(target, prop) || Reflect.has(target.source, prop);
    },
    deleteProperty(target, prop) {
        if (prop in target) {
            return Reflect.deleteProperty(target, prop);
        }
        else if (target.source) {
            // @ts-ignore
            return Reflect.deleteProperty(target.source, prop);
        }
        return true;
    },
    ownKeys(target) {
        return [...Reflect.ownKeys(target), ...Reflect.ownKeys(target.source)];
    },
    getOwnPropertyDescriptor(target, prop) {
        return { ...Reflect.getOwnPropertyDescriptor(target, prop), ...Reflect.getOwnPropertyDescriptor(target.source, prop) };
    },
    getPrototypeOf(target) {
        return Reflect.getPrototypeOf(target);
    },
    setPrototypeOf(target, proto) {
        return Reflect.setPrototypeOf(target, proto);
    },
    isExtensible(target) {
        return Reflect.isExtensible(target);
    },
    preventExtensions(target) {
        return Reflect.preventExtensions(target);
    }
};
//
export const $makeScrollTimeline = (source, axis) => {
    // @ts-ignore
    return new Proxy(new ScrollTimeline({ source: source?.element ?? source, axis }), timelineHandler);
};
//
export const $makeViewTimeline = (source, axis) => {
    // @ts-ignore
    return new Proxy(new ViewTimeline({ source: source?.element ?? source, axis }), timelineHandler);
};
// Enhanced timeline with anchor positioning and container query support
export class EnhancedScrollTimeline {
    source;
    axis;
    timeline;
    anchor;
    //
    constructor(sourceOrOptions, $options) {
        let options = !(sourceOrOptions instanceof HTMLElement) ? sourceOrOptions : {};
        //
        if (sourceOrOptions instanceof HTMLElement) {
            this.source = sourceOrOptions;
            this.axis = typeof $options == "string" ? $options : "inline";
        }
        else {
            this.source = options?.source;
            this.axis = options?.axis ?? "inline";
            this.anchor = options?.anchorElement;
        }
        // @ts-ignore
        this.timeline = $makeScrollTimeline(this.source, this.axis);
        // Import CSSAnchor dynamically to avoid circular dependencies
        if (!(typeof $options == "string") && $options?.useAnchor && !this.anchor) {
            this.anchor = makeAnchorElement(this.source);
        }
    }
    //
    get [$extract]() {
        return this.timeline?.source ?? this.source;
    }
    //
    get [$affected]() {
        return (cb, prop) => {
            const $cb = () => { queueMicrotask(() => cb((this.timeline?.currentTime ?? 0) / (this.timeline?.duration ?? 1), "value")); };
            this.timeline?.addEventListener?.("scroll", $cb);
            return () => this.timeline?.removeEventListener?.("scroll", $cb);
        };
    }
    //
    get element() {
        const $src = this.timeline?.source ?? this.source;
        return $src?.element ?? $src;
    }
    //
    get value() {
        return this.progress;
    }
    //
    get currentTime() {
        return this.timeline?.currentTime ?? 0;
    }
    //
    get duration() {
        return this.timeline?.duration ?? 1;
    }
    // Get current scroll progress as reactive value (0-1)
    get progress() {
        try {
            const maxScroll = this.source[['scrollWidth', 'scrollHeight'][this.axis === 'inline' ? 0 : 1]] -
                this.source[['clientWidth', 'clientHeight'][this.axis === 'inline' ? 0 : 1]];
            const currentScroll = this.source[['scrollLeft', 'scrollTop'][this.axis === 'inline' ? 0 : 1]];
            return maxScroll > 0 ? currentScroll / maxScroll : 0;
        }
        catch {
            return 0;
        }
    }
    // Scroll to specific progress (0-1)
    scrollTo(progress, smooth = true) {
        const maxScroll = this.source[['scrollWidth', 'scrollHeight'][this.axis === 'inline' ? 0 : 1]] -
            this.source[['clientWidth', 'clientHeight'][this.axis === 'inline' ? 0 : 1]];
        const scrollPos = Math.max(0, Math.min(1, progress)) * maxScroll;
        this.source.scrollTo({
            [['left', 'top'][this.axis === 'inline' ? 0 : 1]]: scrollPos,
            behavior: smooth ? 'smooth' : 'instant'
        });
    }
    // Scroll by relative amount
    scrollBy(delta, smooth = true) {
        this.source.scrollBy({
            [['left', 'top'][this.axis === 'inline' ? 0 : 1]]: delta,
            behavior: smooth ? 'smooth' : 'instant'
        });
    }
    // Get scrollable area info
    getScrollInfo() {
        const axisIdx = this.axis === 'inline' ? 0 : 1;
        return {
            scrollSize: this.source[['scrollWidth', 'scrollHeight'][axisIdx]],
            clientSize: this.source[['clientWidth', 'clientHeight'][axisIdx]],
            scrollPos: this.source[['scrollLeft', 'scrollTop'][axisIdx]],
            maxScroll: this.source[['scrollWidth', 'scrollHeight'][axisIdx]] - this.source[['clientWidth', 'clientHeight'][axisIdx]],
            progress: this.progress
        };
    }
}
// Enhanced ViewTimeline with intersection awareness
export class EnhancedViewTimeline {
    source;
    axis;
    timeline;
    intersectionObserver;
    threshold;
    root;
    rootMargin;
    observerOptions;
    //
    constructor(sourceOrOptions, $options) {
        let options = !(sourceOrOptions instanceof HTMLElement) ? sourceOrOptions : {};
        //
        if (sourceOrOptions instanceof HTMLElement) {
            this.source = sourceOrOptions;
            this.axis = typeof $options == "string" ? $options : "inline";
        }
        else {
            this.source = options?.source;
            this.axis = options?.axis ?? "inline";
            this.threshold = options?.threshold || [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0];
            this.root = options?.root;
            this.rootMargin = options?.rootMargin || '0px';
            this.observerOptions = options ?? {
                root: this.root,
                rootMargin: this.rootMargin,
                threshold: this.threshold
            };
        }
        // @ts-ignore
        this.timeline = $makeViewTimeline(this.source, this.axis);
    }
    //
    get [$extract]() {
        return this.timeline?.source ?? this.source;
    }
    //
    get element() {
        const $src = this.timeline?.source ?? this.source;
        return $src?.element ?? $src;
    }
    //
    get value() {
        return (this.timeline?.currentTime ?? 0) / (this.timeline?.duration ?? 1);
    }
    //
    get currentTime() {
        return this.timeline?.currentTime ?? 0;
    }
    //
    get duration() {
        return this.timeline?.duration ?? 1;
    }
    //
    get [$affected]() {
        return (cb, prop) => {
            const $cb = () => { queueMicrotask(() => cb((this.timeline?.currentTime ?? 0) / (this.timeline?.duration ?? 1), "value")); };
            const $observer = new IntersectionObserver((entries) => entries.forEach((entry) => $cb?.()));
            $observer.observe(this.source);
            return () => $observer.disconnect();
        };
    }
    setupIntersectionObserver() {
        this.intersectionObserver = new IntersectionObserver((entries) => this.handleIntersection(entries));
        this.intersectionObserver.observe(this.source);
    }
    handleIntersection(entries) {
        for (const entry of entries) {
            // Custom intersection handling logic
            const ratio = entry.intersectionRatio;
            const rect = entry.boundingClientRect;
            // Update timeline progress based on intersection
            if (this.axis === 'block') {
                // Vertical intersection
                const progress = rect.top < 0 ?
                    Math.abs(rect.top) / (rect.height + globalThis.innerHeight) :
                    1 - (rect.bottom / (rect.height + globalThis.innerHeight));
                this.updateProgress(Math.max(0, Math.min(1, progress)));
            }
            else {
                // Horizontal intersection
                const progress = rect.left < 0 ?
                    Math.abs(rect.left) / (rect.width + globalThis.innerWidth) :
                    1 - (rect.right / (rect.width + globalThis.innerWidth));
                this.updateProgress(Math.max(0, Math.min(1, progress)));
            }
        }
    }
    updateProgress(progress) {
        // Update timeline progress (implementation depends on browser support)
        if (this.timeline && 'currentTime' in this.timeline) {
            try {
                // @ts-ignore
                this.timeline.currentTime = progress * 100; // CSS progress is 0-100
            }
            catch (e) {
                // Fallback for browsers without currentTime support
                console.warn('Timeline currentTime not supported:', e);
            }
        }
    }
    destroy() {
        this.timeline?.disconnect();
    }
}
//
export const makeScrollTimeline = (source, axis) => {
    // @ts-ignore
    if (typeof ScrollTimeline != "undefined") {
        return new EnhancedScrollTimeline({ source: source?.element ?? source, axis: axis });
    }
    //
    const target = toRef(source);
    const scroll = scrollRef(source, ["inline", "block"][axis]);
    const content = computed(sizeRef(source, ["inline", "block"][axis], "content-box"), (v) => (v + getPadding(source, ["inline", "block"][axis])));
    const percent = computed(scroll, (vl) => ((vl || 0) / ((deref(target)?.[['scrollWidth', 'scrollHeight'][axis]] - content?.value) || 1)));
    affected(content, (vl) => ((scroll?.value || 0) / ((deref(target)?.[['scrollWidth', 'scrollHeight'][axis]] - vl) || 1)));
    return percent;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ1NTVGltZWxpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDU1NUaW1lbGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFnQixNQUFNLFdBQVcsQ0FBQztBQUNoRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ25FLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDdEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDL0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRWhELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNoRCxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUVoRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHO0lBQzNCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE1BQU07UUFDNUIsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ3pCLENBQUM7SUFDRCxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxRQUFRO1FBQ3RCLElBQUksSUFBSSxJQUFJLE1BQU0sRUFBRyxDQUFDO1lBQUMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxJQUFJLE1BQU0sQ0FBQyxDQUFDO1FBQUMsQ0FBQztRQUM5RSxJQUFJLElBQUksSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsV0FBVyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFFBQVEs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QUMxSSxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLEtBQUssSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUgsT0FBTyxPQUFPLENBQUM7QUFDbkIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdG9SZWYsIHR5cGUga2V5VHlwZSB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB7IGRlcmVmLCBjb21wdXRlZCwgYWZmZWN0ZWQsICRhZmZlY3RlZCB9IGZyb20gXCJmZXN0L29iamVjdFwiO1xuaW1wb3J0IHsgZ2V0UGFkZGluZyB9IGZyb20gXCJmZXN0L2RvbVwiO1xuaW1wb3J0IHsgc2Nyb2xsUmVmLCBzaXplUmVmIH0gZnJvbSBcImZlc3QvbHVyZVwiO1xuaW1wb3J0IHsgbWFrZUFuY2hvckVsZW1lbnQgfSBmcm9tIFwiLi9DU1NBbmNob3JcIjtcblxuLy9cbmV4cG9ydCBjb25zdCAkZXh0cmFjdCA9IFN5bWJvbC5mb3IoXCJfX2V4dHJhY3RcIik7XG5leHBvcnQgY29uc3QgJGVsZW1lbnQgPSBTeW1ib2wuZm9yKFwiX19lbGVtZW50XCIpO1xuXG4vL1xuZXhwb3J0IGNvbnN0IHRpbWVsaW5lSGFuZGxlciA9IHtcbiAgICBbU3ltYm9sLmZvcihcIl9fZXh0cmFjdFwiKV0odGFyZ2V0KSB7XG4gICAgICAgIHJldHVybiB0YXJnZXQuc291cmNlO1xuICAgIH0sXG4gICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpIHtcbiAgICAgICAgaWYgKHByb3AgaW4gdGFyZ2V0KSAgeyByZXR1cm4gUmVmbGVjdC5nZXQodGFyZ2V0LCBwcm9wLCByZWNlaXZlciA/PyB0YXJnZXQpOyB9XG4gICAgICAgIGlmIChwcm9wID09IFwidmFsdWVcIikgeyByZXR1cm4gKHRhcmdldD8uY3VycmVudFRpbWUgPz8gMCkgLyAodGFyZ2V0Py5kdXJhdGlvbiA/PyAxKTsgfVxuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgaWYgKHByb3AgPT0gJGFmZmVjdGVkICYmICh0YXJnZXQgaW5zdGFuY2VvZiBTY3JvbGxUaW1lbGluZSB8fCB0YXJnZXQgaW5zdGFuY2VvZiBWaWV3VGltZWxpbmUpKSB7XG4gICAgICAgICAgICByZXR1cm4gKGNiOiAodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSkgPT4gdm9pZCwgcHJvcD86IGtleVR5cGUgfCBudWxsKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgJGNiID0gKCk9PiB7IHF1ZXVlTWljcm90YXNrKCgpPT4gY2IoKHRhcmdldD8uY3VycmVudFRpbWUgPz8gMCkgLyAodGFyZ2V0Py5kdXJhdGlvbiA/PyAxKSwgXCJ2YWx1ZVwiKSk7IH1cblxuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgU2Nyb2xsVGltZWxpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Py5zb3VyY2U/LmFkZEV2ZW50TGlzdGVuZXI/LihcInNjcm9sbFwiLCAkY2IpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCAkb2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoKGVudHJpZXMpPT5lbnRyaWVzLmZvckVhY2goKGVudHJ5KT0+JGNiPy4oKSkpO1xuICAgICAgICAgICAgICAgICAgICAkb2JzZXJ2ZXIub2JzZXJ2ZSh0YXJnZXQ/LnNvdXJjZSwgeyBib3g6IFwiY29udGVudC1ib3hcIiB9KTsgdGFyZ2V0Py5zb3VyY2U/LmFkZEV2ZW50TGlzdGVuZXI/LihcInNjcm9sbFwiLCAkY2IpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCk9PnsgJG9ic2VydmVyLmRpc2Nvbm5lY3QoKTsgdGFyZ2V0Py5zb3VyY2U/LnJlbW92ZUV2ZW50TGlzdGVuZXI/LihcInNjcm9sbFwiLCAkY2IpOyB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0IGluc3RhbmNlb2YgVmlld1RpbWVsaW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0ICRvYnNlcnZlciA9IG5ldyBJbnRlcnNlY3Rpb25PYnNlcnZlcigoZW50cmllcyk9PmVudHJpZXMuZm9yRWFjaCgoZW50cnkpPT4kY2I/LigpKSwgdGFyZ2V0Py5vYnNlcnZlck9wdGlvbnMgPz8geyByb290OiB0YXJnZXQ/LnNvdXJjZT8ub2Zmc2V0UGFyZW50ID8/IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCwgcm9vdE1hcmdpbjogXCIwcHhcIiwgdGhyZXNob2xkOiBbMCwgMC4xLCAwLjIsIDAuMywgMC40LCAwLjUsIDAuNiwgMC43LCAwLjgsIDAuOSwgMS4wXSB9KTtcbiAgICAgICAgICAgICAgICAgICAgJG9ic2VydmVyLm9ic2VydmUodGFyZ2V0Py5zb3VyY2UpOyB0YXJnZXQ/LnNvdXJjZT8uYWRkRXZlbnRMaXN0ZW5lcj8uKFwic2Nyb2xsXCIsICRjYik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAoKT0+eyAkb2JzZXJ2ZXIuZGlzY29ubmVjdCgpOyB0YXJnZXQ/LnNvdXJjZT8ucmVtb3ZlRXZlbnRMaXN0ZW5lcj8uKFwic2Nyb2xsXCIsICRjYik7IH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByb3AgPT0gJGV4dHJhY3QpIHsgcmV0dXJuIHRhcmdldDsgfVxuICAgICAgICBpZiAocHJvcCA9PSAkZWxlbWVudCB8fCBwcm9wID09IFwiZWxlbWVudFwiKSB7IHJldHVybiB0YXJnZXQuc291cmNlPy5lbGVtZW50ID8/IHRhcmdldC5zb3VyY2U7IH1cbiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldC5zb3VyY2UsIHByb3AsIHJlY2VpdmVyID8/IHRhcmdldC5zb3VyY2UpO1xuICAgIH0sXG4gICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUsIHJlY2VpdmVyKSB7XG4gICAgICAgIGlmIChwcm9wIGluIHRhcmdldCkge1xuICAgICAgICAgICAgUmVmbGVjdC5zZXQodGFyZ2V0LCBwcm9wLCB2YWx1ZSwgcmVjZWl2ZXIgPz8gdGFyZ2V0KTtcbiAgICAgICAgfSBlbHNlXG4gICAgICAgIGlmICh0YXJnZXQuc291cmNlKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBSZWZsZWN0LnNldCh0YXJnZXQuc291cmNlLCBwcm9wLCB2YWx1ZSwgcmVjZWl2ZXIgPz8gdGFyZ2V0LnNvdXJjZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSxcbiAgICBoYXModGFyZ2V0LCBwcm9wKSB7XG4gICAgICAgIHJldHVybiBSZWZsZWN0Lmhhcyh0YXJnZXQsIHByb3ApIHx8IFJlZmxlY3QuaGFzKHRhcmdldC5zb3VyY2UsIHByb3ApO1xuICAgIH0sXG4gICAgZGVsZXRlUHJvcGVydHkodGFyZ2V0LCBwcm9wKSB7XG4gICAgICAgIGlmIChwcm9wIGluIHRhcmdldCkge1xuICAgICAgICAgICAgcmV0dXJuIFJlZmxlY3QuZGVsZXRlUHJvcGVydHkodGFyZ2V0LCBwcm9wKTtcbiAgICAgICAgfSBlbHNlXG4gICAgICAgIGlmICh0YXJnZXQuc291cmNlKSB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICByZXR1cm4gUmVmbGVjdC5kZWxldGVQcm9wZXJ0eSh0YXJnZXQuc291cmNlLCBwcm9wKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9LFxuICAgIG93bktleXModGFyZ2V0KSB7XG4gICAgICAgIHJldHVybiBbLi4uUmVmbGVjdC5vd25LZXlzKHRhcmdldCksIC4uLlJlZmxlY3Qub3duS2V5cyh0YXJnZXQuc291cmNlKV07XG4gICAgfSxcbiAgICBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBwcm9wKSB7XG4gICAgICAgIHJldHVybiB7IC4uLlJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldCwgcHJvcCksIC4uLlJlZmxlY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHRhcmdldC5zb3VyY2UsIHByb3ApIH07XG4gICAgfSxcbiAgICBnZXRQcm90b3R5cGVPZih0YXJnZXQpIHtcbiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YodGFyZ2V0KTtcbiAgICB9LFxuICAgIHNldFByb3RvdHlwZU9mKHRhcmdldCwgcHJvdG8pIHtcbiAgICAgICAgcmV0dXJuIFJlZmxlY3Quc2V0UHJvdG90eXBlT2YodGFyZ2V0LCBwcm90byk7XG4gICAgfSxcbiAgICBpc0V4dGVuc2libGUodGFyZ2V0KSB7XG4gICAgICAgIHJldHVybiBSZWZsZWN0LmlzRXh0ZW5zaWJsZSh0YXJnZXQpO1xuICAgIH0sXG4gICAgcHJldmVudEV4dGVuc2lvbnModGFyZ2V0KSB7XG4gICAgICAgIHJldHVybiBSZWZsZWN0LnByZXZlbnRFeHRlbnNpb25zKHRhcmdldCk7XG4gICAgfVxufVxuXG4vL1xuZXhwb3J0IGNvbnN0ICRtYWtlU2Nyb2xsVGltZWxpbmUgPSAoc291cmNlOiBIVE1MRWxlbWVudCAmIHtlbGVtZW50PzogSFRNTEVsZW1lbnR9LCBheGlzOiBcImlubGluZVwiIHwgXCJibG9ja1wiKSA9PiB7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiBuZXcgUHJveHkobmV3IFNjcm9sbFRpbWVsaW5lKHsgc291cmNlOiBzb3VyY2U/LmVsZW1lbnQgPz8gc291cmNlLCBheGlzIH0pLCB0aW1lbGluZUhhbmRsZXIpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0ICRtYWtlVmlld1RpbWVsaW5lID0gKHNvdXJjZTogSFRNTEVsZW1lbnQgJiB7ZWxlbWVudD86IEhUTUxFbGVtZW50fSwgYXhpczogXCJpbmxpbmVcIiB8IFwiYmxvY2tcIikgPT4ge1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gbmV3IFByb3h5KG5ldyBWaWV3VGltZWxpbmUoeyBzb3VyY2U6IHNvdXJjZT8uZWxlbWVudCA/PyBzb3VyY2UsIGF4aXMgfSksIHRpbWVsaW5lSGFuZGxlcik7XG59O1xuXG4vLyBFbmhhbmNlZCB0aW1lbGluZSB3aXRoIGFuY2hvciBwb3NpdGlvbmluZyBhbmQgY29udGFpbmVyIHF1ZXJ5IHN1cHBvcnRcbmV4cG9ydCBjbGFzcyBFbmhhbmNlZFNjcm9sbFRpbWVsaW5lIHtcbiAgICBzb3VyY2U6IEhUTUxFbGVtZW50ICYge2VsZW1lbnQ/OiBIVE1MRWxlbWVudH07XG4gICAgYXhpczogXCJpbmxpbmVcIiB8IFwiYmxvY2tcIjtcbiAgICB0aW1lbGluZTogYW55O1xuICAgIGFuY2hvcj86IGFueTtcblxuICAgIC8vXG4gICAgY29uc3RydWN0b3Ioc291cmNlT3JPcHRpb25zOiBIVE1MRWxlbWVudCAmIHtlbGVtZW50PzogSFRNTEVsZW1lbnR9IHwgeyBzb3VyY2U6IEhUTUxFbGVtZW50ICYge2VsZW1lbnQ/OiBIVE1MRWxlbWVudH0sIGF4aXM6IFwiaW5saW5lXCIgfCBcImJsb2NrXCIgfSwgJG9wdGlvbnM/OiB7XG4gICAgICAgIHVzZUFuY2hvcj86IGJvb2xlYW47XG4gICAgICAgIGFuY2hvckVsZW1lbnQ/OiBIVE1MRWxlbWVudDtcbiAgICB9IHwgKFwiaW5saW5lXCIgfCBcImJsb2NrXCIpKSB7XG4gICAgICAgIGxldCBvcHRpb25zOiBhbnkgPSAhKHNvdXJjZU9yT3B0aW9ucyBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSA/IHNvdXJjZU9yT3B0aW9ucyA6IHt9O1xuXG4gICAgICAgIC8vXG4gICAgICAgIGlmIChzb3VyY2VPck9wdGlvbnMgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBzb3VyY2VPck9wdGlvbnM7XG4gICAgICAgICAgICB0aGlzLmF4aXMgPSB0eXBlb2YgJG9wdGlvbnMgPT0gXCJzdHJpbmdcIiA/ICRvcHRpb25zIGFzIFwiaW5saW5lXCIgfCBcImJsb2NrXCIgOiBcImlubGluZVwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBvcHRpb25zPy5zb3VyY2U7XG4gICAgICAgICAgICB0aGlzLmF4aXMgPSBvcHRpb25zPy5heGlzID8/IFwiaW5saW5lXCI7XG4gICAgICAgICAgICB0aGlzLmFuY2hvciA9IG9wdGlvbnM/LmFuY2hvckVsZW1lbnQ7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRoaXMudGltZWxpbmUgPSAkbWFrZVNjcm9sbFRpbWVsaW5lKHRoaXMuc291cmNlLCB0aGlzLmF4aXMpO1xuXG4gICAgICAgIC8vIEltcG9ydCBDU1NBbmNob3IgZHluYW1pY2FsbHkgdG8gYXZvaWQgY2lyY3VsYXIgZGVwZW5kZW5jaWVzXG4gICAgICAgIGlmICghKHR5cGVvZiAkb3B0aW9ucyA9PSBcInN0cmluZ1wiKSAmJiAkb3B0aW9ucz8udXNlQW5jaG9yICYmICF0aGlzLmFuY2hvcikge1xuICAgICAgICAgICAgdGhpcy5hbmNob3IgPSBtYWtlQW5jaG9yRWxlbWVudCh0aGlzLnNvdXJjZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBbJGV4dHJhY3RdKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50aW1lbGluZT8uc291cmNlID8/IHRoaXMuc291cmNlO1xuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IFskYWZmZWN0ZWRdKCkge1xuICAgICAgICByZXR1cm4gKGNiOiAodmFsdWU6IGFueSwgcHJvcDoga2V5VHlwZSkgPT4gdm9pZCwgcHJvcD86IGtleVR5cGUgfCBudWxsKSA9PiB7XG4gICAgICAgICAgICBjb25zdCAkY2IgPSAoKT0+IHsgcXVldWVNaWNyb3Rhc2soKCk9PiBjYigodGhpcy50aW1lbGluZT8uY3VycmVudFRpbWUgPz8gMCkgLyAodGhpcy50aW1lbGluZT8uZHVyYXRpb24gPz8gMSksIFwidmFsdWVcIikpOyB9XG4gICAgICAgICAgICB0aGlzLnRpbWVsaW5lPy5hZGRFdmVudExpc3RlbmVyPy4oXCJzY3JvbGxcIiwgJGNiKTtcbiAgICAgICAgICAgIHJldHVybiAoKT0+IHRoaXMudGltZWxpbmU/LnJlbW92ZUV2ZW50TGlzdGVuZXI/LihcInNjcm9sbFwiLCAkY2IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXQgZWxlbWVudCgpIHtcbiAgICAgICAgY29uc3QgJHNyYyA9IHRoaXMudGltZWxpbmU/LnNvdXJjZSA/PyB0aGlzLnNvdXJjZTtcbiAgICAgICAgcmV0dXJuICRzcmM/LmVsZW1lbnQgPz8gJHNyYztcbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCB2YWx1ZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvZ3Jlc3M7XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXQgY3VycmVudFRpbWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRpbWVsaW5lPy5jdXJyZW50VGltZSA/PyAwO1xuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IGR1cmF0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50aW1lbGluZT8uZHVyYXRpb24gPz8gMTtcbiAgICB9XG5cbiAgICAvLyBHZXQgY3VycmVudCBzY3JvbGwgcHJvZ3Jlc3MgYXMgcmVhY3RpdmUgdmFsdWUgKDAtMSlcbiAgICBnZXQgcHJvZ3Jlc3MoKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBtYXhTY3JvbGwgPSB0aGlzLnNvdXJjZVtbJ3Njcm9sbFdpZHRoJywgJ3Njcm9sbEhlaWdodCddW3RoaXMuYXhpcyA9PT0gJ2lubGluZScgPyAwIDogMV1dIC1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3VyY2VbWydjbGllbnRXaWR0aCcsICdjbGllbnRIZWlnaHQnXVt0aGlzLmF4aXMgPT09ICdpbmxpbmUnID8gMCA6IDFdXTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRTY3JvbGwgPSB0aGlzLnNvdXJjZVtbJ3Njcm9sbExlZnQnLCAnc2Nyb2xsVG9wJ11bdGhpcy5heGlzID09PSAnaW5saW5lJyA/IDAgOiAxXV07XG4gICAgICAgICAgICByZXR1cm4gbWF4U2Nyb2xsID4gMCA/IGN1cnJlbnRTY3JvbGwgLyBtYXhTY3JvbGwgOiAwO1xuICAgICAgICB9IGNhdGNoIHtcbiAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gU2Nyb2xsIHRvIHNwZWNpZmljIHByb2dyZXNzICgwLTEpXG4gICAgc2Nyb2xsVG8ocHJvZ3Jlc3M6IG51bWJlciwgc21vb3RoID0gdHJ1ZSkge1xuICAgICAgICBjb25zdCBtYXhTY3JvbGwgPSB0aGlzLnNvdXJjZVtbJ3Njcm9sbFdpZHRoJywgJ3Njcm9sbEhlaWdodCddW3RoaXMuYXhpcyA9PT0gJ2lubGluZScgPyAwIDogMV1dIC1cbiAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNvdXJjZVtbJ2NsaWVudFdpZHRoJywgJ2NsaWVudEhlaWdodCddW3RoaXMuYXhpcyA9PT0gJ2lubGluZScgPyAwIDogMV1dO1xuICAgICAgICBjb25zdCBzY3JvbGxQb3MgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBwcm9ncmVzcykpICogbWF4U2Nyb2xsO1xuXG4gICAgICAgIHRoaXMuc291cmNlLnNjcm9sbFRvKHtcbiAgICAgICAgICAgIFtbJ2xlZnQnLCAndG9wJ11bdGhpcy5heGlzID09PSAnaW5saW5lJyA/IDAgOiAxXV06IHNjcm9sbFBvcyxcbiAgICAgICAgICAgIGJlaGF2aW9yOiBzbW9vdGggPyAnc21vb3RoJyA6ICdpbnN0YW50J1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBTY3JvbGwgYnkgcmVsYXRpdmUgYW1vdW50XG4gICAgc2Nyb2xsQnkoZGVsdGE6IG51bWJlciwgc21vb3RoID0gdHJ1ZSkge1xuICAgICAgICB0aGlzLnNvdXJjZS5zY3JvbGxCeSh7XG4gICAgICAgICAgICBbWydsZWZ0JywgJ3RvcCddW3RoaXMuYXhpcyA9PT0gJ2lubGluZScgPyAwIDogMV1dOiBkZWx0YSxcbiAgICAgICAgICAgIGJlaGF2aW9yOiBzbW9vdGggPyAnc21vb3RoJyA6ICdpbnN0YW50J1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBHZXQgc2Nyb2xsYWJsZSBhcmVhIGluZm9cbiAgICBnZXRTY3JvbGxJbmZvKCkge1xuICAgICAgICBjb25zdCBheGlzSWR4ID0gdGhpcy5heGlzID09PSAnaW5saW5lJyA/IDAgOiAxO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc2Nyb2xsU2l6ZTogdGhpcy5zb3VyY2VbWydzY3JvbGxXaWR0aCcsICdzY3JvbGxIZWlnaHQnXVtheGlzSWR4XV0sXG4gICAgICAgICAgICBjbGllbnRTaXplOiB0aGlzLnNvdXJjZVtbJ2NsaWVudFdpZHRoJywgJ2NsaWVudEhlaWdodCddW2F4aXNJZHhdXSxcbiAgICAgICAgICAgIHNjcm9sbFBvczogdGhpcy5zb3VyY2VbWydzY3JvbGxMZWZ0JywgJ3Njcm9sbFRvcCddW2F4aXNJZHhdXSxcbiAgICAgICAgICAgIG1heFNjcm9sbDogdGhpcy5zb3VyY2VbWydzY3JvbGxXaWR0aCcsICdzY3JvbGxIZWlnaHQnXVtheGlzSWR4XV0gLSB0aGlzLnNvdXJjZVtbJ2NsaWVudFdpZHRoJywgJ2NsaWVudEhlaWdodCddW2F4aXNJZHhdXSxcbiAgICAgICAgICAgIHByb2dyZXNzOiB0aGlzLnByb2dyZXNzXG4gICAgICAgIH07XG4gICAgfVxufVxuXG4vLyBFbmhhbmNlZCBWaWV3VGltZWxpbmUgd2l0aCBpbnRlcnNlY3Rpb24gYXdhcmVuZXNzXG5leHBvcnQgY2xhc3MgRW5oYW5jZWRWaWV3VGltZWxpbmUge1xuICAgIHNvdXJjZTogSFRNTEVsZW1lbnQgJiB7ZWxlbWVudD86IEhUTUxFbGVtZW50fTtcbiAgICBheGlzOiBcImlubGluZVwiIHwgXCJibG9ja1wiO1xuICAgIHRpbWVsaW5lOiBhbnk7XG4gICAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI/OiBJbnRlcnNlY3Rpb25PYnNlcnZlcjtcbiAgICB0aHJlc2hvbGQ/OiBudW1iZXJbXTtcbiAgICByb290PzogSFRNTEVsZW1lbnQ7XG4gICAgcm9vdE1hcmdpbj86IHN0cmluZztcbiAgICBvYnNlcnZlck9wdGlvbnM/OiBJbnRlcnNlY3Rpb25PYnNlcnZlckluaXQ7XG5cbiAgICAvL1xuICAgIGNvbnN0cnVjdG9yKHNvdXJjZU9yT3B0aW9uczogSFRNTEVsZW1lbnQgJiB7ZWxlbWVudD86IEhUTUxFbGVtZW50fSB8IHsgc291cmNlOiBIVE1MRWxlbWVudCAmIHtlbGVtZW50PzogSFRNTEVsZW1lbnR9LCBheGlzOiBcImlubGluZVwiIHwgXCJibG9ja1wiIH0sICRvcHRpb25zPzoge1xuICAgICAgICByb290PzogSFRNTEVsZW1lbnQ7XG4gICAgICAgIHJvb3RNYXJnaW4/OiBzdHJpbmc7XG4gICAgICAgIHRocmVzaG9sZD86IG51bWJlcltdO1xuICAgIH0gfCAoXCJpbmxpbmVcIiB8IFwiYmxvY2tcIikpIHtcbiAgICAgICAgbGV0IG9wdGlvbnM6IGFueSA9ICEoc291cmNlT3JPcHRpb25zIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpID8gc291cmNlT3JPcHRpb25zIDoge307XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKHNvdXJjZU9yT3B0aW9ucyBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZU9yT3B0aW9ucyBhcyBIVE1MRWxlbWVudCAmIHtlbGVtZW50PzogSFRNTEVsZW1lbnR9O1xuICAgICAgICAgICAgdGhpcy5heGlzID0gdHlwZW9mICRvcHRpb25zID09IFwic3RyaW5nXCIgPyAkb3B0aW9ucyBhcyBcImlubGluZVwiIHwgXCJibG9ja1wiIDogXCJpbmxpbmVcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc291cmNlID0gb3B0aW9ucz8uc291cmNlIGFzIEhUTUxFbGVtZW50ICYge2VsZW1lbnQ/OiBIVE1MRWxlbWVudH07XG4gICAgICAgICAgICB0aGlzLmF4aXMgPSBvcHRpb25zPy5heGlzID8/IFwiaW5saW5lXCI7XG4gICAgICAgICAgICB0aGlzLnRocmVzaG9sZCA9IG9wdGlvbnM/LnRocmVzaG9sZCB8fCBbMCwgMC4xLCAwLjIsIDAuMywgMC40LCAwLjUsIDAuNiwgMC43LCAwLjgsIDAuOSwgMS4wXTtcbiAgICAgICAgICAgIHRoaXMucm9vdCA9IG9wdGlvbnM/LnJvb3Q7XG4gICAgICAgICAgICB0aGlzLnJvb3RNYXJnaW4gPSBvcHRpb25zPy5yb290TWFyZ2luIHx8ICcwcHgnO1xuICAgICAgICAgICAgdGhpcy5vYnNlcnZlck9wdGlvbnMgPSBvcHRpb25zID8/IHtcbiAgICAgICAgICAgICAgICByb290OiB0aGlzLnJvb3QsXG4gICAgICAgICAgICAgICAgcm9vdE1hcmdpbjogdGhpcy5yb290TWFyZ2luLFxuICAgICAgICAgICAgICAgIHRocmVzaG9sZDogdGhpcy50aHJlc2hvbGRcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRoaXMudGltZWxpbmUgPSAkbWFrZVZpZXdUaW1lbGluZSh0aGlzLnNvdXJjZSwgdGhpcy5heGlzKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBbJGV4dHJhY3RdKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50aW1lbGluZT8uc291cmNlID8/IHRoaXMuc291cmNlO1xuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IGVsZW1lbnQoKSB7XG4gICAgICAgIGNvbnN0ICRzcmMgPSB0aGlzLnRpbWVsaW5lPy5zb3VyY2UgPz8gdGhpcy5zb3VyY2U7XG4gICAgICAgIHJldHVybiAkc3JjPy5lbGVtZW50ID8/ICRzcmM7XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXQgdmFsdWUoKSB7XG4gICAgICAgIHJldHVybiAodGhpcy50aW1lbGluZT8uY3VycmVudFRpbWUgPz8gMCkgLyAodGhpcy50aW1lbGluZT8uZHVyYXRpb24gPz8gMSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXQgY3VycmVudFRpbWUoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRpbWVsaW5lPy5jdXJyZW50VGltZSA/PyAwO1xuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IGR1cmF0aW9uKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50aW1lbGluZT8uZHVyYXRpb24gPz8gMTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBbJGFmZmVjdGVkXSgpIHtcbiAgICAgICAgcmV0dXJuIChjYjogKHZhbHVlOiBhbnksIHByb3A6IGtleVR5cGUpID0+IHZvaWQsIHByb3A/OiBrZXlUeXBlIHwgbnVsbCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgJGNiID0gKCk9PiB7IHF1ZXVlTWljcm90YXNrKCgpPT4gY2IoKHRoaXMudGltZWxpbmU/LmN1cnJlbnRUaW1lID8/IDApIC8gKHRoaXMudGltZWxpbmU/LmR1cmF0aW9uID8/IDEpLCBcInZhbHVlXCIpKTsgfVxuICAgICAgICAgICAgY29uc3QgJG9ic2VydmVyID0gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKChlbnRyaWVzKT0+ZW50cmllcy5mb3JFYWNoKChlbnRyeSk9PiRjYj8uKCkpKTtcbiAgICAgICAgICAgICRvYnNlcnZlci5vYnNlcnZlKHRoaXMuc291cmNlKTtcbiAgICAgICAgICAgIHJldHVybiAoKT0+ICRvYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNldHVwSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoKSB7XG4gICAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoKGVudHJpZXMpPT50aGlzLmhhbmRsZUludGVyc2VjdGlvbihlbnRyaWVzKSk7XG4gICAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLnNvdXJjZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVJbnRlcnNlY3Rpb24oZW50cmllczogSW50ZXJzZWN0aW9uT2JzZXJ2ZXJFbnRyeVtdKSB7XG4gICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykge1xuICAgICAgICAgICAgLy8gQ3VzdG9tIGludGVyc2VjdGlvbiBoYW5kbGluZyBsb2dpY1xuICAgICAgICAgICAgY29uc3QgcmF0aW8gPSBlbnRyeS5pbnRlcnNlY3Rpb25SYXRpbztcbiAgICAgICAgICAgIGNvbnN0IHJlY3QgPSBlbnRyeS5ib3VuZGluZ0NsaWVudFJlY3Q7XG5cbiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aW1lbGluZSBwcm9ncmVzcyBiYXNlZCBvbiBpbnRlcnNlY3Rpb25cbiAgICAgICAgICAgIGlmICh0aGlzLmF4aXMgPT09ICdibG9jaycpIHtcbiAgICAgICAgICAgICAgICAvLyBWZXJ0aWNhbCBpbnRlcnNlY3Rpb25cbiAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IHJlY3QudG9wIDwgMCA/XG4gICAgICAgICAgICAgICAgICAgIE1hdGguYWJzKHJlY3QudG9wKSAvIChyZWN0LmhlaWdodCArIGdsb2JhbFRoaXMuaW5uZXJIZWlnaHQpIDpcbiAgICAgICAgICAgICAgICAgICAgMSAtIChyZWN0LmJvdHRvbSAvIChyZWN0LmhlaWdodCArIGdsb2JhbFRoaXMuaW5uZXJIZWlnaHQpKTtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVByb2dyZXNzKE1hdGgubWF4KDAsIE1hdGgubWluKDEsIHByb2dyZXNzKSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIGludGVyc2VjdGlvblxuICAgICAgICAgICAgICAgIGNvbnN0IHByb2dyZXNzID0gcmVjdC5sZWZ0IDwgMCA/XG4gICAgICAgICAgICAgICAgICAgIE1hdGguYWJzKHJlY3QubGVmdCkgLyAocmVjdC53aWR0aCArIGdsb2JhbFRoaXMuaW5uZXJXaWR0aCkgOlxuICAgICAgICAgICAgICAgICAgICAxIC0gKHJlY3QucmlnaHQgLyAocmVjdC53aWR0aCArIGdsb2JhbFRoaXMuaW5uZXJXaWR0aCkpO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlUHJvZ3Jlc3MoTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgcHJvZ3Jlc3MpKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZVByb2dyZXNzKHByb2dyZXNzOiBudW1iZXIpIHtcbiAgICAgICAgLy8gVXBkYXRlIHRpbWVsaW5lIHByb2dyZXNzIChpbXBsZW1lbnRhdGlvbiBkZXBlbmRzIG9uIGJyb3dzZXIgc3VwcG9ydClcbiAgICAgICAgaWYgKHRoaXMudGltZWxpbmUgJiYgJ2N1cnJlbnRUaW1lJyBpbiB0aGlzLnRpbWVsaW5lKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICB0aGlzLnRpbWVsaW5lLmN1cnJlbnRUaW1lID0gcHJvZ3Jlc3MgKiAxMDA7IC8vIENTUyBwcm9ncmVzcyBpcyAwLTEwMFxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIGZvciBicm93c2VycyB3aXRob3V0IGN1cnJlbnRUaW1lIHN1cHBvcnRcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1RpbWVsaW5lIGN1cnJlbnRUaW1lIG5vdCBzdXBwb3J0ZWQ6JywgZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZXN0cm95KCkge1xuICAgICAgICB0aGlzLnRpbWVsaW5lPy5kaXNjb25uZWN0KCk7XG4gICAgfVxufVxuXG4vL1xuZXhwb3J0IGNvbnN0IG1ha2VTY3JvbGxUaW1lbGluZSA9IChzb3VyY2U6IEhUTUxFbGVtZW50ICYge2VsZW1lbnQ/OiBIVE1MRWxlbWVudH0sIGF4aXM6IFwiaW5saW5lXCIgfCBcImJsb2NrXCIpID0+IHtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgaWYgKHR5cGVvZiBTY3JvbGxUaW1lbGluZSAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgIHJldHVybiBuZXcgRW5oYW5jZWRTY3JvbGxUaW1lbGluZSh7IHNvdXJjZTogc291cmNlPy5lbGVtZW50ID8/IHNvdXJjZSwgYXhpczogYXhpcyBhcyBcImlubGluZVwiIHwgXCJibG9ja1wiIH0pO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3QgdGFyZ2V0ICAgPSB0b1JlZihzb3VyY2UpO1xuICAgIGNvbnN0IHNjcm9sbCAgID0gc2Nyb2xsUmVmKHNvdXJjZSwgKFtcImlubGluZVwiLCBcImJsb2NrXCJdIGFzIFtcImlubGluZVwiLCBcImJsb2NrXCJdKVtheGlzXSk7XG4gICAgY29uc3QgY29udGVudCAgPSBjb21wdXRlZChzaXplUmVmKHNvdXJjZSwgKFtcImlubGluZVwiLCBcImJsb2NrXCJdIGFzIFtcImlubGluZVwiLCBcImJsb2NrXCJdKVtheGlzXSwgXCJjb250ZW50LWJveFwiKSwgKHYpPT4odiArIGdldFBhZGRpbmcoc291cmNlLCAoW1wiaW5saW5lXCIsIFwiYmxvY2tcIl0gYXMgW1wiaW5saW5lXCIsIFwiYmxvY2tcIl0pW2F4aXNdKSkpO1xuICAgIGNvbnN0IHBlcmNlbnQgID0gY29tcHV0ZWQgKHNjcm9sbCwgKHZsKT0+ICgodmwgfHwgMCkgLyAoKGRlcmVmKHRhcmdldCk/LltbJ3Njcm9sbFdpZHRoJywgJ3Njcm9sbEhlaWdodCddW2F4aXNdXSAtIGNvbnRlbnQ/LnZhbHVlKSB8fCAxKSkpO1xuICAgIGFmZmVjdGVkKGNvbnRlbnQsICh2bDogYW55KSA9PiAoKHNjcm9sbD8udmFsdWUgfHwgMCkgLyAoKGRlcmVmKHRhcmdldCk/LltbJ3Njcm9sbFdpZHRoJywgJ3Njcm9sbEhlaWdodCddW2F4aXNdXSAtIHZsKSB8fCAxKSkpO1xuICAgIHJldHVybiBwZXJjZW50O1xufVxuIl19
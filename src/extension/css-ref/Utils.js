import { numberRef } from "fest/object";
import { CSSBinder, CSSUnitConverter, CSSTransform, CSSCalc } from "fest/lure";
// generate only random letters, NOT numbers
export const generateAnchorId = () => {
    const randLetters = Math.random().toString(36).substring(2, 15).replace(/[0-9]/g, '');
    return ("--" + randLetters);
};
//
export const getComputedZIndex = (element) => {
    if (element?.computedStyleMap) {
        return Number(element.computedStyleMap().get("z-index")?.toString() || 0) || 0;
    }
    else {
        return Number(getComputedStyle(element?.element ?? element).getPropertyValue("z-index") || 0) || 0;
    }
};
//
export const getExistsZIndex = (element) => {
    if (!element) {
        return 0;
    }
    if (element?.attributeStyleMap && element.attributeStyleMap.get("z-index") != null) {
        return Number(element.attributeStyleMap.get("z-index")?.value ?? 0) || 0;
    }
    if (element?.style && "zIndex" in element.style && element.style.zIndex != null) {
        return Number(element.style.zIndex || 0) || 0;
    }
    return getComputedZIndex(element);
};
// Enhanced CSS utilities that work with reactive math
// Reactive CSS value parser with unit conversion
export class ReactiveCSSValue {
    value;
    unit;
    constructor(initialValue, unit = 'px') {
        const parsed = typeof initialValue === 'string'
            ? CSSUnitConverter.parseValue(initialValue)
            : { value: initialValue, unit };
        this.value = numberRef(parsed.value);
        this.unit = parsed.unit;
    }
    // Get reactive CSS string
    get cssValue() {
        return CSSBinder.bindWithUnit({}, '', this.value, this.unit);
    }
    // Convert to different unit reactively
    toUnit(targetUnit) {
        return CSSCalc.multiply(this.value, numberRef(1)); // Placeholder for unit conversion
    }
    // Bind to element property
    bindTo(element, property) {
        return CSSBinder.bindWithUnit(element, property, this.value, this.unit);
    }
}
// Reactive transform builder
export class ReactiveTransform {
    transforms = [];
    translate(x, y) {
        const vector = typeof x === 'number' && typeof y === 'number'
            ? { x: numberRef(x), y: numberRef(y) }
            : { x: typeof x === 'number' ? numberRef(x) : x,
                y: typeof y === 'number' ? numberRef(y) : y };
        this.transforms.push(CSSTransform.translate2D(vector));
        return this;
    }
    scale(x, y) {
        const scaleX = typeof x === 'number' ? numberRef(x) : x;
        const scaleY = y !== undefined ? (typeof y === 'number' ? numberRef(y) : y) : scaleX;
        this.transforms.push(CSSTransform.scale2D({ x: scaleX, y: scaleY }));
        return this;
    }
    rotate(angle) {
        const angleRef = typeof angle === 'number' ? numberRef(angle) : angle;
        this.transforms.push(CSSTransform.rotate(angleRef));
        return this;
    }
    // Get combined transform string
    get value() {
        return CSSTransform.combine(this.transforms);
    }
    // Bind to element
    bindTo(element) {
        return CSSBinder.bindTransform(element, { x: numberRef(0), y: numberRef(0) });
        // Note: This is a simplified binding - in practice you'd need to track all transform components
    }
}
// Reactive CSS animation helper
export class ReactiveAnimation {
    element;
    properties;
    duration;
    easing;
    constructor(element, duration = 1000, easing = 'ease-out') {
        this.element = element;
        this.properties = new Map();
        this.duration = duration;
        this.easing = easing;
    }
    // Animate CSS property
    animateProperty(property, from, to) {
        const value = numberRef(from);
        this.properties.set(property, value);
        // Bind to element
        CSSBinder.bindWithUnit(this.element, property, value);
        // Start animation
        this.animateValue(value, from, to);
        return this;
    }
    animateValue(ref, from, to) {
        const startTime = performance.now();
        const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / this.duration, 1);
            // Apply easing
            const easedProgress = this.applyEasing(progress);
            ref.value = from + (to - from) * easedProgress;
            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        };
        requestAnimationFrame(animate);
    }
    applyEasing(t) {
        // Simple easing implementation
        switch (this.easing) {
            case 'ease-out':
                return 1 - Math.pow(1 - t, 3);
            case 'ease-in':
                return t * t * t;
            case 'ease-in-out':
                return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
            default:
                return t;
        }
    }
}
// Reactive CSS media query helper
export class ReactiveMediaQuery {
    query;
    matches;
    constructor(query) {
        this.query = query;
        this.matches = numberRef(0);
        const mediaQuery = window?.matchMedia(query);
        this.matches.value = mediaQuery.matches ? 1 : 0;
        mediaQuery?.addEventListener('change', (e) => {
            this.matches.value = e.matches ? 1 : 0;
        });
    }
    get reactiveMatches() {
        return this.matches;
    }
    // Get reactive value based on media query
    valueIfMatches(ifTrue, ifFalse) {
        // This would need a computed value that switches based on matches
        return this.matches.value ? ifTrue : ifFalse;
    }
}
// Reactive viewport dimensions
export class ReactiveViewport {
    static width = numberRef(typeof window != "undefined" ? window?.innerWidth : 0);
    static height = numberRef(typeof window != "undefined" ? window?.innerHeight : 0);
    static init() {
        const updateSize = () => {
            this.width.value = window?.innerWidth;
            this.height.value = window?.innerHeight;
        };
        if (typeof window != "undefined") {
            window?.addEventListener?.('resize', updateSize);
        }
    }
    // Get reactive viewport center
    static center() {
        return {
            x: CSSCalc.divide(this.width, numberRef(2)),
            y: CSSCalc.divide(this.height, numberRef(2))
        };
    }
}
// Initialize viewport tracking
ReactiveViewport.init();
// Reactive element dimensions
export class ReactiveElementSize {
    element;
    size;
    observer;
    constructor(element) {
        this.element = element;
        this.size = {
            width: numberRef(element.offsetWidth),
            height: numberRef(element.offsetHeight)
        };
        this.observer = new ResizeObserver((entries) => {
            for (const entry of entries) {
                if (entry.target === element) {
                    this.size.width.value = entry.contentRect.width;
                    this.size.height.value = entry.contentRect.height;
                }
            }
        });
        this.observer.observe(element);
    }
    get width() { return this.size.width; }
    get height() { return this.size.height; }
    // Get reactive center point
    center() {
        return {
            x: CSSCalc.divide(this.size.width, numberRef(2)),
            y: CSSCalc.divide(this.size.height, numberRef(2))
        };
    }
    destroy() {
        this.observer.disconnect();
    }
}
// Reactive scroll position
export class ReactiveScroll {
    element;
    scrollLeft;
    scrollTop;
    constructor(element = document.documentElement) {
        this.element = element;
        this.scrollLeft = numberRef(element.scrollLeft);
        this.scrollTop = numberRef(element.scrollTop);
        element.addEventListener('scroll', () => {
            this.scrollLeft.value = element.scrollLeft;
            this.scrollTop.value = element.scrollTop;
        });
    }
    get left() { return this.scrollLeft; }
    get top() { return this.scrollTop; }
    // Get reactive scroll progress (0-1)
    progress(axis = 'y') {
        const scrollSize = axis === 'x'
            ? this.element.scrollWidth - this.element.clientWidth
            : this.element.scrollHeight - this.element.clientHeight;
        const scrollPos = axis === 'x' ? this.scrollLeft : this.scrollTop;
        return CSSCalc.divide(scrollPos, numberRef(Math.max(scrollSize, 1)));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUUvRSw0Q0FBNEM7QUFDNUMsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxFQUFFO0lBQ2pDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3RGLE9BQU8sQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDLENBQUM7QUFDaEMsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsT0FBb0IsRUFBVSxFQUFFO0lBQzlELElBQUksT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUM7UUFDNUIsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuRixDQUFDO1NBQU0sQ0FBQztRQUNKLE9BQU8sTUFBTSxDQUFDLGdCQUFnQixDQUFFLE9BQWUsRUFBRSxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hILENBQUM7QUFDTCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHLENBQUMsT0FBb0IsRUFBVSxFQUFF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QUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG51bWJlclJlZiB9IGZyb20gXCJmZXN0L29iamVjdFwiO1xuaW1wb3J0IHsgQ1NTQmluZGVyLCBDU1NVbml0Q29udmVydGVyLCBDU1NUcmFuc2Zvcm0sIENTU0NhbGMgfSBmcm9tIFwiZmVzdC9sdXJlXCI7XG5cbi8vIGdlbmVyYXRlIG9ubHkgcmFuZG9tIGxldHRlcnMsIE5PVCBudW1iZXJzXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVBbmNob3JJZCA9ICgpID0+IHtcbiAgICBjb25zdCByYW5kTGV0dGVycyA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyLCAxNSkucmVwbGFjZSgvWzAtOV0vZywgJycpO1xuICAgIHJldHVybiAoXCItLVwiICsgcmFuZExldHRlcnMpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGdldENvbXB1dGVkWkluZGV4ID0gKGVsZW1lbnQ6IEhUTUxFbGVtZW50KTogbnVtYmVyID0+IHtcbiAgICBpZiAoZWxlbWVudD8uY29tcHV0ZWRTdHlsZU1hcCkge1xuICAgICAgICByZXR1cm4gTnVtYmVyKGVsZW1lbnQuY29tcHV0ZWRTdHlsZU1hcCgpLmdldChcInotaW5kZXhcIik/LnRvU3RyaW5nKCkgfHwgMCkgfHwgMDtcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gTnVtYmVyKGdldENvbXB1dGVkU3R5bGUoKGVsZW1lbnQgYXMgYW55KT8uZWxlbWVudCA/PyBlbGVtZW50KS5nZXRQcm9wZXJ0eVZhbHVlKFwiei1pbmRleFwiKSB8fCAwKSB8fCAwO1xuICAgIH1cbn1cblxuLy9cbmV4cG9ydCBjb25zdCBnZXRFeGlzdHNaSW5kZXggPSAoZWxlbWVudDogSFRNTEVsZW1lbnQpOiBudW1iZXIgPT4ge1xuICAgIGlmICghZWxlbWVudCkgeyByZXR1cm4gMDsgfVxuICAgIGlmICgoZWxlbWVudCBhcyBhbnkpPy5hdHRyaWJ1dGVTdHlsZU1hcCAmJiAoZWxlbWVudCBhcyBhbnkpLmF0dHJpYnV0ZVN0eWxlTWFwLmdldChcInotaW5kZXhcIikgIT0gbnVsbCkgeyByZXR1cm4gTnVtYmVyKChlbGVtZW50IGFzIGFueSkuYXR0cmlidXRlU3R5bGVNYXAuZ2V0KFwiei1pbmRleFwiKT8udmFsdWUgPz8gMCkgfHwgMDsgfVxuICAgIGlmICgoZWxlbWVudCBhcyBhbnkpPy5zdHlsZSAmJiBcInpJbmRleFwiIGluIChlbGVtZW50IGFzIGFueSkuc3R5bGUgJiYgKGVsZW1lbnQgYXMgYW55KS5zdHlsZS56SW5kZXggIT0gbnVsbCkgeyByZXR1cm4gTnVtYmVyKChlbGVtZW50IGFzIGFueSkuc3R5bGUuekluZGV4IHx8IDApIHx8IDA7IH1cbiAgICByZXR1cm4gZ2V0Q29tcHV0ZWRaSW5kZXgoZWxlbWVudCk7XG59XG5cbi8vIEVuaGFuY2VkIENTUyB1dGlsaXRpZXMgdGhhdCB3b3JrIHdpdGggcmVhY3RpdmUgbWF0aFxuXG4vLyBSZWFjdGl2ZSBDU1MgdmFsdWUgcGFyc2VyIHdpdGggdW5pdCBjb252ZXJzaW9uXG5leHBvcnQgY2xhc3MgUmVhY3RpdmVDU1NWYWx1ZSB7XG4gICAgcHJpdmF0ZSB2YWx1ZTogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPjtcbiAgICBwcml2YXRlIHVuaXQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKGluaXRpYWxWYWx1ZTogc3RyaW5nIHwgbnVtYmVyLCB1bml0OiBzdHJpbmcgPSAncHgnKSB7XG4gICAgICAgIGNvbnN0IHBhcnNlZCA9IHR5cGVvZiBpbml0aWFsVmFsdWUgPT09ICdzdHJpbmcnXG4gICAgICAgICAgICA/IENTU1VuaXRDb252ZXJ0ZXIucGFyc2VWYWx1ZShpbml0aWFsVmFsdWUpXG4gICAgICAgICAgICA6IHsgdmFsdWU6IGluaXRpYWxWYWx1ZSwgdW5pdCB9O1xuXG4gICAgICAgIHRoaXMudmFsdWUgPSBudW1iZXJSZWYocGFyc2VkLnZhbHVlKTtcbiAgICAgICAgdGhpcy51bml0ID0gcGFyc2VkLnVuaXQ7XG4gICAgfVxuXG4gICAgLy8gR2V0IHJlYWN0aXZlIENTUyBzdHJpbmdcbiAgICBnZXQgY3NzVmFsdWUoKTogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiB7XG4gICAgICAgIHJldHVybiBDU1NCaW5kZXIuYmluZFdpdGhVbml0KHt9IGFzIEhUTUxFbGVtZW50LCAnJywgdGhpcy52YWx1ZSwgdGhpcy51bml0KTtcbiAgICB9XG5cbiAgICAvLyBDb252ZXJ0IHRvIGRpZmZlcmVudCB1bml0IHJlYWN0aXZlbHlcbiAgICB0b1VuaXQodGFyZ2V0VW5pdDogc3RyaW5nKTogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiB7XG4gICAgICAgIHJldHVybiBDU1NDYWxjLm11bHRpcGx5KHRoaXMudmFsdWUsIG51bWJlclJlZigxKSk7IC8vIFBsYWNlaG9sZGVyIGZvciB1bml0IGNvbnZlcnNpb25cbiAgICB9XG5cbiAgICAvLyBCaW5kIHRvIGVsZW1lbnQgcHJvcGVydHlcbiAgICBiaW5kVG8oZWxlbWVudDogSFRNTEVsZW1lbnQsIHByb3BlcnR5OiBzdHJpbmcpOiAoKSA9PiB2b2lkIHtcbiAgICAgICAgcmV0dXJuIENTU0JpbmRlci5iaW5kV2l0aFVuaXQoZWxlbWVudCwgcHJvcGVydHksIHRoaXMudmFsdWUsIHRoaXMudW5pdCk7XG4gICAgfVxufVxuXG4vLyBSZWFjdGl2ZSB0cmFuc2Zvcm0gYnVpbGRlclxuZXhwb3J0IGNsYXNzIFJlYWN0aXZlVHJhbnNmb3JtIHtcbiAgICBwcml2YXRlIHRyYW5zZm9ybXM6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj5bXSA9IFtdO1xuXG4gICAgdHJhbnNsYXRlKHg6IG51bWJlciB8IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4sIHk6IG51bWJlciB8IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4pOiB0aGlzIHtcbiAgICAgICAgY29uc3QgdmVjdG9yID0gdHlwZW9mIHggPT09ICdudW1iZXInICYmIHR5cGVvZiB5ID09PSAnbnVtYmVyJ1xuICAgICAgICAgICAgPyB7IHg6IG51bWJlclJlZih4KSwgeTogbnVtYmVyUmVmKHkpIH1cbiAgICAgICAgICAgIDogeyB4OiB0eXBlb2YgeCA9PT0gJ251bWJlcicgPyBudW1iZXJSZWYoeCkgOiB4LFxuICAgICAgICAgICAgICAgIHk6IHR5cGVvZiB5ID09PSAnbnVtYmVyJyA/IG51bWJlclJlZih5KSA6IHkgfTtcbiAgICAgICAgdGhpcy50cmFuc2Zvcm1zLnB1c2goQ1NTVHJhbnNmb3JtLnRyYW5zbGF0ZTJEKHZlY3RvciBhcyBhbnkpKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgc2NhbGUoeDogbnVtYmVyIHwgUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiwgeT86IG51bWJlciB8IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4pOiB0aGlzIHtcbiAgICAgICAgY29uc3Qgc2NhbGVYID0gdHlwZW9mIHggPT09ICdudW1iZXInID8gbnVtYmVyUmVmKHgpIDogeDtcbiAgICAgICAgY29uc3Qgc2NhbGVZID0geSAhPT0gdW5kZWZpbmVkID8gKHR5cGVvZiB5ID09PSAnbnVtYmVyJyA/IG51bWJlclJlZih5KSA6IHkpIDogc2NhbGVYO1xuICAgICAgICB0aGlzLnRyYW5zZm9ybXMucHVzaChDU1NUcmFuc2Zvcm0uc2NhbGUyRCh7IHg6IHNjYWxlWCwgeTogc2NhbGVZIH0gYXMgYW55KSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHJvdGF0ZShhbmdsZTogbnVtYmVyIHwgUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPik6IHRoaXMge1xuICAgICAgICBjb25zdCBhbmdsZVJlZiA9IHR5cGVvZiBhbmdsZSA9PT0gJ251bWJlcicgPyBudW1iZXJSZWYoYW5nbGUpIDogYW5nbGU7XG4gICAgICAgIHRoaXMudHJhbnNmb3Jtcy5wdXNoKENTU1RyYW5zZm9ybS5yb3RhdGUoYW5nbGVSZWYpKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgLy8gR2V0IGNvbWJpbmVkIHRyYW5zZm9ybSBzdHJpbmdcbiAgICBnZXQgdmFsdWUoKTogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiB7XG4gICAgICAgIHJldHVybiBDU1NUcmFuc2Zvcm0uY29tYmluZSh0aGlzLnRyYW5zZm9ybXMpO1xuICAgIH1cblxuICAgIC8vIEJpbmQgdG8gZWxlbWVudFxuICAgIGJpbmRUbyhlbGVtZW50OiBIVE1MRWxlbWVudCk6ICgpID0+IHZvaWQge1xuICAgICAgICByZXR1cm4gQ1NTQmluZGVyLmJpbmRUcmFuc2Zvcm0oZWxlbWVudCwgeyB4OiBudW1iZXJSZWYoMCksIHk6IG51bWJlclJlZigwKSB9IGFzIGFueSk7XG4gICAgICAgIC8vIE5vdGU6IFRoaXMgaXMgYSBzaW1wbGlmaWVkIGJpbmRpbmcgLSBpbiBwcmFjdGljZSB5b3UnZCBuZWVkIHRvIHRyYWNrIGFsbCB0cmFuc2Zvcm0gY29tcG9uZW50c1xuICAgIH1cbn1cblxuLy8gUmVhY3RpdmUgQ1NTIGFuaW1hdGlvbiBoZWxwZXJcbmV4cG9ydCBjbGFzcyBSZWFjdGl2ZUFuaW1hdGlvbiB7XG4gICAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgICBwcml2YXRlIHByb3BlcnRpZXM6IE1hcDxzdHJpbmcsIFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4+O1xuICAgIHByaXZhdGUgZHVyYXRpb246IG51bWJlcjtcbiAgICBwcml2YXRlIGVhc2luZzogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IoZWxlbWVudDogSFRNTEVsZW1lbnQsIGR1cmF0aW9uOiBudW1iZXIgPSAxMDAwLCBlYXNpbmc6IHN0cmluZyA9ICdlYXNlLW91dCcpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDtcbiAgICAgICAgdGhpcy5wcm9wZXJ0aWVzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLmR1cmF0aW9uID0gZHVyYXRpb247XG4gICAgICAgIHRoaXMuZWFzaW5nID0gZWFzaW5nO1xuICAgIH1cblxuICAgIC8vIEFuaW1hdGUgQ1NTIHByb3BlcnR5XG4gICAgYW5pbWF0ZVByb3BlcnR5KHByb3BlcnR5OiBzdHJpbmcsIGZyb206IG51bWJlciwgdG86IG51bWJlcik6IHRoaXMge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IG51bWJlclJlZihmcm9tKTtcbiAgICAgICAgdGhpcy5wcm9wZXJ0aWVzLnNldChwcm9wZXJ0eSwgdmFsdWUpO1xuXG4gICAgICAgIC8vIEJpbmQgdG8gZWxlbWVudFxuICAgICAgICBDU1NCaW5kZXIuYmluZFdpdGhVbml0KHRoaXMuZWxlbWVudCwgcHJvcGVydHksIHZhbHVlKTtcblxuICAgICAgICAvLyBTdGFydCBhbmltYXRpb25cbiAgICAgICAgdGhpcy5hbmltYXRlVmFsdWUodmFsdWUsIGZyb20sIHRvKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhbmltYXRlVmFsdWUocmVmOiBSZXR1cm5UeXBlPHR5cGVvZiBudW1iZXJSZWY+LCBmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgICAgICAgY29uc3QgYW5pbWF0ZSA9IChjdXJyZW50VGltZTogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlbGFwc2VkID0gY3VycmVudFRpbWUgLSBzdGFydFRpbWU7XG4gICAgICAgICAgICBjb25zdCBwcm9ncmVzcyA9IE1hdGgubWluKGVsYXBzZWQgLyB0aGlzLmR1cmF0aW9uLCAxKTtcblxuICAgICAgICAgICAgLy8gQXBwbHkgZWFzaW5nXG4gICAgICAgICAgICBjb25zdCBlYXNlZFByb2dyZXNzID0gdGhpcy5hcHBseUVhc2luZyhwcm9ncmVzcyk7XG4gICAgICAgICAgICByZWYudmFsdWUgPSBmcm9tICsgKHRvIC0gZnJvbSkgKiBlYXNlZFByb2dyZXNzO1xuXG4gICAgICAgICAgICBpZiAocHJvZ3Jlc3MgPCAxKSB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFuaW1hdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShhbmltYXRlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFwcGx5RWFzaW5nKHQ6IG51bWJlcik6IG51bWJlciB7XG4gICAgICAgIC8vIFNpbXBsZSBlYXNpbmcgaW1wbGVtZW50YXRpb25cbiAgICAgICAgc3dpdGNoICh0aGlzLmVhc2luZykge1xuICAgICAgICAgICAgY2FzZSAnZWFzZS1vdXQnOlxuICAgICAgICAgICAgICAgIHJldHVybiAxIC0gTWF0aC5wb3coMSAtIHQsIDMpO1xuICAgICAgICAgICAgY2FzZSAnZWFzZS1pbic6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHQgKiB0ICogdDtcbiAgICAgICAgICAgIGNhc2UgJ2Vhc2UtaW4tb3V0JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdCA8IDAuNSA/IDQgKiB0ICogdCAqIHQgOiAxIC0gTWF0aC5wb3coLTIgKiB0ICsgMiwgMykgLyAyO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gdDtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLy8gUmVhY3RpdmUgQ1NTIG1lZGlhIHF1ZXJ5IGhlbHBlclxuZXhwb3J0IGNsYXNzIFJlYWN0aXZlTWVkaWFRdWVyeSB7XG4gICAgcHJpdmF0ZSBxdWVyeTogc3RyaW5nO1xuICAgIHByaXZhdGUgbWF0Y2hlczogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPjtcblxuICAgIGNvbnN0cnVjdG9yKHF1ZXJ5OiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5xdWVyeSA9IHF1ZXJ5O1xuICAgICAgICB0aGlzLm1hdGNoZXMgPSBudW1iZXJSZWYoMCk7XG5cbiAgICAgICAgY29uc3QgbWVkaWFRdWVyeSA9IHdpbmRvdz8ubWF0Y2hNZWRpYShxdWVyeSk7XG4gICAgICAgIHRoaXMubWF0Y2hlcy52YWx1ZSA9IG1lZGlhUXVlcnkubWF0Y2hlcyA/IDEgOiAwO1xuXG4gICAgICAgIG1lZGlhUXVlcnk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm1hdGNoZXMudmFsdWUgPSBlLm1hdGNoZXMgPyAxIDogMDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0IHJlYWN0aXZlTWF0Y2hlcygpOiBSZXR1cm5UeXBlPHR5cGVvZiBudW1iZXJSZWY+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF0Y2hlcztcbiAgICB9XG5cbiAgICAvLyBHZXQgcmVhY3RpdmUgdmFsdWUgYmFzZWQgb24gbWVkaWEgcXVlcnlcbiAgICB2YWx1ZUlmTWF0Y2hlczxUPihpZlRydWU6IFQsIGlmRmFsc2U6IFQpOiBUIHtcbiAgICAgICAgLy8gVGhpcyB3b3VsZCBuZWVkIGEgY29tcHV0ZWQgdmFsdWUgdGhhdCBzd2l0Y2hlcyBiYXNlZCBvbiBtYXRjaGVzXG4gICAgICAgIHJldHVybiB0aGlzLm1hdGNoZXMudmFsdWUgPyBpZlRydWUgOiBpZkZhbHNlO1xuICAgIH1cbn1cblxuLy8gUmVhY3RpdmUgdmlld3BvcnQgZGltZW5zaW9uc1xuZXhwb3J0IGNsYXNzIFJlYWN0aXZlVmlld3BvcnQge1xuICAgIHN0YXRpYyB3aWR0aDogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiA9IG51bWJlclJlZih0eXBlb2Ygd2luZG93ICE9IFwidW5kZWZpbmVkXCIgPyB3aW5kb3c/LmlubmVyV2lkdGggOiAwKTtcbiAgICBzdGF0aWMgaGVpZ2h0OiBSZXR1cm5UeXBlPHR5cGVvZiBudW1iZXJSZWY+ID0gbnVtYmVyUmVmKHR5cGVvZiB3aW5kb3cgIT0gXCJ1bmRlZmluZWRcIiA/IHdpbmRvdz8uaW5uZXJIZWlnaHQgOiAwKTtcblxuICAgIHN0YXRpYyBpbml0KCk6IHZvaWQge1xuICAgICAgICBjb25zdCB1cGRhdGVTaXplID0gKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy53aWR0aC52YWx1ZSA9IHdpbmRvdz8uaW5uZXJXaWR0aDtcbiAgICAgICAgICAgIHRoaXMuaGVpZ2h0LnZhbHVlID0gd2luZG93Py5pbm5lckhlaWdodDtcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodHlwZW9mIHdpbmRvdyAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICAgICAgICB3aW5kb3c/LmFkZEV2ZW50TGlzdGVuZXI/LigncmVzaXplJywgdXBkYXRlU2l6ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBHZXQgcmVhY3RpdmUgdmlld3BvcnQgY2VudGVyXG4gICAgc3RhdGljIGNlbnRlcigpOiB7IHg6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4sIHk6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4gfSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB4OiBDU1NDYWxjLmRpdmlkZSh0aGlzLndpZHRoLCBudW1iZXJSZWYoMikpLFxuICAgICAgICAgICAgeTogQ1NTQ2FsYy5kaXZpZGUodGhpcy5oZWlnaHQsIG51bWJlclJlZigyKSlcbiAgICAgICAgfTtcbiAgICB9XG59XG5cbi8vIEluaXRpYWxpemUgdmlld3BvcnQgdHJhY2tpbmdcblJlYWN0aXZlVmlld3BvcnQuaW5pdCgpO1xuXG4vLyBSZWFjdGl2ZSBlbGVtZW50IGRpbWVuc2lvbnNcbmV4cG9ydCBjbGFzcyBSZWFjdGl2ZUVsZW1lbnRTaXplIHtcbiAgICBwcml2YXRlIGVsZW1lbnQ6IEhUTUxFbGVtZW50O1xuICAgIHByaXZhdGUgc2l6ZTogeyB3aWR0aDogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiwgaGVpZ2h0OiBSZXR1cm5UeXBlPHR5cGVvZiBudW1iZXJSZWY+IH07XG4gICAgcHJpdmF0ZSBvYnNlcnZlcjogUmVzaXplT2JzZXJ2ZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgICB0aGlzLnNpemUgPSB7XG4gICAgICAgICAgICB3aWR0aDogbnVtYmVyUmVmKGVsZW1lbnQub2Zmc2V0V2lkdGgpLFxuICAgICAgICAgICAgaGVpZ2h0OiBudW1iZXJSZWYoZWxlbWVudC5vZmZzZXRIZWlnaHQpXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5vYnNlcnZlciA9IG5ldyBSZXNpemVPYnNlcnZlcigoZW50cmllcykgPT4ge1xuICAgICAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVudHJ5LnRhcmdldCA9PT0gZWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNpemUud2lkdGgudmFsdWUgPSBlbnRyeS5jb250ZW50UmVjdC53aWR0aDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaXplLmhlaWdodC52YWx1ZSA9IGVudHJ5LmNvbnRlbnRSZWN0LmhlaWdodDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMub2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50KTtcbiAgICB9XG5cbiAgICBnZXQgd2lkdGgoKTogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiB7IHJldHVybiB0aGlzLnNpemUud2lkdGg7IH1cbiAgICBnZXQgaGVpZ2h0KCk6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4geyByZXR1cm4gdGhpcy5zaXplLmhlaWdodDsgfVxuXG4gICAgLy8gR2V0IHJlYWN0aXZlIGNlbnRlciBwb2ludFxuICAgIGNlbnRlcigpOiB7IHg6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4sIHk6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4gfSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB4OiBDU1NDYWxjLmRpdmlkZSh0aGlzLnNpemUud2lkdGgsIG51bWJlclJlZigyKSksXG4gICAgICAgICAgICB5OiBDU1NDYWxjLmRpdmlkZSh0aGlzLnNpemUuaGVpZ2h0LCBudW1iZXJSZWYoMikpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgZGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5vYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgfVxufVxuXG4vLyBSZWFjdGl2ZSBzY3JvbGwgcG9zaXRpb25cbmV4cG9ydCBjbGFzcyBSZWFjdGl2ZVNjcm9sbCB7XG4gICAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgICBwcml2YXRlIHNjcm9sbExlZnQ6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj47XG4gICAgcHJpdmF0ZSBzY3JvbGxUb3A6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj47XG5cbiAgICBjb25zdHJ1Y3RvcihlbGVtZW50OiBIVE1MRWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkge1xuICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50O1xuICAgICAgICB0aGlzLnNjcm9sbExlZnQgPSBudW1iZXJSZWYoZWxlbWVudC5zY3JvbGxMZWZ0KTtcbiAgICAgICAgdGhpcy5zY3JvbGxUb3AgPSBudW1iZXJSZWYoZWxlbWVudC5zY3JvbGxUb3ApO1xuXG4gICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zY3JvbGxMZWZ0LnZhbHVlID0gZWxlbWVudC5zY3JvbGxMZWZ0O1xuICAgICAgICAgICAgdGhpcy5zY3JvbGxUb3AudmFsdWUgPSBlbGVtZW50LnNjcm9sbFRvcDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0IGxlZnQoKTogUmV0dXJuVHlwZTx0eXBlb2YgbnVtYmVyUmVmPiB7IHJldHVybiB0aGlzLnNjcm9sbExlZnQ7IH1cbiAgICBnZXQgdG9wKCk6IFJldHVyblR5cGU8dHlwZW9mIG51bWJlclJlZj4geyByZXR1cm4gdGhpcy5zY3JvbGxUb3A7IH1cblxuICAgIC8vIEdldCByZWFjdGl2ZSBzY3JvbGwgcHJvZ3Jlc3MgKDAtMSlcbiAgICBwcm9ncmVzcyhheGlzOiAneCcgfCAneScgPSAneScpOiBSZXR1cm5UeXBlPHR5cGVvZiBudW1iZXJSZWY+IHtcbiAgICAgICAgY29uc3Qgc2Nyb2xsU2l6ZSA9IGF4aXMgPT09ICd4J1xuICAgICAgICAgICAgPyB0aGlzLmVsZW1lbnQuc2Nyb2xsV2lkdGggLSB0aGlzLmVsZW1lbnQuY2xpZW50V2lkdGhcbiAgICAgICAgICAgIDogdGhpcy5lbGVtZW50LnNjcm9sbEhlaWdodCAtIHRoaXMuZWxlbWVudC5jbGllbnRIZWlnaHQ7XG5cbiAgICAgICAgY29uc3Qgc2Nyb2xsUG9zID0gYXhpcyA9PT0gJ3gnID8gdGhpcy5zY3JvbGxMZWZ0IDogdGhpcy5zY3JvbGxUb3A7XG5cbiAgICAgICAgcmV0dXJuIENTU0NhbGMuZGl2aWRlKHNjcm9sbFBvcywgbnVtYmVyUmVmKE1hdGgubWF4KHNjcm9sbFNpemUsIDEpKSk7XG4gICAgfVxufVxuIl19
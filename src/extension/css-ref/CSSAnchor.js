import { getExistsZIndex, generateAnchorId } from "./Utils";
//
const registeredAnchorIds = new WeakMap();
const registeredAnchors = new WeakMap();
//
export class CSSAnchor {
    source;
    anchorId;
    //
    constructor(source) {
        this.source = source;
        registeredAnchors.set(source, this); //@ts-ignore
        this.anchorId = registeredAnchorIds.getOrInsert(source, generateAnchorId());
        this.source.style.setProperty("anchor-name", this.anchorId);
        this.source.style.setProperty("position-visibility", `always`);
    }
    //
    connectElement(connect, { placement = "fill", zIndexShift = 1, inset = 0, size = "100%", transformOrigin = "50% 50%", }) {
        if (placement == "fill") {
            connect.style.setProperty("inset-block-start", `anchor(start, ${inset}px)`);
            connect.style.setProperty("inset-inline-start", `anchor(start, ${inset}px)`);
            connect.style.setProperty("inset-block-end", `anchor(end, ${inset}px)`);
            connect.style.setProperty("inset-inline-end", `anchor(end, ${inset}px)`);
            connect.style.setProperty("inline-size", `anchor-size(inline, ${size})`);
            connect.style.setProperty("block-size", `anchor-size(block, ${size})`);
            connect.style.setProperty("transform-origin", transformOrigin);
        }
        else if (placement == "bottom") {
            connect.style.setProperty("inset-block-start", `anchor(end, ${inset}px)`);
            connect.style.setProperty("inset-inline-start", `anchor(start, ${inset}px)`);
            connect.style.setProperty("inline-size", `anchor-size(self-inline, ${size})`);
            connect.style.setProperty("transform-origin", transformOrigin);
        }
        else if (placement == "top") {
            connect.style.setProperty("inset-block-end", `anchor(start, ${inset}px)`);
            connect.style.setProperty("inset-inline-start", `anchor(start, ${inset}px)`);
            connect.style.setProperty("inline-size", `anchor-size(self-inline, ${size})`);
            connect.style.setProperty("transform-origin", transformOrigin);
        }
        else if (placement == "left") {
            connect.style.setProperty("inset-inline-start", `anchor(end, ${inset}px)`);
            connect.style.setProperty("inset-block-start", `anchor(start, ${inset}px)`);
            connect.style.setProperty("block-size", `anchor-size(self-block, ${size})`);
            connect.style.setProperty("transform-origin", transformOrigin);
        }
        else if (placement == "right") {
            connect.style.setProperty("inset-inline-end", `anchor(start, ${inset}px)`);
            connect.style.setProperty("inset-block-start", `anchor(start, ${inset}px)`);
            connect.style.setProperty("block-size", `anchor-size(self-block, ${size})`);
            connect.style.setProperty("transform-origin", transformOrigin);
        }
        else if (placement == "center") {
            connect.style.setProperty("inset-inline-start", `anchor(center, ${inset}px)`);
            connect.style.setProperty("inset-block-start", `anchor(center, ${inset}px)`);
            connect.style.setProperty("inline-size", `anchor-size(self-inline, ${size})`);
            connect.style.setProperty("block-size", `anchor-size(self-block, ${size})`);
            connect.style.setProperty("transform-origin", transformOrigin);
        }
        //
        connect.style.setProperty("position-visibility", `always`);
        connect.style.setProperty("position-anchor", this.anchorId);
        connect.style.setProperty("position", `absolute`);
        connect.style.setProperty("position-area", `span-all`);
        connect.style.setProperty("z-index", String(getExistsZIndex(this.source ?? connect) + zIndexShift));
        return this;
    }
    // Enhanced anchor positioning with container query awareness
    connectWithContainerQuery(connect, { placement = "fill", containerQuery = "(min-width: 768px)", fallbackPlacement = "bottom", zIndexShift = 1, inset = 0, size = "100%", }) {
        // Use container query to determine positioning strategy
        const mediaQuery = globalThis.matchMedia ? globalThis.matchMedia(containerQuery) : null;
        const updatePosition = () => {
            const canUseAnchor = CSS.supports && CSS.supports("anchor-name", this.anchorId);
            const useModern = canUseAnchor && mediaQuery?.matches;
            if (useModern) {
                this.connectElement(connect, { placement, zIndexShift, inset, size });
            }
            else {
                // Fallback to traditional positioning
                connect.style.removeProperty("position-anchor");
                connect.style.removeProperty("anchor-name");
                connect.style.setProperty("position", "absolute");
                connect.style.setProperty("z-index", String(getExistsZIndex(this.source ?? connect) + zIndexShift));
                // Simple fallback positioning based on source element
                const sourceRect = this.source.getBoundingClientRect();
                if (fallbackPlacement === "bottom") {
                    connect.style.setProperty("top", `${sourceRect.bottom + inset}px`);
                    connect.style.setProperty("left", `${sourceRect.left + inset}px`);
                    connect.style.setProperty("width", size);
                }
                else if (fallbackPlacement === "top") {
                    connect.style.setProperty("bottom", `${globalThis.innerHeight - sourceRect.top + inset}px`);
                    connect.style.setProperty("left", `${sourceRect.left + inset}px`);
                    connect.style.setProperty("width", size);
                }
                else if (fallbackPlacement === "right") {
                    connect.style.setProperty("top", `${sourceRect.top + inset}px`);
                    connect.style.setProperty("left", `${sourceRect.right + inset}px`);
                    connect.style.setProperty("height", size);
                }
                else if (fallbackPlacement === "left") {
                    connect.style.setProperty("top", `${sourceRect.top + inset}px`);
                    connect.style.setProperty("right", `${globalThis.innerWidth - sourceRect.left + inset}px`);
                    connect.style.setProperty("height", size);
                }
            }
        };
        if (mediaQuery) {
            mediaQuery.addEventListener("change", updatePosition);
            updatePosition();
        }
        return () => mediaQuery?.removeEventListener("change", updatePosition);
    }
}
//
export const makeAnchorElement = (anchorElement) => {
    return registeredAnchors.getOrInsert(anchorElement, new CSSAnchor(anchorElement));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ1NTQW5jaG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQ1NTQW5jaG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxlQUFlLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFNUQsRUFBRTtBQUNGLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUMxQyxNQUFNLGlCQUFpQixHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7QUFFeEMsRUFBRTtBQUNGLE1BQU0sT0FBTyxTQUFTO0lBQ2xCLE1BQU0sQ0FBYztJQUNwQixRQUFRLENBQVM7SUFFakIsRUFBRTtJQUNGLFlBQVksTUFBbUI7UUFDM0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWTtRQUN2RSxJQUFJLENBQUMsUUFBUSxHQUFHLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1FBQzVFLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBRUQsRUFBRTtJQUNGLGNBQWMsQ0FBQyxPQUFvQixFQUFFLEVBQ2pDLFNBQVMsR0FBRyxNQUFNLEVBQ2xCLFdBQVcsR0FBRyxDQUFDLEVBQ2YsS0FBSyxHQUFHLENBQUMsRUFDVCxJQUFJLEdBQUcsTUFBTSxFQUNiLGVBQWUsR0FBRyxTQUFTLEdBQzlCO1FBQ0csSUFBSSxTQUFTLElBQUksTUFBTSxFQUFFLENBQUM7WUFDdEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsbUJB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QUFDLENBQUM7Z0JBQzlDLENBQUM7cUJBQU0sSUFBSSxpQkFBaUIsS0FBSyxNQUFNLEVBQUUsQ0FBQztvQkFDdEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLEdBQUcsVUFBVSxDQUFDLEdBQUcsR0FBRyxLQUFLLElBQUksQ0FBQyxDQUFDO29CQUNoRSxPQUFPLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxVQUFVLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxJQUFJLEdBQUcsS0FBSyxJQUFJLENBQUMsQ0FBQztvQkFDM0YsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUM5QyxDQUFDO1lBQ0wsQ0FBQztRQUNMLENBQUMsQ0FBQztRQUVGLElBQUksVUFBVSxFQUFFLENBQUM7WUFDYixVQUFVLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBQ3RELGNBQWMsRUFBRSxDQUFDO1FBQ3JCLENBQUM7UUFFRCxPQUFPLEdBQUcsRUFBRSxDQUFDLFVBQVUsRUFBRSxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDM0UsQ0FBQztDQUNKO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsYUFBMEIsRUFBRSxFQUFFO0lBQzVELE9BQU8saUJBQWlCLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxJQUFJLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0FBQ3RGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldEV4aXN0c1pJbmRleCwgZ2VuZXJhdGVBbmNob3JJZCB9IGZyb20gXCIuL1V0aWxzXCI7XG5cbi8vXG5jb25zdCByZWdpc3RlcmVkQW5jaG9ySWRzID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0IHJlZ2lzdGVyZWRBbmNob3JzID0gbmV3IFdlYWtNYXAoKTtcblxuLy9cbmV4cG9ydCBjbGFzcyBDU1NBbmNob3Ige1xuICAgIHNvdXJjZTogSFRNTEVsZW1lbnQ7XG4gICAgYW5jaG9ySWQ6IHN0cmluZztcblxuICAgIC8vXG4gICAgY29uc3RydWN0b3Ioc291cmNlOiBIVE1MRWxlbWVudCkge1xuICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsgcmVnaXN0ZXJlZEFuY2hvcnMuc2V0KHNvdXJjZSwgdGhpcyk7IC8vQHRzLWlnbm9yZVxuICAgICAgICB0aGlzLmFuY2hvcklkID0gcmVnaXN0ZXJlZEFuY2hvcklkcy5nZXRPckluc2VydChzb3VyY2UsIGdlbmVyYXRlQW5jaG9ySWQoKSk7XG4gICAgICAgIHRoaXMuc291cmNlLnN0eWxlLnNldFByb3BlcnR5KFwiYW5jaG9yLW5hbWVcIiwgdGhpcy5hbmNob3JJZCk7XG4gICAgICAgIHRoaXMuc291cmNlLnN0eWxlLnNldFByb3BlcnR5KFwicG9zaXRpb24tdmlzaWJpbGl0eVwiLCBgYWx3YXlzYCk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBjb25uZWN0RWxlbWVudChjb25uZWN0OiBIVE1MRWxlbWVudCwge1xuICAgICAgICBwbGFjZW1lbnQgPSBcImZpbGxcIixcbiAgICAgICAgekluZGV4U2hpZnQgPSAxLFxuICAgICAgICBpbnNldCA9IDAsXG4gICAgICAgIHNpemUgPSBcIjEwMCVcIixcbiAgICAgICAgdHJhbnNmb3JtT3JpZ2luID0gXCI1MCUgNTAlXCIsXG4gICAgfSkge1xuICAgICAgICBpZiAocGxhY2VtZW50ID09IFwiZmlsbFwiKSB7XG4gICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwiaW5zZXQtYmxvY2stc3RhcnRcIiwgYGFuY2hvcihzdGFydCwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbnNldC1pbmxpbmUtc3RhcnRcIiwgYGFuY2hvcihzdGFydCwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbnNldC1ibG9jay1lbmRcIiwgYGFuY2hvcihlbmQsICR7aW5zZXR9cHgpYCk7XG4gICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwiaW5zZXQtaW5saW5lLWVuZFwiLCBgYW5jaG9yKGVuZCwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbmxpbmUtc2l6ZVwiLCBgYW5jaG9yLXNpemUoaW5saW5lLCAke3NpemV9KWApO1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImJsb2NrLXNpemVcIiwgYGFuY2hvci1zaXplKGJsb2NrLCAke3NpemV9KWApO1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcInRyYW5zZm9ybS1vcmlnaW5cIiwgdHJhbnNmb3JtT3JpZ2luKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwbGFjZW1lbnQgPT0gXCJib3R0b21cIikge1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImluc2V0LWJsb2NrLXN0YXJ0XCIsIGBhbmNob3IoZW5kLCAke2luc2V0fXB4KWApO1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImluc2V0LWlubGluZS1zdGFydFwiLCBgYW5jaG9yKHN0YXJ0LCAke2luc2V0fXB4KWApO1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImlubGluZS1zaXplXCIsIGBhbmNob3Itc2l6ZShzZWxmLWlubGluZSwgJHtzaXplfSlgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJ0cmFuc2Zvcm0tb3JpZ2luXCIsIHRyYW5zZm9ybU9yaWdpbik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAocGxhY2VtZW50ID09IFwidG9wXCIpIHtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbnNldC1ibG9jay1lbmRcIiwgYGFuY2hvcihzdGFydCwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbnNldC1pbmxpbmUtc3RhcnRcIiwgYGFuY2hvcihzdGFydCwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbmxpbmUtc2l6ZVwiLCBgYW5jaG9yLXNpemUoc2VsZi1pbmxpbmUsICR7c2l6ZX0pYCk7XG4gICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwidHJhbnNmb3JtLW9yaWdpblwiLCB0cmFuc2Zvcm1PcmlnaW4pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHBsYWNlbWVudCA9PSBcImxlZnRcIikge1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImluc2V0LWlubGluZS1zdGFydFwiLCBgYW5jaG9yKGVuZCwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbnNldC1ibG9jay1zdGFydFwiLCBgYW5jaG9yKHN0YXJ0LCAke2luc2V0fXB4KWApO1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImJsb2NrLXNpemVcIiwgYGFuY2hvci1zaXplKHNlbGYtYmxvY2ssICR7c2l6ZX0pYCk7XG4gICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwidHJhbnNmb3JtLW9yaWdpblwiLCB0cmFuc2Zvcm1PcmlnaW4pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHBsYWNlbWVudCA9PSBcInJpZ2h0XCIpIHtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbnNldC1pbmxpbmUtZW5kXCIsIGBhbmNob3Ioc3RhcnQsICR7aW5zZXR9cHgpYCk7XG4gICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwiaW5zZXQtYmxvY2stc3RhcnRcIiwgYGFuY2hvcihzdGFydCwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJibG9jay1zaXplXCIsIGBhbmNob3Itc2l6ZShzZWxmLWJsb2NrLCAke3NpemV9KWApO1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcInRyYW5zZm9ybS1vcmlnaW5cIiwgdHJhbnNmb3JtT3JpZ2luKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChwbGFjZW1lbnQgPT0gXCJjZW50ZXJcIikge1xuICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImluc2V0LWlubGluZS1zdGFydFwiLCBgYW5jaG9yKGNlbnRlciwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbnNldC1ibG9jay1zdGFydFwiLCBgYW5jaG9yKGNlbnRlciwgJHtpbnNldH1weClgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJpbmxpbmUtc2l6ZVwiLCBgYW5jaG9yLXNpemUoc2VsZi1pbmxpbmUsICR7c2l6ZX0pYCk7XG4gICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwiYmxvY2stc2l6ZVwiLCBgYW5jaG9yLXNpemUoc2VsZi1ibG9jaywgJHtzaXplfSlgKTtcbiAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJ0cmFuc2Zvcm0tb3JpZ2luXCIsIHRyYW5zZm9ybU9yaWdpbik7XG4gICAgICAgIH1cblxuICAgICAgICAvL1xuICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwicG9zaXRpb24tdmlzaWJpbGl0eVwiLCBgYWx3YXlzYCk7XG4gICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJwb3NpdGlvbi1hbmNob3JcIiwgdGhpcy5hbmNob3JJZCk7XG4gICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJwb3NpdGlvblwiLCBgYWJzb2x1dGVgKTtcbiAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcInBvc2l0aW9uLWFyZWFcIiwgYHNwYW4tYWxsYCk7XG4gICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJ6LWluZGV4XCIsIFN0cmluZyhnZXRFeGlzdHNaSW5kZXgodGhpcy5zb3VyY2UgPz8gY29ubmVjdCkgKyB6SW5kZXhTaGlmdCkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvLyBFbmhhbmNlZCBhbmNob3IgcG9zaXRpb25pbmcgd2l0aCBjb250YWluZXIgcXVlcnkgYXdhcmVuZXNzXG4gICAgY29ubmVjdFdpdGhDb250YWluZXJRdWVyeShjb25uZWN0OiBIVE1MRWxlbWVudCwge1xuICAgICAgICBwbGFjZW1lbnQgPSBcImZpbGxcIixcbiAgICAgICAgY29udGFpbmVyUXVlcnkgPSBcIihtaW4td2lkdGg6IDc2OHB4KVwiLFxuICAgICAgICBmYWxsYmFja1BsYWNlbWVudCA9IFwiYm90dG9tXCIsXG4gICAgICAgIHpJbmRleFNoaWZ0ID0gMSxcbiAgICAgICAgaW5zZXQgPSAwLFxuICAgICAgICBzaXplID0gXCIxMDAlXCIsXG4gICAgfSkge1xuICAgICAgICAvLyBVc2UgY29udGFpbmVyIHF1ZXJ5IHRvIGRldGVybWluZSBwb3NpdGlvbmluZyBzdHJhdGVneVxuICAgICAgICBjb25zdCBtZWRpYVF1ZXJ5ID0gZ2xvYmFsVGhpcy5tYXRjaE1lZGlhID8gZ2xvYmFsVGhpcy5tYXRjaE1lZGlhKGNvbnRhaW5lclF1ZXJ5KSA6IG51bGw7XG4gICAgICAgIGNvbnN0IHVwZGF0ZVBvc2l0aW9uID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2FuVXNlQW5jaG9yID0gQ1NTLnN1cHBvcnRzICYmIENTUy5zdXBwb3J0cyhcImFuY2hvci1uYW1lXCIsIHRoaXMuYW5jaG9ySWQpO1xuICAgICAgICAgICAgY29uc3QgdXNlTW9kZXJuID0gY2FuVXNlQW5jaG9yICYmIG1lZGlhUXVlcnk/Lm1hdGNoZXM7XG5cbiAgICAgICAgICAgIGlmICh1c2VNb2Rlcm4pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbm5lY3RFbGVtZW50KGNvbm5lY3QsIHsgcGxhY2VtZW50LCB6SW5kZXhTaGlmdCwgaW5zZXQsIHNpemUgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIHRyYWRpdGlvbmFsIHBvc2l0aW9uaW5nXG4gICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5yZW1vdmVQcm9wZXJ0eShcInBvc2l0aW9uLWFuY2hvclwiKTtcbiAgICAgICAgICAgICAgICBjb25uZWN0LnN0eWxlLnJlbW92ZVByb3BlcnR5KFwiYW5jaG9yLW5hbWVcIik7XG4gICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcInBvc2l0aW9uXCIsIFwiYWJzb2x1dGVcIik7XG4gICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcInotaW5kZXhcIiwgU3RyaW5nKGdldEV4aXN0c1pJbmRleCh0aGlzLnNvdXJjZSA/PyBjb25uZWN0KSArIHpJbmRleFNoaWZ0KSk7XG5cbiAgICAgICAgICAgICAgICAvLyBTaW1wbGUgZmFsbGJhY2sgcG9zaXRpb25pbmcgYmFzZWQgb24gc291cmNlIGVsZW1lbnRcbiAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VSZWN0ID0gdGhpcy5zb3VyY2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoZmFsbGJhY2tQbGFjZW1lbnQgPT09IFwiYm90dG9tXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcInRvcFwiLCBgJHtzb3VyY2VSZWN0LmJvdHRvbSArIGluc2V0fXB4YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJsZWZ0XCIsIGAke3NvdXJjZVJlY3QubGVmdCArIGluc2V0fXB4YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJ3aWR0aFwiLCBzaXplKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGZhbGxiYWNrUGxhY2VtZW50ID09PSBcInRvcFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJib3R0b21cIiwgYCR7Z2xvYmFsVGhpcy5pbm5lckhlaWdodCAtIHNvdXJjZVJlY3QudG9wICsgaW5zZXR9cHhgKTtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImxlZnRcIiwgYCR7c291cmNlUmVjdC5sZWZ0ICsgaW5zZXR9cHhgKTtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcIndpZHRoXCIsIHNpemUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZmFsbGJhY2tQbGFjZW1lbnQgPT09IFwicmlnaHRcIikge1xuICAgICAgICAgICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwidG9wXCIsIGAke3NvdXJjZVJlY3QudG9wICsgaW5zZXR9cHhgKTtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcImxlZnRcIiwgYCR7c291cmNlUmVjdC5yaWdodCArIGluc2V0fXB4YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJoZWlnaHRcIiwgc2l6ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChmYWxsYmFja1BsYWNlbWVudCA9PT0gXCJsZWZ0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdC5zdHlsZS5zZXRQcm9wZXJ0eShcInRvcFwiLCBgJHtzb3VyY2VSZWN0LnRvcCArIGluc2V0fXB4YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Quc3R5bGUuc2V0UHJvcGVydHkoXCJyaWdodFwiLCBgJHtnbG9iYWxUaGlzLmlubmVyV2lkdGggLSBzb3VyY2VSZWN0LmxlZnQgKyBpbnNldH1weGApO1xuICAgICAgICAgICAgICAgICAgICBjb25uZWN0LnN0eWxlLnNldFByb3BlcnR5KFwiaGVpZ2h0XCIsIHNpemUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBpZiAobWVkaWFRdWVyeSkge1xuICAgICAgICAgICAgbWVkaWFRdWVyeS5hZGRFdmVudExpc3RlbmVyKFwiY2hhbmdlXCIsIHVwZGF0ZVBvc2l0aW9uKTtcbiAgICAgICAgICAgIHVwZGF0ZVBvc2l0aW9uKCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gKCkgPT4gbWVkaWFRdWVyeT8ucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImNoYW5nZVwiLCB1cGRhdGVQb3NpdGlvbik7XG4gICAgfVxufVxuXG4vL1xuZXhwb3J0IGNvbnN0IG1ha2VBbmNob3JFbGVtZW50ID0gKGFuY2hvckVsZW1lbnQ6IEhUTUxFbGVtZW50KSA9PiB7IC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gcmVnaXN0ZXJlZEFuY2hvcnMuZ2V0T3JJbnNlcnQoYW5jaG9yRWxlbWVudCwgbmV3IENTU0FuY2hvcihhbmNob3JFbGVtZW50KSk7XG59XG4iXX0=
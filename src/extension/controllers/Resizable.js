import { bbh, bbw, cbh, cbw, ROOT } from "fest/dom";
import { makeShiftTrigger, doObserve } from "./Trigger";
import { clamp } from "fest/core";
import { E } from "../../lure/node/Bindings";
import { bindDraggable } from "./PointerAPI";
import { vector2Ref } from "fest/lure";
//
export class ResizeHandler {
    #holder;
    #resizing;
    // @ts-ignore
    get #parent() { return this.#holder.offsetParent ?? this.#holder?.host ?? ROOT; }
    //
    constructor(holder, options) {
        if (!holder) {
            throw Error("Element is null...");
        }
        doObserve(this.#holder = holder, this.#parent);
        this.#resizing = vector2Ref(0, 0);
        if (options)
            this.resizable(options);
    }
    //
    limitResize(real, virtual, holder, container) {
        const widthDiff = cbw(holder) - (bbw(holder) - (this.#resizing.x.value || 0));
        const heightDiff = cbh(holder) - (bbh(holder) - (this.#resizing.y.value || 0));
        // if relative of un-resized to edge corner max-size
        // discount of dragging offset!
        real[0] = clamp(0, virtual?.[0] || 0, widthDiff) || 0;
        real[1] = clamp(0, virtual?.[1] || 0, heightDiff) || 0;
        return real;
    }
    // TODO! Resizing v2 (full reworking for performance)
    resizable(options) {
        const handler = options.handler ?? this.#holder, status = { pointerId: -1 };
        const resizing = this.#resizing, weak = new WeakRef(this.#holder), self_w = new WeakRef(this);
        //
        const dragResolve = (dragging) => {
            const holder = weak?.deref?.();
            holder?.style?.removeProperty?.("will-change");
            //holder?.style?.setProperty("--resize-x", "0");
            //holder?.style?.setProperty("--resize-y", "0");
            queueMicrotask(() => {
                holder?.removeAttribute?.("data-resizing");
            });
        };
        //
        const binding = (grabAction) => handler.addEventListener("pointerdown", makeShiftTrigger((ev) => grabAction(ev, this.#holder), this.#holder));
        const initDrag = () => {
            const starting = [this.#resizing.x.value || 0, this.#resizing.y.value || 0];
            const holder = weak?.deref?.();
            const parent = this.#parent;
            self_w?.deref?.()?.limitResize?.(starting, starting, holder, parent);
            holder?.setAttribute?.("data-resizing", "");
            return starting;
        };
        //
        // Convert Vector2D to array format for bindDraggable compatibility
        const resizingArray = [this.#resizing.x, this.#resizing.y];
        E(this.#holder, { style: {
                "--resize-x": this.#resizing.x,
                "--resize-y": this.#resizing.y
            } });
        //
        return bindDraggable(binding, dragResolve, resizingArray, initDrag);
    }
}
//
export default ResizeHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVzaXphYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUmVzaXphYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFvQyxNQUFNLFVBQVUsQ0FBQztBQUN0RixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3hELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFJbEMsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzdDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDN0MsT0FBTyxFQUFZLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVqRCxFQUFFO0FBQ0YsTUFBTSxPQUFPLGFBQWE7SUFDdEIsT0FBTyxDQUFjO0lBQ3JCLFNBQVMsQ0FBVztJQUVwQixhQUFhO0lBQ2IsSUFBSSxPQUFPLEtBQUssT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRWpGLEVBQUU7SUFDRixZQUFZLE1BQU0sRUFBRSxPQUFhO1FBQzdCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUFDLE1BQU0sS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFBQyxDQUFDO1FBQ25ELFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFBQyxJQUFJLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbEYsSUFBSSxPQUFPO1lBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsRUFB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TyxRQUFRLENBQUM7UUFDcEIsQ0FBQyxDQUFDO1FBRUYsRUFBRTtRQUNGLG1FQUFtRTtRQUNuRSxNQUFNLGFBQWEsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0QsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUU7Z0JBQ3JCLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzlCLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDakMsRUFBRSxDQUFDLENBQUM7UUFFTCxFQUFFO1FBQ0YsT0FBTyxhQUFhLENBQUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDeEUsQ0FBQztDQUNKO0FBRUQsRUFBRTtBQUNGLGVBQWUsYUFBYSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYmJoLCBiYncsIGNiaCwgY2J3LCBST09ULCB0eXBlIEludGVyYWN0U3RhdHVzLCBSQUZCZWhhdmlvciB9IGZyb20gXCJmZXN0L2RvbVwiO1xuaW1wb3J0IHsgbWFrZVNoaWZ0VHJpZ2dlciwgZG9PYnNlcnZlIH0gZnJvbSBcIi4vVHJpZ2dlclwiO1xuaW1wb3J0IHsgY2xhbXAgfSBmcm9tIFwiZmVzdC9jb3JlXCI7XG5cbi8vXG5pbXBvcnQgeyBudW1iZXJSZWYgfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7IEUgfSBmcm9tIFwiLi4vLi4vbHVyZS9ub2RlL0JpbmRpbmdzXCI7XG5pbXBvcnQgeyBiaW5kRHJhZ2dhYmxlIH0gZnJvbSBcIi4vUG9pbnRlckFQSVwiO1xuaW1wb3J0IHsgVmVjdG9yMkQsIHZlY3RvcjJSZWYgfSBmcm9tIFwiZmVzdC9sdXJlXCI7XG5cbi8vXG5leHBvcnQgY2xhc3MgUmVzaXplSGFuZGxlciB7XG4gICAgI2hvbGRlcjogSFRNTEVsZW1lbnQ7XG4gICAgI3Jlc2l6aW5nOiBWZWN0b3IyRDtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBnZXQgI3BhcmVudCgpIHsgcmV0dXJuIHRoaXMuI2hvbGRlci5vZmZzZXRQYXJlbnQgPz8gdGhpcy4jaG9sZGVyPy5ob3N0ID8/IFJPT1Q7IH1cblxuICAgIC8vXG4gICAgY29uc3RydWN0b3IoaG9sZGVyLCBvcHRpb25zPzogYW55KSB7XG4gICAgICAgIGlmICghaG9sZGVyKSB7IHRocm93IEVycm9yKFwiRWxlbWVudCBpcyBudWxsLi4uXCIpOyB9XG4gICAgICAgIGRvT2JzZXJ2ZSh0aGlzLiNob2xkZXIgPSBob2xkZXIsIHRoaXMuI3BhcmVudCk7IHRoaXMuI3Jlc2l6aW5nID0gdmVjdG9yMlJlZigwLCAwKTtcbiAgICAgICAgaWYgKG9wdGlvbnMpIHRoaXMucmVzaXphYmxlKG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8vXG4gICAgbGltaXRSZXNpemUocmVhbCwgdmlydHVhbCwgaG9sZGVyLCBjb250YWluZXIpIHtcbiAgICAgICAgY29uc3Qgd2lkdGhEaWZmICA9IGNidyhob2xkZXIpIC0gKGJidyhob2xkZXIpIC0gKHRoaXMuI3Jlc2l6aW5nLngudmFsdWUgfHwgMCkpO1xuICAgICAgICBjb25zdCBoZWlnaHREaWZmID0gY2JoKGhvbGRlcikgLSAoYmJoKGhvbGRlcikgLSAodGhpcy4jcmVzaXppbmcueS52YWx1ZSB8fCAwKSk7XG5cbiAgICAgICAgLy8gaWYgcmVsYXRpdmUgb2YgdW4tcmVzaXplZCB0byBlZGdlIGNvcm5lciBtYXgtc2l6ZVxuICAgICAgICAvLyBkaXNjb3VudCBvZiBkcmFnZ2luZyBvZmZzZXQhXG4gICAgICAgIHJlYWxbMF0gPSBjbGFtcCgwLCB2aXJ0dWFsPy5bMF0gfHwgMCwgd2lkdGhEaWZmKSB8fCAwO1xuICAgICAgICByZWFsWzFdID0gY2xhbXAoMCwgdmlydHVhbD8uWzFdIHx8IDAsIGhlaWdodERpZmYpIHx8IDA7XG4gICAgICAgIHJldHVybiByZWFsO1xuICAgIH1cblxuICAgIC8vIFRPRE8hIFJlc2l6aW5nIHYyIChmdWxsIHJld29ya2luZyBmb3IgcGVyZm9ybWFuY2UpXG4gICAgcmVzaXphYmxlKG9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgaGFuZGxlciAgPSBvcHRpb25zLmhhbmRsZXIgPz8gdGhpcy4jaG9sZGVyLCBzdGF0dXM6IEludGVyYWN0U3RhdHVzID0geyBwb2ludGVySWQ6IC0xIH07XG4gICAgICAgIGNvbnN0IHJlc2l6aW5nID0gdGhpcy4jcmVzaXppbmcsIHdlYWsgPSBuZXcgV2Vha1JlZih0aGlzLiNob2xkZXIpLCBzZWxmX3cgPSBuZXcgV2Vha1JlZih0aGlzKTtcblxuICAgICAgICAvL1xuICAgICAgICBjb25zdCBkcmFnUmVzb2x2ZSA9IChkcmFnZ2luZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgaG9sZGVyID0gd2Vhaz8uZGVyZWY/LigpIGFzIGFueTtcbiAgICAgICAgICAgIGhvbGRlcj8uc3R5bGU/LnJlbW92ZVByb3BlcnR5Py4oXCJ3aWxsLWNoYW5nZVwiKTtcbiAgICAgICAgICAgIC8vaG9sZGVyPy5zdHlsZT8uc2V0UHJvcGVydHkoXCItLXJlc2l6ZS14XCIsIFwiMFwiKTtcbiAgICAgICAgICAgIC8vaG9sZGVyPy5zdHlsZT8uc2V0UHJvcGVydHkoXCItLXJlc2l6ZS15XCIsIFwiMFwiKTtcbiAgICAgICAgICAgIHF1ZXVlTWljcm90YXNrKCgpPT57XG4gICAgICAgICAgICAgICAgaG9sZGVyPy5yZW1vdmVBdHRyaWJ1dGU/LihcImRhdGEtcmVzaXppbmdcIik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICAvL1xuICAgICAgICBjb25zdCBiaW5kaW5nICA9IChncmFiQWN0aW9uKT0+aGFuZGxlci5hZGRFdmVudExpc3RlbmVyKFwicG9pbnRlcmRvd25cIiwgbWFrZVNoaWZ0VHJpZ2dlcigoZXYpPT5ncmFiQWN0aW9uKGV2LCB0aGlzLiNob2xkZXIpLCB0aGlzLiNob2xkZXIpKTtcbiAgICAgICAgY29uc3QgaW5pdERyYWcgPSAoKT0+e1xuICAgICAgICAgICAgY29uc3Qgc3RhcnRpbmcgPSBbdGhpcy4jcmVzaXppbmcueC52YWx1ZSB8fCAwLCB0aGlzLiNyZXNpemluZy55LnZhbHVlIHx8IDBdO1xuICAgICAgICAgICAgY29uc3QgaG9sZGVyID0gd2Vhaz8uZGVyZWY/LigpIGFzIGFueTtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuI3BhcmVudDtcbiAgICAgICAgICAgIHNlbGZfdz8uZGVyZWY/LigpPy5saW1pdFJlc2l6ZT8uKHN0YXJ0aW5nLCBzdGFydGluZywgaG9sZGVyLCBwYXJlbnQpXG4gICAgICAgICAgICBob2xkZXI/LnNldEF0dHJpYnV0ZT8uKFwiZGF0YS1yZXNpemluZ1wiLCBcIlwiKTtcbiAgICAgICAgICAgIHJldHVybiBzdGFydGluZztcbiAgICAgICAgfTtcblxuICAgICAgICAvL1xuICAgICAgICAvLyBDb252ZXJ0IFZlY3RvcjJEIHRvIGFycmF5IGZvcm1hdCBmb3IgYmluZERyYWdnYWJsZSBjb21wYXRpYmlsaXR5XG4gICAgICAgIGNvbnN0IHJlc2l6aW5nQXJyYXkgPSBbdGhpcy4jcmVzaXppbmcueCwgdGhpcy4jcmVzaXppbmcueV07XG4gICAgICAgIEUodGhpcy4jaG9sZGVyLCB7IHN0eWxlOiB7XG4gICAgICAgICAgICBcIi0tcmVzaXplLXhcIjogdGhpcy4jcmVzaXppbmcueCxcbiAgICAgICAgICAgIFwiLS1yZXNpemUteVwiOiB0aGlzLiNyZXNpemluZy55XG4gICAgICAgIH0gfSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgcmV0dXJuIGJpbmREcmFnZ2FibGUoYmluZGluZywgZHJhZ1Jlc29sdmUsIHJlc2l6aW5nQXJyYXksIGluaXREcmFnKTtcbiAgICB9XG59XG5cbi8vXG5leHBvcnQgZGVmYXVsdCBSZXNpemVIYW5kbGVyO1xuIl19
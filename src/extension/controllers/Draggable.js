import { setStyleProperty, ROOT } from "fest/dom";
import { makeShiftTrigger, doObserve } from "./Trigger";
import { bindDraggable } from "./PointerAPI";
//
//import {  E  } from "fest/lure";
import { affected } from "fest/object";
import { Vector2D, vector2Ref, clampPointToRect, createRect2D } from "fest/lure";
//
const _LOG_ = (...args) => { console.log(...args); return args?.[0]; };
//
export class DragHandler {
    #holder;
    #dragging;
    #raf = 0;
    #pending;
    #options;
    #subscriptions;
    // @ts-ignore
    get #parent() { return this.#holder.offsetParent ?? this.#holder?.host ?? ROOT; }
    //
    constructor(holder, options) {
        if (!holder) {
            throw Error("Element is null...");
        }
        doObserve(this.#holder = holder, this.#parent);
        this.#dragging = vector2Ref(0, 0);
        this.#pending = vector2Ref(0, 0);
        this.#options = options;
        setStyleProperty(this.#holder, "--drag-x", 0);
        setStyleProperty(this.#holder, "--drag-y", 0);
        this.#attachObservers();
        if (options)
            this.draggable(options);
    }
    //
    #queueFrame(x = 0, y = 0) {
        let constrainedX = x || 0;
        let constrainedY = y || 0;
        // Apply constraints if specified
        if (this.#options?.constraints?.bounds) {
            const bounds = this.#options.constraints.bounds;
            const centerOffset = this.#options.constraints.centerOffset || vector2Ref(0, 0);
            // Calculate element bounds for constraint checking
            const elementSize = vector2Ref(this.#holder.offsetWidth, this.#holder.offsetHeight);
            const elementBounds = createRect2D(constrainedX, constrainedY, elementSize.x, elementSize.y);
            // Apply bounds constraints
            const constrainedPos = clampPointToRect(new Vector2D(constrainedX + centerOffset.x.value, constrainedY + centerOffset.y.value), bounds);
            constrainedX = constrainedPos.x.value - centerOffset.x.value;
            constrainedY = constrainedPos.y.value - centerOffset.y.value;
        }
        // Apply grid snapping if specified
        if (this.#options?.constraints?.snapToGrid) {
            const { size: gridSize, offset: gridOffset } = this.#options.constraints.snapToGrid;
            constrainedX = Math.round((constrainedX - gridOffset.x.value) / gridSize.x.value) * gridSize.x.value + gridOffset.x.value;
            constrainedY = Math.round((constrainedY - gridOffset.y.value) / gridSize.y.value) * gridSize.y.value + gridOffset.y.value;
        }
        this.#pending.x.value = constrainedX;
        this.#pending.y.value = constrainedY;
        if (this.#raf) {
            return;
        }
        this.#raf = requestAnimationFrame(() => {
            this.#raf = 0;
            const dx = this.#pending.x.value;
            const dy = this.#pending.y.value;
            //
            //setStyleProperty(this.#holder, "--drag-x", dx || 0);
            //setStyleProperty(this.#holder, "--drag-y", dy || 0);
            //setStyleProperty(this.#holder, "transform", `translate3d(calc(var(--drag-x, 0) * 1px), calc(var(--drag-y, 0) * 1px), 0px)`);
            // CSS variables slows down the animation, so we use transform instead
            setStyleProperty(this.#holder, "transform", `translate3d(
                clamp(calc(-1px * var(--shift-x, 0)), ${dx || 0}px, calc(100cqi - 100% - var(--shift-x, 0) * 1px)),
                clamp(calc(-1px * var(--shift-y, 0)), ${dy || 0}px, calc(100cqb - 100% - var(--shift-y, 0) * 1px)),
                0px)`?.trim?.()?.replaceAll?.(/\s+/g, " ")?.replaceAll?.(/\n+/g, " ")?.trim?.() ?? "");
        });
    }
    #attachObservers() {
        if (this.#subscriptions) {
            return;
        }
        const emit = () => {
            this.#queueFrame(this.#dragging.x.value, this.#dragging.y.value);
        };
        this.#subscriptions = [
            affected(this.#dragging.x, emit),
            affected(this.#dragging.y, emit),
        ];
        emit();
    }
    //
    draggable(options) {
        const handler = options.handler ?? this.#holder;
        const dragging = this.#dragging;
        this.#attachObservers();
        //
        const weak = new WeakRef(this.#holder);
        const binding = (grabAction) => handler.addEventListener("pointerdown", makeShiftTrigger((ev) => grabAction(ev, this.#holder), this.#holder));
        const dragResolve = (dragging) => {
            const holder = weak?.deref?.();
            holder?.style?.removeProperty?.("will-change");
            queueMicrotask(() => {
                holder?.removeAttribute?.("data-dragging");
                holder?.style?.removeProperty?.("transform");
            });
            //
            const box = /*getBoundingOrientRect(holder) ||*/ holder?.getBoundingClientRect?.();
            this.#dragging.x.value = 0;
            this.#dragging.y.value = 0;
            this.#queueFrame(0, 0);
            //
            setStyleProperty(holder, "--shift-x", (box?.left || 0));
            setStyleProperty(holder, "--shift-y", (box?.top || 0));
        };
        //
        // Convert Vector2D to array format for bindDraggable compatibility
        const draggingArray = [this.#dragging.x, this.#dragging.y];
        return bindDraggable(binding, dragResolve, draggingArray, () => {
            const holder = weak?.deref?.();
            holder?.setAttribute?.("data-dragging", "");
            holder?.style?.setProperty("will-change", "inset, translate, transform, opacity, z-index");
            this.#queueFrame(this.#dragging.x.value, this.#dragging.y.value);
            return [0, 0];
        });
    }
}
//
export default DragHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRHJhZ2dhYmxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRHJhZ2dhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBZSxJQUFJLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDL0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBRTdDLEVBQUU7QUFDRixrQ0FBa0M7QUFDbEMsT0FBTyxFQUFhLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNsRCxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBVSxnQkFBZ0IsRUFBRSxZQUFZLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFZekYsRUFBRTtBQUNGLE1BQU0sS0FBSyxHQUFHLENBQUMsR0FBRyxJQUFJLEVBQUMsRUFBRSxHQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFFckUsRUFBRTtBQUNGLE1BQU0sT0FBTyxXQUFXO0lBQ3BCLE9BQU8sQ0FBYztJQUNyQixTQUFTLENBQVc7SUFDcEIsSUFBSSxHQUFHLENBQUMsQ0FBQztJQUNULFFBQVEsQ0FBVztJQUNuQixRQUFRLENBQXNCO0lBQzlCLGNBQWMsQ0FBcUI7SUFFbkMsYUFBYTtJQUNiLElBQUksT0FBTyxLQUFLLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztJQUVqRixFQUFFO0lBQ0YsWUFBWSxNQUFNLEVBQUUsT0FBMkI7UUFDM0MsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQUMsTUFBTSxLQUFLLENBQUMsb0JBQW9CLENBQUMsQ0FBQztR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QyxDQUFDO1lBQzNGLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pFLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUFFRCxFQUFFO0FBQ0YsZUFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzZXRTdHlsZVByb3BlcnR5LCBSQUZCZWhhdmlvciwgUk9PVCB9IGZyb20gXCJmZXN0L2RvbVwiO1xuaW1wb3J0IHsgbWFrZVNoaWZ0VHJpZ2dlciwgZG9PYnNlcnZlIH0gZnJvbSBcIi4vVHJpZ2dlclwiO1xuaW1wb3J0IHsgYmluZERyYWdnYWJsZSB9IGZyb20gXCIuL1BvaW50ZXJBUElcIjtcblxuLy9cbi8vaW1wb3J0IHsgIEUgIH0gZnJvbSBcImZlc3QvbHVyZVwiO1xuaW1wb3J0IHsgbnVtYmVyUmVmLCBhZmZlY3RlZCB9IGZyb20gXCJmZXN0L29iamVjdFwiO1xuaW1wb3J0IHsgVmVjdG9yMkQsIHZlY3RvcjJSZWYsIFJlY3QyRCwgY2xhbXBQb2ludFRvUmVjdCwgY3JlYXRlUmVjdDJEIH0gZnJvbSBcImZlc3QvbHVyZVwiO1xuXG4vL1xuaW50ZXJmYWNlIERyYWdIYW5kbGVyT3B0aW9ucyB7XG4gICAgaGFuZGxlcj86IEhUTUxFbGVtZW50O1xuICAgIGNvbnN0cmFpbnRzPzoge1xuICAgICAgICBib3VuZHM/OiBSZWN0MkQ7ICAgICAgLy8gRHJhZyB3aXRoaW4gdGhlc2UgYm91bmRzXG4gICAgICAgIGNlbnRlck9mZnNldD86IFZlY3RvcjJEOyAvLyBPZmZzZXQgZnJvbSBjZW50ZXIgZm9yIGJvdW5kcyBjaGVja2luZ1xuICAgICAgICBzbmFwVG9HcmlkPzogeyBzaXplOiBWZWN0b3IyRCwgb2Zmc2V0OiBWZWN0b3IyRCB9OyAvLyBHcmlkIHNuYXBwaW5nXG4gICAgfTtcbn1cblxuLy9cbmNvbnN0IF9MT0dfID0gKC4uLmFyZ3MpPT57IGNvbnNvbGUubG9nKC4uLmFyZ3MpOyByZXR1cm4gYXJncz8uWzBdOyB9O1xuXG4vL1xuZXhwb3J0IGNsYXNzIERyYWdIYW5kbGVyIHtcbiAgICAjaG9sZGVyOiBIVE1MRWxlbWVudDtcbiAgICAjZHJhZ2dpbmc6IFZlY3RvcjJEO1xuICAgICNyYWYgPSAwO1xuICAgICNwZW5kaW5nOiBWZWN0b3IyRDtcbiAgICAjb3B0aW9ucz86IERyYWdIYW5kbGVyT3B0aW9ucztcbiAgICAjc3Vic2NyaXB0aW9ucz86IEFycmF5PCgpID0+IHZvaWQ+O1xuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGdldCAjcGFyZW50KCkgeyByZXR1cm4gdGhpcy4jaG9sZGVyLm9mZnNldFBhcmVudCA/PyB0aGlzLiNob2xkZXI/Lmhvc3QgPz8gUk9PVDsgfVxuXG4gICAgLy9cbiAgICBjb25zdHJ1Y3Rvcihob2xkZXIsIG9wdGlvbnM6IERyYWdIYW5kbGVyT3B0aW9ucykge1xuICAgICAgICBpZiAoIWhvbGRlcikgeyB0aHJvdyBFcnJvcihcIkVsZW1lbnQgaXMgbnVsbC4uLlwiKTsgfVxuICAgICAgICBkb09ic2VydmUodGhpcy4jaG9sZGVyID0gaG9sZGVyLCB0aGlzLiNwYXJlbnQpO1xuICAgICAgICB0aGlzLiNkcmFnZ2luZyA9IHZlY3RvcjJSZWYoMCwgMCk7XG4gICAgICAgIHRoaXMuI3BlbmRpbmcgPSB2ZWN0b3IyUmVmKDAsIDApO1xuICAgICAgICB0aGlzLiNvcHRpb25zID0gb3B0aW9ucztcbiAgICAgICAgc2V0U3R5bGVQcm9wZXJ0eSh0aGlzLiNob2xkZXIsIFwiLS1kcmFnLXhcIiwgMCk7XG4gICAgICAgIHNldFN0eWxlUHJvcGVydHkodGhpcy4jaG9sZGVyLCBcIi0tZHJhZy15XCIsIDApO1xuICAgICAgICB0aGlzLiNhdHRhY2hPYnNlcnZlcnMoKTtcbiAgICAgICAgaWYgKG9wdGlvbnMpIHRoaXMuZHJhZ2dhYmxlKG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8vXG4gICAgI3F1ZXVlRnJhbWUoeCA9IDAsIHkgPSAwKSB7XG4gICAgICAgIGxldCBjb25zdHJhaW5lZFggPSB4IHx8IDA7XG4gICAgICAgIGxldCBjb25zdHJhaW5lZFkgPSB5IHx8IDA7XG5cbiAgICAgICAgLy8gQXBwbHkgY29uc3RyYWludHMgaWYgc3BlY2lmaWVkXG4gICAgICAgIGlmICh0aGlzLiNvcHRpb25zPy5jb25zdHJhaW50cz8uYm91bmRzKSB7XG4gICAgICAgICAgICBjb25zdCBib3VuZHMgPSB0aGlzLiNvcHRpb25zLmNvbnN0cmFpbnRzLmJvdW5kcztcbiAgICAgICAgICAgIGNvbnN0IGNlbnRlck9mZnNldCA9IHRoaXMuI29wdGlvbnMuY29uc3RyYWludHMuY2VudGVyT2Zmc2V0IHx8IHZlY3RvcjJSZWYoMCwgMCk7XG5cbiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBlbGVtZW50IGJvdW5kcyBmb3IgY29uc3RyYWludCBjaGVja2luZ1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudFNpemUgPSB2ZWN0b3IyUmVmKHRoaXMuI2hvbGRlci5vZmZzZXRXaWR0aCwgdGhpcy4jaG9sZGVyLm9mZnNldEhlaWdodCk7XG4gICAgICAgICAgICBjb25zdCBlbGVtZW50Qm91bmRzID0gY3JlYXRlUmVjdDJEKGNvbnN0cmFpbmVkWCwgY29uc3RyYWluZWRZLCBlbGVtZW50U2l6ZS54LCBlbGVtZW50U2l6ZS55KTtcblxuICAgICAgICAgICAgLy8gQXBwbHkgYm91bmRzIGNvbnN0cmFpbnRzXG4gICAgICAgICAgICBjb25zdCBjb25zdHJhaW5lZFBvcyA9IGNsYW1wUG9pbnRUb1JlY3QoXG4gICAgICAgICAgICAgICAgbmV3IFZlY3RvcjJEKGNvbnN0cmFpbmVkWCArIGNlbnRlck9mZnNldC54LnZhbHVlLCBjb25zdHJhaW5lZFkgKyBjZW50ZXJPZmZzZXQueS52YWx1ZSksXG4gICAgICAgICAgICAgICAgYm91bmRzXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICBjb25zdHJhaW5lZFggPSBjb25zdHJhaW5lZFBvcy54LnZhbHVlIC0gY2VudGVyT2Zmc2V0LngudmFsdWU7XG4gICAgICAgICAgICBjb25zdHJhaW5lZFkgPSBjb25zdHJhaW5lZFBvcy55LnZhbHVlIC0gY2VudGVyT2Zmc2V0LnkudmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBcHBseSBncmlkIHNuYXBwaW5nIGlmIHNwZWNpZmllZFxuICAgICAgICBpZiAodGhpcy4jb3B0aW9ucz8uY29uc3RyYWludHM/LnNuYXBUb0dyaWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHsgc2l6ZTogZ3JpZFNpemUsIG9mZnNldDogZ3JpZE9mZnNldCB9ID0gdGhpcy4jb3B0aW9ucy5jb25zdHJhaW50cy5zbmFwVG9HcmlkO1xuICAgICAgICAgICAgY29uc3RyYWluZWRYID0gTWF0aC5yb3VuZCgoY29uc3RyYWluZWRYIC0gZ3JpZE9mZnNldC54LnZhbHVlKSAvIGdyaWRTaXplLngudmFsdWUpICogZ3JpZFNpemUueC52YWx1ZSArIGdyaWRPZmZzZXQueC52YWx1ZTtcbiAgICAgICAgICAgIGNvbnN0cmFpbmVkWSA9IE1hdGgucm91bmQoKGNvbnN0cmFpbmVkWSAtIGdyaWRPZmZzZXQueS52YWx1ZSkgLyBncmlkU2l6ZS55LnZhbHVlKSAqIGdyaWRTaXplLnkudmFsdWUgKyBncmlkT2Zmc2V0LnkudmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLiNwZW5kaW5nLngudmFsdWUgPSBjb25zdHJhaW5lZFg7XG4gICAgICAgIHRoaXMuI3BlbmRpbmcueS52YWx1ZSA9IGNvbnN0cmFpbmVkWTtcblxuICAgICAgICBpZiAodGhpcy4jcmFmKSB7IHJldHVybjsgfVxuICAgICAgICB0aGlzLiNyYWYgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy4jcmFmID0gMDtcbiAgICAgICAgICAgIGNvbnN0IGR4ID0gdGhpcy4jcGVuZGluZy54LnZhbHVlO1xuICAgICAgICAgICAgY29uc3QgZHkgPSB0aGlzLiNwZW5kaW5nLnkudmFsdWU7XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAvL3NldFN0eWxlUHJvcGVydHkodGhpcy4jaG9sZGVyLCBcIi0tZHJhZy14XCIsIGR4IHx8IDApO1xuICAgICAgICAgICAgLy9zZXRTdHlsZVByb3BlcnR5KHRoaXMuI2hvbGRlciwgXCItLWRyYWcteVwiLCBkeSB8fCAwKTtcbiAgICAgICAgICAgIC8vc2V0U3R5bGVQcm9wZXJ0eSh0aGlzLiNob2xkZXIsIFwidHJhbnNmb3JtXCIsIGB0cmFuc2xhdGUzZChjYWxjKHZhcigtLWRyYWcteCwgMCkgKiAxcHgpLCBjYWxjKHZhcigtLWRyYWcteSwgMCkgKiAxcHgpLCAwcHgpYCk7XG5cbiAgICAgICAgICAgIC8vIENTUyB2YXJpYWJsZXMgc2xvd3MgZG93biB0aGUgYW5pbWF0aW9uLCBzbyB3ZSB1c2UgdHJhbnNmb3JtIGluc3RlYWRcbiAgICAgICAgICAgIHNldFN0eWxlUHJvcGVydHkodGhpcy4jaG9sZGVyLCBcInRyYW5zZm9ybVwiLCBgdHJhbnNsYXRlM2QoXG4gICAgICAgICAgICAgICAgY2xhbXAoY2FsYygtMXB4ICogdmFyKC0tc2hpZnQteCwgMCkpLCAke2R4IHx8IDB9cHgsIGNhbGMoMTAwY3FpIC0gMTAwJSAtIHZhcigtLXNoaWZ0LXgsIDApICogMXB4KSksXG4gICAgICAgICAgICAgICAgY2xhbXAoY2FsYygtMXB4ICogdmFyKC0tc2hpZnQteSwgMCkpLCAke2R5IHx8IDB9cHgsIGNhbGMoMTAwY3FiIC0gMTAwJSAtIHZhcigtLXNoaWZ0LXksIDApICogMXB4KSksXG4gICAgICAgICAgICAgICAgMHB4KWA/LnRyaW0/LigpPy5yZXBsYWNlQWxsPy4oL1xccysvZywgXCIgXCIpPy5yZXBsYWNlQWxsPy4oL1xcbisvZywgXCIgXCIpPy50cmltPy4oKSA/PyBcIlwiKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgI2F0dGFjaE9ic2VydmVycygpIHtcbiAgICAgICAgaWYgKHRoaXMuI3N1YnNjcmlwdGlvbnMpIHsgcmV0dXJuOyB9XG4gICAgICAgIGNvbnN0IGVtaXQgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLiNxdWV1ZUZyYW1lKFxuICAgICAgICAgICAgICAgIHRoaXMuI2RyYWdnaW5nLngudmFsdWUsXG4gICAgICAgICAgICAgICAgdGhpcy4jZHJhZ2dpbmcueS52YWx1ZVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy4jc3Vic2NyaXB0aW9ucyA9IFtcbiAgICAgICAgICAgIGFmZmVjdGVkKHRoaXMuI2RyYWdnaW5nLngsIGVtaXQpLFxuICAgICAgICAgICAgYWZmZWN0ZWQodGhpcy4jZHJhZ2dpbmcueSwgZW1pdCksXG4gICAgICAgIF07XG4gICAgICAgIGVtaXQoKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGRyYWdnYWJsZShvcHRpb25zOiBEcmFnSGFuZGxlck9wdGlvbnMpIHtcbiAgICAgICAgY29uc3QgaGFuZGxlciA9IG9wdGlvbnMuaGFuZGxlciA/PyB0aGlzLiNob2xkZXI7XG4gICAgICAgIGNvbnN0IGRyYWdnaW5nID0gdGhpcy4jZHJhZ2dpbmc7XG4gICAgICAgIHRoaXMuI2F0dGFjaE9ic2VydmVycygpO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGNvbnN0IHdlYWsgICAgICAgID0gbmV3IFdlYWtSZWYodGhpcy4jaG9sZGVyKTtcbiAgICAgICAgY29uc3QgYmluZGluZyAgICAgPSAoZ3JhYkFjdGlvbikgPT4gaGFuZGxlci5hZGRFdmVudExpc3RlbmVyKFwicG9pbnRlcmRvd25cIiwgbWFrZVNoaWZ0VHJpZ2dlcigoZXYpPT5ncmFiQWN0aW9uKGV2LCB0aGlzLiNob2xkZXIpLCB0aGlzLiNob2xkZXIpKTtcbiAgICAgICAgY29uc3QgZHJhZ1Jlc29sdmUgPSAoZHJhZ2dpbmcpICAgPT4ge1xuICAgICAgICAgICAgY29uc3QgaG9sZGVyID0gd2Vhaz8uZGVyZWY/LigpIGFzIGFueTtcbiAgICAgICAgICAgIGhvbGRlcj8uc3R5bGU/LnJlbW92ZVByb3BlcnR5Py4oXCJ3aWxsLWNoYW5nZVwiKTtcbiAgICAgICAgICAgIHF1ZXVlTWljcm90YXNrKCgpPT57XG4gICAgICAgICAgICAgICAgaG9sZGVyPy5yZW1vdmVBdHRyaWJ1dGU/LihcImRhdGEtZHJhZ2dpbmdcIik7XG4gICAgICAgICAgICAgICAgaG9sZGVyPy5zdHlsZT8ucmVtb3ZlUHJvcGVydHk/LihcInRyYW5zZm9ybVwiKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgY29uc3QgYm94ID0gLypnZXRCb3VuZGluZ09yaWVudFJlY3QoaG9sZGVyKSB8fCovIGhvbGRlcj8uZ2V0Qm91bmRpbmdDbGllbnRSZWN0Py4oKTtcbiAgICAgICAgICAgIHRoaXMuI2RyYWdnaW5nLngudmFsdWUgPSAwO1xuICAgICAgICAgICAgdGhpcy4jZHJhZ2dpbmcueS52YWx1ZSA9IDA7XG4gICAgICAgICAgICB0aGlzLiNxdWV1ZUZyYW1lKDAsIDApO1xuXG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgc2V0U3R5bGVQcm9wZXJ0eShob2xkZXIsIFwiLS1zaGlmdC14XCIsIChib3g/LmxlZnQgfHwgMCkpO1xuICAgICAgICAgICAgc2V0U3R5bGVQcm9wZXJ0eShob2xkZXIsIFwiLS1zaGlmdC15XCIsIChib3g/LnRvcCAgfHwgMCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgLy8gQ29udmVydCBWZWN0b3IyRCB0byBhcnJheSBmb3JtYXQgZm9yIGJpbmREcmFnZ2FibGUgY29tcGF0aWJpbGl0eVxuICAgICAgICBjb25zdCBkcmFnZ2luZ0FycmF5ID0gW3RoaXMuI2RyYWdnaW5nLngsIHRoaXMuI2RyYWdnaW5nLnldO1xuICAgICAgICByZXR1cm4gYmluZERyYWdnYWJsZShiaW5kaW5nLCBkcmFnUmVzb2x2ZSwgZHJhZ2dpbmdBcnJheSwgKCk9PntcbiAgICAgICAgICAgIGNvbnN0IGhvbGRlciA9IHdlYWs/LmRlcmVmPy4oKSBhcyBhbnk7XG4gICAgICAgICAgICBob2xkZXI/LnNldEF0dHJpYnV0ZT8uKFwiZGF0YS1kcmFnZ2luZ1wiLCBcIlwiKTtcbiAgICAgICAgICAgIGhvbGRlcj8uc3R5bGU/LnNldFByb3BlcnR5KFwid2lsbC1jaGFuZ2VcIiwgXCJpbnNldCwgdHJhbnNsYXRlLCB0cmFuc2Zvcm0sIG9wYWNpdHksIHotaW5kZXhcIik7XG4gICAgICAgICAgICB0aGlzLiNxdWV1ZUZyYW1lKHRoaXMuI2RyYWdnaW5nLngudmFsdWUsIHRoaXMuI2RyYWdnaW5nLnkudmFsdWUpO1xuICAgICAgICAgICAgcmV0dXJuIFswLCAwXTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG4vL1xuZXhwb3J0IGRlZmF1bHQgRHJhZ0hhbmRsZXI7XG4iXX0=
const hubsByTarget = new WeakMap();
const keyOf = (type, options) => {
    const capture = options?.capture ? "1" : "0";
    const passive = options?.passive ? "1" : "0";
    return `${type}|c:${capture}|p:${passive}`;
};
export const lazyAddEventListener = (target, type, handler, options = {}) => {
    if (!target || typeof target.addEventListener !== "function")
        return () => { };
    // `once` is not compatible with a shared hub listener; callers should implement their own once-logic.
    const normalized = {
        capture: Boolean(options.capture),
        passive: Boolean(options.passive),
    };
    const key = keyOf(type, normalized);
    let hubs = hubsByTarget.get(target);
    if (!hubs) {
        hubs = new Map();
        hubsByTarget.set(target, hubs);
    }
    let hub = hubs.get(key);
    if (!hub) {
        const handlers = new Set();
        const listener = (ev) => {
            for (const cb of Array.from(handlers)) {
                try {
                    cb(ev);
                }
                catch (e) {
                    console.warn(e);
                }
            }
        };
        hubs.set(key, hub = { handlers, listener, options: normalized });
        target.addEventListener(type, listener, normalized);
    }
    hub.handlers.add(handler);
    return () => {
        const hubsNow = hubsByTarget.get(target);
        const hubNow = hubsNow?.get(key);
        if (!hubNow)
            return;
        hubNow.handlers.delete(handler);
        if (hubNow.handlers.size > 0)
            return;
        target.removeEventListener(type, hubNow.listener, hubNow.options);
        hubsNow?.delete(key);
        if (hubsNow && hubsNow.size === 0)
            hubsByTarget.delete(target);
    };
};
const proxiedByRoot = new WeakMap();
const resolveHTMLElement = (el) => {
    const resolved = el?.element ?? el;
    return resolved instanceof HTMLElement ? resolved : null;
};
const shouldApply = (when, hadMatch, hadHandled) => {
    if (!when)
        return false;
    if (when === "handled")
        return hadHandled;
    return hadMatch;
};
/**
 * Proxied events:
 * - Installs **one** real DOM listener on `root` (per event/options/config), but only after the first element handler registers.
 * - Routes events to registered element handlers based on the composed path.
 * - Can conditionally call preventDefault/stop* only when a trigger matches (or when handled).
 */
export const addProxiedEvent = (root, type, options = { capture: true, passive: false }, config = {}) => {
    const target = root;
    if (!target || typeof target.addEventListener !== "function") {
        return (_element, _handler) => () => { };
    }
    const normalized = {
        capture: Boolean(options.capture),
        passive: Boolean(options.passive),
    };
    const strategy = config.strategy ?? "closest";
    const key = `${type}|c:${normalized.capture ? "1" : "0"}|p:${normalized.passive ? "1" : "0"}|s:${strategy}|pd:${String(config.preventDefault ?? "")}|sp:${String(config.stopPropagation ?? "")}|sip:${String(config.stopImmediatePropagation ?? "")}`;
    let hubs = proxiedByRoot.get(target);
    if (!hubs) {
        hubs = new Map();
        proxiedByRoot.set(target, hubs);
    }
    let hub = hubs.get(key);
    if (!hub) {
        const targets = new Map();
        const dispatch = (ev) => {
            let hadMatch = false;
            let hadHandled = false;
            const callSet = (set) => {
                if (!set || set.size === 0)
                    return;
                hadMatch = true;
                for (const cb of Array.from(set)) {
                    const r = cb(ev);
                    if (r)
                        hadHandled = true;
                }
            };
            const path = ev?.composedPath?.();
            if (Array.isArray(path)) {
                if (strategy === "closest") {
                    for (const n of path) {
                        const el = resolveHTMLElement(n);
                        if (!el)
                            continue;
                        const set = targets.get(el);
                        if (!set)
                            continue;
                        callSet(set);
                        break;
                    }
                }
                else {
                    for (const n of path) {
                        const el = resolveHTMLElement(n);
                        if (!el)
                            continue;
                        callSet(targets.get(el));
                    }
                }
            }
            else {
                let cur = resolveHTMLElement(ev?.target);
                while (cur) {
                    const set = targets.get(cur);
                    if (set) {
                        callSet(set);
                        if (strategy === "closest")
                            break;
                    }
                    const r = cur.getRootNode?.();
                    cur = (cur.parentElement || (r instanceof ShadowRoot ? r.host : null));
                }
            }
            if (shouldApply(config.preventDefault, hadMatch, hadHandled))
                ev?.preventDefault?.();
            if (shouldApply(config.stopImmediatePropagation, hadMatch, hadHandled))
                ev?.stopImmediatePropagation?.();
            if (shouldApply(config.stopPropagation, hadMatch, hadHandled))
                ev?.stopPropagation?.();
        };
        hub = { targets, unbindGlobal: null, options: normalized, strategy, config, dispatch };
        hubs.set(key, hub);
    }
    return (element, handler) => {
        const el = resolveHTMLElement(element);
        if (!el)
            return () => { };
        // Attach the single real DOM listener only when the first trigger registers.
        if (hub.targets.size === 0 && !hub.unbindGlobal) {
            hub.unbindGlobal = lazyAddEventListener(target, type, hub.dispatch, hub.options);
        }
        let set = hub.targets.get(el);
        if (!set) {
            set = new Set();
            hub.targets.set(el, set);
        }
        set.add(handler);
        return () => {
            const hubsNow = proxiedByRoot.get(target);
            const h = hubsNow?.get(key);
            if (!h)
                return;
            const resolved = resolveHTMLElement(element);
            if (!resolved)
                return;
            const s = h.targets.get(resolved);
            if (!s)
                return;
            s.delete(handler);
            if (s.size === 0)
                h.targets.delete(resolved);
            if (h.targets.size === 0) {
                h.unbindGlobal?.();
                h.unbindGlobal = null;
                hubsNow?.delete(key);
                if (hubsNow && hubsNow.size === 0)
                    proxiedByRoot.delete(target);
            }
        };
    };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGF6eUV2ZW50cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkxhenlFdmVudHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsTUFBTSxZQUFZLEdBQUcsSUFBSSxPQUFPLEVBQWlDLENBQUM7QUFFbEUsTUFBTSxLQUFLLEdBQUcsQ0FBQyxJQUFZLEVBQUUsT0FBZ0MsRUFBRSxFQUFFO0lBQzdELE1BQU0sT0FBTyxHQUFHLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQzdDLE1BQU0sT0FBTyxHQUFHLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQzdDLE9BQU8sR0FBRyxJQUFJLE1BQU0sT0FBTyxNQUFNLE9BQU8sRUFBRSxDQUFDO0FBQy9DLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxNQUFNLG9CQUFvQixHQUFHLENBQ2hDLE1BQXNDLEVBQ3RDLElBQVksRUFDWixPQUFzQixFQUN0QixVQUFtQyxFQUFFLEVBQ3ZDLEVBQUU7SUFDQSxJQUFJLENBQUMsTUFBTSxJQUFJLE9BQVEsTUFBYyxDQUFDLGdCQUFnQixLQUFLLFVBQVU7UUFBRSxPQUFPLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUV4RixzR0FBc0c7SUFDdEcsTUFBTSxVQUFVLEdBQTRCO1FBQ3hDLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQztRQUNqQyxPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7S0FDcEMsQ0FBQztJQUVGLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDcEMsSUFBSSxJQUFJLEdBQUcsWUFBWSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNwQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDUixJQUFJ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LENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFDLE1BQU0sQ0FBQyxHQUFHLE9BQU8sRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLENBQUM7Z0JBQUUsT0FBTztZQUVmLE1BQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxRQUFRO2dCQUFFLE9BQU87WUFFdEIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbEMsSUFBSSxDQUFDLENBQUM7Z0JBQUUsT0FBTztZQUNmLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBcUIsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDO2dCQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRTdDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZCLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDO2dCQUNuQixDQUFDLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztnQkFDdEIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDckIsSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyxDQUFDO29CQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDcEUsQ0FBQztRQUNMLENBQUMsQ0FBQztJQUNOLENBQUMsQ0FBQztBQUNOLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbInR5cGUgQW55SGFuZGxlcjxFIGV4dGVuZHMgRXZlbnQgPSBFdmVudD4gPSAoZXY6IEUpID0+IGFueTtcblxudHlwZSBIdWIgPSB7XG4gICAgaGFuZGxlcnM6IFNldDxBbnlIYW5kbGVyPjtcbiAgICBsaXN0ZW5lcjogKGV2OiBFdmVudCkgPT4gdm9pZDtcbiAgICBvcHRpb25zOiBBZGRFdmVudExpc3RlbmVyT3B0aW9ucztcbn07XG5cbmNvbnN0IGh1YnNCeVRhcmdldCA9IG5ldyBXZWFrTWFwPEV2ZW50VGFyZ2V0LCBNYXA8c3RyaW5nLCBIdWI+PigpO1xuXG5jb25zdCBrZXlPZiA9ICh0eXBlOiBzdHJpbmcsIG9wdGlvbnM6IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zKSA9PiB7XG4gICAgY29uc3QgY2FwdHVyZSA9IG9wdGlvbnM/LmNhcHR1cmUgPyBcIjFcIiA6IFwiMFwiO1xuICAgIGNvbnN0IHBhc3NpdmUgPSBvcHRpb25zPy5wYXNzaXZlID8gXCIxXCIgOiBcIjBcIjtcbiAgICByZXR1cm4gYCR7dHlwZX18Yzoke2NhcHR1cmV9fHA6JHtwYXNzaXZlfWA7XG59O1xuXG5leHBvcnQgY29uc3QgbGF6eUFkZEV2ZW50TGlzdGVuZXIgPSA8RSBleHRlbmRzIEV2ZW50ID0gRXZlbnQ+KFxuICAgIHRhcmdldDogRXZlbnRUYXJnZXQgfCBudWxsIHwgdW5kZWZpbmVkLFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBoYW5kbGVyOiBBbnlIYW5kbGVyPEU+LFxuICAgIG9wdGlvbnM6IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zID0ge31cbikgPT4ge1xuICAgIGlmICghdGFyZ2V0IHx8IHR5cGVvZiAodGFyZ2V0IGFzIGFueSkuYWRkRXZlbnRMaXN0ZW5lciAhPT0gXCJmdW5jdGlvblwiKSByZXR1cm4gKCkgPT4geyB9O1xuXG4gICAgLy8gYG9uY2VgIGlzIG5vdCBjb21wYXRpYmxlIHdpdGggYSBzaGFyZWQgaHViIGxpc3RlbmVyOyBjYWxsZXJzIHNob3VsZCBpbXBsZW1lbnQgdGhlaXIgb3duIG9uY2UtbG9naWMuXG4gICAgY29uc3Qgbm9ybWFsaXplZDogQWRkRXZlbnRMaXN0ZW5lck9wdGlvbnMgPSB7XG4gICAgICAgIGNhcHR1cmU6IEJvb2xlYW4ob3B0aW9ucy5jYXB0dXJlKSxcbiAgICAgICAgcGFzc2l2ZTogQm9vbGVhbihvcHRpb25zLnBhc3NpdmUpLFxuICAgIH07XG5cbiAgICBjb25zdCBrZXkgPSBrZXlPZih0eXBlLCBub3JtYWxpemVkKTtcbiAgICBsZXQgaHVicyA9IGh1YnNCeVRhcmdldC5nZXQodGFyZ2V0KTtcbiAgICBpZiAoIWh1YnMpIHtcbiAgICAgICAgaHVicyA9IG5ldyBNYXAoKTtcbiAgICAgICAgaHVic0J5VGFyZ2V0LnNldCh0YXJnZXQsIGh1YnMpO1xuICAgIH1cblxuICAgIGxldCBodWIgPSBodWJzLmdldChrZXkpO1xuICAgIGlmICghaHViKSB7XG4gICAgICAgIGNvbnN0IGhhbmRsZXJzID0gbmV3IFNldDxBbnlIYW5kbGVyPigpO1xuICAgICAgICBjb25zdCBsaXN0ZW5lciA9IChldjogRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgY2Igb2YgQXJyYXkuZnJvbShoYW5kbGVycykpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBjYihldik7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBodWJzLnNldChrZXksIGh1YiA9IHsgaGFuZGxlcnMsIGxpc3RlbmVyLCBvcHRpb25zOiBub3JtYWxpemVkIH0pO1xuICAgICAgICAodGFyZ2V0IGFzIGFueSkuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lciwgbm9ybWFsaXplZCk7XG4gICAgfVxuXG4gICAgaHViLmhhbmRsZXJzLmFkZChoYW5kbGVyIGFzIEFueUhhbmRsZXIpO1xuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgY29uc3QgaHVic05vdyA9IGh1YnNCeVRhcmdldC5nZXQodGFyZ2V0KTtcbiAgICAgICAgY29uc3QgaHViTm93ID0gaHVic05vdz8uZ2V0KGtleSk7XG4gICAgICAgIGlmICghaHViTm93KSByZXR1cm47XG5cbiAgICAgICAgaHViTm93LmhhbmRsZXJzLmRlbGV0ZShoYW5kbGVyIGFzIEFueUhhbmRsZXIpO1xuICAgICAgICBpZiAoaHViTm93LmhhbmRsZXJzLnNpemUgPiAwKSByZXR1cm47XG5cbiAgICAgICAgKHRhcmdldCBhcyBhbnkpLnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgaHViTm93Lmxpc3RlbmVyLCBodWJOb3cub3B0aW9ucyk7XG4gICAgICAgIGh1YnNOb3c/LmRlbGV0ZShrZXkpO1xuICAgICAgICBpZiAoaHVic05vdyAmJiBodWJzTm93LnNpemUgPT09IDApIGh1YnNCeVRhcmdldC5kZWxldGUodGFyZ2V0KTtcbiAgICB9O1xufTtcblxudHlwZSBQcm94aWVkU3RyYXRlZ3kgPSBcImNsb3Nlc3RcIiB8IFwiYnViYmxlXCI7XG50eXBlIFdoZW4gPSBib29sZWFuIHwgXCJoYW5kbGVkXCI7XG5cbnR5cGUgUHJveGllZENvbmZpZyA9IHtcbiAgICBzdHJhdGVneT86IFByb3hpZWRTdHJhdGVneTtcbiAgICBwcmV2ZW50RGVmYXVsdD86IFdoZW47XG4gICAgc3RvcFByb3BhZ2F0aW9uPzogV2hlbjtcbiAgICBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24/OiBXaGVuO1xufTtcblxudHlwZSBQcm94aWVkSHViID0ge1xuICAgIHRhcmdldHM6IE1hcDxIVE1MRWxlbWVudCwgU2V0PEFueUhhbmRsZXI+PjtcbiAgICB1bmJpbmRHbG9iYWw6ICgoKSA9PiB2b2lkKSB8IG51bGw7XG4gICAgb3B0aW9uczogQWRkRXZlbnRMaXN0ZW5lck9wdGlvbnM7XG4gICAgc3RyYXRlZ3k6IFByb3hpZWRTdHJhdGVneTtcbiAgICBjb25maWc6IFByb3hpZWRDb25maWc7XG4gICAgZGlzcGF0Y2g6IChldjogRXZlbnQpID0+IHZvaWQ7XG59O1xuXG5jb25zdCBwcm94aWVkQnlSb290ID0gbmV3IFdlYWtNYXA8RXZlbnRUYXJnZXQsIE1hcDxzdHJpbmcsIFByb3hpZWRIdWI+PigpO1xuXG5jb25zdCByZXNvbHZlSFRNTEVsZW1lbnQgPSAoZWw6IGFueSk6IEhUTUxFbGVtZW50IHwgbnVsbCA9PiB7XG4gICAgY29uc3QgcmVzb2x2ZWQgPSAoZWwgYXMgYW55KT8uZWxlbWVudCA/PyBlbDtcbiAgICByZXR1cm4gcmVzb2x2ZWQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IHJlc29sdmVkIDogbnVsbDtcbn07XG5cbmNvbnN0IHNob3VsZEFwcGx5ID0gKHdoZW46IFdoZW4gfCB1bmRlZmluZWQsIGhhZE1hdGNoOiBib29sZWFuLCBoYWRIYW5kbGVkOiBib29sZWFuKSA9PiB7XG4gICAgaWYgKCF3aGVuKSByZXR1cm4gZmFsc2U7XG4gICAgaWYgKHdoZW4gPT09IFwiaGFuZGxlZFwiKSByZXR1cm4gaGFkSGFuZGxlZDtcbiAgICByZXR1cm4gaGFkTWF0Y2g7XG59O1xuXG4vKipcbiAqIFByb3hpZWQgZXZlbnRzOlxuICogLSBJbnN0YWxscyAqKm9uZSoqIHJlYWwgRE9NIGxpc3RlbmVyIG9uIGByb290YCAocGVyIGV2ZW50L29wdGlvbnMvY29uZmlnKSwgYnV0IG9ubHkgYWZ0ZXIgdGhlIGZpcnN0IGVsZW1lbnQgaGFuZGxlciByZWdpc3RlcnMuXG4gKiAtIFJvdXRlcyBldmVudHMgdG8gcmVnaXN0ZXJlZCBlbGVtZW50IGhhbmRsZXJzIGJhc2VkIG9uIHRoZSBjb21wb3NlZCBwYXRoLlxuICogLSBDYW4gY29uZGl0aW9uYWxseSBjYWxsIHByZXZlbnREZWZhdWx0L3N0b3AqIG9ubHkgd2hlbiBhIHRyaWdnZXIgbWF0Y2hlcyAob3Igd2hlbiBoYW5kbGVkKS5cbiAqL1xuZXhwb3J0IGNvbnN0IGFkZFByb3hpZWRFdmVudCA9IDxFIGV4dGVuZHMgRXZlbnQgPSBFdmVudD4oXG4gICAgcm9vdDogRXZlbnRUYXJnZXQgfCBudWxsIHwgdW5kZWZpbmVkLFxuICAgIHR5cGU6IHN0cmluZyxcbiAgICBvcHRpb25zOiBBZGRFdmVudExpc3RlbmVyT3B0aW9ucyA9IHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogZmFsc2UgfSxcbiAgICBjb25maWc6IFByb3hpZWRDb25maWcgPSB7fVxuKSA9PiB7XG4gICAgY29uc3QgdGFyZ2V0ID0gcm9vdDtcbiAgICBpZiAoIXRhcmdldCB8fCB0eXBlb2YgKHRhcmdldCBhcyBhbnkpLmFkZEV2ZW50TGlzdGVuZXIgIT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICByZXR1cm4gKF9lbGVtZW50OiBhbnksIF9oYW5kbGVyOiBBbnlIYW5kbGVyPEU+KSA9PiAoKSA9PiB7IH07XG4gICAgfVxuXG4gICAgY29uc3Qgbm9ybWFsaXplZDogQWRkRXZlbnRMaXN0ZW5lck9wdGlvbnMgPSB7XG4gICAgICAgIGNhcHR1cmU6IEJvb2xlYW4ob3B0aW9ucy5jYXB0dXJlKSxcbiAgICAgICAgcGFzc2l2ZTogQm9vbGVhbihvcHRpb25zLnBhc3NpdmUpLFxuICAgIH07XG4gICAgY29uc3Qgc3RyYXRlZ3k6IFByb3hpZWRTdHJhdGVneSA9IGNvbmZpZy5zdHJhdGVneSA/PyBcImNsb3Nlc3RcIjtcblxuICAgIGNvbnN0IGtleSA9IGAke3R5cGV9fGM6JHtub3JtYWxpemVkLmNhcHR1cmUgPyBcIjFcIiA6IFwiMFwifXxwOiR7bm9ybWFsaXplZC5wYXNzaXZlID8gXCIxXCIgOiBcIjBcIn18czoke3N0cmF0ZWd5fXxwZDoke1N0cmluZyhjb25maWcucHJldmVudERlZmF1bHQgPz8gXCJcIil9fHNwOiR7U3RyaW5nKGNvbmZpZy5zdG9wUHJvcGFnYXRpb24gPz8gXCJcIil9fHNpcDoke1N0cmluZyhjb25maWcuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uID8/IFwiXCIpfWA7XG5cbiAgICBsZXQgaHVicyA9IHByb3hpZWRCeVJvb3QuZ2V0KHRhcmdldCk7XG4gICAgaWYgKCFodWJzKSB7XG4gICAgICAgIGh1YnMgPSBuZXcgTWFwKCk7XG4gICAgICAgIHByb3hpZWRCeVJvb3Quc2V0KHRhcmdldCwgaHVicyk7XG4gICAgfVxuXG4gICAgbGV0IGh1YiA9IGh1YnMuZ2V0KGtleSk7XG4gICAgaWYgKCFodWIpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0cyA9IG5ldyBNYXA8SFRNTEVsZW1lbnQsIFNldDxBbnlIYW5kbGVyPj4oKTtcblxuICAgICAgICBjb25zdCBkaXNwYXRjaCA9IChldjogRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBoYWRNYXRjaCA9IGZhbHNlO1xuICAgICAgICAgICAgbGV0IGhhZEhhbmRsZWQgPSBmYWxzZTtcblxuICAgICAgICAgICAgY29uc3QgY2FsbFNldCA9IChzZXQ6IFNldDxBbnlIYW5kbGVyPiB8IHVuZGVmaW5lZCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghc2V0IHx8IHNldC5zaXplID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaGFkTWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgY2Igb2YgQXJyYXkuZnJvbShzZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBjYihldik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyKSBoYWRIYW5kbGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBjb25zdCBwYXRoID0gKGV2IGFzIGFueSk/LmNvbXBvc2VkUGF0aD8uKCkgYXMgYW55W10gfCB1bmRlZmluZWQ7XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwYXRoKSkge1xuICAgICAgICAgICAgICAgIGlmIChzdHJhdGVneSA9PT0gXCJjbG9zZXN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBuIG9mIHBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVsID0gcmVzb2x2ZUhUTUxFbGVtZW50KG4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlbCkgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzZXQgPSB0YXJnZXRzLmdldChlbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNldCkgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsU2V0KHNldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgbiBvZiBwYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbCA9IHJlc29sdmVIVE1MRWxlbWVudChuKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZWwpIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbFNldCh0YXJnZXRzLmdldChlbCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgY3VyID0gcmVzb2x2ZUhUTUxFbGVtZW50KChldiBhcyBhbnkpPy50YXJnZXQpIGFzIEhUTUxFbGVtZW50IHwgbnVsbDtcbiAgICAgICAgICAgICAgICB3aGlsZSAoY3VyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNldCA9IHRhcmdldHMuZ2V0KGN1cik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxTZXQoc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdHJhdGVneSA9PT0gXCJjbG9zZXN0XCIpIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBjdXIuZ2V0Um9vdE5vZGU/LigpIGFzIChTaGFkb3dSb290IHwgRG9jdW1lbnQgfCBudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgY3VyID0gKGN1ci5wYXJlbnRFbGVtZW50IHx8IChyIGluc3RhbmNlb2YgU2hhZG93Um9vdCA/IHIuaG9zdCA6IG51bGwpKSBhcyBIVE1MRWxlbWVudCB8IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc2hvdWxkQXBwbHkoY29uZmlnLnByZXZlbnREZWZhdWx0LCBoYWRNYXRjaCwgaGFkSGFuZGxlZCkpIChldiBhcyBhbnkpPy5wcmV2ZW50RGVmYXVsdD8uKCk7XG4gICAgICAgICAgICBpZiAoc2hvdWxkQXBwbHkoY29uZmlnLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbiwgaGFkTWF0Y2gsIGhhZEhhbmRsZWQpKSAoZXYgYXMgYW55KT8uc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uPy4oKTtcbiAgICAgICAgICAgIGlmIChzaG91bGRBcHBseShjb25maWcuc3RvcFByb3BhZ2F0aW9uLCBoYWRNYXRjaCwgaGFkSGFuZGxlZCkpIChldiBhcyBhbnkpPy5zdG9wUHJvcGFnYXRpb24/LigpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGh1YiA9IHsgdGFyZ2V0cywgdW5iaW5kR2xvYmFsOiBudWxsLCBvcHRpb25zOiBub3JtYWxpemVkLCBzdHJhdGVneSwgY29uZmlnLCBkaXNwYXRjaCB9O1xuICAgICAgICBodWJzLnNldChrZXksIGh1Yik7XG4gICAgfVxuXG4gICAgcmV0dXJuIChlbGVtZW50OiBhbnksIGhhbmRsZXI6IEFueUhhbmRsZXI8RT4pID0+IHtcbiAgICAgICAgY29uc3QgZWwgPSByZXNvbHZlSFRNTEVsZW1lbnQoZWxlbWVudCk7XG4gICAgICAgIGlmICghZWwpIHJldHVybiAoKSA9PiB7IH07XG5cbiAgICAgICAgLy8gQXR0YWNoIHRoZSBzaW5nbGUgcmVhbCBET00gbGlzdGVuZXIgb25seSB3aGVuIHRoZSBmaXJzdCB0cmlnZ2VyIHJlZ2lzdGVycy5cbiAgICAgICAgaWYgKGh1YiEudGFyZ2V0cy5zaXplID09PSAwICYmICFodWIhLnVuYmluZEdsb2JhbCkge1xuICAgICAgICAgICAgaHViIS51bmJpbmRHbG9iYWwgPSBsYXp5QWRkRXZlbnRMaXN0ZW5lcih0YXJnZXQsIHR5cGUsIGh1YiEuZGlzcGF0Y2gsIGh1YiEub3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgc2V0ID0gaHViIS50YXJnZXRzLmdldChlbCk7XG4gICAgICAgIGlmICghc2V0KSB7XG4gICAgICAgICAgICBzZXQgPSBuZXcgU2V0KCk7XG4gICAgICAgICAgICBodWIhLnRhcmdldHMuc2V0KGVsLCBzZXQpO1xuICAgICAgICB9XG4gICAgICAgIHNldC5hZGQoaGFuZGxlciBhcyBBbnlIYW5kbGVyKTtcblxuICAgICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaHVic05vdyA9IHByb3hpZWRCeVJvb3QuZ2V0KHRhcmdldCk7XG4gICAgICAgICAgICBjb25zdCBoID0gaHVic05vdz8uZ2V0KGtleSk7XG4gICAgICAgICAgICBpZiAoIWgpIHJldHVybjtcblxuICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWQgPSByZXNvbHZlSFRNTEVsZW1lbnQoZWxlbWVudCk7XG4gICAgICAgICAgICBpZiAoIXJlc29sdmVkKSByZXR1cm47XG5cbiAgICAgICAgICAgIGNvbnN0IHMgPSBoLnRhcmdldHMuZ2V0KHJlc29sdmVkKTtcbiAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgcy5kZWxldGUoaGFuZGxlciBhcyBBbnlIYW5kbGVyKTtcbiAgICAgICAgICAgIGlmIChzLnNpemUgPT09IDApIGgudGFyZ2V0cy5kZWxldGUocmVzb2x2ZWQpO1xuXG4gICAgICAgICAgICBpZiAoaC50YXJnZXRzLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgICAgICBoLnVuYmluZEdsb2JhbD8uKCk7XG4gICAgICAgICAgICAgICAgaC51bmJpbmRHbG9iYWwgPSBudWxsO1xuICAgICAgICAgICAgICAgIGh1YnNOb3c/LmRlbGV0ZShrZXkpO1xuICAgICAgICAgICAgICAgIGlmIChodWJzTm93ICYmIGh1YnNOb3cuc2l6ZSA9PT0gMCkgcHJveGllZEJ5Um9vdC5kZWxldGUodGFyZ2V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9O1xufTtcbiJdfQ==
import { addEvents } from "fest/dom";
//
const defaultOptions = {
    anyPointer: true,
    mouseImmediate: true,
    minHoldTime: 100,
    maxHoldTime: 2000,
    maxOffsetRadius: 10
};
//
const preventor = [
    (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        ev.stopImmediatePropagation();
    }, { once: true }
];
//
export class LongPressHandler {
    #holder;
    #preventedPointers;
    //
    constructor(holder, options = { ...defaultOptions }, fx) {
        (this.#holder = holder)["@control"] = this;
        this.#preventedPointers = new Set();
        if (!holder) {
            throw Error("Element is null...");
        }
        if (!options) {
            options = { ...defaultOptions };
        }
        const currentClone = { ...options };
        Object.assign(options, defaultOptions, currentClone);
        if (options) {
            this.longPress(options, fx);
        }
    }
    //
    defaultHandler(ev, weakRef) {
        return weakRef?.deref()?.dispatchEvent?.(new PointerEvent("long-press", { ...ev, bubbles: true }));
    }
    //
    longPress(options = { ...defaultOptions }, fx) {
        const ROOT = document.documentElement;
        const weakRef = new WeakRef(this.#holder);
        const actionState = this.initializeActionState();
        //
        this.holding = {
            actionState,
            options, fx: fx || ((ev) => this.defaultHandler(ev, weakRef))
        };
        // Event listeners
        const pointerDownListener = (ev) => this.onPointerDown(this.holding, ev, weakRef);
        const pointerMoveListener = (ev) => this.onPointerMove(this.holding, ev);
        const pointerUpListener = (ev) => this.onPointerUp(this.holding, ev);
        //
        addEvents(ROOT, {
            "pointerdown": pointerDownListener,
            "pointermove": pointerMoveListener,
            "pointerup": pointerUpListener,
            "pointercancel": pointerUpListener
        });
    }
    //
    initializeActionState() {
        return {
            timerId: null,
            immediateTimerId: null,
            pointerId: -1,
            startCoord: [0, 0],
            lastCoord: [0, 0],
            isReadyForLongPress: false,
            cancelCallback: () => { },
            cancelPromiseResolver: null,
            cancelPromiseRejector: null,
        };
    }
    //
    preventFromClicking(self, ev) {
        if (!this.#preventedPointers.has(ev.pointerId)) {
            this.#preventedPointers.add(ev.pointerId);
            self?.addEventListener?.("click", ...preventor);
            self?.addEventListener?.("contextmenu", ...preventor);
        }
    }
    //
    releasePreventing(self, pointerId) {
        if (this.#preventedPointers.has(pointerId)) {
            this.#preventedPointers.delete(pointerId);
            self?.removeEventListener?.("click", ...preventor);
            self?.removeEventListener?.("contextmenu", ...preventor);
        }
    }
    //
    onPointerDown(self, ev, weakRef) {
        if (!this.isValidTarget(self, ev.target, weakRef) ||
            !(self.options?.anyPointer || ev?.pointerType == "touch"))
            return;
        //
        ev.preventDefault();
        this.resetAction(self, self.actionState);
        // Initialize state
        const { actionState } = self;
        actionState.pointerId = ev.pointerId;
        actionState.startCoord = [ev.clientX, ev.clientY];
        actionState.lastCoord = [...actionState.startCoord];
        // Set up cancellation promise
        const $withResolver = Promise.withResolvers();
        actionState.cancelPromiseResolver = $withResolver.resolve;
        actionState.cancelPromiseRejector = $withResolver.reject;
        actionState.cancelCallback = () => {
            clearTimeout(actionState.timerId);
            clearTimeout(actionState.immediateTimerId);
            actionState.isReadyForLongPress = false;
            $withResolver.resolve();
            this.resetAction(self, actionState);
        };
        // Immediate trigger timer
        if (self.options?.mouseImmediate && ev.pointerType === "mouse") {
            self.fx?.(ev);
            return actionState.cancelCallback();
        }
        // Long press timer
        actionState.timerId = setTimeout(() => {
            actionState.isReadyForLongPress = true;
        }, self.options?.minHoldTime);
        // Start timers for long press and immediate actions
        actionState.immediateTimerId = setTimeout(() => {
            if (this.isInPlace(self)) {
                this.preventFromClicking(self, ev);
                //
                self.fx?.(ev);
                actionState.cancelCallback();
            }
        }, self.options?.maxHoldTime);
        // Cancel promise handling
        Promise.race([
            $withResolver.promise,
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 3000)),
        ]).catch(console.warn);
    }
    //
    onPointerMove(self, ev) {
        const { actionState } = self;
        if (ev.pointerId !== actionState.pointerId)
            return;
        actionState.lastCoord = [ev.clientX, ev.clientY];
        //
        if (!this.isInPlace(self)) {
            return actionState.cancelCallback();
        }
        //
        this.preventFromClicking(self, ev);
        actionState.startCoord = [ev.clientX, ev.clientY];
    }
    //
    resetAction(self, actionState) {
        this.releasePreventing(self, actionState.pointerId);
        actionState.pointerId = -1;
        actionState.cancelPromiseResolver = null;
        actionState.cancelPromiseRejector = null;
        actionState.isReadyForLongPress = false;
        actionState.cancelCallback = null;
    }
    //
    onPointerUp(self, ev) {
        const { actionState } = self;
        if (ev.pointerId !== actionState.pointerId)
            return;
        actionState.lastCoord = [ev.clientX, ev.clientY];
        if (actionState.isReadyForLongPress && this.isInPlace(self)) {
            self.fx?.(ev);
            this.preventFromClicking(self, ev);
        }
        actionState.cancelCallback();
        this.resetAction(self, actionState);
    }
    //
    holding = { fx: null, options: {}, actionState: {} };
    hasParent(current, parent) { while (current) {
        if (current === parent)
            return true;
        current = current.parentElement;
    } }
    isInPlace(self) {
        const { actionState } = self;
        const [startX, startY] = actionState.startCoord;
        const [lastX, lastY] = actionState.lastCoord;
        const distance = Math.hypot(lastX - startX, lastY - startY);
        return distance <= (self.options?.maxOffsetRadius);
    }
    //
    isValidTarget(self, target, weakRef) {
        const weakElement = weakRef?.deref?.();
        return (weakElement && (this.hasParent(target, weakElement) || target === weakElement) &&
            (!self.options?.handler || target.matches(self.options?.handler)));
    }
}
//
export default LongPressHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9uZ1ByZXNzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTG9uZ1ByZXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFckMsRUFBRTtBQUNGLE1BQU0sY0FBYyxHQUFHO0lBQ25CLFVBQVUsRUFBRSxJQUFJO0lBQ2hCLGNBQWMsRUFBRSxJQUFJO0lBQ3BCLFdBQVcsRUFBRSxHQUFHO0lBQ2hCLFdBQVcsRUFBRSxJQUFJO0lBQ2pCLGVBQWUsRUFBRSxFQUFFO0NBQ3RCLENBQUM7QUFFRixFQUFFO0FBQ0YsTUFBTSxTQUFTLEdBQTBEO0lBQ3JFLENBQUMsRUFBZ0IsRUFBRSxFQUFFO1FBQ3JCLEVBQUUsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUNwQixFQUFFLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDckIsRUFBRSxDQUFDLHdCQUF3QixFQUFFLENBQUM7SUFDbEMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRTtDQUFDLENBQUE7QUFFbEIsRUFBRTtBQUNGLE1BQU0sT0FBTyxnQkFBZ0I7SUFDekIsT0FBTyxDQUFjO0lBQ3JCLGtCQUFrQixDQUFjO0lBQ2hDLEVBQUU7SUFDRixZQUFZLE1BQU0sRUFBRyxVQUFlLEVBQUMsR0FBRyxjQUFjLEVBQUMsRUFBRSxFQUErQjtRQUNwRixDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQzNDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3BDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUFDLE1BQU0sS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFBQyxDQUFDO1FBQ25ELElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUFDLE9BQU8sR0FBRyxFQUFDLEdBQUcsY0FBYyxFQUFDLENBQUM7UUFBQyxD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dXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkZEV2ZW50cyB9IGZyb20gXCJmZXN0L2RvbVwiO1xuXG4vL1xuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgYW55UG9pbnRlcjogdHJ1ZSxcbiAgICBtb3VzZUltbWVkaWF0ZTogdHJ1ZSxcbiAgICBtaW5Ib2xkVGltZTogMTAwLFxuICAgIG1heEhvbGRUaW1lOiAyMDAwLFxuICAgIG1heE9mZnNldFJhZGl1czogMTBcbn07XG5cbi8vXG5jb25zdCBwcmV2ZW50b3I6IFsoZXY6IFBvaW50ZXJFdmVudCkgPT4gdm9pZCwgQWRkRXZlbnRMaXN0ZW5lck9wdGlvbnNdID0gW1xuICAgIChldjogUG9pbnRlckV2ZW50KSA9PiB7XG4gICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICBldi5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbn0sIHsgb25jZTogdHJ1ZSB9XVxuXG4vL1xuZXhwb3J0IGNsYXNzIExvbmdQcmVzc0hhbmRsZXIge1xuICAgICNob2xkZXI6IEhUTUxFbGVtZW50O1xuICAgICNwcmV2ZW50ZWRQb2ludGVyczogU2V0PG51bWJlcj47XG4gICAgLy9cbiAgICBjb25zdHJ1Y3Rvcihob2xkZXIsICBvcHRpb25zOiBhbnkgPSB7Li4uZGVmYXVsdE9wdGlvbnN9LCBmeD86IChldjogUG9pbnRlckV2ZW50KSA9PiB2b2lkKSB7XG4gICAgICAgICh0aGlzLiNob2xkZXIgPSBob2xkZXIpW1wiQGNvbnRyb2xcIl0gPSB0aGlzO1xuICAgICAgICB0aGlzLiNwcmV2ZW50ZWRQb2ludGVycyA9IG5ldyBTZXQoKTtcbiAgICAgICAgaWYgKCFob2xkZXIpIHsgdGhyb3cgRXJyb3IoXCJFbGVtZW50IGlzIG51bGwuLi5cIik7IH1cbiAgICAgICAgaWYgKCFvcHRpb25zKSB7IG9wdGlvbnMgPSB7Li4uZGVmYXVsdE9wdGlvbnN9OyB9XG4gICAgICAgIGNvbnN0IGN1cnJlbnRDbG9uZSA9IHsuLi5vcHRpb25zfTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihvcHRpb25zLCBkZWZhdWx0T3B0aW9ucywgY3VycmVudENsb25lKTtcbiAgICAgICAgaWYgKG9wdGlvbnMpIHsgdGhpcy5sb25nUHJlc3Mob3B0aW9ucywgZngpOyB9XG4gICAgfVxuXG4gICAgLy9cbiAgICBkZWZhdWx0SGFuZGxlcihldiwgd2Vha1JlZjogV2Vha1JlZjxIVE1MRWxlbWVudD4pIHtcbiAgICAgICAgcmV0dXJuIHdlYWtSZWY/LmRlcmVmKCk/LmRpc3BhdGNoRXZlbnQ/LihuZXcgUG9pbnRlckV2ZW50KFwibG9uZy1wcmVzc1wiLCB7Li4uZXYsIGJ1YmJsZXM6IHRydWV9KSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBsb25nUHJlc3Mob3B0aW9uczogYW55ID0gey4uLmRlZmF1bHRPcHRpb25zfSwgZng/OiAoZXY6IFBvaW50ZXJFdmVudCkgPT4gdm9pZCkge1xuICAgICAgICBjb25zdCBST09UID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuICAgICAgICBjb25zdCB3ZWFrUmVmID0gbmV3IFdlYWtSZWYodGhpcy4jaG9sZGVyKTtcbiAgICAgICAgY29uc3QgYWN0aW9uU3RhdGUgPSB0aGlzLmluaXRpYWxpemVBY3Rpb25TdGF0ZSgpO1xuXG4gICAgICAgIC8vXG4gICAgICAgIHRoaXMuaG9sZGluZyA9IHtcbiAgICAgICAgICAgIGFjdGlvblN0YXRlLFxuICAgICAgICAgICAgb3B0aW9ucywgZng6IGZ4IHx8ICgoZXYpID0+IHRoaXMuZGVmYXVsdEhhbmRsZXIoZXYsIHdlYWtSZWYpKVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gRXZlbnQgbGlzdGVuZXJzXG4gICAgICAgIGNvbnN0IHBvaW50ZXJEb3duTGlzdGVuZXIgPSAoZXY6IFBvaW50ZXJFdmVudCkgPT4gdGhpcy5vblBvaW50ZXJEb3duKHRoaXMuaG9sZGluZywgZXYsIHdlYWtSZWYpO1xuICAgICAgICBjb25zdCBwb2ludGVyTW92ZUxpc3RlbmVyID0gKGV2OiBQb2ludGVyRXZlbnQpID0+IHRoaXMub25Qb2ludGVyTW92ZSh0aGlzLmhvbGRpbmcsIGV2KTtcbiAgICAgICAgY29uc3QgcG9pbnRlclVwTGlzdGVuZXIgICA9IChldjogUG9pbnRlckV2ZW50KSA9PiB0aGlzLm9uUG9pbnRlclVwKHRoaXMuaG9sZGluZywgZXYpO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGFkZEV2ZW50cyhST09ULCB7XG4gICAgICAgICAgICBcInBvaW50ZXJkb3duXCI6IHBvaW50ZXJEb3duTGlzdGVuZXIsXG4gICAgICAgICAgICBcInBvaW50ZXJtb3ZlXCI6IHBvaW50ZXJNb3ZlTGlzdGVuZXIsXG4gICAgICAgICAgICBcInBvaW50ZXJ1cFwiICA6IHBvaW50ZXJVcExpc3RlbmVyLFxuICAgICAgICAgICAgXCJwb2ludGVyY2FuY2VsXCI6IHBvaW50ZXJVcExpc3RlbmVyXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vXG4gICAgcHJpdmF0ZSBpbml0aWFsaXplQWN0aW9uU3RhdGUoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0aW1lcklkOiBudWxsLFxuICAgICAgICAgICAgaW1tZWRpYXRlVGltZXJJZDogbnVsbCxcbiAgICAgICAgICAgIHBvaW50ZXJJZDogLTEsXG4gICAgICAgICAgICBzdGFydENvb3JkOiBbMCwgMF0gYXMgW251bWJlciwgbnVtYmVyXSxcbiAgICAgICAgICAgIGxhc3RDb29yZDogWzAsIDBdIGFzIFtudW1iZXIsIG51bWJlcl0sXG4gICAgICAgICAgICBpc1JlYWR5Rm9yTG9uZ1ByZXNzOiBmYWxzZSxcbiAgICAgICAgICAgIGNhbmNlbENhbGxiYWNrOiAoKSA9PiB7fSxcbiAgICAgICAgICAgIGNhbmNlbFByb21pc2VSZXNvbHZlcjogbnVsbCBhcyAoKCkgPT4gdm9pZCkgfCBudWxsLFxuICAgICAgICAgICAgY2FuY2VsUHJvbWlzZVJlamVjdG9yOiBudWxsIGFzICgocmVhc29uPzogYW55KSA9PiB2b2lkKSB8IG51bGwsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy9cbiAgICBwcml2YXRlIHByZXZlbnRGcm9tQ2xpY2tpbmcoc2VsZjogYW55LCBldjogUG9pbnRlckV2ZW50KSB7XG4gICAgICAgIGlmICghdGhpcy4jcHJldmVudGVkUG9pbnRlcnMuaGFzKGV2LnBvaW50ZXJJZCkpIHtcbiAgICAgICAgICAgIHRoaXMuI3ByZXZlbnRlZFBvaW50ZXJzLmFkZChldi5wb2ludGVySWQpO1xuXG4gICAgICAgICAgICBzZWxmPy5hZGRFdmVudExpc3RlbmVyPy4oXCJjbGlja1wiLCAuLi5wcmV2ZW50b3IpO1xuICAgICAgICAgICAgc2VsZj8uYWRkRXZlbnRMaXN0ZW5lcj8uKFwiY29udGV4dG1lbnVcIiwgLi4ucHJldmVudG9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgcHJpdmF0ZSByZWxlYXNlUHJldmVudGluZyhzZWxmOiBhbnksIHBvaW50ZXJJZDogbnVtYmVyKSB7XG4gICAgICAgIGlmICh0aGlzLiNwcmV2ZW50ZWRQb2ludGVycy5oYXMocG9pbnRlcklkKSkge1xuICAgICAgICAgICAgdGhpcy4jcHJldmVudGVkUG9pbnRlcnMuZGVsZXRlKHBvaW50ZXJJZCk7XG4gICAgICAgICAgICBzZWxmPy5yZW1vdmVFdmVudExpc3RlbmVyPy4oXCJjbGlja1wiLCAuLi5wcmV2ZW50b3IpO1xuICAgICAgICAgICAgc2VsZj8ucmVtb3ZlRXZlbnRMaXN0ZW5lcj8uKFwiY29udGV4dG1lbnVcIiwgLi4ucHJldmVudG9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgcHJpdmF0ZSBvblBvaW50ZXJEb3duKHNlbGY6IGFueSwgZXY6IFBvaW50ZXJFdmVudCwgd2Vha1JlZjogV2Vha1JlZjxIVE1MRWxlbWVudD4pIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgIXRoaXMuaXNWYWxpZFRhcmdldChzZWxmLCBldi50YXJnZXQgYXMgSFRNTEVsZW1lbnQsIHdlYWtSZWYpIHx8XG4gICAgICAgICAgICAhKHNlbGYub3B0aW9ucz8uYW55UG9pbnRlciB8fCBldj8ucG9pbnRlclR5cGUgPT0gXCJ0b3VjaFwiKVxuICAgICAgICApIHJldHVybjtcblxuICAgICAgICAvL1xuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICB0aGlzLnJlc2V0QWN0aW9uKHNlbGYsIHNlbGYuYWN0aW9uU3RhdGUpO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgc3RhdGVcbiAgICAgICAgY29uc3QgeyBhY3Rpb25TdGF0ZSB9ICA9IHNlbGY7XG4gICAgICAgIGFjdGlvblN0YXRlLnBvaW50ZXJJZCAgPSBldi5wb2ludGVySWQ7XG4gICAgICAgIGFjdGlvblN0YXRlLnN0YXJ0Q29vcmQgPSBbZXYuY2xpZW50WCwgZXYuY2xpZW50WV07XG4gICAgICAgIGFjdGlvblN0YXRlLmxhc3RDb29yZCAgPSBbLi4uYWN0aW9uU3RhdGUuc3RhcnRDb29yZF07XG5cbiAgICAgICAgLy8gU2V0IHVwIGNhbmNlbGxhdGlvbiBwcm9taXNlXG4gICAgICAgIGNvbnN0ICR3aXRoUmVzb2x2ZXIgPSBQcm9taXNlLndpdGhSZXNvbHZlcnM8dm9pZD4oKTtcbiAgICAgICAgYWN0aW9uU3RhdGUuY2FuY2VsUHJvbWlzZVJlc29sdmVyID0gJHdpdGhSZXNvbHZlci5yZXNvbHZlO1xuICAgICAgICBhY3Rpb25TdGF0ZS5jYW5jZWxQcm9taXNlUmVqZWN0b3IgPSAkd2l0aFJlc29sdmVyLnJlamVjdDtcbiAgICAgICAgYWN0aW9uU3RhdGUuY2FuY2VsQ2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQoYWN0aW9uU3RhdGUudGltZXJJZCEpO1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGFjdGlvblN0YXRlLmltbWVkaWF0ZVRpbWVySWQhKTtcbiAgICAgICAgICAgIGFjdGlvblN0YXRlLmlzUmVhZHlGb3JMb25nUHJlc3MgPSBmYWxzZTtcbiAgICAgICAgICAgICR3aXRoUmVzb2x2ZXIucmVzb2x2ZSgpO1xuICAgICAgICAgICAgdGhpcy5yZXNldEFjdGlvbihzZWxmLCBhY3Rpb25TdGF0ZSk7XG4gICAgICAgIH07XG4gICAgICAgIC8vIEltbWVkaWF0ZSB0cmlnZ2VyIHRpbWVyXG4gICAgICAgIGlmIChzZWxmLm9wdGlvbnM/Lm1vdXNlSW1tZWRpYXRlICYmIGV2LnBvaW50ZXJUeXBlID09PSBcIm1vdXNlXCIpIHtcbiAgICAgICAgICAgIHNlbGYuZng/Lihldik7XG4gICAgICAgICAgICByZXR1cm4gYWN0aW9uU3RhdGUuY2FuY2VsQ2FsbGJhY2soKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIExvbmcgcHJlc3MgdGltZXJcbiAgICAgICAgYWN0aW9uU3RhdGUudGltZXJJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgYWN0aW9uU3RhdGUuaXNSZWFkeUZvckxvbmdQcmVzcyA9IHRydWU7XG4gICAgICAgIH0sIHNlbGYub3B0aW9ucz8ubWluSG9sZFRpbWUpO1xuXG4gICAgICAgIC8vIFN0YXJ0IHRpbWVycyBmb3IgbG9uZyBwcmVzcyBhbmQgaW1tZWRpYXRlIGFjdGlvbnNcbiAgICAgICAgYWN0aW9uU3RhdGUuaW1tZWRpYXRlVGltZXJJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuaXNJblBsYWNlKHNlbGYpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcmV2ZW50RnJvbUNsaWNraW5nKHNlbGYsIGV2KTtcblxuICAgICAgICAgICAgICAgIC8vXG4gICAgICAgICAgICAgICAgc2VsZi5meD8uKGV2KTtcbiAgICAgICAgICAgICAgICBhY3Rpb25TdGF0ZS5jYW5jZWxDYWxsYmFjaygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCBzZWxmLm9wdGlvbnM/Lm1heEhvbGRUaW1lKTtcblxuICAgICAgICAvLyBDYW5jZWwgcHJvbWlzZSBoYW5kbGluZ1xuICAgICAgICBQcm9taXNlLnJhY2UoW1xuICAgICAgICAgICAgJHdpdGhSZXNvbHZlci5wcm9taXNlLFxuICAgICAgICAgICAgbmV3IFByb21pc2U8dm9pZD4oKF8sIHJlamVjdCkgPT4gc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKFwiVGltZW91dFwiKSksIDMwMDApKSxcbiAgICAgICAgXSkuY2F0Y2goY29uc29sZS53YXJuKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIHByaXZhdGUgb25Qb2ludGVyTW92ZShzZWxmOiBhbnksIGV2OiBQb2ludGVyRXZlbnQpIHtcbiAgICAgICAgY29uc3Qge2FjdGlvblN0YXRlfSA9IHNlbGY7XG4gICAgICAgIGlmIChldi5wb2ludGVySWQgIT09IGFjdGlvblN0YXRlLnBvaW50ZXJJZCkgcmV0dXJuO1xuICAgICAgICBhY3Rpb25TdGF0ZS5sYXN0Q29vcmQgPSBbZXYuY2xpZW50WCwgZXYuY2xpZW50WV07XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKCF0aGlzLmlzSW5QbGFjZShzZWxmKSkgeyByZXR1cm4gYWN0aW9uU3RhdGUuY2FuY2VsQ2FsbGJhY2soKTsgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIHRoaXMucHJldmVudEZyb21DbGlja2luZyhzZWxmLCBldik7XG4gICAgICAgIGFjdGlvblN0YXRlLnN0YXJ0Q29vcmQgPSBbZXYuY2xpZW50WCwgZXYuY2xpZW50WV07XG4gICAgfVxuXG4gICAgLy9cbiAgICBwcml2YXRlIHJlc2V0QWN0aW9uKHNlbGY6IGFueSwgYWN0aW9uU3RhdGU6IGFueSkge1xuICAgICAgICB0aGlzLnJlbGVhc2VQcmV2ZW50aW5nKHNlbGYsIGFjdGlvblN0YXRlLnBvaW50ZXJJZCk7XG4gICAgICAgIGFjdGlvblN0YXRlLnBvaW50ZXJJZCAgICAgICAgICAgICAgID0gLTE7XG4gICAgICAgIGFjdGlvblN0YXRlLmNhbmNlbFByb21pc2VSZXNvbHZlciAgID0gbnVsbDtcbiAgICAgICAgYWN0aW9uU3RhdGUuY2FuY2VsUHJvbWlzZVJlamVjdG9yICAgPSBudWxsO1xuICAgICAgICBhY3Rpb25TdGF0ZS5pc1JlYWR5Rm9yTG9uZ1ByZXNzICAgICA9IGZhbHNlO1xuICAgICAgICBhY3Rpb25TdGF0ZS5jYW5jZWxDYWxsYmFjayAgICAgICAgICA9IG51bGw7XG4gICAgfVxuXG4gICAgLy9cbiAgICBwcml2YXRlIG9uUG9pbnRlclVwKHNlbGY6IGFueSwgZXY6IFBvaW50ZXJFdmVudCkge1xuICAgICAgICBjb25zdCB7YWN0aW9uU3RhdGV9ID0gc2VsZjtcbiAgICAgICAgaWYgKGV2LnBvaW50ZXJJZCAhPT0gYWN0aW9uU3RhdGUucG9pbnRlcklkKSByZXR1cm47XG4gICAgICAgIGFjdGlvblN0YXRlLmxhc3RDb29yZCA9IFtldi5jbGllbnRYLCBldi5jbGllbnRZXTtcblxuICAgICAgICBpZiAoYWN0aW9uU3RhdGUuaXNSZWFkeUZvckxvbmdQcmVzcyAmJiB0aGlzLmlzSW5QbGFjZShzZWxmKSkge1xuICAgICAgICAgICAgc2VsZi5meD8uKGV2KTtcbiAgICAgICAgICAgIHRoaXMucHJldmVudEZyb21DbGlja2luZyhzZWxmLCBldik7XG4gICAgICAgIH1cblxuICAgICAgICBhY3Rpb25TdGF0ZS5jYW5jZWxDYWxsYmFjaygpO1xuICAgICAgICB0aGlzLnJlc2V0QWN0aW9uKHNlbGYsIGFjdGlvblN0YXRlKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIHByaXZhdGUgaG9sZGluZzogYW55ID0geyBmeDogbnVsbCwgb3B0aW9uczoge30sIGFjdGlvblN0YXRlOiB7fSB9XG4gICAgcHJpdmF0ZSBoYXNQYXJlbnQoY3VycmVudCwgcGFyZW50KSB7IHdoaWxlIChjdXJyZW50KSB7IGlmIChjdXJyZW50ID09PSBwYXJlbnQpIHJldHVybiB0cnVlOyBjdXJyZW50ID0gY3VycmVudC5wYXJlbnRFbGVtZW50OyB9IH1cbiAgICBwcml2YXRlIGlzSW5QbGFjZShzZWxmOiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qge2FjdGlvblN0YXRlfSAgICA9IHNlbGY7XG4gICAgICAgIGNvbnN0IFtzdGFydFgsIHN0YXJ0WV0gPSBhY3Rpb25TdGF0ZS5zdGFydENvb3JkO1xuICAgICAgICBjb25zdCBbbGFzdFgsIGxhc3RZXSAgID0gYWN0aW9uU3RhdGUubGFzdENvb3JkO1xuICAgICAgICBjb25zdCAgZGlzdGFuY2UgICAgICAgID0gTWF0aC5oeXBvdChsYXN0WCAtIHN0YXJ0WCwgbGFzdFkgLSBzdGFydFkpO1xuICAgICAgICByZXR1cm4gZGlzdGFuY2UgPD0gKHNlbGYub3B0aW9ucz8ubWF4T2Zmc2V0UmFkaXVzKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIHByaXZhdGUgaXNWYWxpZFRhcmdldChzZWxmOiBhbnksIHRhcmdldDogSFRNTEVsZW1lbnQsIHdlYWtSZWY6IFdlYWtSZWY8SFRNTEVsZW1lbnQ+KTogYm9vbGVhbnxudWxsfHVuZGVmaW5lZCB7XG4gICAgICAgIGNvbnN0IHdlYWtFbGVtZW50ID0gd2Vha1JlZj8uZGVyZWY/LigpO1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgd2Vha0VsZW1lbnQgJiYgKHRoaXMuaGFzUGFyZW50KHRhcmdldCwgd2Vha0VsZW1lbnQpIHx8IHRhcmdldCA9PT0gd2Vha0VsZW1lbnQpICYmXG4gICAgICAgICAgICAoIXNlbGYub3B0aW9ucz8uaGFuZGxlciB8fCB0YXJnZXQubWF0Y2hlcyhzZWxmLm9wdGlvbnM/LmhhbmRsZXIpKVxuICAgICAgICApO1xuICAgIH1cbn1cblxuLy9cbmV4cG9ydCBkZWZhdWx0IExvbmdQcmVzc0hhbmRsZXI7XG4iXX0=
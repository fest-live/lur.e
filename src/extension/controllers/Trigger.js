import { doBorderObserve, doContentObserve, addEvents, addEvent } from "fest/dom";
import { addToCallChain, booleanRef } from "fest/object";
import { lazyAddEventListener } from "./LazyEvents";
import { unref } from "fest/core";
import { toRef } from "fest/core";
//
const ROOT = typeof document != "undefined" ? document?.documentElement : null;
const SELECTOR = "ui-modal[type=\"contextmenu\"], ui-button, ui-taskbar, ui-navbar, ui-statusbar, button, label, input, ui-longtext, ui-focustext, ui-row-select, ui-row-button, .u2-input, .ui-input";
const $set = (rv, key, val) => { if (rv?.deref?.() != null) {
    return (rv.deref()[key] = val);
} ; };
//
export function makeInterruptTrigger(except = null, ref = booleanRef(false), closeEvents = ["pointerdown", "click", "contextmenu", "scroll"], element = document?.documentElement) {
    if (!element)
        return () => { };
    const wr = new WeakRef(ref);
    const close = typeof ref === "function" ? ref : (ev) => { (!(except?.contains?.(ev?.target) || ev?.target == (except?.element ?? except)) || !except) ? $set(wr, "value", false) : false; };
    const listening = closeEvents.map((event) => lazyAddEventListener(element, event, close, { capture: false, passive: false }));
    const dispose = () => listening.forEach((ub) => ub?.());
    addToCallChain(ref, Symbol.dispose, dispose);
    return dispose;
}
//
export const doObserve = (holder, parent) => {
    if (!holder) {
        throw Error("Element is null...");
    }
    ;
    if (parent) {
        doContentObserve(parent);
    }
    ;
    doBorderObserve(holder);
};
//
export const makeShiftTrigger = (callable, newItem) => ((evc) => {
    const ev = evc;
    newItem ??= ev?.target ?? newItem;
    if (!newItem.dataset.dragging) {
        const n_coord = [ev.clientX, ev.clientY];
        if (ev?.pointerId >= 0) {
            newItem?.setPointerCapture?.(ev?.pointerId);
        }
        ;
        //
        const shifting = ((evc_l) => {
            const ev_l = evc_l;
            ev_l?.preventDefault?.();
            if (ev_l?.pointerId == ev?.pointerId) {
                const coord = [evc_l.clientX, evc_l.clientY];
                const shift = [coord[0] - n_coord[0], coord[1] - n_coord[1]];
                if (Math.hypot(...shift) > 2) {
                    newItem?.style?.setProperty?.("will-change", "inset, transform, translate, z-index");
                    //
                    unbind?.(ev_l);
                    callable?.(ev);
                }
            }
        });
        //
        const releasePointer = ((evc_l) => {
            const ev_l = evc_l;
            if (ev_l?.pointerId == ev?.pointerId) {
                newItem?.releasePointerCapture?.(ev?.pointerId);
                unbind?.(ev_l);
            }
        });
        //
        const handler = {
            "pointermove": shifting,
            "pointercancel": releasePointer,
            "pointerup": releasePointer
        };
        //
        const unbind = ((evc_l) => {
            const ev_l = evc_l;
            if (ev_l?.pointerId == ev?.pointerId) {
                bindings?.forEach(binding => binding?.());
            }
        });
        //
        const bindings = addEvents(ROOT, handler);
    }
});
//
function deepContains(container, target) {
    let node = target;
    while (node) {
        if (node === container)
            return true;
        //
        const anyNode = node;
        if (anyNode.assignedSlot) {
            node = anyNode.assignedSlot;
            continue;
        }
        //
        if (node.parentNode) {
            node = node.parentNode;
            continue;
        }
        //
        const root = node.getRootNode?.();
        if (root && root.host) {
            node = root.host;
        }
        else {
            node = null;
        }
    }
    return false;
}
//
function isInside(target, container) {
    if ('composedPath' in target && typeof target.composedPath === 'function') {
        return target.composedPath().includes(container);
    }
    //
    const node = target.target ? target.target : target;
    return node ? deepContains(container, node) : false;
}
//
export function makeClickOutsideTrigger(ref, except = null, element, options = {}) {
    const { root = typeof document != "undefined" ? document?.documentElement : null, closeEvents = ["scroll", "click", "pointerdown"], mouseLeaveDelay = 100 } = options;
    //
    let mouseLeaveTimer = null;
    //
    const wr = new WeakRef(ref);
    function onMouseLeave() { mouseLeaveTimer = setTimeout(() => { $set(wr, "value", false); }, mouseLeaveDelay); }
    function onMouseEnter() { if (mouseLeaveTimer)
        clearTimeout(mouseLeaveTimer); }
    function onDisposeEvent(ev) { if (!isInside(ev, element?.element ?? element) && !isInside(ev, except?.element ?? except))
        $set(wr, "value", false); }
    function onPointerDown(ev) {
        const t = ev;
        if (!isInside(t, element?.element ?? element) && !isInside(t, except?.element ?? except))
            $set(wr, "value", false);
    }
    //
    const listening = [
        ...addEvents(root, Object.fromEntries(closeEvents.map(event => [event, onDisposeEvent]))),
        addEvent(root, "pointerdown", onPointerDown)
    ];
    if (element) {
        //listening.push(addEvent(element, "mouseleave", onMouseLeave), addEvent(element, "mouseenter", onMouseEnter));
    }
    //
    function destroy() {
        listening.forEach(ub => ub?.());
    }
    //
    addToCallChain(ref, Symbol.dispose, destroy);
    return ref;
}
//
export const OOBTrigger = (element, ref, selector, root = typeof document != "undefined" ? document?.documentElement : null) => {
    ref = toRef(ref);
    const checker = (ev) => {
        let $ref = unref(ref);
        const target = selector ? (ev?.target?.matches?.(selector) ? ev?.target : (ev?.target ?? root)?.querySelector?.(selector)) : ev?.target;
        if (!target || (element != target)) {
            $ref.value = false;
        }
    };
    const cancel = () => { root?.removeEventListener?.("click", checker); };
    if (root)
        root.addEventListener?.("click", checker);
    return cancel;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHJpZ2dlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlRyaWdnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxTQUFTLEVBQXdDLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN4SCxPQUFPLEVBQUUsY0FBYyxFQUF3QixVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0UsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3BELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbEMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVsQyxFQUFFO0FBQ0YsTUFBTSxJQUFJLEdBQUcsT0FBTyxRQUFRLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDL0UsTUFBTSxRQUFRLEdBQUcscUxBQXFMLENBQUM7QUFDdk0sTUFBTSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBQyxFQUFFLEdBQUUsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7QUFBQyxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQXFCaEcsRUFBRTtBQUNGLE1BQU0sVUFBVSxvQkFBb0IsQ0FDaEMsU0FBYyxJQUFJLEVBQ2xCLE1BQXdCLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFDekMsY0FBd0IsQ0FBQyxhQUFhLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxRQUFRLENBQUMsRUFDekUsVUFBZSxRQUFRLEVBQUUsZUFBZTtJQUV4QyxJQUFJLENBQUMsT0FBTztRQUFFLE9BQU8sR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQy9CLE1BQU0sRUFBRSxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVCLE1BQU0sS0FBSyxHQUFHLE9BQU8sR0FBRyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUUsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFLE9BQU8sSUFBSSxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUwsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQ3hDLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBWSxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FDekYsQ0FBQztJQUNGLE1BQU0sT0FBTyxHQUFHLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN4RCxjQUFjLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDN0MsT0FBTyxPQUFPLENBQUM7QUFDbkIsQ0FBQztBQUVELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFDLEVBQUU7SUFDdkMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQUMsTUFBTSxLQUFLLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUFDLENBQUM7SUFBQSxDQUFDO0lBQ3BELElBQUssTUFBTSxFQUFFLENBQUM7UUFBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUFDLENBQUM7SUFBQSxDQUFDO0lBQzNDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM1QixDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxRQUFRLEVBQUUsT0FBUSxFQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFDLEVBQUU7SUFDM0QsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDO0lBQ2YsT0FBTyxLQUFLLEVBQUUsRUFBRSxNQUFNLElBQUksT0FBTyxDQUFDO0lBQ2xDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzVCLE1BQU0sT0FBTyxHQUFxQixDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNELElBQUksRUFBRSxFQUFFLFNBQVMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNwQixPQUF1QixFQUFFLGlCQUFpQixFQUFFLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ2pFLENBQUM7UUFBQSxDQUFDO1FBRUYsRUFBRTtRQUNGLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQyxLQUFVLEVBQUMsRUFBRTtZQUM1QixNQUFNLElBQUksR0FBRyxLQUFLLENBQUM7WUFDbkIsSUFBSSxFQUFFLGNBQWMsRUFBRSxFQUFFLENBQUM7WUFDekIsSUFBSSxJQUFJLEVBQUUsU0FBUyxJQUFJLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQztnQkFDbkMsTUFBTSxLQUFLLEdBQXFCLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQy9ELE1BQU0sS0FBSyxHQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMvRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFDM0IsT0FBTyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsQ0FBQyxhQUFhLEVBQUUsc0NBQXNDLENBQUMsQ0FBQztvQkFFckYsRUFBRTtvQkFDRixNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDZixRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDbkIsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUU7UUFDRixNQUFNLGNBQWMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFDLEVBQUU7WUFDN0IsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDO1lBQ25CLElBQUksSUFBSSxFQUFFLFNBQVMsSUFBSSxFQUFFLEVBQUUsU0FBUyxFQUFFLENBQUM7Z0JBQ2xDLE9BQXVCLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ2pFLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25CLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUU7UUFDRixNQUFNLE9BQU8sR0FBRztZQUNaLGFBQWEsRUFBRSxRQUFRO1lBQ3ZCLGVBQWUsRUFBRSxjQUFjO1lBQy9CLFdBQVcsRUFBRSxjQUFjO1NBQzlCLENBQUE7UUFFRCxFQUFFO1FBQ0YsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBQyxFQUFFO1lBQ3JCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQztZQUNuQixJQUFJLElBQUksRUFBRSxTQUFTLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDO2dCQUNuQyxRQUFRLEVBQUUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzlDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUU7UUFDRixNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQztBQUVILEVBQUU7QUFDRixTQUFTLFlBQVksQ0FBQyxTQUFlLEVBQUUsTUFBWTtJQUMvQyxJQUFJLElBQUksR0FBZ0IsTUFBTSxDQUFDO0lBRS9CLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDVixJQUFJLElBQUksS0FBSyxTQUFTO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFcEMsRUFBRTtRQUNGLE1BQU0sT0FBTyxHQUFHLElBQVcsQ0FBQztRQUM1QixJQUFJLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN2QixJQUFJLEdBQUcsT0FBTyxDQUFDLFlBQW9CLENBQUM7WUFDcEMsU0FBUztRQUNiLENBQUM7UUFFRCxFQUFFO1FBQ0YsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDbEIsSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDdkIsU0FBUztRQUNiLENBQUM7UUFFRCxFQUFFO1FBQ0YsTUFBTSxJQUFJLEdBQUksSUFBWSxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7UUFDM0MsSUFBSSxJQUFJLElBQUssSUFBbUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNwQyxJQUFJLEdBQUksSUFBbUIsQ0FBQyxJQUFJLENBQUM7UUFDckMsQ0FBQzthQUFNLENBQUM7WUFDSixJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2hCLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUVELEVBQUU7QUFDRixTQUFTLFFBQVEsQ0FBQyxNQUFvQixFQUFFLFNBQWtCO0lBQ3RELElBQUksY0FBYyxJQUFLLE1BQWdCLElBQUksT0FBUSxNQUFnQixDQUFDLFlBQVksS0FBSyxVQUFVLEVBQUUsQ0FBQztRQUM5RixPQUFRLE1BQWdCLENBQUMsWUFBWSxFQUFFLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxFQUFFO0lBQ0YsTUFBTSxJQUFJLEdBQUksTUFBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUUsTUFBYyxDQUFDLE1BQWMsQ0FBQyxDQUFDLENBQUMsTUFBYyxDQUFDO0lBQ3RGLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDeEQsQ0FBQztBQUVELEVBQUU7QUFDRixNQUFNLFVBQVUsdUJBQXVCLENBQUMsR0FBWSxFQUFFLFNBQWMsSUFBSSxFQUFFLE9BQVksRUFBRSxVQUEwQixFQUFFO0lBQ2hILE1BQU0sRUFDRixJQUFJLEdBQUcsT0FBTyxRQUFRLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQ3hFLFdBQVcsR0FBRyxDQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLEVBQ2hELGVBQWUsR0FBRyxHQUFHLEVBQ3hCLEdBQUcsT0FBTyxDQUFDO0lBRVosRUFBRTtJQUNGLElBQUksZUFBZSxHQUFRLElBQUksQ0FBQztJQUVoQyxFQUFFO0lBQ0YsTUFBTSxFQUFFLEdBQUcsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUIsU0FBUyxZQUFZLEtBQUssZUFBZSxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0csU0FBUyxZQUFZLEtBQUssSUFBSSxlQUFlO1FBQUUsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUMvRSxTQUFTLGNBQWMsQ0FBQyxFQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sSUFBSSxNQUFNLENBQUM7UUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUosU0FBUyxhQUFhLENBQUMsRUFBUztRQUM1QixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDYixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxJQUFJLE1BQU0sQ0FBQztZQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3ZILENBQUM7SUFFRCxFQUFFO0lBQ0YsTUFBTSxTQUFTLEdBQUc7UUFDZCxHQUFHLFNBQVMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pGLFFBQVEsQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFLGFBQWEsQ0FBQztLQUMvQyxDQUFDO0lBQ0YsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUNWLCtHQUErRztJQUNuSCxDQUFDO0lBRUQsRUFBRTtJQUNGLFNBQVMsT0FBTztRQUNaLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFBLEVBQUUsQ0FBQSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELEVBQUU7SUFDRixjQUFjLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDN0MsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsUUFBUyxFQUFFLElBQUksR0FBRyxPQUFPLFFBQVEsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO0lBQzVILEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRTtRQUNuQixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEIsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLE1BQU0sSUFBSSxJQUFJLENBQUMsRUFBRSxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDO1FBQ3hJLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQUMsQ0FBQztJQUMvRCxDQUFDLENBQUE7SUFDRCxNQUFNLE1BQU0sR0FBRyxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDdkUsSUFBSSxJQUFJO1FBQUUsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQUMsT0FBTyxNQUFNLENBQUM7QUFDdkUsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZG9Cb3JkZXJPYnNlcnZlLCBkb0NvbnRlbnRPYnNlcnZlLCBhZGRFdmVudHMsIGhhbmRsZVN0eWxlQ2hhbmdlLCBpdGVyYXRlQ29udGVudEJveCwgYWRkRXZlbnQgfSBmcm9tIFwiZmVzdC9kb21cIjtcbmltcG9ydCB7IGFkZFRvQ2FsbENoYWluLCBudW1iZXJSZWYsIHN0cmluZ1JlZiwgYm9vbGVhblJlZiB9IGZyb20gXCJmZXN0L29iamVjdFwiO1xuaW1wb3J0IHsgbGF6eUFkZEV2ZW50TGlzdGVuZXIgfSBmcm9tIFwiLi9MYXp5RXZlbnRzXCI7XG5pbXBvcnQgeyB1bnJlZiB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB7IHRvUmVmIH0gZnJvbSBcImZlc3QvY29yZVwiO1xuXG4vL1xuY29uc3QgUk9PVCA9IHR5cGVvZiBkb2N1bWVudCAhPSBcInVuZGVmaW5lZFwiID8gZG9jdW1lbnQ/LmRvY3VtZW50RWxlbWVudCA6IG51bGw7XG5jb25zdCBTRUxFQ1RPUiA9IFwidWktbW9kYWxbdHlwZT1cXFwiY29udGV4dG1lbnVcXFwiXSwgdWktYnV0dG9uLCB1aS10YXNrYmFyLCB1aS1uYXZiYXIsIHVpLXN0YXR1c2JhciwgYnV0dG9uLCBsYWJlbCwgaW5wdXQsIHVpLWxvbmd0ZXh0LCB1aS1mb2N1c3RleHQsIHVpLXJvdy1zZWxlY3QsIHVpLXJvdy1idXR0b24sIC51Mi1pbnB1dCwgLnVpLWlucHV0XCI7XG5jb25zdCAkc2V0ID0gKHJ2LCBrZXksIHZhbCk9PnsgaWYgKHJ2Py5kZXJlZj8uKCkgIT0gbnVsbCkgeyByZXR1cm4gKHJ2LmRlcmVmKClba2V5XSA9IHZhbCk7IH07IH1cblxuLy9cbnR5cGUgUmVmQm9vbCA9IHsgdmFsdWU6IGJvb2xlYW4gfTtcbnR5cGUgQXJlYSA9IHtcbiAgICBsZWZ0ICA6IG51bWJlcjtcbiAgICB0b3AgICA6IG51bWJlcjtcbiAgICByaWdodCA6IG51bWJlcjtcbiAgICBib3R0b206IG51bWJlcjtcbiAgICB3aWR0aCA6IG51bWJlcjtcbiAgICBoZWlnaHQ6IG51bWJlcjtcbn07XG5cbi8vXG5pbnRlcmZhY2UgVHJpZ2dlck9wdGlvbnMge1xuICAgIHJvb3Q/OiBhbnk7XG4gICAgc2VsZWN0b3I/OiBzdHJpbmc7ICAgICAvLyDRgdC10LvQtdC60YLQvtGALCDQstC90YPRgtGA0Lgg0LrQvtGC0L7RgNC+0LPQviDQutC70LjQuiDQvdC1INGB0YfQuNGC0LDQtdGC0YHRjyBcImRpc3Bvc2VcIlxuICAgIGNsb3NlRXZlbnRzPzogc3RyaW5nW107IC8vINC00L7Qv9C+0LvQvdC40YLQtdC70YzQvdGL0LUg0YHQvtCx0YvRgtC40Y8g0LTQu9GPIFwiZGlzcG9zZVwiXG4gICAgbW91c2VMZWF2ZURlbGF5PzogbnVtYmVyOyAvLyDQt9Cw0LTQtdGA0LbQutCwINC00LvRjyBtb3VzZWxlYXZlXG59XG5cbi8vXG5leHBvcnQgZnVuY3Rpb24gbWFrZUludGVycnVwdFRyaWdnZXIoXG4gICAgZXhjZXB0OiBhbnkgPSBudWxsLFxuICAgIHJlZjogUmVmQm9vbHxGdW5jdGlvbiA9IGJvb2xlYW5SZWYoZmFsc2UpLFxuICAgIGNsb3NlRXZlbnRzOiBzdHJpbmdbXSA9IFtcInBvaW50ZXJkb3duXCIsIFwiY2xpY2tcIiwgXCJjb250ZXh0bWVudVwiLCBcInNjcm9sbFwiXSxcbiAgICBlbGVtZW50OiBhbnkgPSBkb2N1bWVudD8uZG9jdW1lbnRFbGVtZW50XG4pIHtcbiAgICBpZiAoIWVsZW1lbnQpIHJldHVybiAoKSA9PiB7IH07XG4gICAgY29uc3Qgd3IgPSBuZXcgV2Vha1JlZihyZWYpO1xuICAgIGNvbnN0IGNsb3NlID0gdHlwZW9mIHJlZiA9PT0gXCJmdW5jdGlvblwiID8gcmVmIDogKGV2KSA9PiB7ICghKGV4Y2VwdD8uY29udGFpbnM/Lihldj8udGFyZ2V0KSB8fCBldj8udGFyZ2V0ID09IChleGNlcHQ/LmVsZW1lbnQgPz8gZXhjZXB0KSkgfHwgIWV4Y2VwdCkgPyAkc2V0KHdyLCBcInZhbHVlXCIsIGZhbHNlKSA6IGZhbHNlOyB9O1xuICAgIGNvbnN0IGxpc3RlbmluZyA9IGNsb3NlRXZlbnRzLm1hcCgoZXZlbnQpID0+XG4gICAgICAgIGxhenlBZGRFdmVudExpc3RlbmVyKGVsZW1lbnQsIGV2ZW50LCBjbG9zZSBhcyBhbnksIHsgY2FwdHVyZTogZmFsc2UsIHBhc3NpdmU6IGZhbHNlIH0pXG4gICAgKTtcbiAgICBjb25zdCBkaXNwb3NlID0gKCkgPT4gbGlzdGVuaW5nLmZvckVhY2goKHViKSA9PiB1Yj8uKCkpO1xuICAgIGFkZFRvQ2FsbENoYWluKHJlZiwgU3ltYm9sLmRpc3Bvc2UsIGRpc3Bvc2UpO1xuICAgIHJldHVybiBkaXNwb3NlO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGRvT2JzZXJ2ZSA9IChob2xkZXIsIHBhcmVudCk9PntcbiAgICBpZiAoIWhvbGRlcikgeyB0aHJvdyBFcnJvcihcIkVsZW1lbnQgaXMgbnVsbC4uLlwiKTsgfTtcbiAgICBpZiAoIHBhcmVudCkgeyBkb0NvbnRlbnRPYnNlcnZlKHBhcmVudCk7IH07XG4gICAgZG9Cb3JkZXJPYnNlcnZlKGhvbGRlcik7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgbWFrZVNoaWZ0VHJpZ2dlciA9IChjYWxsYWJsZSwgbmV3SXRlbT8pPT4gKChldmMpPT57XG4gICAgY29uc3QgZXYgPSBldmM7XG4gICAgbmV3SXRlbSA/Pz0gZXY/LnRhcmdldCA/PyBuZXdJdGVtO1xuICAgIGlmICghbmV3SXRlbS5kYXRhc2V0LmRyYWdnaW5nKSB7XG4gICAgICAgIGNvbnN0IG5fY29vcmQ6IFtudW1iZXIsIG51bWJlcl0gPSBbZXYuY2xpZW50WCwgZXYuY2xpZW50WV07XG4gICAgICAgIGlmIChldj8ucG9pbnRlcklkID49IDApIHtcbiAgICAgICAgICAgIChuZXdJdGVtIGFzIEhUTUxFbGVtZW50KT8uc2V0UG9pbnRlckNhcHR1cmU/Lihldj8ucG9pbnRlcklkKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvL1xuICAgICAgICBjb25zdCBzaGlmdGluZyA9ICgoZXZjX2w6IGFueSk9PntcbiAgICAgICAgICAgIGNvbnN0IGV2X2wgPSBldmNfbDtcbiAgICAgICAgICAgIGV2X2w/LnByZXZlbnREZWZhdWx0Py4oKTtcbiAgICAgICAgICAgIGlmIChldl9sPy5wb2ludGVySWQgPT0gZXY/LnBvaW50ZXJJZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvb3JkOiBbbnVtYmVyLCBudW1iZXJdID0gW2V2Y19sLmNsaWVudFgsIGV2Y19sLmNsaWVudFldO1xuICAgICAgICAgICAgICAgIGNvbnN0IHNoaWZ0OiBbbnVtYmVyLCBudW1iZXJdID0gW2Nvb3JkWzBdIC0gbl9jb29yZFswXSwgY29vcmRbMV0gLSBuX2Nvb3JkWzFdXTtcbiAgICAgICAgICAgICAgICBpZiAoTWF0aC5oeXBvdCguLi5zaGlmdCkgPiAyKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld0l0ZW0/LnN0eWxlPy5zZXRQcm9wZXJ0eT8uKFwid2lsbC1jaGFuZ2VcIiwgXCJpbnNldCwgdHJhbnNmb3JtLCB0cmFuc2xhdGUsIHotaW5kZXhcIik7XG5cbiAgICAgICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAgICAgdW5iaW5kPy4oZXZfbCk7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxhYmxlPy4oZXYpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3QgcmVsZWFzZVBvaW50ZXIgPSAoKGV2Y19sKT0+e1xuICAgICAgICAgICAgY29uc3QgZXZfbCA9IGV2Y19sO1xuICAgICAgICAgICAgaWYgKGV2X2w/LnBvaW50ZXJJZCA9PSBldj8ucG9pbnRlcklkKSB7XG4gICAgICAgICAgICAgICAgKG5ld0l0ZW0gYXMgSFRNTEVsZW1lbnQpPy5yZWxlYXNlUG9pbnRlckNhcHR1cmU/Lihldj8ucG9pbnRlcklkKTtcbiAgICAgICAgICAgICAgICB1bmJpbmQ/Lihldl9sKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3QgaGFuZGxlciA9IHtcbiAgICAgICAgICAgIFwicG9pbnRlcm1vdmVcIjogc2hpZnRpbmcsXG4gICAgICAgICAgICBcInBvaW50ZXJjYW5jZWxcIjogcmVsZWFzZVBvaW50ZXIsXG4gICAgICAgICAgICBcInBvaW50ZXJ1cFwiOiByZWxlYXNlUG9pbnRlclxuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3QgdW5iaW5kID0gKChldmNfbCk9PntcbiAgICAgICAgICAgIGNvbnN0IGV2X2wgPSBldmNfbDtcbiAgICAgICAgICAgIGlmIChldl9sPy5wb2ludGVySWQgPT0gZXY/LnBvaW50ZXJJZCkge1xuICAgICAgICAgICAgICAgIGJpbmRpbmdzPy5mb3JFYWNoKGJpbmRpbmcgPT4gYmluZGluZz8uKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvL1xuICAgICAgICBjb25zdCBiaW5kaW5ncyA9IGFkZEV2ZW50cyhST09ULCBoYW5kbGVyKTtcbiAgICB9XG59KTtcblxuLy9cbmZ1bmN0aW9uIGRlZXBDb250YWlucyhjb250YWluZXI6IE5vZGUsIHRhcmdldDogTm9kZSk6IGJvb2xlYW4ge1xuICAgIGxldCBub2RlOiBOb2RlIHwgbnVsbCA9IHRhcmdldDtcblxuICAgIHdoaWxlIChub2RlKSB7XG4gICAgICAgIGlmIChub2RlID09PSBjb250YWluZXIpIHJldHVybiB0cnVlO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGNvbnN0IGFueU5vZGUgPSBub2RlIGFzIGFueTtcbiAgICAgICAgaWYgKGFueU5vZGUuYXNzaWduZWRTbG90KSB7XG4gICAgICAgICAgICBub2RlID0gYW55Tm9kZS5hc3NpZ25lZFNsb3QgYXMgTm9kZTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkge1xuICAgICAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3Qgcm9vdCA9IChub2RlIGFzIGFueSkuZ2V0Um9vdE5vZGU/LigpO1xuICAgICAgICBpZiAocm9vdCAmJiAocm9vdCBhcyBTaGFkb3dSb290KS5ob3N0KSB7XG4gICAgICAgICAgICBub2RlID0gKHJvb3QgYXMgU2hhZG93Um9vdCkuaG9zdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vZGUgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG4vL1xuZnVuY3Rpb24gaXNJbnNpZGUodGFyZ2V0OiBFdmVudCB8IE5vZGUsIGNvbnRhaW5lcjogRWxlbWVudCk6IGJvb2xlYW4ge1xuICAgIGlmICgnY29tcG9zZWRQYXRoJyBpbiAodGFyZ2V0IGFzIEV2ZW50KSAmJiB0eXBlb2YgKHRhcmdldCBhcyBFdmVudCkuY29tcG9zZWRQYXRoID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHJldHVybiAodGFyZ2V0IGFzIEV2ZW50KS5jb21wb3NlZFBhdGgoKS5pbmNsdWRlcyhjb250YWluZXIpO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3Qgbm9kZSA9ICh0YXJnZXQgYXMgYW55KS50YXJnZXQgPyAodGFyZ2V0IGFzIGFueSkudGFyZ2V0IGFzIE5vZGUgOiB0YXJnZXQgYXMgTm9kZTtcbiAgICByZXR1cm4gbm9kZSA/IGRlZXBDb250YWlucyhjb250YWluZXIsIG5vZGUpIDogZmFsc2U7XG59XG5cbi8vXG5leHBvcnQgZnVuY3Rpb24gbWFrZUNsaWNrT3V0c2lkZVRyaWdnZXIocmVmOiBSZWZCb29sLCBleGNlcHQ6IGFueSA9IG51bGwsIGVsZW1lbnQ6IGFueSwgb3B0aW9uczogVHJpZ2dlck9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IHtcbiAgICAgICAgcm9vdCA9IHR5cGVvZiBkb2N1bWVudCAhPSBcInVuZGVmaW5lZFwiID8gZG9jdW1lbnQ/LmRvY3VtZW50RWxlbWVudCA6IG51bGwsXG4gICAgICAgIGNsb3NlRXZlbnRzID0gW1wic2Nyb2xsXCIsIFwiY2xpY2tcIiwgXCJwb2ludGVyZG93blwiXSxcbiAgICAgICAgbW91c2VMZWF2ZURlbGF5ID0gMTAwXG4gICAgfSA9IG9wdGlvbnM7XG5cbiAgICAvL1xuICAgIGxldCBtb3VzZUxlYXZlVGltZXI6IGFueSA9IG51bGw7XG5cbiAgICAvL1xuICAgIGNvbnN0IHdyID0gbmV3IFdlYWtSZWYocmVmKTtcbiAgICBmdW5jdGlvbiBvbk1vdXNlTGVhdmUoKSB7IG1vdXNlTGVhdmVUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4geyAkc2V0KHdyLCBcInZhbHVlXCIsIGZhbHNlKTsgfSwgbW91c2VMZWF2ZURlbGF5KTsgfVxuICAgIGZ1bmN0aW9uIG9uTW91c2VFbnRlcigpIHsgaWYgKG1vdXNlTGVhdmVUaW1lcikgY2xlYXJUaW1lb3V0KG1vdXNlTGVhdmVUaW1lcik7IH1cbiAgICBmdW5jdGlvbiBvbkRpc3Bvc2VFdmVudChldjogRXZlbnQpIHsgaWYgKCFpc0luc2lkZShldiwgZWxlbWVudD8uZWxlbWVudCA/PyBlbGVtZW50KSAmJiAhaXNJbnNpZGUoZXYsIGV4Y2VwdD8uZWxlbWVudCA/PyBleGNlcHQpKSAkc2V0KHdyLCBcInZhbHVlXCIsIGZhbHNlKTsgfVxuICAgIGZ1bmN0aW9uIG9uUG9pbnRlckRvd24oZXY6IEV2ZW50KSB7XG4gICAgICAgIGNvbnN0IHQgPSBldjtcbiAgICAgICAgaWYgKCFpc0luc2lkZSh0LCBlbGVtZW50Py5lbGVtZW50ID8/IGVsZW1lbnQpICYmICFpc0luc2lkZSh0LCBleGNlcHQ/LmVsZW1lbnQgPz8gZXhjZXB0KSkgJHNldCh3ciwgXCJ2YWx1ZVwiLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBjb25zdCBsaXN0ZW5pbmcgPSBbXG4gICAgICAgIC4uLmFkZEV2ZW50cyhyb290LCBPYmplY3QuZnJvbUVudHJpZXMoY2xvc2VFdmVudHMubWFwKGV2ZW50ID0+IFtldmVudCwgb25EaXNwb3NlRXZlbnRdKSkpLFxuICAgICAgICBhZGRFdmVudChyb290LCBcInBvaW50ZXJkb3duXCIsIG9uUG9pbnRlckRvd24pXG4gICAgXTtcbiAgICBpZiAoZWxlbWVudCkge1xuICAgICAgICAvL2xpc3RlbmluZy5wdXNoKGFkZEV2ZW50KGVsZW1lbnQsIFwibW91c2VsZWF2ZVwiLCBvbk1vdXNlTGVhdmUpLCBhZGRFdmVudChlbGVtZW50LCBcIm1vdXNlZW50ZXJcIiwgb25Nb3VzZUVudGVyKSk7XG4gICAgfVxuXG4gICAgLy9cbiAgICBmdW5jdGlvbiBkZXN0cm95KCkge1xuICAgICAgICBsaXN0ZW5pbmcuZm9yRWFjaCh1Yj0+dWI/LigpKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGFkZFRvQ2FsbENoYWluKHJlZiwgU3ltYm9sLmRpc3Bvc2UsIGRlc3Ryb3kpO1xuICAgIHJldHVybiByZWY7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgT09CVHJpZ2dlciA9IChlbGVtZW50LCByZWYsIHNlbGVjdG9yPywgcm9vdCA9IHR5cGVvZiBkb2N1bWVudCAhPSBcInVuZGVmaW5lZFwiID8gZG9jdW1lbnQ/LmRvY3VtZW50RWxlbWVudCA6IG51bGwpID0+IHtcbiAgICByZWYgPSB0b1JlZihyZWYpO1xuICAgIGNvbnN0IGNoZWNrZXIgPSAoZXYpID0+IHtcbiAgICAgICAgbGV0ICRyZWYgPSB1bnJlZihyZWYpO1xuICAgICAgICBjb25zdCB0YXJnZXQgPSBzZWxlY3RvciA/IChldj8udGFyZ2V0Py5tYXRjaGVzPy4oc2VsZWN0b3IpID8gZXY/LnRhcmdldCA6IChldj8udGFyZ2V0ID8/IHJvb3QpPy5xdWVyeVNlbGVjdG9yPy4oc2VsZWN0b3IpKSA6IGV2Py50YXJnZXQ7XG4gICAgICAgIGlmICghdGFyZ2V0IHx8IChlbGVtZW50ICE9IHRhcmdldCkpIHsgJHJlZi52YWx1ZSA9IGZhbHNlOyB9XG4gICAgfVxuICAgIGNvbnN0IGNhbmNlbCA9ICgpID0+IHsgcm9vdD8ucmVtb3ZlRXZlbnRMaXN0ZW5lcj8uKFwiY2xpY2tcIiwgY2hlY2tlcik7IH1cbiAgICBpZiAocm9vdCkgcm9vdC5hZGRFdmVudExpc3RlbmVyPy4oXCJjbGlja1wiLCBjaGVja2VyKTsgcmV0dXJuIGNhbmNlbDtcbn1cbiJdfQ==
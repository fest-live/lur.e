import { addEvent, fixedClientZoom } from "fest/dom";
import { stringRef } from "fest/object";
//
export const electronAPI = "electronBridge";
//
function extractAlpha(input) {
    if (typeof input !== 'string')
        return null;
    let color = input.trim().toLowerCase();
    // 1) Ключевые слова
    if (color === 'transparent')
        return 0;
    // 2) Hex-формы (#rgb[a], #rrggbb[aa]) — обычно не из getComputedStyle, но полезно
    if (color.startsWith('#')) {
        const hex = color;
        if (hex.length === 4)
            return 1; // #rgb
        if (hex.length === 7)
            return 1; // #rrggbb
        if (hex.length === 5) { // #rgba
            const a = hex[4];
            const aa = a + a; // expand
            return clamp(parseInt(aa, 16) / 255, 0, 1);
        }
        if (hex.length === 9) { // #rrggbbaa
            const aa = hex.slice(7, 9);
            return clamp(parseInt(aa, 16) / 255, 0, 1);
        }
        return null; // неизвестная длина
    }
    // 3) Функциональные нотации: rgb(), rgba(), hsl()/hsla() и т.п., color()
    const fnMatch = color.match(/^([a-z-]+)\((.*)\)$/i);
    if (!fnMatch) {
        // getComputedStyle не возвращает 'inherit/initial/unset' — если вдруг:
        return null;
    }
    const name = fnMatch[1];
    const body = fnMatch[2].trim();
    // 3a) Новая синтаксис с косой чертой: … / <alpha>
    // Работает для rgb(), hsl(), hwb(), lab(), lch(), oklab(), oklch(), color()
    {
        const slashIdx = body.lastIndexOf('/');
        if (slashIdx !== -1) {
            const aStr = body.slice(slashIdx + 1).trim();
            const a = parseAlphaComponent(aStr);
            if (a != null)
                return clamp(a, 0, 1);
            return null;
        }
    }
    // 3b) Старая запятая-форма с 4-м аргументом: rgba(..., a), hsla(..., a)
    // Также многие браузеры ещё возвращают rgba(r,g,b,a)
    if (body.includes(',')) {
        const parts = body.split(',').map(s => s.trim());
        if (parts.length >= 4) {
            const a = parseAlphaComponent(parts[3]);
            if (a != null)
                return clamp(a, 0, 1);
            return null;
        }
        // 3 аргумента — альфы нет
        return 1;
    }
    // 3c) Другие функциональные без альфы => 1
    return 1;
}
function parseAlphaComponent(str) {
    if (!str)
        return null;
    // Проценты: 30% => 0.3
    if (str.endsWith('%')) {
        const n = parseFloat(str);
        if (Number.isNaN(n))
            return null;
        return n / 100;
    }
    // Число 0..1
    const n = parseFloat(str);
    if (Number.isNaN(n))
        return null;
    return n;
}
function clamp(v, min, max) {
    return Math.min(max, Math.max(min, v));
}
//
const tacp = (color) => {
    if (!color || color == null)
        return 0;
    return (extractAlpha?.(color) || 0) > 0.1;
};
//
const setIdleInterval = (cb, timeout = 1000, ...args) => {
    requestIdleCallback(async () => {
        if (!cb || (typeof cb != "function"))
            return;
        while (true) { // @ts-ignore
            await Promise.try(cb, ...args);
            await new Promise((r) => setTimeout(r, timeout));
            await new Promise((r) => requestIdleCallback(r, { timeout: 100 }));
            await new Promise((r) => requestAnimationFrame(r));
        }
    }, { timeout: 1000 });
};
//
export const pickBgColor = (x, y, holder = null) => {
    // exclude any non-reasonable
    const opaque = Array.from(document.elementsFromPoint(x, y))?.filter?.((el) => (((el instanceof HTMLElement) && el != holder) &&
        (el?.dataset?.alpha != null ? parseFloat(el?.dataset?.alpha) > 0.01 : true) && // @ts-ignore
        el?.checkVisibility?.({ contentVisibilityAuto: true, opacityProperty: true, visibilityProperty: true }) &&
        el?.matches?.(":not([data-hidden])") &&
        (el?.style?.getPropertyValue("display") != "none")))
        .map((element) => {
        const computed = getComputedStyle?.(element);
        return {
            element,
            zIndex: parseInt(computed?.zIndex || "0", 10) || 0,
            color: (computed?.backgroundColor || "transparent")
        };
    })
        .sort((a, b) => Math.sign(b.zIndex - a.zIndex))
        .filter(({ color }) => (tacp(color)));
    //
    if (opaque?.[0]?.element instanceof HTMLElement) {
        return opaque?.[0]?.color || "transparent";
    }
    //
    return "transparent";
};
//
export const pickFromCenter = (holder) => {
    // not able to using some mechanics
    const box = holder?.getBoundingClientRect(); //getBoundingOrientBox(holder);
    if (box) {
        const Z = 0.5 * (fixedClientZoom?.() || 1);
        const xy = [(box.left + box.right) * Z, (box.top + box.bottom) * Z];
        return pickBgColor(...xy, holder);
    }
};
//
export const dynamicNativeFrame = (root = document.documentElement) => {
    let media = root?.querySelector?.('meta[data-theme-color]') ?? root?.querySelector?.('meta[name="theme-color"]');
    // Create meta element if it doesn't exist
    if (!media && root == document.documentElement) {
        media = document.createElement('meta');
        media.setAttribute('name', 'theme-color');
        media.setAttribute('data-theme-color', '');
        media.setAttribute('content', 'transparent');
        document.head.appendChild(media);
    }
    const color = pickBgColor(globalThis.innerWidth - 64, 10);
    if ((media || window?.[electronAPI]) && root == document.documentElement) {
        media?.setAttribute?.("content", color);
    }
};
//
export const dynamicBgColors = (root = document.documentElement) => {
    root.querySelectorAll("body, body > *, body > * > *").forEach((target) => {
        if (target) {
            pickFromCenter(target);
        }
    });
};
//
export const dynamicTheme = (ROOT = document.documentElement) => {
    matchMedia("(prefers-color-scheme: dark)").addEventListener("change", ({}) => dynamicBgColors(ROOT));
    //
    const updater = () => {
        dynamicNativeFrame(ROOT);
        dynamicBgColors(ROOT);
    };
    //
    addEvent(ROOT, "u2-appear", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(ROOT, "u2-hidden", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(ROOT, "u2-theme-change", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(window, "load", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(document, "visibilitychange", () => requestIdleCallback(updater, { timeout: 100 }));
    setIdleInterval(updater, 500);
};
//
export const currentColorFromPointRef = (x, y, ROOT = document.documentElement, timeout = 500) => {
    const color = pickBgColor(x, y, ROOT);
    const rfc = stringRef(color);
    const updater = () => {
        const color = pickBgColor(x, y, ROOT);
        rfc.value = color;
    };
    //
    addEvent(ROOT, "u2-appear", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(ROOT, "u2-hidden", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(ROOT, "u2-theme-change", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(window, "load", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(document, "visibilitychange", () => requestIdleCallback(updater, { timeout: 100 }));
    setIdleInterval(updater, timeout);
    return rfc;
};
//
export const currentColorFromCenterRef = (element, ROOT = document.documentElement, timeout = 500) => {
    const color = pickFromCenter(element);
    const rfc = stringRef(color);
    const updater = () => {
        const color = pickFromCenter(element);
        rfc.value = color;
    };
    //
    addEvent(ROOT, "u2-appear", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(ROOT, "u2-hidden", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(ROOT, "u2-theme-change", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(window, "load", () => requestIdleCallback(updater, { timeout: 100 }));
    addEvent(document, "visibilitychange", () => requestIdleCallback(updater, { timeout: 100 }));
    setIdleInterval(updater, timeout);
    return rfc;
};
//
export default dynamicTheme;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRHluYW1pY0VuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkR5bmFtaWNFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV4QyxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLGdCQUFnQixDQUFDO0FBRTVDLEVBQUU7QUFDRixTQUFTLFlBQVksQ0FBQyxLQUFLO0lBQ3ZCLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtRQUFFLE9BQU8sSUFBSSxDQUFDO0lBQzNDLElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUV2QyxvQkFBb0I7SUFDcEIsSUFBSSxLQUFLLEtBQUssYUFBYTtRQUFFLE9BQU8sQ0FBQyxDQUFDO0lBRXRDLGtGQUFrRjtJQUNsRixJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUN4QixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7UUFDbEIsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU87UUFDdkMsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLFVBQVU7UUFDMUMsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsUUFBUTtZQUM1QixNQUFNLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDakIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFNBQVM7WUFDM0IsT0FBTyxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQy9DLENBQUM7UUFDRCxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZO1lBQ2hDLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzNCLE9BQU8sS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMvQyxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsQ0FBQyxvQkFBb0I7SUFDckMsQ0FBQztJQUVELHlFQUF5RTtJQUN6RSxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUM7SUFDcEQsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ1gsdUVBQXVFO1FBQ3ZFLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEIsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBRS9CLGtEQUFrRDtJQUNsRCw0RUFBNEU7SUFDNUUsQ0FBQztRQUNHLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdkMsSUFBSSxRQUFRLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUNsQixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUM3QyxNQUFNLENBQUMsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwQyxJQUFJLENBQUMsSUFBSSxJQUFJO2dCQUFFLE9BQU8sS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDckMsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztJQUNMLENBQUM7SUFFRCx3RUFBd0U7SUFDeEUscURBQXFEO0lBQ3JELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ3JCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7UUFDakQsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxHQUFHLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3hDLElBQUksQ0FBQyxJQUFJLElBQUk7Z0JBQUUsT0FBTyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNyQyxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDO1FBQ0QsMEJBQTBCO1FBQzFCLE9BQU8sQ0FBQyxDQUFDO0lBQ2IsQ0FBQztJQUVELDJDQUEyQztJQUMzQyxPQUFPLENBQUMsQ0FBQztBQUNiLENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLEdBQUc7SUFDNUIsSUFBSSxDQUFDLEdBQUc7UUFBRSxPQUFPLElBQUksQ0FBQztJQUN0Qix1QkFBdUI7SUFDdkIsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDcEIsTUFBTSxDQUFDLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFBRSxPQUFPLElBQUksQ0FBQztRQUNqQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUM7SUFDbkIsQ0FBQztJQUNELGFBQWE7SUFDYixNQUFNLENBQUMsR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDMUIsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUFFLE9BQU8sSUFBSSxDQUFDO0lBQ2pDLE9BQU8sQ0FBQyxDQUFDO0FBQ2IsQ0FBQztBQUVELFNBQVMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRztJQUN0QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDM0MsQ0FBQztBQUlELEVBQUU7QUFDRixNQUFNLElBQUksR0FBRyxDQUFDLEtBQWEsRUFBQyxFQUFFO0lBQzFCLElBQUksQ0FBQyxLQUFLLElBQUksS0FBSyxJQUFJLElBQUk7UUFBRSxPQUFPLENBQUMsQ0FBQztJQUN0QyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBQzlDLENBQUMsQ0FBQztBQUVGLEVBQUU7QUFDRixNQUFNLGVBQWUsR0FBRyxDQUFDLEVBQUUsRUFBRSxPQUFPLEdBQUcsSUFBSSxFQUFFLEdBQUcsSUFBSSxFQUFDLEVBQUU7SUFDbkQsbUJBQW1CLENBQUMsS0FBSyxJQUFHLEVBQUU7UUFDMUIsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLFVBQVUsQ0FBQztZQUFFLE9BQU87UUFDN0MsT0FBTyxJQUFJLEVBQUUsQ0FBQyxDQUFDLGFBQWE7WUFDeEIsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQy9CLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUMsRUFBRSxDQUFBLFVBQVUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUMvQyxNQUFNLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQSxtQkFBbUIsQ0FBQyxDQUFDLEVBQUUsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9ELE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUMsRUFBRSxDQUFBLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckQsQ0FBQztJQUNMLENBQUMsRUFBRSxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0FBQ3hCLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLFNBQTZCLElBQUksRUFBQyxFQUFFO0lBQ2xFLDZCQUE2QjtJQUM3QixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQU8sRUFBQyxFQUFFLENBQUEsQ0FDN0UsQ0FBQyxDQUFDLEVBQUUsWUFBWSxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksTUFBTSxDQUFDO1FBQzdDLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLGFBQWE7UUFDM0YsRUFBRSxFQUFFLGVBQWUsRUFBRSxDQUFDLEVBQUUscUJBQXFCLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsa0JBQWtCLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDdkcsRUFBRSxFQUFFLE9BQU8sRUFBRSxDQUFDLHFCQUFxQixDQUFDO1FBQ3JDLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FDckQsQ0FBQztTQUNELEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQ2IsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM3QyxPQUFPO1lBQ0gsT0FBTztZQUNQLE1BQU0sRUFBRSxRQUFRLENBQUMsUUFBUSxFQUFFLE1BQU0sSUFBSSxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQztZQUNsRCxLQUFLLEVBQUUsQ0FBQyxRQUFRLEVBQUUsZUFBZSxJQUFJLGFBQWEsQ0FBQztTQUN0RCxDQUFBO0lBQUEsQ0FBQyxDQUFDO1NBQ04sSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUM5QyxNQUFNLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFDLEVBQUUsQ0FBQSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFcEMsRUFBRTtJQUNGLElBQUksTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxZQUFZLFdBQVcsRUFBRSxDQUFDO1FBQzlDLE9BQU8sTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxJQUFJLGFBQWEsQ0FBQztJQUMvQyxDQUFDO0lBRUQsRUFBRTtJQUNGLE9BQU8sYUFBYSxDQUFDO0FBQ3pCLENBQUMsQ0FBQztBQUVGLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxjQUFjLEdBQUcsQ0FBQyxNQUFNLEVBQUMsRUFBRTtJQUNwQyxtQ0FBbUM7SUFDbkMsTUFBTSxHQUFHLEdBQUcsTUFBTSxFQUFFLHFCQUFxQixFQUFFLENBQUMsQ0FBQSwrQkFBK0I7SUFDM0UsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNOLE1BQU0sQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLGVBQWUsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDM0MsTUFBTSxFQUFFLEdBQXFCLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUN0RixPQUFPLFdBQVcsQ0FBQyxHQUFHLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUN0QyxDQUFDO0FBQ0wsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxlQUFlLEVBQUMsRUFBRTtJQUNqRSxJQUFJLEtBQUssR0FBRyxJQUFJLEVBQUUsYUFBYSxFQUFFLENBQUMsd0JBQXdCLENBQUMsSUFBSSxJQUFJLEVBQUUsYUFBYSxFQUFFLENBQUMsMEJBQTBCLENBQUMsQ0FBQztJQUVqSCwwQ0FBMEM7SUFDMUMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLElBQUksUUFBUSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzdDLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZDLEtBQUssQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQzFDLEtBQUssQ0FBQyxZQUFZLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDM0MsS0FBSyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDN0MsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUMsVUFBVSxHQUFHLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUMxRCxJQUFJLENBQUMsS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN2RSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzVDLENBQUM7QUFDTCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sZUFBZSxHQUFHLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxlQUFlLEVBQUUsRUFBRTtJQUMvRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsOEJBQThCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUMsRUFBRTtRQUNwRSxJQUFJLE1BQU0sRUFBRSxDQUFDO1lBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLGVBQWUsRUFBQyxFQUFFO0lBQzNELFVBQVUsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFckcsRUFBRTtJQUNGLE1BQU0sT0FBTyxHQUFHLEdBQUUsRUFBRTtRQUNoQixrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUIsQ0FBQyxDQUFBO0lBRUQsRUFBRTtJQUNGLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUUsUUFBUSxDQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsR0FBRSxFQUFFLENBQUEsbUJBQW1CLENBQUMsT0FBTyxFQUFFLEVBQUMsT0FBTyxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQztJQUM5RSxRQUFRLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEYsUUFBUSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRSxFQUFFLENBQUEsbUJBQW1CLENBQUMsT0FBTyxFQUFFLEVBQUMsT0FBTyxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQztJQUMzRSxRQUFRLENBQUMsUUFBUSxFQUFFLGtCQUFrQixFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekYsZUFBZSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNsQyxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sd0JBQXdCLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksR0FBRyxRQUFRLENBQUMsZUFBZSxFQUFFLE9BQU8sR0FBRyxHQUFHLEVBQUMsRUFBRTtJQUM1RixNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUN0QyxNQUFNLEdBQUcsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsTUFBTSxPQUFPLEdBQUcsR0FBRSxFQUFFO1FBQ2hCLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3RDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3RCLENBQUMsQ0FBQTtJQUVELEVBQUU7SUFDRixRQUFRLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxHQUFFLEVBQUUsQ0FBQSxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzlFLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUUsUUFBUSxDQUFDLElBQUksRUFBRSxpQkFBaUIsRUFBRSxHQUFFLEVBQUUsQ0FBQSxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLFFBQVEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDM0UsUUFBUSxDQUFDLFFBQVEsRUFBRSxrQkFBa0IsRUFBRSxHQUFFLEVBQUUsQ0FBQSxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pGLGVBQWUsQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDbEMsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0seUJBQXlCLEdBQUcsQ0FBQyxPQUFvQixFQUFFLElBQUksR0FBRyxRQUFRLENBQUMsZUFBZSxFQUFFLE9BQU8sR0FBRyxHQUFHLEVBQUMsRUFBRTtJQUM3RyxNQUFNLEtBQUssR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzdCLE1BQU0sT0FBTyxHQUFHLEdBQUUsRUFBRTtRQUNoQixNQUFNLEtBQUssR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdEMsR0FBRyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDdEIsQ0FBQyxDQUFBO0lBRUQsRUFBRTtJQUNGLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUUsUUFBUSxDQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsR0FBRSxFQUFFLENBQUEsbUJBQW1CLENBQUMsT0FBTyxFQUFFLEVBQUMsT0FBTyxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQztJQUM5RSxRQUFRLENBQUMsSUFBSSxFQUFFLGlCQUFpQixFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEYsUUFBUSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRSxFQUFFLENBQUEsbUJBQW1CLENBQUMsT0FBTyxFQUFFLEVBQUMsT0FBTyxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQztJQUMzRSxRQUFRLENBQUMsUUFBUSxFQUFFLGtCQUFrQixFQUFFLEdBQUUsRUFBRSxDQUFBLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekYsZUFBZSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNsQyxPQUFPLEdBQUcsQ0FBQztBQUNmLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixlQUFlLFlBQVksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkZEV2ZW50LCBmaXhlZENsaWVudFpvb20gfSBmcm9tIFwiZmVzdC9kb21cIjtcbmltcG9ydCB7IHN0cmluZ1JlZiB9IGZyb20gXCJmZXN0L29iamVjdFwiO1xuXG4vL1xuZXhwb3J0IGNvbnN0IGVsZWN0cm9uQVBJID0gXCJlbGVjdHJvbkJyaWRnZVwiO1xuXG4vL1xuZnVuY3Rpb24gZXh0cmFjdEFscGhhKGlucHV0KSB7XG4gICAgaWYgKHR5cGVvZiBpbnB1dCAhPT0gJ3N0cmluZycpIHJldHVybiBudWxsO1xuICAgIGxldCBjb2xvciA9IGlucHV0LnRyaW0oKS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgLy8gMSkg0JrQu9GO0YfQtdCy0YvQtSDRgdC70L7QstCwXG4gICAgaWYgKGNvbG9yID09PSAndHJhbnNwYXJlbnQnKSByZXR1cm4gMDtcblxuICAgIC8vIDIpIEhleC3RhNC+0YDQvNGLICgjcmdiW2FdLCAjcnJnZ2JiW2FhXSkg4oCUINC+0LHRi9GH0L3QviDQvdC1INC40LcgZ2V0Q29tcHV0ZWRTdHlsZSwg0L3QviDQv9C+0LvQtdC30L3QvlxuICAgIGlmIChjb2xvci5zdGFydHNXaXRoKCcjJykpIHtcbiAgICAgICAgY29uc3QgaGV4ID0gY29sb3I7XG4gICAgICAgIGlmIChoZXgubGVuZ3RoID09PSA0KSByZXR1cm4gMTsgLy8gI3JnYlxuICAgICAgICBpZiAoaGV4Lmxlbmd0aCA9PT0gNykgcmV0dXJuIDE7IC8vICNycmdnYmJcbiAgICAgICAgaWYgKGhleC5sZW5ndGggPT09IDUpIHsgLy8gI3JnYmFcbiAgICAgICAgICAgIGNvbnN0IGEgPSBoZXhbNF07XG4gICAgICAgICAgICBjb25zdCBhYSA9IGEgKyBhOyAvLyBleHBhbmRcbiAgICAgICAgICAgIHJldHVybiBjbGFtcChwYXJzZUludChhYSwgMTYpIC8gMjU1LCAwLCAxKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaGV4Lmxlbmd0aCA9PT0gOSkgeyAvLyAjcnJnZ2JiYWFcbiAgICAgICAgICAgIGNvbnN0IGFhID0gaGV4LnNsaWNlKDcsIDkpO1xuICAgICAgICAgICAgcmV0dXJuIGNsYW1wKHBhcnNlSW50KGFhLCAxNikgLyAyNTUsIDAsIDEpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsOyAvLyDQvdC10LjQt9Cy0LXRgdGC0L3QsNGPINC00LvQuNC90LBcbiAgICB9XG5cbiAgICAvLyAzKSDQpNGD0L3QutGG0LjQvtC90LDQu9GM0L3Ri9C1INC90L7RgtCw0YbQuNC4OiByZ2IoKSwgcmdiYSgpLCBoc2woKS9oc2xhKCkg0Lgg0YIu0L8uLCBjb2xvcigpXG4gICAgY29uc3QgZm5NYXRjaCA9IGNvbG9yLm1hdGNoKC9eKFthLXotXSspXFwoKC4qKVxcKSQvaSk7XG4gICAgaWYgKCFmbk1hdGNoKSB7XG4gICAgICAgIC8vIGdldENvbXB1dGVkU3R5bGUg0L3QtSDQstC+0LfQstGA0LDRidCw0LXRgiAnaW5oZXJpdC9pbml0aWFsL3Vuc2V0JyDigJQg0LXRgdC70Lgg0LLQtNGA0YPQszpcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgbmFtZSA9IGZuTWF0Y2hbMV07XG4gICAgY29uc3QgYm9keSA9IGZuTWF0Y2hbMl0udHJpbSgpO1xuXG4gICAgLy8gM2EpINCd0L7QstCw0Y8g0YHQuNC90YLQsNC60YHQuNGBINGBINC60L7RgdC+0Lkg0YfQtdGA0YLQvtC5OiDigKYgLyA8YWxwaGE+XG4gICAgLy8g0KDQsNCx0L7RgtCw0LXRgiDQtNC70Y8gcmdiKCksIGhzbCgpLCBod2IoKSwgbGFiKCksIGxjaCgpLCBva2xhYigpLCBva2xjaCgpLCBjb2xvcigpXG4gICAge1xuICAgICAgICBjb25zdCBzbGFzaElkeCA9IGJvZHkubGFzdEluZGV4T2YoJy8nKTtcbiAgICAgICAgaWYgKHNsYXNoSWR4ICE9PSAtMSkge1xuICAgICAgICAgICAgY29uc3QgYVN0ciA9IGJvZHkuc2xpY2Uoc2xhc2hJZHggKyAxKS50cmltKCk7XG4gICAgICAgICAgICBjb25zdCBhID0gcGFyc2VBbHBoYUNvbXBvbmVudChhU3RyKTtcbiAgICAgICAgICAgIGlmIChhICE9IG51bGwpIHJldHVybiBjbGFtcChhLCAwLCAxKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gM2IpINCh0YLQsNGA0LDRjyDQt9Cw0L/Rj9GC0LDRjy3RhNC+0YDQvNCwINGBIDQt0Lwg0LDRgNCz0YPQvNC10L3RgtC+0Lw6IHJnYmEoLi4uLCBhKSwgaHNsYSguLi4sIGEpXG4gICAgLy8g0KLQsNC60LbQtSDQvNC90L7Qs9C40LUg0LHRgNCw0YPQt9C10YDRiyDQtdGJ0ZEg0LLQvtC30LLRgNCw0YnQsNGO0YIgcmdiYShyLGcsYixhKVxuICAgIGlmIChib2R5LmluY2x1ZGVzKCcsJykpIHtcbiAgICAgICAgY29uc3QgcGFydHMgPSBib2R5LnNwbGl0KCcsJykubWFwKHMgPT4gcy50cmltKCkpO1xuICAgICAgICBpZiAocGFydHMubGVuZ3RoID49IDQpIHtcbiAgICAgICAgICAgIGNvbnN0IGEgPSBwYXJzZUFscGhhQ29tcG9uZW50KHBhcnRzWzNdKTtcbiAgICAgICAgICAgIGlmIChhICE9IG51bGwpIHJldHVybiBjbGFtcChhLCAwLCAxKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIC8vIDMg0LDRgNCz0YPQvNC10L3RgtCwIOKAlCDQsNC70YzRhNGLINC90LXRglxuICAgICAgICByZXR1cm4gMTtcbiAgICB9XG5cbiAgICAvLyAzYykg0JTRgNGD0LPQuNC1INGE0YPQvdC60YbQuNC+0L3QsNC70YzQvdGL0LUg0LHQtdC3INCw0LvRjNGE0YsgPT4gMVxuICAgIHJldHVybiAxO1xufVxuXG5mdW5jdGlvbiBwYXJzZUFscGhhQ29tcG9uZW50KHN0cikge1xuICAgIGlmICghc3RyKSByZXR1cm4gbnVsbDtcbiAgICAvLyDQn9GA0L7RhtC10L3RgtGLOiAzMCUgPT4gMC4zXG4gICAgaWYgKHN0ci5lbmRzV2l0aCgnJScpKSB7XG4gICAgICAgIGNvbnN0IG4gPSBwYXJzZUZsb2F0KHN0cik7XG4gICAgICAgIGlmIChOdW1iZXIuaXNOYU4obikpIHJldHVybiBudWxsO1xuICAgICAgICByZXR1cm4gbiAvIDEwMDtcbiAgICB9XG4gICAgLy8g0KfQuNGB0LvQviAwLi4xXG4gICAgY29uc3QgbiA9IHBhcnNlRmxvYXQoc3RyKTtcbiAgICBpZiAoTnVtYmVyLmlzTmFOKG4pKSByZXR1cm4gbnVsbDtcbiAgICByZXR1cm4gbjtcbn1cblxuZnVuY3Rpb24gY2xhbXAodiwgbWluLCBtYXgpIHtcbiAgICByZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHYpKTtcbn1cblxuXG5cbi8vXG5jb25zdCB0YWNwID0gKGNvbG9yOiBzdHJpbmcpPT57XG4gICAgaWYgKCFjb2xvciB8fCBjb2xvciA9PSBudWxsKSByZXR1cm4gMDtcbiAgICByZXR1cm4gKGV4dHJhY3RBbHBoYT8uKGNvbG9yKSB8fCAwKSA+IDAuMTtcbn07XG5cbi8vXG5jb25zdCBzZXRJZGxlSW50ZXJ2YWwgPSAoY2IsIHRpbWVvdXQgPSAxMDAwLCAuLi5hcmdzKT0+e1xuICAgIHJlcXVlc3RJZGxlQ2FsbGJhY2soYXN5bmMgKCk9PntcbiAgICAgICAgaWYgKCFjYiB8fCAodHlwZW9mIGNiICE9IFwiZnVuY3Rpb25cIikpIHJldHVybjtcbiAgICAgICAgd2hpbGUgKHRydWUpIHsgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS50cnkoY2IsIC4uLmFyZ3MpO1xuICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHIpPT5zZXRUaW1lb3V0KHIsIHRpbWVvdXQpKTtcbiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyKT0+cmVxdWVzdElkbGVDYWxsYmFjayhyLCB7dGltZW91dDogMTAwfSkpO1xuICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHIpPT5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUocikpO1xuICAgICAgICB9XG4gICAgfSwge3RpbWVvdXQ6IDEwMDB9KTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBwaWNrQmdDb2xvciA9ICh4LCB5LCBob2xkZXI6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGwpPT57XG4gICAgLy8gZXhjbHVkZSBhbnkgbm9uLXJlYXNvbmFibGVcbiAgICBjb25zdCBvcGFxdWUgPSBBcnJheS5mcm9tKGRvY3VtZW50LmVsZW1lbnRzRnJvbVBvaW50KHgsIHkpKT8uZmlsdGVyPy4oKGVsOiBhbnkpPT4oXG4gICAgICAgICgoZWwgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgJiYgZWwgIT0gaG9sZGVyKSAmJlxuICAgICAgICAoZWw/LmRhdGFzZXQ/LmFscGhhICE9IG51bGwgPyBwYXJzZUZsb2F0KGVsPy5kYXRhc2V0Py5hbHBoYSkgPiAwLjAxIDogdHJ1ZSkgJiYgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgZWw/LmNoZWNrVmlzaWJpbGl0eT8uKHsgY29udGVudFZpc2liaWxpdHlBdXRvOiB0cnVlLCBvcGFjaXR5UHJvcGVydHk6IHRydWUsIHZpc2liaWxpdHlQcm9wZXJ0eTogdHJ1ZSB9KSAmJlxuICAgICAgICAgZWw/Lm1hdGNoZXM/LihcIjpub3QoW2RhdGEtaGlkZGVuXSlcIikgJiZcbiAgICAgICAgKGVsPy5zdHlsZT8uZ2V0UHJvcGVydHlWYWx1ZShcImRpc3BsYXlcIikgIT0gXCJub25lXCIpXG4gICAgKSlcbiAgICAubWFwKChlbGVtZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbXB1dGVkID0gZ2V0Q29tcHV0ZWRTdHlsZT8uKGVsZW1lbnQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZWxlbWVudCxcbiAgICAgICAgICAgIHpJbmRleDogcGFyc2VJbnQoY29tcHV0ZWQ/LnpJbmRleCB8fCBcIjBcIiwgMTApIHx8IDAsXG4gICAgICAgICAgICBjb2xvcjogKGNvbXB1dGVkPy5iYWNrZ3JvdW5kQ29sb3IgfHwgXCJ0cmFuc3BhcmVudFwiKVxuICAgICAgICB9fSlcbiAgICAuc29ydCgoYSwgYikgPT4gTWF0aC5zaWduKGIuekluZGV4IC0gYS56SW5kZXgpKVxuICAgIC5maWx0ZXIoKHsgY29sb3IgfSk9Pih0YWNwKGNvbG9yKSkpO1xuXG4gICAgLy9cbiAgICBpZiAob3BhcXVlPy5bMF0/LmVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkge1xuICAgICAgICByZXR1cm4gb3BhcXVlPy5bMF0/LmNvbG9yIHx8IFwidHJhbnNwYXJlbnRcIjtcbiAgICB9XG5cbiAgICAvL1xuICAgIHJldHVybiBcInRyYW5zcGFyZW50XCI7XG59O1xuXG4vL1xuZXhwb3J0IGNvbnN0IHBpY2tGcm9tQ2VudGVyID0gKGhvbGRlcik9PntcbiAgICAvLyBub3QgYWJsZSB0byB1c2luZyBzb21lIG1lY2hhbmljc1xuICAgIGNvbnN0IGJveCA9IGhvbGRlcj8uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7Ly9nZXRCb3VuZGluZ09yaWVudEJveChob2xkZXIpO1xuICAgIGlmIChib3gpIHtcbiAgICAgICAgY29uc3QgWiA9IDAuNSAqIChmaXhlZENsaWVudFpvb20/LigpIHx8IDEpO1xuICAgICAgICBjb25zdCB4eTogW251bWJlciwgbnVtYmVyXSA9IFsoYm94LmxlZnQgKyBib3gucmlnaHQpICogWiwgKGJveC50b3AgKyBib3guYm90dG9tKSAqIFpdO1xuICAgICAgICByZXR1cm4gcGlja0JnQ29sb3IoLi4ueHksIGhvbGRlcik7XG4gICAgfVxufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGR5bmFtaWNOYXRpdmVGcmFtZSA9IChyb290ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KT0+e1xuICAgIGxldCBtZWRpYSA9IHJvb3Q/LnF1ZXJ5U2VsZWN0b3I/LignbWV0YVtkYXRhLXRoZW1lLWNvbG9yXScpID8/IHJvb3Q/LnF1ZXJ5U2VsZWN0b3I/LignbWV0YVtuYW1lPVwidGhlbWUtY29sb3JcIl0nKTtcblxuICAgIC8vIENyZWF0ZSBtZXRhIGVsZW1lbnQgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgIGlmICghbWVkaWEgJiYgcm9vdCA9PSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpIHtcbiAgICAgICAgbWVkaWEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdtZXRhJyk7XG4gICAgICAgIG1lZGlhLnNldEF0dHJpYnV0ZSgnbmFtZScsICd0aGVtZS1jb2xvcicpO1xuICAgICAgICBtZWRpYS5zZXRBdHRyaWJ1dGUoJ2RhdGEtdGhlbWUtY29sb3InLCAnJyk7XG4gICAgICAgIG1lZGlhLnNldEF0dHJpYnV0ZSgnY29udGVudCcsICd0cmFuc3BhcmVudCcpO1xuICAgICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKG1lZGlhKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb2xvciA9IHBpY2tCZ0NvbG9yKGdsb2JhbFRoaXMuaW5uZXJXaWR0aCAtIDY0LCAxMCk7XG4gICAgaWYgKChtZWRpYSB8fCB3aW5kb3c/LltlbGVjdHJvbkFQSV0pICYmIHJvb3QgPT0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSB7XG4gICAgICAgIG1lZGlhPy5zZXRBdHRyaWJ1dGU/LihcImNvbnRlbnRcIiwgY29sb3IpO1xuICAgIH1cbn1cblxuLy9cbmV4cG9ydCBjb25zdCBkeW5hbWljQmdDb2xvcnMgPSAocm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgPT4ge1xuICAgIHJvb3QucXVlcnlTZWxlY3RvckFsbChcImJvZHksIGJvZHkgPiAqLCBib2R5ID4gKiA+ICpcIikuZm9yRWFjaCgodGFyZ2V0KT0+e1xuICAgICAgICBpZiAodGFyZ2V0KSB7IHBpY2tGcm9tQ2VudGVyKHRhcmdldCk7IH1cbiAgICB9KTtcbn07XG5cbi8vXG5leHBvcnQgY29uc3QgZHluYW1pY1RoZW1lID0gKFJPT1QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpPT57XG4gICAgbWF0Y2hNZWRpYShcIihwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaylcIikuYWRkRXZlbnRMaXN0ZW5lcihcImNoYW5nZVwiLCAoe30pID0+IGR5bmFtaWNCZ0NvbG9ycyhST09UKSk7XG5cbiAgICAvL1xuICAgIGNvbnN0IHVwZGF0ZXIgPSAoKT0+e1xuICAgICAgICBkeW5hbWljTmF0aXZlRnJhbWUoUk9PVCk7XG4gICAgICAgIGR5bmFtaWNCZ0NvbG9ycyhST09UKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGFkZEV2ZW50KFJPT1QsIFwidTItYXBwZWFyXCIsICgpPT5yZXF1ZXN0SWRsZUNhbGxiYWNrKHVwZGF0ZXIsIHt0aW1lb3V0OiAxMDB9KSk7XG4gICAgYWRkRXZlbnQoUk9PVCwgXCJ1Mi1oaWRkZW5cIiwgKCk9PnJlcXVlc3RJZGxlQ2FsbGJhY2sodXBkYXRlciwge3RpbWVvdXQ6IDEwMH0pKTtcbiAgICBhZGRFdmVudChST09ULCBcInUyLXRoZW1lLWNoYW5nZVwiLCAoKT0+cmVxdWVzdElkbGVDYWxsYmFjayh1cGRhdGVyLCB7dGltZW91dDogMTAwfSkpO1xuICAgIGFkZEV2ZW50KHdpbmRvdywgXCJsb2FkXCIsICgpPT5yZXF1ZXN0SWRsZUNhbGxiYWNrKHVwZGF0ZXIsIHt0aW1lb3V0OiAxMDB9KSk7XG4gICAgYWRkRXZlbnQoZG9jdW1lbnQsIFwidmlzaWJpbGl0eWNoYW5nZVwiLCAoKT0+cmVxdWVzdElkbGVDYWxsYmFjayh1cGRhdGVyLCB7dGltZW91dDogMTAwfSkpO1xuICAgIHNldElkbGVJbnRlcnZhbCh1cGRhdGVyLCA1MDApO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGN1cnJlbnRDb2xvckZyb21Qb2ludFJlZiA9ICh4LCB5LCBST09UID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCB0aW1lb3V0ID0gNTAwKT0+e1xuICAgIGNvbnN0IGNvbG9yID0gcGlja0JnQ29sb3IoeCwgeSwgUk9PVCk7XG4gICAgY29uc3QgcmZjID0gc3RyaW5nUmVmKGNvbG9yKTtcbiAgICBjb25zdCB1cGRhdGVyID0gKCk9PntcbiAgICAgICAgY29uc3QgY29sb3IgPSBwaWNrQmdDb2xvcih4LCB5LCBST09UKTtcbiAgICAgICAgcmZjLnZhbHVlID0gY29sb3I7XG4gICAgfVxuXG4gICAgLy9cbiAgICBhZGRFdmVudChST09ULCBcInUyLWFwcGVhclwiLCAoKT0+cmVxdWVzdElkbGVDYWxsYmFjayh1cGRhdGVyLCB7dGltZW91dDogMTAwfSkpO1xuICAgIGFkZEV2ZW50KFJPT1QsIFwidTItaGlkZGVuXCIsICgpPT5yZXF1ZXN0SWRsZUNhbGxiYWNrKHVwZGF0ZXIsIHt0aW1lb3V0OiAxMDB9KSk7XG4gICAgYWRkRXZlbnQoUk9PVCwgXCJ1Mi10aGVtZS1jaGFuZ2VcIiwgKCk9PnJlcXVlc3RJZGxlQ2FsbGJhY2sodXBkYXRlciwge3RpbWVvdXQ6IDEwMH0pKTtcbiAgICBhZGRFdmVudCh3aW5kb3csIFwibG9hZFwiLCAoKT0+cmVxdWVzdElkbGVDYWxsYmFjayh1cGRhdGVyLCB7dGltZW91dDogMTAwfSkpO1xuICAgIGFkZEV2ZW50KGRvY3VtZW50LCBcInZpc2liaWxpdHljaGFuZ2VcIiwgKCk9PnJlcXVlc3RJZGxlQ2FsbGJhY2sodXBkYXRlciwge3RpbWVvdXQ6IDEwMH0pKTtcbiAgICBzZXRJZGxlSW50ZXJ2YWwodXBkYXRlciwgdGltZW91dCk7XG4gICAgcmV0dXJuIHJmYztcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBjdXJyZW50Q29sb3JGcm9tQ2VudGVyUmVmID0gKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBST09UID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCB0aW1lb3V0ID0gNTAwKT0+e1xuICAgIGNvbnN0IGNvbG9yID0gcGlja0Zyb21DZW50ZXIoZWxlbWVudCk7XG4gICAgY29uc3QgcmZjID0gc3RyaW5nUmVmKGNvbG9yKTtcbiAgICBjb25zdCB1cGRhdGVyID0gKCk9PntcbiAgICAgICAgY29uc3QgY29sb3IgPSBwaWNrRnJvbUNlbnRlcihlbGVtZW50KTtcbiAgICAgICAgcmZjLnZhbHVlID0gY29sb3I7XG4gICAgfVxuXG4gICAgLy9cbiAgICBhZGRFdmVudChST09ULCBcInUyLWFwcGVhclwiLCAoKT0+cmVxdWVzdElkbGVDYWxsYmFjayh1cGRhdGVyLCB7dGltZW91dDogMTAwfSkpO1xuICAgIGFkZEV2ZW50KFJPT1QsIFwidTItaGlkZGVuXCIsICgpPT5yZXF1ZXN0SWRsZUNhbGxiYWNrKHVwZGF0ZXIsIHt0aW1lb3V0OiAxMDB9KSk7XG4gICAgYWRkRXZlbnQoUk9PVCwgXCJ1Mi10aGVtZS1jaGFuZ2VcIiwgKCk9PnJlcXVlc3RJZGxlQ2FsbGJhY2sodXBkYXRlciwge3RpbWVvdXQ6IDEwMH0pKTtcbiAgICBhZGRFdmVudCh3aW5kb3csIFwibG9hZFwiLCAoKT0+cmVxdWVzdElkbGVDYWxsYmFjayh1cGRhdGVyLCB7dGltZW91dDogMTAwfSkpO1xuICAgIGFkZEV2ZW50KGRvY3VtZW50LCBcInZpc2liaWxpdHljaGFuZ2VcIiwgKCk9PnJlcXVlc3RJZGxlQ2FsbGJhY2sodXBkYXRlciwge3RpbWVvdXQ6IDEwMH0pKTtcbiAgICBzZXRJZGxlSW50ZXJ2YWwodXBkYXRlciwgdGltZW91dCk7XG4gICAgcmV0dXJuIHJmYztcbn1cblxuLy9cbmV4cG9ydCBkZWZhdWx0IGR5bmFtaWNUaGVtZTtcbiJdfQ==
import { RAFBehavior } from "fest/dom";
//
export const makeRenderer = () => {
    const canvas = document.createElement("canvas");
    const fallback = document.createElement("div");
    canvas.width = 1;
    canvas.height = 1;
    //
    canvas.classList.add("u2-renderer");
    canvas.classList.add("u2-implement");
    fallback.classList.add("u2-fallback");
    fallback.classList.add("u2-renderer");
    //
    fallback.style.inlineSize = "stretch";
    fallback.style.blockSize = "stretch";
    fallback.style.contain = "layout paint";
    //fallback.style.containerType = "size";
    fallback.style.containIntrinsicInlineSize = "1px";
    fallback.style.containIntrinsicBlockSize = "1px";
    fallback.style.maxInlineSize = "min(100cqi, 100dvi)";
    fallback.style.maxBlockSize = "min(100cqb, 100dvb)";
    fallback.style.pointerEvents = "auto";
    //
    //return fallback;
    //
    canvas.style.inlineSize = "stretch";
    canvas.style.blockSize = "stretch";
    canvas.style.objectFit = "contain";
    canvas.style.objectPosition = "center";
    canvas.style.imageRendering = "auto";
    canvas.style.imageRendering = "optimizeQuality";
    canvas.style.imageRendering = "smooth";
    canvas.style.imageRendering = "high-quality";
    canvas.style.contain = "layout paint";
    //canvas.style.containerType = "size";
    canvas.style.containIntrinsicInlineSize = "1px";
    canvas.style.containIntrinsicBlockSize = "1px";
    canvas.style.maxInlineSize = "min(100cqi, 100dvi)";
    canvas.style.maxBlockSize = "min(100cqb, 100dvb)";
    canvas.style.pointerEvents = "auto";
    // @ts-ignore
    canvas.layoutsubtree = true;
    canvas.setAttribute("layoutsubtree", "true");
    //\
    const ctx = canvas?.getContext?.("2d");
    if (!ctx) {
        return fallback;
    }
    //
    if (ctx?.drawElement == null && ctx?.drawElementImage == null) {
        return fallback;
    }
    //
    const drawElementAct = ctx?.drawElementImage != null ? ctx?.drawElementImage?.bind?.(ctx) : ctx?.drawElement?.bind?.(ctx);
    if (drawElementAct == null) {
        return fallback;
    }
    //
    const makeInteractive = (element) => {
        const drawElement = element ?? canvas.children?.[0];
        if (drawElement == null)
            return;
        //
        try {
            ctx.setHitTestRegions([{
                    element: drawElement,
                    rect: {
                        x: 0,
                        y: 0,
                        width: drawElement?.offsetWidth * devicePixelRatio,
                        height: drawElement?.offsetHeight * devicePixelRatio
                    }
                }]);
        }
        catch (e) {
            console.warn(e);
        }
    };
    //
    const rafDebounce = RAFBehavior();
    const doRender = () => {
        const drawElement = canvas.children?.[0];
        if (drawElementAct == null || drawElement == null || !canvas.checkVisibility() || canvas.dataset.dragging != null || canvas.closest?.("[data-dragging]") != null)
            return;
        //
        ctx.reset();
        ctx.save();
        ctx.scale(devicePixelRatio || 1, devicePixelRatio || 1);
        try {
            drawElementAct(drawElement, 0, 0, canvas.width / devicePixelRatio, canvas.height / devicePixelRatio);
        }
        catch (e) {
            console.warn(e);
        }
        makeInteractive();
        ctx.restore();
    };
    //https://localhost/#task2
    const resizeObserver = new ResizeObserver((entries) => {
        const entry = entries.find((entry) => entry.target === canvas);
        const newWidth = Math.min(entry?.devicePixelContentBoxSize?.[0]?.inlineSize || canvas.width, (canvas?.offsetParent || document.documentElement)?.clientWidth * devicePixelRatio);
        const newHeight = Math.min(entry?.devicePixelContentBoxSize?.[0]?.blockSize || canvas.height, (canvas?.offsetParent || document.documentElement)?.clientHeight * devicePixelRatio);
        //
        if (newWidth != canvas.width) {
            canvas.width = newWidth;
        }
        ;
        if (newHeight != canvas.height) {
            canvas.height = newHeight;
        }
        ;
        if (newWidth != canvas.width || newHeight != canvas.height) {
            rafDebounce(doRender);
        }
        ;
        //
    });
    //
    queueMicrotask(() => {
        resizeObserver.observe(canvas, { box: ['device-pixel-content-box'], fireOnEveryPaint: true });
    });
    //
    (async () => {
        while (true) {
            await new Promise((resolve) => requestAnimationFrame(resolve));
            if (canvas.checkVisibility() && canvas.dataset.dragging == null && canvas.closest?.("[data-dragging]") == null) {
                doRender();
            }
        }
    })();
    //
    return canvas;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJSZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRXZDLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsR0FBRyxFQUFFO0lBQzdCLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDaEQsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQyxNQUFNLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztJQUNqQixNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUVsQixFQUFFO0lBQ0YsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDcEMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDckMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdEMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFFdEMsRUFBRTtJQUNGLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztJQUN0QyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7SUFDckMsUUFBUSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDO0lBQ3hDLHdDQUF3QztJQUN4QyxRQUFRLENBQUMsS0FBSyxDQUFDLDBCQUEwQixHQUFHLEtBQUssQ0FBQztJQUNsRCxRQUFRLENBQUMsS0FBSyxDQUFDLHlCQUF5QixHQUFHLEtBQUssQ0FBQztJQUNqRCxRQUFRLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxxQkFBcUIsQ0FBQztJQUNyRCxR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QUNmLGNBQWMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEVBQUMsR0FBRyxFQUFFLENBQUMsMEJBQTBCLENBQUMsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0lBQ2hHLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRTtJQUNGLENBQUMsS0FBSyxJQUFHLEVBQUU7UUFDUCxPQUFPLElBQUksRUFBRSxDQUFDO1lBQ1YsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUMvRCxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUUsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsSUFBSSxJQUFJLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLGlCQUFpQixDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7Z0JBQzdHLFFBQVEsRUFBRSxDQUFDO1lBQ2YsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDLENBQUMsRUFBRSxDQUFDO0lBRUwsRUFBRTtJQUNGLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJBRkJlaGF2aW9yIH0gZnJvbSBcImZlc3QvZG9tXCI7XG5cbi8vXG5leHBvcnQgY29uc3QgbWFrZVJlbmRlcmVyID0gKCkgPT4ge1xuICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJjYW52YXNcIik7XG4gICAgY29uc3QgZmFsbGJhY2sgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgIGNhbnZhcy53aWR0aCA9IDE7XG4gICAgY2FudmFzLmhlaWdodCA9IDE7XG5cbiAgICAvL1xuICAgIGNhbnZhcy5jbGFzc0xpc3QuYWRkKFwidTItcmVuZGVyZXJcIik7XG4gICAgY2FudmFzLmNsYXNzTGlzdC5hZGQoXCJ1Mi1pbXBsZW1lbnRcIik7XG4gICAgZmFsbGJhY2suY2xhc3NMaXN0LmFkZChcInUyLWZhbGxiYWNrXCIpO1xuICAgIGZhbGxiYWNrLmNsYXNzTGlzdC5hZGQoXCJ1Mi1yZW5kZXJlclwiKTtcblxuICAgIC8vXG4gICAgZmFsbGJhY2suc3R5bGUuaW5saW5lU2l6ZSA9IFwic3RyZXRjaFwiO1xuICAgIGZhbGxiYWNrLnN0eWxlLmJsb2NrU2l6ZSA9IFwic3RyZXRjaFwiO1xuICAgIGZhbGxiYWNrLnN0eWxlLmNvbnRhaW4gPSBcImxheW91dCBwYWludFwiO1xuICAgIC8vZmFsbGJhY2suc3R5bGUuY29udGFpbmVyVHlwZSA9IFwic2l6ZVwiO1xuICAgIGZhbGxiYWNrLnN0eWxlLmNvbnRhaW5JbnRyaW5zaWNJbmxpbmVTaXplID0gXCIxcHhcIjtcbiAgICBmYWxsYmFjay5zdHlsZS5jb250YWluSW50cmluc2ljQmxvY2tTaXplID0gXCIxcHhcIjtcbiAgICBmYWxsYmFjay5zdHlsZS5tYXhJbmxpbmVTaXplID0gXCJtaW4oMTAwY3FpLCAxMDBkdmkpXCI7XG4gICAgZmFsbGJhY2suc3R5bGUubWF4QmxvY2tTaXplID0gXCJtaW4oMTAwY3FiLCAxMDBkdmIpXCI7XG4gICAgZmFsbGJhY2suc3R5bGUucG9pbnRlckV2ZW50cyA9IFwiYXV0b1wiO1xuXG4gICAgLy9cbiAgICAvL3JldHVybiBmYWxsYmFjaztcblxuICAgIC8vXG4gICAgY2FudmFzLnN0eWxlLmlubGluZVNpemUgPSBcInN0cmV0Y2hcIjtcbiAgICBjYW52YXMuc3R5bGUuYmxvY2tTaXplID0gXCJzdHJldGNoXCI7XG4gICAgY2FudmFzLnN0eWxlLm9iamVjdEZpdCA9IFwiY29udGFpblwiO1xuICAgIGNhbnZhcy5zdHlsZS5vYmplY3RQb3NpdGlvbiA9IFwiY2VudGVyXCI7XG4gICAgY2FudmFzLnN0eWxlLmltYWdlUmVuZGVyaW5nID0gXCJhdXRvXCI7XG4gICAgY2FudmFzLnN0eWxlLmltYWdlUmVuZGVyaW5nID0gXCJvcHRpbWl6ZVF1YWxpdHlcIjtcbiAgICBjYW52YXMuc3R5bGUuaW1hZ2VSZW5kZXJpbmcgPSBcInNtb290aFwiO1xuICAgIGNhbnZhcy5zdHlsZS5pbWFnZVJlbmRlcmluZyA9IFwiaGlnaC1xdWFsaXR5XCI7XG4gICAgY2FudmFzLnN0eWxlLmNvbnRhaW4gPSBcImxheW91dCBwYWludFwiO1xuICAgIC8vY2FudmFzLnN0eWxlLmNvbnRhaW5lclR5cGUgPSBcInNpemVcIjtcbiAgICBjYW52YXMuc3R5bGUuY29udGFpbkludHJpbnNpY0lubGluZVNpemUgPSBcIjFweFwiO1xuICAgIGNhbnZhcy5zdHlsZS5jb250YWluSW50cmluc2ljQmxvY2tTaXplID0gXCIxcHhcIjtcbiAgICBjYW52YXMuc3R5bGUubWF4SW5saW5lU2l6ZSA9IFwibWluKDEwMGNxaSwgMTAwZHZpKVwiO1xuICAgIGNhbnZhcy5zdHlsZS5tYXhCbG9ja1NpemUgPSBcIm1pbigxMDBjcWIsIDEwMGR2YilcIjtcbiAgICBjYW52YXMuc3R5bGUucG9pbnRlckV2ZW50cyA9IFwiYXV0b1wiO1xuXG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNhbnZhcy5sYXlvdXRzdWJ0cmVlID0gdHJ1ZTtcbiAgICBjYW52YXMuc2V0QXR0cmlidXRlKFwibGF5b3V0c3VidHJlZVwiLCBcInRydWVcIik7XG5cbiAgICAvL1xcXG4gICAgY29uc3QgY3R4ID0gY2FudmFzPy5nZXRDb250ZXh0Py4oXCIyZFwiKSBhcyBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgfCBudWxsO1xuICAgIGlmICghY3R4KSB7IHJldHVybiBmYWxsYmFjazsgfVxuXG4gICAgLy9cbiAgICBpZiAoKGN0eCBhcyBhbnkpPy5kcmF3RWxlbWVudCA9PSBudWxsICYmIChjdHggYXMgYW55KT8uZHJhd0VsZW1lbnRJbWFnZSA9PSBudWxsKSB7XG4gICAgICAgIHJldHVybiBmYWxsYmFjaztcbiAgICB9XG5cbiAgICAvL1xuICAgIGNvbnN0IGRyYXdFbGVtZW50QWN0ID0gKGN0eCBhcyBhbnkpPy5kcmF3RWxlbWVudEltYWdlICE9IG51bGwgPyAoY3R4IGFzIGFueSk/LmRyYXdFbGVtZW50SW1hZ2U/LmJpbmQ/LihjdHgpIDogKGN0eCBhcyBhbnkpPy5kcmF3RWxlbWVudD8uYmluZD8uKGN0eCk7XG4gICAgaWYgKGRyYXdFbGVtZW50QWN0ID09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGZhbGxiYWNrO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3QgbWFrZUludGVyYWN0aXZlID0gKGVsZW1lbnQ/OiBIVE1MRWxlbWVudCk9PntcbiAgICAgICAgY29uc3QgZHJhd0VsZW1lbnQgPSBlbGVtZW50ID8/IChjYW52YXMuY2hpbGRyZW4/LlswXSBhcyBIVE1MRWxlbWVudCk7XG4gICAgICAgIGlmIChkcmF3RWxlbWVudCA9PSBudWxsKSByZXR1cm47XG5cbiAgICAgICAgLy9cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIChjdHggYXMgYW55KS5zZXRIaXRUZXN0UmVnaW9ucyhbe1xuICAgICAgICAgICAgICAgIGVsZW1lbnQ6IGRyYXdFbGVtZW50LFxuICAgICAgICAgICAgICAgIHJlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgeDogMCxcbiAgICAgICAgICAgICAgICAgICAgeTogMCxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6IGRyYXdFbGVtZW50Py5vZmZzZXRXaWR0aCAqIGRldmljZVBpeGVsUmF0aW8sXG4gICAgICAgICAgICAgICAgICAgIGhlaWdodDogZHJhd0VsZW1lbnQ/Lm9mZnNldEhlaWdodCAqIGRldmljZVBpeGVsUmF0aW9cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XSk7XG4gICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGUpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9cbiAgICBjb25zdCByYWZEZWJvdW5jZSA9IFJBRkJlaGF2aW9yKCk7XG4gICAgY29uc3QgZG9SZW5kZXIgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGRyYXdFbGVtZW50ID0gY2FudmFzLmNoaWxkcmVuPy5bMF07XG4gICAgICAgIGlmIChkcmF3RWxlbWVudEFjdCA9PSBudWxsIHx8IGRyYXdFbGVtZW50ID09IG51bGwgfHwgIWNhbnZhcy5jaGVja1Zpc2liaWxpdHkoKSB8fCBjYW52YXMuZGF0YXNldC5kcmFnZ2luZyAhPSBudWxsIHx8IGNhbnZhcy5jbG9zZXN0Py4oXCJbZGF0YS1kcmFnZ2luZ11cIikgIT0gbnVsbCkgcmV0dXJuO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGN0eC5yZXNldCgpO1xuICAgICAgICBjdHguc2F2ZSgpO1xuICAgICAgICBjdHguc2NhbGUoZGV2aWNlUGl4ZWxSYXRpbyB8fCAxLCBkZXZpY2VQaXhlbFJhdGlvIHx8IDEpO1xuICAgICAgICB0cnkgeyBkcmF3RWxlbWVudEFjdChkcmF3RWxlbWVudCwgMCwgMCwgY2FudmFzLndpZHRoIC8gZGV2aWNlUGl4ZWxSYXRpbywgY2FudmFzLmhlaWdodCAvIGRldmljZVBpeGVsUmF0aW8pOyB9IGNhdGNoKGUpIHsgY29uc29sZS53YXJuKGUpOyB9XG4gICAgICAgIG1ha2VJbnRlcmFjdGl2ZSgpO1xuICAgICAgICBjdHgucmVzdG9yZSgpO1xuICAgIH1cblxuICAgIC8vaHR0cHM6Ly9sb2NhbGhvc3QvI3Rhc2syXG4gICAgY29uc3QgcmVzaXplT2JzZXJ2ZXIgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoKGVudHJpZXMpID0+IHtcbiAgICAgICAgY29uc3QgZW50cnkgPSBlbnRyaWVzLmZpbmQoKGVudHJ5KSA9PiBlbnRyeS50YXJnZXQgPT09IGNhbnZhcyk7XG4gICAgICAgIGNvbnN0IG5ld1dpZHRoICA9IE1hdGgubWluKGVudHJ5Py5kZXZpY2VQaXhlbENvbnRlbnRCb3hTaXplPy5bMF0/LmlubGluZVNpemUgfHwgY2FudmFzLndpZHRoLCAoY2FudmFzPy5vZmZzZXRQYXJlbnQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KT8uY2xpZW50V2lkdGggKiBkZXZpY2VQaXhlbFJhdGlvKTtcbiAgICAgICAgY29uc3QgbmV3SGVpZ2h0ID0gTWF0aC5taW4oZW50cnk/LmRldmljZVBpeGVsQ29udGVudEJveFNpemU/LlswXT8uYmxvY2tTaXplIHx8IGNhbnZhcy5oZWlnaHQsIChjYW52YXM/Lm9mZnNldFBhcmVudCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpPy5jbGllbnRIZWlnaHQgKiBkZXZpY2VQaXhlbFJhdGlvKTtcblxuICAgICAgICAvL1xuICAgICAgICBpZiAobmV3V2lkdGggIT0gY2FudmFzLndpZHRoKSB7IGNhbnZhcy53aWR0aCA9IG5ld1dpZHRoOyB9O1xuICAgICAgICBpZiAobmV3SGVpZ2h0ICE9IGNhbnZhcy5oZWlnaHQpIHsgY2FudmFzLmhlaWdodCA9IG5ld0hlaWdodDsgfTtcbiAgICAgICAgaWYgKG5ld1dpZHRoICE9IGNhbnZhcy53aWR0aCB8fCBuZXdIZWlnaHQgIT0gY2FudmFzLmhlaWdodCkgeyByYWZEZWJvdW5jZShkb1JlbmRlcik7IH07XG4gICAgICAgIC8vXG4gICAgfSk7XG5cbiAgICAvL1xuICAgIHF1ZXVlTWljcm90YXNrKCgpPT57IC8vIEB0cy1pZ25vcmVcbiAgICAgICAgcmVzaXplT2JzZXJ2ZXIub2JzZXJ2ZShjYW52YXMsIHtib3g6IFsnZGV2aWNlLXBpeGVsLWNvbnRlbnQtYm94J10sIGZpcmVPbkV2ZXJ5UGFpbnQ6IHRydWV9KTtcbiAgICB9KTtcblxuICAgIC8vXG4gICAgKGFzeW5jICgpPT57XG4gICAgICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlc29sdmUpKTtcbiAgICAgICAgICAgIGlmIChjYW52YXMuY2hlY2tWaXNpYmlsaXR5KCkgJiYgY2FudmFzLmRhdGFzZXQuZHJhZ2dpbmcgPT0gbnVsbCAmJiBjYW52YXMuY2xvc2VzdD8uKFwiW2RhdGEtZHJhZ2dpbmddXCIpID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBkb1JlbmRlcigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSkoKTtcblxuICAgIC8vXG4gICAgcmV0dXJuIGNhbnZhcztcbn1cbiJdfQ==
import { makeAnchorElement } from "../css-ref/CSSAnchor";
import { bindScrollbarPosition, boundingBoxAnchorRef } from "../space-ref/BBoxAnchor";
import { enhancedIntersectionBoxAnchorRef } from "../space-ref/IntersectionAnchor";
//
export const getParentOrShadowRoot = (element) => {
    if (element?.parentElement) {
        return (!(element?.parentElement instanceof DocumentFragment) ? element?.parentElement : undefined);
    }
    return element?.host?.shadowRoot;
};
//
export const observeDisconnect = (element, handleMutation) => {
    if (!element?.isConnected) {
        return handleMutation();
    }
    //
    const observer = new MutationObserver((mutationList, observer) => {
        for (const mutation of mutationList) {
            if (mutation.type == "childList") {
                if (Array.from(mutation?.removedNodes || []).some((node) => (node === element || node?.contains?.(element)))) {
                    queueMicrotask(() => handleMutation(mutation));
                    observer?.disconnect?.();
                }
            }
        }
    });
    //
    const parent = getParentOrShadowRoot(element) ?? document.documentElement;
    const observed = (parent instanceof HTMLElement ? parent : parent?.host) ?? parent;
    queueMicrotask(() => observer.observe(observed, {
        subtree: true,
        childList: true
    }));
};
//
export const observeConnect = (element, handleMutation) => {
    if (element?.isConnected) {
        return handleMutation();
    }
    //
    const observer = new MutationObserver((mutationList, observer) => {
        for (const mutation of mutationList) {
            if (mutation.type == "childList") {
                if (Array.from(mutation?.addedNodes || []).some((node) => (node === element || node?.contains?.(element)))) {
                    queueMicrotask(() => handleMutation(mutation));
                    observer?.disconnect?.();
                }
            }
        }
    });
    //
    const parent = getParentOrShadowRoot(element) ?? document.documentElement;
    const observed = (parent instanceof HTMLElement ? parent : parent?.host) ?? parent;
    queueMicrotask(() => observer.observe(observed, {
        subtree: true,
        childList: true
    }));
};
//
export const appendAsOverlay = (anchor, overlay, self, options) => {
    const { root = window, zIndexShift = 1, placement = "fill", inset = 0, size = "100%", transformOrigin = "50% 50%", useIntersection = false } = options || {};
    anchor ??= self?.children?.[0] ?? anchor;
    //
    if (!anchor && (self?.children?.length ?? 0) < 1) {
        // fix anchor problems
        const fillAnchorBox = document.createElement("div");
        fillAnchorBox.classList.add("ui-window-frame-anchor-box");
        fillAnchorBox.style.position = "relative";
        fillAnchorBox.style.inlineSize = "stretch";
        fillAnchorBox.style.blockSize = "stretch";
        fillAnchorBox.style.zIndex = String(zIndexShift + 0);
        fillAnchorBox.style.pointerEvents = "none";
        fillAnchorBox.style.opacity = "1";
        fillAnchorBox.style.visibility = "visible";
        fillAnchorBox.style.backgroundColor = "transparent";
        self?.append?.(anchor = fillAnchorBox);
    }
    //
    if (anchor == null || overlay == null)
        return;
    const anchorBinder = makeAnchorElement(anchor);
    // Handle scrollbar-specific placements
    if (placement === "scrollbar-x") {
        anchorBinder.connectElement(overlay, {
            placement: "bottom",
            zIndexShift,
            inset,
            size,
            transformOrigin
        });
    }
    else if (placement === "scrollbar-y") {
        anchorBinder.connectElement(overlay, {
            placement: "right",
            zIndexShift,
            inset,
            size,
            transformOrigin
        });
    }
    else {
        anchorBinder.connectElement(overlay, {
            placement,
            zIndexShift,
            inset,
            size,
            transformOrigin
        });
    }
    //
    observeConnect(anchor, () => {
        const parent = getParentOrShadowRoot(anchor) ?? self;
        const styled = parent instanceof HTMLElement ? parent : parent?.host;
        styled?.style?.setProperty?.("anchor-scope", anchorBinder.anchorId);
        anchor?.after?.(overlay);
        observeDisconnect(parent, () => overlay?.remove?.());
    });
    //
    return anchor;
};
// Enhanced scrollbar overlay with reactive positioning
export const appendScrollbarOverlay = (content, scrollbar, axis, options) => {
    const { zIndexShift = 1, autoPosition = true, useIntersection = false, theme = "default" } = options || {};
    // Set theme class
    scrollbar.classList.add(`scrollbar-theme-${theme}`);
    scrollbar.setAttribute("data-axis", axis);
    let cleanupFunctions = [];
    if (autoPosition) {
        // Use enhanced intersection box for precise positioning
        if (useIntersection) {
            const intersectionBox = enhancedIntersectionBoxAnchorRef(content, {
                root: window,
                observeResize: true,
                observeMutations: true,
                observeIntersection: true
            });
            // Position scrollbar using reactive bindings
            cleanupFunctions.push(bindScrollbarPosition(scrollbar, intersectionBox, axis, {
                useIntersection: true,
                zIndexShift
            }));
        }
        else {
            // Use standard bounding box with reactive bindings
            const box = boundingBoxAnchorRef(content, {
                observeResize: true,
                observeMutations: true
            });
            // Position scrollbar using reactive bindings
            cleanupFunctions.push(bindScrollbarPosition(scrollbar, box, axis, {
                useIntersection: false,
                zIndexShift
            }));
        }
    }
    // Add scrollbar to DOM
    if (!scrollbar.parentNode) {
        document.body.appendChild(scrollbar);
    }
    // Set up removal on content disconnect with cleanup
    observeDisconnect(content, () => {
        cleanupFunctions.forEach(cleanup => cleanup());
        scrollbar.remove();
    });
    //
    return scrollbar;
};
// Example usage function for testing reactive scrollbar overlays
export const createReactiveScrollbarOverlay = (content, axis = 'vertical') => {
    // Create scrollbar element
    const scrollbar = document.createElement('div');
    scrollbar.className = `reactive-scrollbar reactive-scrollbar-${axis}`;
    scrollbar.style.background = 'rgba(0,0,0,0.3)';
    scrollbar.style.borderRadius = '4px';
    scrollbar.style.position = 'absolute';
    scrollbar.style.zIndex = '1000';
    if (axis === 'horizontal') {
        scrollbar.style.height = '8px';
        scrollbar.style.width = '100px';
    }
    else {
        scrollbar.style.width = '8px';
        scrollbar.style.height = '100px';
    }
    // Use reactive positioning
    return appendScrollbarOverlay(content, scrollbar, axis, {
        autoPosition: true,
        useIntersection: true,
        theme: 'default'
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQW5jaG9yT3ZlcmxheS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkFuY2hvck92ZXJsYXkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLG9CQUFvQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDdEYsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFFbkYsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsT0FBb0IsRUFBb0MsRUFBRTtJQUM1RixJQUFLLE9BQWUsRUFBRSxhQUFhLEVBQUUsQ0FBQztRQUNsQyxPQUFPLENBQUMsQ0FBQyxDQUFFLE9BQWUsRUFBRSxhQUFhLFlBQVksZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUUsT0FBZSxFQUFFLGFBQTRCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3pJLENBQUM7SUFDRCxPQUFRLE9BQWUsRUFBRSxJQUFJLEVBQUUsVUFBd0IsQ0FBQztBQUM1RCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxPQUFnQixFQUFFLGNBQWMsRUFBRSxFQUFFO0lBQ2xFLElBQUksQ0FBQyxPQUFPLEVBQUUsV0FBVyxFQUFFLENBQUM7UUFDeEIsT0FBTyxjQUFjLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQsRUFBRTtJQUNGLE1BQU0sUUFBUSxHQUFHLElBQUksZ0JBQWdCLENBQUMsQ0FBQyxZQUFZLEVBQUUsUUFBUSxFQUFFLEVBQUU7UUFDN0QsS0FBSyxNQUFNLFFBQVEsSUFBSSxZQUFZLEVBQUUsQ0FBQztZQUNsQyxJQUFJLFFBQVEsQ0FBQyxJQUFJLElBQUksV0FBVyxFQUFFLENBQUM7Z0JBQy9CLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUs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SSxLQUFLLFlBQVksRUFBRSxDQUFDO1FBQ3hCLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztRQUMvQixTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUM7SUFDcEMsQ0FBQztTQUFNLENBQUM7UUFDSixTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDOUIsU0FBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDO0lBQ3JDLENBQUM7SUFFRCwyQkFBMkI7SUFDM0IsT0FBTyxzQkFBc0IsQ0FBQyxPQUFPLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRTtRQUNwRCxZQUFZLEVBQUUsSUFBSTtRQUNsQixlQUFlLEVBQUUsSUFBSTtRQUNyQixLQUFLLEVBQUUsU0FBUztLQUNuQixDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtYWtlQW5jaG9yRWxlbWVudCB9IGZyb20gXCIuLi9jc3MtcmVmL0NTU0FuY2hvclwiO1xuaW1wb3J0IHsgYmluZFNjcm9sbGJhclBvc2l0aW9uLCBib3VuZGluZ0JveEFuY2hvclJlZiB9IGZyb20gXCIuLi9zcGFjZS1yZWYvQkJveEFuY2hvclwiO1xuaW1wb3J0IHsgZW5oYW5jZWRJbnRlcnNlY3Rpb25Cb3hBbmNob3JSZWYgfSBmcm9tIFwiLi4vc3BhY2UtcmVmL0ludGVyc2VjdGlvbkFuY2hvclwiO1xuXG4vL1xuZXhwb3J0IGNvbnN0IGdldFBhcmVudE9yU2hhZG93Um9vdCA9IChlbGVtZW50OiBIVE1MRWxlbWVudCk6IEhUTUxFbGVtZW50fFNoYWRvd1Jvb3R8dW5kZWZpbmVkID0+IHtcbiAgICBpZiAoKGVsZW1lbnQgYXMgYW55KT8ucGFyZW50RWxlbWVudCkge1xuICAgICAgICByZXR1cm4gKCEoKGVsZW1lbnQgYXMgYW55KT8ucGFyZW50RWxlbWVudCBpbnN0YW5jZW9mIERvY3VtZW50RnJhZ21lbnQpID8gKGVsZW1lbnQgYXMgYW55KT8ucGFyZW50RWxlbWVudCBhcyBIVE1MRWxlbWVudCA6IHVuZGVmaW5lZCk7XG4gICAgfVxuICAgIHJldHVybiAoZWxlbWVudCBhcyBhbnkpPy5ob3N0Py5zaGFkb3dSb290IGFzIFNoYWRvd1Jvb3Q7XG59XG5cbi8vXG5leHBvcnQgY29uc3Qgb2JzZXJ2ZURpc2Nvbm5lY3QgPSAoZWxlbWVudDogRWxlbWVudCwgaGFuZGxlTXV0YXRpb24pID0+IHtcbiAgICBpZiAoIWVsZW1lbnQ/LmlzQ29ubmVjdGVkKSB7XG4gICAgICAgIHJldHVybiBoYW5kbGVNdXRhdGlvbigpO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3Qgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcigobXV0YXRpb25MaXN0LCBvYnNlcnZlcikgPT4ge1xuICAgICAgICBmb3IgKGNvbnN0IG11dGF0aW9uIG9mIG11dGF0aW9uTGlzdCkge1xuICAgICAgICAgICAgaWYgKG11dGF0aW9uLnR5cGUgPT0gXCJjaGlsZExpc3RcIikge1xuICAgICAgICAgICAgICAgIGlmIChBcnJheS5mcm9tKG11dGF0aW9uPy5yZW1vdmVkTm9kZXN8fFtdKS5zb21lKChub2RlKT0+KG5vZGUgPT09IGVsZW1lbnQgfHwgbm9kZT8uY29udGFpbnM/LihlbGVtZW50KSkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXVlTWljcm90YXNrKCgpPT5oYW5kbGVNdXRhdGlvbihtdXRhdGlvbikpO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlcj8uZGlzY29ubmVjdD8uKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICAvL1xuICAgIGNvbnN0IHBhcmVudCA9IGdldFBhcmVudE9yU2hhZG93Um9vdChlbGVtZW50IGFzIEhUTUxFbGVtZW50KSA/PyBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG4gICAgY29uc3Qgb2JzZXJ2ZWQgPSAocGFyZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgPyBwYXJlbnQgOiBwYXJlbnQ/Lmhvc3QpID8/IHBhcmVudDtcbiAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiBvYnNlcnZlci5vYnNlcnZlKG9ic2VydmVkLCB7XG4gICAgICAgIHN1YnRyZWU6IHRydWUsXG4gICAgICAgIGNoaWxkTGlzdDogdHJ1ZVxuICAgIH0pKTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBvYnNlcnZlQ29ubmVjdCA9IChlbGVtZW50OiBFbGVtZW50LCBoYW5kbGVNdXRhdGlvbikgPT4ge1xuICAgIGlmIChlbGVtZW50Py5pc0Nvbm5lY3RlZCkge1xuICAgICAgICByZXR1cm4gaGFuZGxlTXV0YXRpb24oKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGNvbnN0IG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKG11dGF0aW9uTGlzdCwgb2JzZXJ2ZXIpID0+IHtcbiAgICAgICAgZm9yIChjb25zdCBtdXRhdGlvbiBvZiBtdXRhdGlvbkxpc3QpIHtcbiAgICAgICAgICAgIGlmIChtdXRhdGlvbi50eXBlID09IFwiY2hpbGRMaXN0XCIpIHtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuZnJvbShtdXRhdGlvbj8uYWRkZWROb2Rlc3x8W10pLnNvbWUoKG5vZGUpPT4obm9kZSA9PT0gZWxlbWVudCB8fCBub2RlPy5jb250YWlucz8uKGVsZW1lbnQpKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcXVldWVNaWNyb3Rhc2soKCk9PmhhbmRsZU11dGF0aW9uKG11dGF0aW9uKSk7XG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyPy5kaXNjb25uZWN0Py4oKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vXG4gICAgY29uc3QgcGFyZW50ID0gZ2V0UGFyZW50T3JTaGFkb3dSb290KGVsZW1lbnQgYXMgSFRNTEVsZW1lbnQpID8/IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcbiAgICBjb25zdCBvYnNlcnZlZCA9IChwYXJlbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IHBhcmVudCA6IHBhcmVudD8uaG9zdCkgPz8gcGFyZW50O1xuICAgIHF1ZXVlTWljcm90YXNrKCgpID0+IG9ic2VydmVyLm9ic2VydmUob2JzZXJ2ZWQsIHtcbiAgICAgICAgc3VidHJlZTogdHJ1ZSxcbiAgICAgICAgY2hpbGRMaXN0OiB0cnVlXG4gICAgfSkpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGFwcGVuZEFzT3ZlcmxheSA9IChhbmNob3I6IEhUTUxFbGVtZW50fG51bGwsIG92ZXJsYXk/OiBIVE1MRWxlbWVudHxudWxsLCBzZWxmPzogSFRNTEVsZW1lbnR8bnVsbCwgb3B0aW9ucz86IHtcbiAgICByb290PzogSFRNTEVsZW1lbnQsXG4gICAgekluZGV4U2hpZnQ/OiBudW1iZXIsXG4gICAgcGxhY2VtZW50PzogXCJmaWxsXCIgfCBcImJvdHRvbVwiIHwgXCJ0b3BcIiB8IFwibGVmdFwiIHwgXCJyaWdodFwiIHwgXCJjZW50ZXJcIiB8IFwic2Nyb2xsYmFyLXhcIiB8IFwic2Nyb2xsYmFyLXlcIixcbiAgICBpbnNldD86IG51bWJlcixcbiAgICBzaXplPzogc3RyaW5nLFxuICAgIHRyYW5zZm9ybU9yaWdpbj86IHN0cmluZyxcbiAgICB1c2VJbnRlcnNlY3Rpb24/OiBib29sZWFuLFxufSkgPT4ge1xuICAgIGNvbnN0IHtcbiAgICAgICAgcm9vdCA9IHdpbmRvdyxcbiAgICAgICAgekluZGV4U2hpZnQgPSAxLFxuICAgICAgICBwbGFjZW1lbnQgPSBcImZpbGxcIixcbiAgICAgICAgaW5zZXQgPSAwLFxuICAgICAgICBzaXplID0gXCIxMDAlXCIsXG4gICAgICAgIHRyYW5zZm9ybU9yaWdpbiA9IFwiNTAlIDUwJVwiLFxuICAgICAgICB1c2VJbnRlcnNlY3Rpb24gPSBmYWxzZVxuICAgIH0gPSBvcHRpb25zIHx8IHt9O1xuICAgIGFuY2hvciA/Pz0gKHNlbGY/LmNoaWxkcmVuPy5bMF0gYXMgSFRNTEVsZW1lbnQpID8/IGFuY2hvcjtcblxuICAgIC8vXG4gICAgaWYgKCFhbmNob3IgJiYgKHNlbGY/LmNoaWxkcmVuPy5sZW5ndGggPz8gMCkgPCAxKSB7XG4gICAgICAgIC8vIGZpeCBhbmNob3IgcHJvYmxlbXNcbiAgICAgICAgY29uc3QgZmlsbEFuY2hvckJveCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgIGZpbGxBbmNob3JCb3guY2xhc3NMaXN0LmFkZChcInVpLXdpbmRvdy1mcmFtZS1hbmNob3ItYm94XCIpO1xuICAgICAgICBmaWxsQW5jaG9yQm94LnN0eWxlLnBvc2l0aW9uID0gXCJyZWxhdGl2ZVwiO1xuICAgICAgICBmaWxsQW5jaG9yQm94LnN0eWxlLmlubGluZVNpemUgPSBcInN0cmV0Y2hcIjtcbiAgICAgICAgZmlsbEFuY2hvckJveC5zdHlsZS5ibG9ja1NpemUgPSBcInN0cmV0Y2hcIjtcbiAgICAgICAgZmlsbEFuY2hvckJveC5zdHlsZS56SW5kZXggPSBTdHJpbmcoekluZGV4U2hpZnQgKyAwKTtcbiAgICAgICAgZmlsbEFuY2hvckJveC5zdHlsZS5wb2ludGVyRXZlbnRzID0gXCJub25lXCI7XG4gICAgICAgIGZpbGxBbmNob3JCb3guc3R5bGUub3BhY2l0eSA9IFwiMVwiO1xuICAgICAgICBmaWxsQW5jaG9yQm94LnN0eWxlLnZpc2liaWxpdHkgPSBcInZpc2libGVcIjtcbiAgICAgICAgZmlsbEFuY2hvckJveC5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBcInRyYW5zcGFyZW50XCI7XG4gICAgICAgIChzZWxmIGFzIGFueSk/LmFwcGVuZD8uKGFuY2hvciA9IGZpbGxBbmNob3JCb3gpO1xuICAgIH1cblxuICAgIC8vXG4gICAgaWYgKGFuY2hvciA9PSBudWxsIHx8IG92ZXJsYXkgPT0gbnVsbCkgcmV0dXJuO1xuICAgIGNvbnN0IGFuY2hvckJpbmRlciA9IG1ha2VBbmNob3JFbGVtZW50KGFuY2hvcik7XG5cbiAgICAvLyBIYW5kbGUgc2Nyb2xsYmFyLXNwZWNpZmljIHBsYWNlbWVudHNcbiAgICBpZiAocGxhY2VtZW50ID09PSBcInNjcm9sbGJhci14XCIpIHtcbiAgICAgICAgYW5jaG9yQmluZGVyLmNvbm5lY3RFbGVtZW50KG92ZXJsYXksIHtcbiAgICAgICAgICAgIHBsYWNlbWVudDogXCJib3R0b21cIixcbiAgICAgICAgICAgIHpJbmRleFNoaWZ0LFxuICAgICAgICAgICAgaW5zZXQsXG4gICAgICAgICAgICBzaXplLFxuICAgICAgICAgICAgdHJhbnNmb3JtT3JpZ2luXG4gICAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAocGxhY2VtZW50ID09PSBcInNjcm9sbGJhci15XCIpIHtcbiAgICAgICAgYW5jaG9yQmluZGVyLmNvbm5lY3RFbGVtZW50KG92ZXJsYXksIHtcbiAgICAgICAgICAgIHBsYWNlbWVudDogXCJyaWdodFwiLFxuICAgICAgICAgICAgekluZGV4U2hpZnQsXG4gICAgICAgICAgICBpbnNldCxcbiAgICAgICAgICAgIHNpemUsXG4gICAgICAgICAgICB0cmFuc2Zvcm1PcmlnaW5cbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgYW5jaG9yQmluZGVyLmNvbm5lY3RFbGVtZW50KG92ZXJsYXksIHtcbiAgICAgICAgICAgIHBsYWNlbWVudCxcbiAgICAgICAgICAgIHpJbmRleFNoaWZ0LFxuICAgICAgICAgICAgaW5zZXQsXG4gICAgICAgICAgICBzaXplLFxuICAgICAgICAgICAgdHJhbnNmb3JtT3JpZ2luXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vXG4gICAgb2JzZXJ2ZUNvbm5lY3QoYW5jaG9yLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhcmVudCA9IGdldFBhcmVudE9yU2hhZG93Um9vdChhbmNob3IpID8/IHNlbGY7XG4gICAgICAgIGNvbnN0IHN0eWxlZCA9IHBhcmVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ID8gcGFyZW50IDogcGFyZW50Py5ob3N0O1xuICAgICAgICAoc3R5bGVkIGFzIEhUTUxFbGVtZW50KT8uc3R5bGU/LnNldFByb3BlcnR5Py4oXCJhbmNob3Itc2NvcGVcIiwgYW5jaG9yQmluZGVyLmFuY2hvcklkKTtcbiAgICAgICAgKGFuY2hvciBhcyBhbnkpPy5hZnRlcj8uKG92ZXJsYXkpO1xuICAgICAgICBvYnNlcnZlRGlzY29ubmVjdChwYXJlbnQgYXMgRWxlbWVudCwgKCkgPT4gb3ZlcmxheT8ucmVtb3ZlPy4oKSk7XG4gICAgfSk7XG5cbiAgICAvL1xuICAgIHJldHVybiBhbmNob3I7XG59XG5cbi8vIEVuaGFuY2VkIHNjcm9sbGJhciBvdmVybGF5IHdpdGggcmVhY3RpdmUgcG9zaXRpb25pbmdcbmV4cG9ydCBjb25zdCBhcHBlbmRTY3JvbGxiYXJPdmVybGF5ID0gKGNvbnRlbnQ6IEhUTUxFbGVtZW50LCBzY3JvbGxiYXI6IEhUTUxFbGVtZW50LCBheGlzOiAnaG9yaXpvbnRhbCcgfCAndmVydGljYWwnLCBvcHRpb25zPzoge1xuICAgIHpJbmRleFNoaWZ0PzogbnVtYmVyLFxuICAgIGF1dG9Qb3NpdGlvbj86IGJvb2xlYW4sXG4gICAgdXNlSW50ZXJzZWN0aW9uPzogYm9vbGVhbixcbiAgICB0aGVtZT86IHN0cmluZyxcbn0pID0+IHtcbiAgICBjb25zdCB7IHpJbmRleFNoaWZ0ID0gMSwgYXV0b1Bvc2l0aW9uID0gdHJ1ZSwgdXNlSW50ZXJzZWN0aW9uID0gZmFsc2UsIHRoZW1lID0gXCJkZWZhdWx0XCIgfSA9IG9wdGlvbnMgfHwge307XG5cbiAgICAvLyBTZXQgdGhlbWUgY2xhc3NcbiAgICBzY3JvbGxiYXIuY2xhc3NMaXN0LmFkZChgc2Nyb2xsYmFyLXRoZW1lLSR7dGhlbWV9YCk7XG4gICAgc2Nyb2xsYmFyLnNldEF0dHJpYnV0ZShcImRhdGEtYXhpc1wiLCBheGlzKTtcblxuICAgIGxldCBjbGVhbnVwRnVuY3Rpb25zOiAoKCkgPT4gdm9pZClbXSA9IFtdO1xuXG4gICAgaWYgKGF1dG9Qb3NpdGlvbikge1xuICAgICAgICAvLyBVc2UgZW5oYW5jZWQgaW50ZXJzZWN0aW9uIGJveCBmb3IgcHJlY2lzZSBwb3NpdGlvbmluZ1xuICAgICAgICBpZiAodXNlSW50ZXJzZWN0aW9uKSB7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnNlY3Rpb25Cb3g6IGFueVtdID0gZW5oYW5jZWRJbnRlcnNlY3Rpb25Cb3hBbmNob3JSZWYoY29udGVudCBhcyBIVE1MRWxlbWVudCwge1xuICAgICAgICAgICAgICAgIHJvb3Q6IHdpbmRvdyBhcyBhbnksXG4gICAgICAgICAgICAgICAgb2JzZXJ2ZVJlc2l6ZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBvYnNlcnZlTXV0YXRpb25zOiB0cnVlLFxuICAgICAgICAgICAgICAgIG9ic2VydmVJbnRlcnNlY3Rpb246IHRydWVcbiAgICAgICAgICAgIH0pIGFzIGFueVtdO1xuXG4gICAgICAgICAgICAvLyBQb3NpdGlvbiBzY3JvbGxiYXIgdXNpbmcgcmVhY3RpdmUgYmluZGluZ3NcbiAgICAgICAgICAgIGNsZWFudXBGdW5jdGlvbnMucHVzaChiaW5kU2Nyb2xsYmFyUG9zaXRpb24oc2Nyb2xsYmFyLCBpbnRlcnNlY3Rpb25Cb3ggYXMgYW55W10sIGF4aXMsIHtcbiAgICAgICAgICAgICAgICB1c2VJbnRlcnNlY3Rpb246IHRydWUsXG4gICAgICAgICAgICAgICAgekluZGV4U2hpZnRcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFVzZSBzdGFuZGFyZCBib3VuZGluZyBib3ggd2l0aCByZWFjdGl2ZSBiaW5kaW5nc1xuICAgICAgICAgICAgY29uc3QgYm94OiBhbnlbXSA9IGJvdW5kaW5nQm94QW5jaG9yUmVmKGNvbnRlbnQgYXMgSFRNTEVsZW1lbnQsIHtcbiAgICAgICAgICAgICAgICBvYnNlcnZlUmVzaXplOiB0cnVlLFxuICAgICAgICAgICAgICAgIG9ic2VydmVNdXRhdGlvbnM6IHRydWVcbiAgICAgICAgICAgIH0pIGFzIGFueVtdO1xuXG4gICAgICAgICAgICAvLyBQb3NpdGlvbiBzY3JvbGxiYXIgdXNpbmcgcmVhY3RpdmUgYmluZGluZ3NcbiAgICAgICAgICAgIGNsZWFudXBGdW5jdGlvbnMucHVzaChiaW5kU2Nyb2xsYmFyUG9zaXRpb24oc2Nyb2xsYmFyLCBib3gsIGF4aXMsIHtcbiAgICAgICAgICAgICAgICB1c2VJbnRlcnNlY3Rpb246IGZhbHNlLFxuICAgICAgICAgICAgICAgIHpJbmRleFNoaWZ0XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBZGQgc2Nyb2xsYmFyIHRvIERPTVxuICAgIGlmICghc2Nyb2xsYmFyLnBhcmVudE5vZGUpIHtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JvbGxiYXIpO1xuICAgIH1cblxuICAgIC8vIFNldCB1cCByZW1vdmFsIG9uIGNvbnRlbnQgZGlzY29ubmVjdCB3aXRoIGNsZWFudXBcbiAgICBvYnNlcnZlRGlzY29ubmVjdChjb250ZW50LCAoKSA9PiB7XG4gICAgICAgIGNsZWFudXBGdW5jdGlvbnMuZm9yRWFjaChjbGVhbnVwID0+IGNsZWFudXAoKSk7XG4gICAgICAgIHNjcm9sbGJhci5yZW1vdmUoKTtcbiAgICB9KTtcblxuICAgIC8vXG4gICAgcmV0dXJuIHNjcm9sbGJhcjtcbn07XG5cbi8vIEV4YW1wbGUgdXNhZ2UgZnVuY3Rpb24gZm9yIHRlc3RpbmcgcmVhY3RpdmUgc2Nyb2xsYmFyIG92ZXJsYXlzXG5leHBvcnQgY29uc3QgY3JlYXRlUmVhY3RpdmVTY3JvbGxiYXJPdmVybGF5ID0gKGNvbnRlbnQ6IEhUTUxFbGVtZW50LCBheGlzOiAnaG9yaXpvbnRhbCcgfCAndmVydGljYWwnID0gJ3ZlcnRpY2FsJykgPT4ge1xuICAgIC8vIENyZWF0ZSBzY3JvbGxiYXIgZWxlbWVudFxuICAgIGNvbnN0IHNjcm9sbGJhciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgIHNjcm9sbGJhci5jbGFzc05hbWUgPSBgcmVhY3RpdmUtc2Nyb2xsYmFyIHJlYWN0aXZlLXNjcm9sbGJhci0ke2F4aXN9YDtcbiAgICBzY3JvbGxiYXIuc3R5bGUuYmFja2dyb3VuZCA9ICdyZ2JhKDAsMCwwLDAuMyknO1xuICAgIHNjcm9sbGJhci5zdHlsZS5ib3JkZXJSYWRpdXMgPSAnNHB4JztcbiAgICBzY3JvbGxiYXIuc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnO1xuICAgIHNjcm9sbGJhci5zdHlsZS56SW5kZXggPSAnMTAwMCc7XG5cbiAgICBpZiAoYXhpcyA9PT0gJ2hvcml6b250YWwnKSB7XG4gICAgICAgIHNjcm9sbGJhci5zdHlsZS5oZWlnaHQgPSAnOHB4JztcbiAgICAgICAgc2Nyb2xsYmFyLnN0eWxlLndpZHRoID0gJzEwMHB4JztcbiAgICB9IGVsc2Uge1xuICAgICAgICBzY3JvbGxiYXIuc3R5bGUud2lkdGggPSAnOHB4JztcbiAgICAgICAgc2Nyb2xsYmFyLnN0eWxlLmhlaWdodCA9ICcxMDBweCc7XG4gICAgfVxuXG4gICAgLy8gVXNlIHJlYWN0aXZlIHBvc2l0aW9uaW5nXG4gICAgcmV0dXJuIGFwcGVuZFNjcm9sbGJhck92ZXJsYXkoY29udGVudCwgc2Nyb2xsYmFyLCBheGlzLCB7XG4gICAgICAgIGF1dG9Qb3NpdGlvbjogdHJ1ZSxcbiAgICAgICAgdXNlSW50ZXJzZWN0aW9uOiB0cnVlLFxuICAgICAgICB0aGVtZTogJ2RlZmF1bHQnXG4gICAgfSk7XG59O1xuIl19
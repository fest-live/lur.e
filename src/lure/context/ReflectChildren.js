import { addToCallChain, iterated } from "fest/object";
//
import getNode, { appendChild, removeNotExists, replaceChildren } from "./Utils";
import { removeChild } from "./Utils";
import { $mapped, addToBank, hasInBank } from "../core/Binding";
import { indexOf, isValidParent } from "fest/dom";
//
export const makeUpdater = (defaultParent = null, mapper, isArray = true) => {
    /*const toBeRemoved: any[] = [], toBeAppend: any[] = [], toBeReplace: any[] = [];
    const merge = () => { // @ts-ignore
        toBeAppend.forEach((args) => appendChild(...args)); toBeAppend.splice(0, toBeAppend.length); // @ts-ignore
        toBeRemoved.forEach((args) => removeChild(...args)); toBeRemoved.splice(0, toBeRemoved.length); // @ts-ignore
        toBeReplace.forEach((args) => replaceChildren(...args)); toBeReplace.splice(0, toBeReplace.length); // @ts-ignore
    }*/
    //
    const commandBuffer = [];
    const merge = () => {
        commandBuffer?.forEach?.(([fn, args]) => fn?.(...args));
        commandBuffer?.splice?.(0, commandBuffer?.length);
    };
    //
    const updateChildList = (newEl, idx, oldEl, op, boundParent = null) => {
        const $requestor = isValidParent(boundParent) ?? isValidParent(defaultParent);
        const newNode = getNode(newEl, mapper, idx, $requestor);
        const oldNode = getNode(oldEl, mapper, idx, $requestor);
        //
        let doubtfulParent = newNode?.parentElement ?? oldNode?.parentElement;
        let element = isValidParent(doubtfulParent) ?? $requestor;
        if (!element)
            return;
        if (defaultParent != element) {
            defaultParent = element;
        }
        //
        const oldIdx = indexOf(element, oldNode);
        //
        if ((["@add", "@set", "@delete"].indexOf(op || "") >= 0 || !op)) {
            // due splice already removed that index, we need to add +1 to the index in exists children
            if ((newNode == null && oldNode != null) || op == "@delete") {
                commandBuffer?.push?.([removeChild, [element, oldNode, null, oldIdx >= 0 ? oldIdx : idx]]);
            }
            else if ((newNode != null && oldNode == null) || op == "@add") {
                commandBuffer?.push?.([appendChild, [element, newNode, null, idx]]);
            }
            else if ((newNode != null && oldNode != null) || op == "@set") {
                commandBuffer?.push?.([replaceChildren, [element, newNode, null, oldIdx >= 0 ? oldIdx : idx, oldNode]]);
            }
            ; // TODO: add support for oldNode in replace method
        }
        //
        if ((op && op != "@get" && ["@add", "@set", "@delete"].indexOf(op) >= 0) || (!op && !isArray)) {
            merge?.();
        }
    };
    //
    return updateChildList;
};
//
const asArray = (children) => {
    if (children instanceof Map || children instanceof Set) {
        children = Array.from(children?.values?.());
    }
    return children;
};
// TODO! use handlerMap registry
export const reflectChildren = (element, children = [], mapper) => {
    const $parent = getNode(Array.from(children?.values?.() || [])?.[0], mapper, 0)?.parentElement;
    if (!isValidParent(element)) {
        element = (isValidParent($parent) ? $parent : element) ?? element;
    }
    if (!children || hasInBank(element, children))
        return element;
    //
    mapper = (children?.[$mapped] ? children?.mapper : mapper) ?? mapper;
    children = (children?.[$mapped] ? children?.children : children) ?? children;
    //
    removeNotExists(element, asArray(children)?.map?.((nd, index) => getNode(nd, mapper, index, element)));
    const updater = makeUpdater(element, mapper, true);
    const unsub = iterated(children, (...args) => {
        const firstOf = getNode(Array.from(children?.values?.() || [])?.[0], mapper, 0);
        const boundParent = firstOf?.parentElement; // @ts-ignore
        return updater(args?.[0], args?.[1], args?.[2], args?.[3], boundParent);
    });
    //
    addToBank(element, reflectChildren, "childNodes", [children, unsub]);
    addToCallChain(children, Symbol.dispose, unsub);
    addToCallChain(element, Symbol.dispose, unsub);
    return element;
};
// forcely update child nodes (and erase current content)
export const reformChildren = (element, children = [], mapper) => {
    if (!children || !element)
        return element;
    //
    mapper = (children?.[$mapped] ? children?.mapper : mapper) ?? mapper;
    children = (children?.[$mapped] ? children?.children : children) ?? children;
    //
    const keys = Array.from(children?.keys?.() || []);
    const cvt = asArray(children)?.map?.((nd, index) => getNode(nd, mapper, keys?.[index] ?? index, element));
    //
    removeNotExists(element, cvt);
    cvt?.forEach?.((nd) => appendChild(element, nd));
    return element;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVmbGVjdENoaWxkcmVuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiUmVmbGVjdENoaWxkcmVuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFpQixNQUFNLGFBQWEsQ0FBQztBQUV0RSxFQUFFO0FBQ0YsT0FBTyxPQUFPLEVBQUUsRUFBRSxXQUFXLEVBQUUsZUFBZSxFQUFFLGVBQWUsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNqRixPQUFPLEVBQUUsV0FBVyxFQUF1QixNQUFNLFNBQVMsQ0FBQztBQUMzRCxPQUFPLEVBQUUsT0FBTyxFQUFhLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVsRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sV0FBVyxHQUFHLENBQUMsZ0JBQTZCLElBQUksRUFBRSxNQUF3QixFQUFFLFVBQW1CLElBQUksRUFBRSxFQUFFO0lBQ2hIOzs7OztPQUtHO0lBRUgsRUFBRTtJQUNGLE1BQU0sYUFBYSxHQUFVLEVBQUUsQ0FBQztJQUNoQyxNQUFNLEtBQUssR0FBRyxHQUFFLEVBQUU7UUFDZCxhQUFhLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBQyxFQUFFLENBQUEsRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3RELGFBQWEsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQUUsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELENBQUMsQ0FBQTtJQUVELEVBQUU7SUFDRixNQUFNLGVBQWUsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQWlCLEVBQUUsY0FBMkIsSUFBSSxFQUFFLEVBQUU7UUFDOUYsTUFBTSxVQUFVLEdBQUcsYUFB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QixFQUFFLEVBQUUsTUFBaUIsRUFBRSxFQUFFO0lBQy9HLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxPQUFPO1FBQUUsT0FBTyxPQUFPLENBQUM7SUFFMUMsRUFBRTtJQUNGLE1BQU0sR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBRSxRQUFnQixFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxDQUFDO0lBQzlFLFFBQVEsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBRSxRQUFnQixFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksUUFBUSxDQUFDO0lBRXRGLEVBQUU7SUFDRixNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBRTFHLEVBQUU7SUFDRixlQUFlLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDaEYsT0FBTyxPQUFPLENBQUM7QUFDbkIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWRkVG9DYWxsQ2hhaW4sIGl0ZXJhdGVkLCByZWYsIGFmZmVjdGVkIH0gZnJvbSBcImZlc3Qvb2JqZWN0XCI7XG5cbi8vXG5pbXBvcnQgZ2V0Tm9kZSwgeyBhcHBlbmRDaGlsZCwgcmVtb3ZlTm90RXhpc3RzLCByZXBsYWNlQ2hpbGRyZW4gfSBmcm9tIFwiLi9VdGlsc1wiO1xuaW1wb3J0IHsgcmVtb3ZlQ2hpbGQsIHJlbW92ZUNoaWxkRGlyZWN0bHkgfSBmcm9tIFwiLi9VdGlsc1wiO1xuaW1wb3J0IHsgJG1hcHBlZCwgJGJlaGF2aW9yLCBhZGRUb0JhbmssIGhhc0luQmFuayB9IGZyb20gXCIuLi9jb3JlL0JpbmRpbmdcIjtcbmltcG9ydCB7IGluZGV4T2YsIGlzVmFsaWRQYXJlbnQgfSBmcm9tIFwiZmVzdC9kb21cIjtcblxuLy9cbmV4cG9ydCBjb25zdCBtYWtlVXBkYXRlciA9IChkZWZhdWx0UGFyZW50OiBOb2RlIHwgbnVsbCA9IG51bGwsIG1hcHBlcj86IEZ1bmN0aW9uIHwgbnVsbCwgaXNBcnJheTogYm9vbGVhbiA9IHRydWUpID0+IHtcbiAgICAvKmNvbnN0IHRvQmVSZW1vdmVkOiBhbnlbXSA9IFtdLCB0b0JlQXBwZW5kOiBhbnlbXSA9IFtdLCB0b0JlUmVwbGFjZTogYW55W10gPSBbXTtcbiAgICBjb25zdCBtZXJnZSA9ICgpID0+IHsgLy8gQHRzLWlnbm9yZVxuICAgICAgICB0b0JlQXBwZW5kLmZvckVhY2goKGFyZ3MpID0+IGFwcGVuZENoaWxkKC4uLmFyZ3MpKTsgdG9CZUFwcGVuZC5zcGxpY2UoMCwgdG9CZUFwcGVuZC5sZW5ndGgpOyAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRvQmVSZW1vdmVkLmZvckVhY2goKGFyZ3MpID0+IHJlbW92ZUNoaWxkKC4uLmFyZ3MpKTsgdG9CZVJlbW92ZWQuc3BsaWNlKDAsIHRvQmVSZW1vdmVkLmxlbmd0aCk7IC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdG9CZVJlcGxhY2UuZm9yRWFjaCgoYXJncykgPT4gcmVwbGFjZUNoaWxkcmVuKC4uLmFyZ3MpKTsgdG9CZVJlcGxhY2Uuc3BsaWNlKDAsIHRvQmVSZXBsYWNlLmxlbmd0aCk7IC8vIEB0cy1pZ25vcmVcbiAgICB9Ki9cblxuICAgIC8vXG4gICAgY29uc3QgY29tbWFuZEJ1ZmZlcjogYW55W10gPSBbXTtcbiAgICBjb25zdCBtZXJnZSA9ICgpPT57XG4gICAgICAgIGNvbW1hbmRCdWZmZXI/LmZvckVhY2g/LigoW2ZuLCBhcmdzXSk9PmZuPy4oLi4uYXJncykpO1xuICAgICAgICBjb21tYW5kQnVmZmVyPy5zcGxpY2U/LigwLCBjb21tYW5kQnVmZmVyPy5sZW5ndGgpO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3QgdXBkYXRlQ2hpbGRMaXN0ID0gKG5ld0VsLCBpZHgsIG9sZEVsLCBvcDogc3RyaW5nIHwgbnVsbCwgYm91bmRQYXJlbnQ6IE5vZGUgfCBudWxsID0gbnVsbCkgPT4ge1xuICAgICAgICBjb25zdCAkcmVxdWVzdG9yID0gaXNWYWxpZFBhcmVudChib3VuZFBhcmVudCkgPz8gaXNWYWxpZFBhcmVudChkZWZhdWx0UGFyZW50KTtcbiAgICAgICAgY29uc3QgbmV3Tm9kZSA9IGdldE5vZGUobmV3RWwsIG1hcHBlciwgaWR4LCAkcmVxdWVzdG9yKTtcbiAgICAgICAgY29uc3Qgb2xkTm9kZSA9IGdldE5vZGUob2xkRWwsIG1hcHBlciwgaWR4LCAkcmVxdWVzdG9yKTtcblxuICAgICAgICAvL1xuICAgICAgICBsZXQgZG91YnRmdWxQYXJlbnQgPSBuZXdOb2RlPy5wYXJlbnRFbGVtZW50ID8/IG9sZE5vZGU/LnBhcmVudEVsZW1lbnQ7XG4gICAgICAgIGxldCBlbGVtZW50ID0gaXNWYWxpZFBhcmVudChkb3VidGZ1bFBhcmVudCkgPz8gJHJlcXVlc3RvcjtcbiAgICAgICAgaWYgKCFlbGVtZW50KSByZXR1cm47IGlmIChkZWZhdWx0UGFyZW50ICE9IGVsZW1lbnQpIHsgZGVmYXVsdFBhcmVudCA9IGVsZW1lbnQ7IH1cblxuICAgICAgICAvL1xuICAgICAgICBjb25zdCBvbGRJZHggPSBpbmRleE9mKGVsZW1lbnQsIG9sZE5vZGUpO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGlmICgoW1wiQGFkZFwiLCBcIkBzZXRcIiwgXCJAZGVsZXRlXCJdLmluZGV4T2Yob3AgfHwgXCJcIikgPj0gMCB8fCAhb3ApKSB7XG4gICAgICAgICAgICAvLyBkdWUgc3BsaWNlIGFscmVhZHkgcmVtb3ZlZCB0aGF0IGluZGV4LCB3ZSBuZWVkIHRvIGFkZCArMSB0byB0aGUgaW5kZXggaW4gZXhpc3RzIGNoaWxkcmVuXG4gICAgICAgICAgICBpZiAoKG5ld05vZGUgPT0gbnVsbCAmJiBvbGROb2RlICE9IG51bGwpIHx8IG9wID09IFwiQGRlbGV0ZVwiKSB7IGNvbW1hbmRCdWZmZXI/LnB1c2g/LihbcmVtb3ZlQ2hpbGQsIFtlbGVtZW50LCBvbGROb2RlLCBudWxsLCBvbGRJZHggPj0gMCA/IG9sZElkeCA6IGlkeF1dKTsgfSBlbHNlXG4gICAgICAgICAgICBpZiAoKG5ld05vZGUgIT0gbnVsbCAmJiBvbGROb2RlID09IG51bGwpIHx8IG9wID09IFwiQGFkZFwiKSB7IGNvbW1hbmRCdWZmZXI/LnB1c2g/LihbYXBwZW5kQ2hpbGQsIFtlbGVtZW50LCBuZXdOb2RlLCBudWxsLCBpZHhdXSk7IH0gZWxzZVxuICAgICAgICAgICAgaWYgKChuZXdOb2RlICE9IG51bGwgJiYgb2xkTm9kZSAhPSBudWxsKSB8fCBvcCA9PSBcIkBzZXRcIikgeyBjb21tYW5kQnVmZmVyPy5wdXNoPy4oW3JlcGxhY2VDaGlsZHJlbiwgW2VsZW1lbnQsIG5ld05vZGUsIG51bGwsIG9sZElkeCA+PSAwID8gb2xkSWR4IDogaWR4LCBvbGROb2RlXV0pOyB9OyAvLyBUT0RPOiBhZGQgc3VwcG9ydCBmb3Igb2xkTm9kZSBpbiByZXBsYWNlIG1ldGhvZFxuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKChvcCAmJiBvcCAhPSBcIkBnZXRcIiAmJiBbXCJAYWRkXCIsIFwiQHNldFwiLCBcIkBkZWxldGVcIl0uaW5kZXhPZihvcCkgPj0gMCkgfHwgKCFvcCAmJiAhaXNBcnJheSkpIHsgbWVyZ2U/LigpOyB9XG4gICAgfVxuXG4gICAgLy9cbiAgICByZXR1cm4gdXBkYXRlQ2hpbGRMaXN0O1xufVxuXG4vL1xuY29uc3QgYXNBcnJheSA9IChjaGlsZHJlbik9PntcbiAgICBpZiAoY2hpbGRyZW4gaW5zdGFuY2VvZiBNYXAgfHwgY2hpbGRyZW4gaW5zdGFuY2VvZiBTZXQpIHtcbiAgICAgICAgY2hpbGRyZW4gPSBBcnJheS5mcm9tKGNoaWxkcmVuPy52YWx1ZXM/LigpKTtcbiAgICB9XG4gICAgcmV0dXJuIGNoaWxkcmVuO1xufVxuXG4vLyBUT0RPISB1c2UgaGFuZGxlck1hcCByZWdpc3RyeVxuZXhwb3J0IGNvbnN0IHJlZmxlY3RDaGlsZHJlbiA9IChlbGVtZW50OiBIVE1MRWxlbWVudCB8IERvY3VtZW50RnJhZ21lbnQsIGNoaWxkcmVuOiBhbnlbXSA9IFtdLCBtYXBwZXI/OiBGdW5jdGlvbikgPT4ge1xuICAgIGNvbnN0ICRwYXJlbnQgPSBnZXROb2RlKEFycmF5LmZyb20oY2hpbGRyZW4/LnZhbHVlcz8uKCkgfHwgW10pPy5bMF0sIG1hcHBlciwgMCk/LnBhcmVudEVsZW1lbnQ7XG4gICAgaWYgKCFpc1ZhbGlkUGFyZW50KGVsZW1lbnQpKSB7IGVsZW1lbnQgPSAoaXNWYWxpZFBhcmVudCgkcGFyZW50KSA/ICRwYXJlbnQgOiBlbGVtZW50KSA/PyBlbGVtZW50OyB9XG4gICAgaWYgKCFjaGlsZHJlbiB8fCBoYXNJbkJhbmsoZWxlbWVudCwgY2hpbGRyZW4pKSByZXR1cm4gZWxlbWVudDtcblxuICAgIC8vXG4gICAgbWFwcGVyID0gKGNoaWxkcmVuPy5bJG1hcHBlZF0gPyAoY2hpbGRyZW4gYXMgYW55KT8ubWFwcGVyIDogbWFwcGVyKSA/PyBtYXBwZXI7XG4gICAgY2hpbGRyZW4gPSAoY2hpbGRyZW4/LlskbWFwcGVkXSA/IChjaGlsZHJlbiBhcyBhbnkpPy5jaGlsZHJlbiA6IGNoaWxkcmVuKSA/PyBjaGlsZHJlbjtcblxuICAgIC8vXG4gICAgcmVtb3ZlTm90RXhpc3RzKGVsZW1lbnQsIGFzQXJyYXkoY2hpbGRyZW4pPy5tYXA/LigobmQsIGluZGV4KSA9PiBnZXROb2RlKG5kLCBtYXBwZXIsIGluZGV4LCBlbGVtZW50KSkpO1xuICAgIGNvbnN0IHVwZGF0ZXIgPSBtYWtlVXBkYXRlcihlbGVtZW50LCBtYXBwZXIsIHRydWUpO1xuICAgIGNvbnN0IHVuc3ViID0gaXRlcmF0ZWQoY2hpbGRyZW4sICguLi5hcmdzKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpcnN0T2YgPSBnZXROb2RlKEFycmF5LmZyb20oY2hpbGRyZW4/LnZhbHVlcz8uKCkgfHwgW10pPy5bMF0sIG1hcHBlciwgMCk7XG4gICAgICAgIGNvbnN0IGJvdW5kUGFyZW50ID0gZmlyc3RPZj8ucGFyZW50RWxlbWVudDsgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gdXBkYXRlcihhcmdzPy5bMF0sIGFyZ3M/LlsxXSwgYXJncz8uWzJdLCBhcmdzPy5bM10sIGJvdW5kUGFyZW50KTtcbiAgICB9KTtcblxuICAgIC8vXG4gICAgYWRkVG9CYW5rKGVsZW1lbnQsIHJlZmxlY3RDaGlsZHJlbiwgXCJjaGlsZE5vZGVzXCIsIFtjaGlsZHJlbiwgdW5zdWJdKTtcbiAgICBhZGRUb0NhbGxDaGFpbihjaGlsZHJlbiwgU3ltYm9sLmRpc3Bvc2UsIHVuc3ViKTtcbiAgICBhZGRUb0NhbGxDaGFpbihlbGVtZW50LCBTeW1ib2wuZGlzcG9zZSwgdW5zdWIpOyByZXR1cm4gZWxlbWVudDtcbn1cblxuLy8gZm9yY2VseSB1cGRhdGUgY2hpbGQgbm9kZXMgKGFuZCBlcmFzZSBjdXJyZW50IGNvbnRlbnQpXG5leHBvcnQgY29uc3QgcmVmb3JtQ2hpbGRyZW4gPSAoZWxlbWVudDogSFRNTEVsZW1lbnQgfCBEb2N1bWVudEZyYWdtZW50LCBjaGlsZHJlbjogYW55W10gPSBbXSwgbWFwcGVyPzogRnVuY3Rpb24pID0+IHtcbiAgICBpZiAoIWNoaWxkcmVuIHx8ICFlbGVtZW50KSByZXR1cm4gZWxlbWVudDtcblxuICAgIC8vXG4gICAgbWFwcGVyID0gKGNoaWxkcmVuPy5bJG1hcHBlZF0gPyAoY2hpbGRyZW4gYXMgYW55KT8ubWFwcGVyIDogbWFwcGVyKSA/PyBtYXBwZXI7XG4gICAgY2hpbGRyZW4gPSAoY2hpbGRyZW4/LlskbWFwcGVkXSA/IChjaGlsZHJlbiBhcyBhbnkpPy5jaGlsZHJlbiA6IGNoaWxkcmVuKSA/PyBjaGlsZHJlbjtcblxuICAgIC8vXG4gICAgY29uc3Qga2V5cyA9IEFycmF5LmZyb20oY2hpbGRyZW4/LmtleXM/LigpIHx8IFtdKTtcbiAgICBjb25zdCBjdnQgPSBhc0FycmF5KGNoaWxkcmVuKT8ubWFwPy4oKG5kLCBpbmRleCkgPT4gZ2V0Tm9kZShuZCwgbWFwcGVyLCBrZXlzPy5baW5kZXhdID8/IGluZGV4LCBlbGVtZW50KSk7XG5cbiAgICAvL1xuICAgIHJlbW92ZU5vdEV4aXN0cyhlbGVtZW50LCBjdnQpOyBjdnQ/LmZvckVhY2g/LigobmQpID0+IGFwcGVuZENoaWxkKGVsZW1lbnQsIG5kKSk7XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG59XG4iXX0=
import { addToCallChain, affected, iterated } from "fest/object";
import { isNotEqual, isPrimitive } from "fest/core";
//
import { bindHandler, bindWith } from "../core/Binding";
import { handleDataset, handleProperty, handleAttribute, handleStyleChange } from "fest/dom";
import Q from "../node/Queried";
import { setChecked } from "fest/dom";
// !
// TODO! - add support for un-subscribe for everyone...
// !
//
const $entries = (obj) => {
    if (isPrimitive(obj)) {
        return [];
    }
    if (Array.isArray(obj)) {
        return obj.map((item, idx) => [idx, item]);
    }
    if (obj instanceof Map) {
        return Array.from(obj.entries());
    }
    if (obj instanceof Set) {
        return Array.from(obj.values());
    }
    return Array.from(Object.entries(obj));
};
//
export const reflectAttributes = (element, attributes) => {
    if (!attributes)
        return element;
    const weak = new WeakRef(attributes), wel = new WeakRef(element);
    if (typeof attributes == "object" || typeof attributes == "function") {
        $entries(attributes).forEach(([prop, value]) => {
            handleAttribute(wel?.deref?.(), prop, value);
        });
        const usub = affected(attributes, (value, prop) => {
            handleAttribute(wel?.deref?.(), prop, value);
            bindHandler(wel?.deref?.(), value, prop, handleAttribute, weak, true);
        });
        addToCallChain(attributes, Symbol.dispose, usub);
        addToCallChain(element, Symbol.dispose, usub);
    }
    else {
        console.warn("Invalid attributes object:", attributes);
    }
};
//
export const reflectARIA = (element, aria) => {
    if (!aria)
        return element;
    const weak = new WeakRef(aria), wel = new WeakRef(element);
    if (typeof aria == "object" || typeof aria == "function") {
        $entries(aria).forEach(([prop, value]) => {
            handleAttribute(wel?.deref?.(), "aria-" + (prop?.toString?.() || prop || ""), value);
        });
        const usub = affected(aria, (value, prop) => {
            handleAttribute(wel?.deref?.(), "aria-" + (prop?.toString?.() || prop || ""), value, true);
            bindHandler(wel, value, prop, handleAttribute, weak, true);
        });
        addToCallChain(aria, Symbol.dispose, usub);
        addToCallChain(element, Symbol.dispose, usub);
    }
    else {
        console.warn("Invalid ARIA object:", aria);
    }
    ;
    return element;
};
//
export const reflectDataset = (element, dataset) => {
    if (!dataset)
        return element;
    const weak = new WeakRef(dataset), wel = new WeakRef(element);
    if (typeof dataset == "object" || typeof dataset == "function") {
        $entries(dataset).forEach(([prop, value]) => {
            handleDataset(wel?.deref?.(), prop, value);
        });
        const usub = affected(dataset, (value, prop) => {
            handleDataset(wel?.deref?.(), prop, value);
            bindHandler(wel?.deref?.(), value, prop, handleDataset, weak);
        });
        addToCallChain(dataset, Symbol.dispose, usub);
        addToCallChain(element, Symbol.dispose, usub);
    }
    else {
        console.warn("Invalid dataset object:", dataset);
    }
    ;
    return element;
};
// TODO! support observe styles
export const reflectStyles = (element, styles) => {
    if (!styles)
        return element;
    if (typeof styles == "string") {
        element.style.cssText = styles;
    }
    else if (typeof styles?.value == "string") {
        affected([styles, "value"], (val) => { element.style.cssText = val; });
    }
    else if (typeof styles == "object" || typeof styles == "function") {
        const weak = new WeakRef(styles), wel = new WeakRef(element);
        $entries(styles).forEach(([prop, value]) => {
            handleStyleChange(wel?.deref?.(), prop, value);
        });
        const usub = affected(styles, (value, prop) => {
            handleStyleChange(wel?.deref?.(), prop, value);
            bindHandler(wel?.deref?.(), value, prop, handleStyleChange, weak?.deref?.());
        });
        //
        addToCallChain(styles, Symbol.dispose, usub);
        addToCallChain(element, Symbol.dispose, usub);
    }
    else {
        console.warn("Invalid styles object:", styles);
    }
    return element;
};
// one-shot update
export const reflectWithStyleRules = async (element, rule) => { const styles = await rule?.(element); return reflectStyles(element, styles); };
export const reflectProperties = (element, properties) => {
    if (!properties)
        return element;
    const weak = new WeakRef(properties), wel = new WeakRef(element);
    //
    const onChange = (ev) => {
        const input = Q("input", ev?.target);
        if (input?.value != null && isNotEqual(input?.value, properties?.value))
            properties.value = input?.value;
        if (input?.valueAsNumber != null && isNotEqual(input?.valueAsNumber, properties?.valueAsNumber))
            properties.valueAsNumber = input?.valueAsNumber;
        if (input?.checked != null && isNotEqual(input?.checked, properties?.checked))
            properties.checked = input?.checked;
    };
    //
    $entries(properties).forEach(([prop, value]) => {
        handleProperty(wel?.deref?.(), prop, value);
    });
    //
    const usub = affected(properties, (value, prop) => {
        const el = wel.deref();
        if (el) {
            if (prop == "checked") {
                setChecked(el, value);
            }
            else {
                bindWith(el, prop, value, handleProperty, weak?.deref?.(), true);
            }
        }
    });
    //
    addToCallChain(properties, Symbol.dispose, usub);
    addToCallChain(element, Symbol.dispose, usub);
    element.addEventListener("change", onChange);
    return element;
};
//
export const reflectClassList = (element, classList) => {
    if (!classList)
        return element;
    const wel = new WeakRef(element);
    //
    $entries(classList).forEach(([prop, value]) => {
        const el = element;
        if (typeof value == "undefined" || value == null) {
            if (el.classList.contains(value)) {
                el.classList.remove(value);
            }
        }
        else {
            if (!el.classList.contains(value)) {
                el.classList.add(value);
            }
        }
    });
    const usub = iterated(classList, (value) => {
        const el = wel?.deref?.();
        if (el) {
            if (typeof value == "undefined" || value == null) {
                if (el.classList.contains(value)) {
                    el.classList.remove(value);
                }
            }
            else {
                if (!el.classList.contains(value)) {
                    el.classList.add(value);
                }
            }
        }
    });
    //
    addToCallChain(classList, Symbol.dispose, usub);
    addToCallChain(element, Symbol.dispose, usub);
    return element;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVmbGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlJlZmxlY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXBELEVBQUU7QUFDRixPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUM3RixPQUFPLENBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUNoQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRXRDLElBQUk7QUFDSix1REFBdUQ7QUFDdkQsSUFBSTtBQUVKLEVBQUU7QUFDRixNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQVEsRUFBRSxFQUFFO0lBQzFCLElBQUksV0FBVyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFBQyxPQUFPLEVBQUUsQ0FBQztJQUFDLENBQUM7SUFDcEMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFBQyxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQUMsQ0FBQztJQUN2RSxJQUFJLEdBQUcsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUFDLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUFDLENBQUM7SUFDN0QsSUFBSSxHQUFHLFlBQVksR0FBRyxFQUFFLENBQUM7UUFBQyxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFBQyxDQUFDO0lBQzVELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDM0MsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsT0FBb0IsRUFBRSxVQUFlLEVBQUMsRUFBRTtJQUN0RSxJQUFJLENBQUMsVUFBVTtRQUFFLE9BQU8sT0FBTyxDQUFDO0lBQ2hDLE1BQU0sSUFBSSxHQUFHLElBQUksT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLEdBQUcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNqRSxJQUFJLE9BQU8sVUFBVSxJQUFJLFFBQVEsSUFBSSxPQUFPLFVBQVUsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUNuRSxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUMsRUFBRTtZQUMxQyxlQUFlLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2pELENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFTLEVBQUMsRUFBRTtZQUNsRCxlQUFlLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzdDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUUsQ0FBQyxDQUFDLENBQUM7UUFDSCxjQUFjLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakQsY0FBYyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7U0FDRCxDQUFDO1FBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxVQUFVLENBQUMsQ0FBQztJQUFDLENBQUM7QUFDL0QsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLE9BQW9CLEVBQUUsSUFBUyxFQUFDLEVBQUU7SUFDMUQsSUFBSSxDQUFDLElBQUk7UUFBRSxPQUFPLE9BQU8sQ0FBQztJQUMxQixNQUFNLElBQUksR0FBRyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0QsSUFBSSxPQUFPLElBQUksSUFBSSxRQUFRLElBQUksT0FBTyxJQUFJLElBQUksVUFBVSxFQUFFLENBQUM7UUFDdkQsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFDLEVBQUU7WUFDcEMsZUFBZSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE9BQU8sR0FBQyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxJQUFFLElBQUksSUFBRSxFQUFFLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNuRixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFDLEVBQUU7WUFDdkMsZUFBZSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLE9BQU8sR0FBQyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsRUFBRSxJQUFFLElBQUksSUFBRSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDckYsV0FBVyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDLENBQUM7UUFDSCxjQUFjLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDM0MsY0FBYyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7U0FDRCxDQUFDO1FBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUFBLENBQUM7SUFBQSxDQUFDO0lBQUMsT0FBTyxPQUFPLENBQUM7QUFDbkUsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBRyxDQUFDLE9BQW9CLEVBQUUsT0FBWSxFQUFDLEVBQUU7SUFDaEUsSUFBSSxDQUFDLE9BQU87UUFBRSxPQUFPLE9BQU8sQ0FBQztJQUM3QixNQUFNLElBQUksR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUQsSUFBSSxPQUFPLE9BQU8sSUFBSSxRQUFRLElBQUksT0FBTyxPQUFPLElBQUksVUFBVSxFQUFFLENBQUM7UUFDN0QsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFDLEVBQUU7WUFDdkMsYUFBYSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBUyxFQUFDLEVBQUU7WUFDL0MsYUFBYSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMzQyxXQUFXLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEUsQ0FBQyxDQUFDLENBQUM7UUFDSCxjQUFjLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDOUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7U0FDRCxDQUFDO1FBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUFDLENBQUM7SUFBQSxDQUFDO0lBQUMsT0FBTyxPQUFPLENBQUM7QUFDMUUsQ0FBQyxDQUFBO0FBRUQsK0JBQStCO0FBQy9CLE1BQU0sQ0FBQyxNQUFNLGFBQWEsR0FBRyxDQUFDLE9BQW9CLEVBQUUsTUFBa0IsRUFBQyxFQUFFO0lBQ3JFLElBQUksQ0FBQyxNQUFNO1FBQUUsT0FBTyxPQUFPLENBQUM7SUFDNUIsSUFBSSxPQUFPLE1BQU0sSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUFDLENBQUM7U0FDbEUsSUFBSSxPQUFPLE1BQU0sRUFBRSxLQUFLLElBQUksUUFBUSxFQUFFLENBQUM7UUFBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQUMsQ0FBQztTQUNqSCxJQUFJLE9BQU8sTUFBTSxJQUFJLFFBQVEsSUFBSSxPQUFPLE1BQU0sSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUMzRCxNQUFNLElBQUksR0FBRyxJQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0QsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFDLEVBQUU7WUFDdEMsaUJBQWlCLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQUssRUFBRSxJQUFTLEVBQUMsRUFBRTtZQUM5QyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDL0MsV0FBVyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNqRixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUU7UUFDRixjQUFjLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDN0MsY0FBYyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7U0FDRCxDQUFDO1FBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUFDLENBQUM7SUFBQyxPQUFPLE9BQU8sQ0FBQztBQUN2RSxDQUFDLENBQUE7QUFFRCxrQkFBa0I7QUFDbEIsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQUcsS0FBSyxFQUFFLE9BQW9CLEVBQUUsSUFBUyxFQUFDLEVBQUUsR0FBRSxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxhQUFhLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQzlKLE1BQU0sQ0FBQyxNQUFNLGlCQUFpQixHQUFHLENBQUMsT0FBb0IsRUFBRSxVQUFlLEVBQUMsRUFBRTtJQUN0RSxJQUFJLENBQUMsVUFBVTtRQUFFLE9BQU8sT0FBTyxDQUFDO0lBQUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRWxHLEVBQUU7SUFDRixNQUFNLFFBQVEsR0FBRyxDQUFDLEVBQU8sRUFBQyxFQUFFO1FBQ3hCLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3JDLElBQUksS0FBSyxFQUFFLEtBQUssSUFBSSxJQUFJLElBQUksVUFBVSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEtBQUssQ0FBQztZQUFFLFVBQVUsQ0FBQyxLQUFLLEdBQUcsS0FBSyxFQUFFLEtBQUssQ0FBQztRQUN6RyxJQUFJLEtBQUssRUFBRSxhQUFhLElBQUksSUFBSSxJQUFJLFVBQVUsQ0FBQyxLQUFLLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxhQUFhLENBQUM7WUFBRSxVQUFVLENBQUMsYUFBYSxHQUFHLEtBQUssRUFBRSxhQUFhLENBQUM7UUFDakosSUFBSSxLQUFLLEVBQUUsT0FBTyxJQUFJLElBQUksSUFBSSxVQUFVLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDO1lBQUUsVUFBVSxDQUFDLE9BQU8sR0FBRyxLQUFLLEVBQUUsT0FBTyxDQUFDO0lBQ3ZILENBQUMsQ0FBQztJQUVGLEVBQUU7SUFDRixRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUMsRUFBRTtRQUMxQyxjQUFjLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2hELENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRTtJQUNGLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBUyxFQUFFLEVBQUU7UUFDbkQsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3ZCLElBQUksRUFBRSxFQUFFLENBQUM7WUFDTCxJQUFJLElBQUksSUFBSSxTQUFTLEVBQUUsQ0FBQztnQkFDcEIsVUFBVSxDQUFDLEVBQXNCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDOUMsQ0FBQztpQkFBTSxDQUFDO2dCQUNKLFFBQVEsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDckUsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUU7SUFDRixjQUFjLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFBQyxjQUFjLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQUMsT0FBTyxPQUFPLENBQUM7QUFDbEssQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLENBQUMsT0FBb0IsRUFBRSxTQUF1QixFQUFDLEVBQUU7SUFDN0UsSUFBSSxDQUFDLFNBQVM7UUFBRSxPQUFPLE9BQU8sQ0FBQztJQUFDLE1BQU0sR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRWpFLEVBQUU7SUFDRixRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRTtRQUMxQyxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDbkIsSUFBSSxPQUFPLEtBQUssSUFBSSxXQUFXLElBQUksS0FBSyxJQUFJLElBQUksRUFDNUMsQ0FBQztZQUFDLElBQUssRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFBQyxFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUFDLENBQUM7UUFBQyxDQUFDO2FBQ3RFLENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFBQyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUFDLENBQUM7UUFDckUsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDLEtBQWEsRUFBQyxFQUFFO1FBQzlDLE1BQU0sRUFBRSxHQUFHLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDO1FBQzFCLElBQUksRUFBRSxFQUFFLENBQUM7WUFDTCxJQUFJLE9BQU8sS0FBSyxJQUFJLFdBQVcsSUFBSSxLQUFLLElBQUksSUFBSSxFQUM1QyxDQUFDO2dCQUFDLElBQUssRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztvQkFBQyxFQUFFLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFBQyxDQUFDO1lBQUMsQ0FBQztpQkFDdEUsQ0FBQztnQkFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztvQkFBQyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFBQyxDQUFDO1lBQ3JFLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFO0lBQ0YsY0FBYyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2hELGNBQWMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUFDLE9BQU8sT0FBTyxDQUFDO0FBQ2xFLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkZFRvQ2FsbENoYWluLCBhZmZlY3RlZCwgaXRlcmF0ZWQgfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7IGlzTm90RXF1YWwsIGlzUHJpbWl0aXZlIH0gZnJvbSBcImZlc3QvY29yZVwiO1xuXG4vL1xuaW1wb3J0IHsgYmluZEhhbmRsZXIsIGJpbmRXaXRoIH0gZnJvbSBcIi4uL2NvcmUvQmluZGluZ1wiO1xuaW1wb3J0IHsgaGFuZGxlRGF0YXNldCwgaGFuZGxlUHJvcGVydHksIGhhbmRsZUF0dHJpYnV0ZSwgaGFuZGxlU3R5bGVDaGFuZ2UgfSBmcm9tIFwiZmVzdC9kb21cIjtcbmltcG9ydCBRIGZyb20gXCIuLi9ub2RlL1F1ZXJpZWRcIjtcbmltcG9ydCB7IHNldENoZWNrZWQgfSBmcm9tIFwiZmVzdC9kb21cIjtcblxuLy8gIVxuLy8gVE9ETyEgLSBhZGQgc3VwcG9ydCBmb3IgdW4tc3Vic2NyaWJlIGZvciBldmVyeW9uZS4uLlxuLy8gIVxuXG4vL1xuY29uc3QgJGVudHJpZXMgPSAob2JqOiBhbnkpID0+IHtcbiAgICBpZiAoaXNQcmltaXRpdmUob2JqKSkgeyByZXR1cm4gW107IH1cbiAgICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7IHJldHVybiBvYmoubWFwKChpdGVtLCBpZHgpID0+IFtpZHgsIGl0ZW1dKTsgfVxuICAgIGlmIChvYmogaW5zdGFuY2VvZiBNYXApIHsgcmV0dXJuIEFycmF5LmZyb20ob2JqLmVudHJpZXMoKSk7IH1cbiAgICBpZiAob2JqIGluc3RhbmNlb2YgU2V0KSB7IHJldHVybiBBcnJheS5mcm9tKG9iai52YWx1ZXMoKSk7IH1cbiAgICByZXR1cm4gQXJyYXkuZnJvbShPYmplY3QuZW50cmllcyhvYmopKTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCByZWZsZWN0QXR0cmlidXRlcyA9IChlbGVtZW50OiBIVE1MRWxlbWVudCwgYXR0cmlidXRlczogYW55KT0+e1xuICAgIGlmICghYXR0cmlidXRlcykgcmV0dXJuIGVsZW1lbnQ7XG4gICAgY29uc3Qgd2VhayA9IG5ldyBXZWFrUmVmKGF0dHJpYnV0ZXMpLCB3ZWwgPSBuZXcgV2Vha1JlZihlbGVtZW50KTtcbiAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZXMgPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgYXR0cmlidXRlcyA9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgJGVudHJpZXMoYXR0cmlidXRlcykuZm9yRWFjaCgoW3Byb3AsIHZhbHVlXSk9PntcbiAgICAgICAgICAgIGhhbmRsZUF0dHJpYnV0ZSh3ZWw/LmRlcmVmPy4oKSwgcHJvcCwgdmFsdWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgdXN1YiA9IGFmZmVjdGVkKGF0dHJpYnV0ZXMsICh2YWx1ZSwgcHJvcDogYW55KT0+e1xuICAgICAgICAgICAgaGFuZGxlQXR0cmlidXRlKHdlbD8uZGVyZWY/LigpLCBwcm9wLCB2YWx1ZSk7XG4gICAgICAgICAgICBiaW5kSGFuZGxlcih3ZWw/LmRlcmVmPy4oKSwgdmFsdWUsIHByb3AsIGhhbmRsZUF0dHJpYnV0ZSwgd2VhaywgdHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgICAgICBhZGRUb0NhbGxDaGFpbihhdHRyaWJ1dGVzLCBTeW1ib2wuZGlzcG9zZSwgdXN1Yik7XG4gICAgICAgIGFkZFRvQ2FsbENoYWluKGVsZW1lbnQsIFN5bWJvbC5kaXNwb3NlLCB1c3ViKTtcbiAgICB9IGVsc2VcbiAgICB7IGNvbnNvbGUud2FybihcIkludmFsaWQgYXR0cmlidXRlcyBvYmplY3Q6XCIsIGF0dHJpYnV0ZXMpOyB9XG59XG5cbi8vXG5leHBvcnQgY29uc3QgcmVmbGVjdEFSSUEgPSAoZWxlbWVudDogSFRNTEVsZW1lbnQsIGFyaWE6IGFueSk9PntcbiAgICBpZiAoIWFyaWEpIHJldHVybiBlbGVtZW50O1xuICAgIGNvbnN0IHdlYWsgPSBuZXcgV2Vha1JlZihhcmlhKSwgd2VsID0gbmV3IFdlYWtSZWYoZWxlbWVudCk7XG4gICAgaWYgKHR5cGVvZiBhcmlhID09IFwib2JqZWN0XCIgfHwgdHlwZW9mIGFyaWEgPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICRlbnRyaWVzKGFyaWEpLmZvckVhY2goKFtwcm9wLCB2YWx1ZV0pPT57XG4gICAgICAgICAgICBoYW5kbGVBdHRyaWJ1dGUod2VsPy5kZXJlZj8uKCksIFwiYXJpYS1cIisocHJvcD8udG9TdHJpbmc/LigpfHxwcm9wfHxcIlwiKSwgdmFsdWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgdXN1YiA9IGFmZmVjdGVkKGFyaWEsICh2YWx1ZSwgcHJvcCk9PnsgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgaGFuZGxlQXR0cmlidXRlKHdlbD8uZGVyZWY/LigpLCBcImFyaWEtXCIrKHByb3A/LnRvU3RyaW5nPy4oKXx8cHJvcHx8XCJcIiksIHZhbHVlLCB0cnVlKTtcbiAgICAgICAgICAgIGJpbmRIYW5kbGVyKHdlbCwgdmFsdWUsIHByb3AsIGhhbmRsZUF0dHJpYnV0ZSwgd2VhaywgdHJ1ZSk7XG4gICAgICAgIH0pO1xuICAgICAgICBhZGRUb0NhbGxDaGFpbihhcmlhLCBTeW1ib2wuZGlzcG9zZSwgdXN1Yik7XG4gICAgICAgIGFkZFRvQ2FsbENoYWluKGVsZW1lbnQsIFN5bWJvbC5kaXNwb3NlLCB1c3ViKTtcbiAgICB9IGVsc2VcbiAgICB7IGNvbnNvbGUud2FybihcIkludmFsaWQgQVJJQSBvYmplY3Q6XCIsIGFyaWEpO307IHJldHVybiBlbGVtZW50O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHJlZmxlY3REYXRhc2V0ID0gKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBkYXRhc2V0OiBhbnkpPT57XG4gICAgaWYgKCFkYXRhc2V0KSByZXR1cm4gZWxlbWVudDtcbiAgICBjb25zdCB3ZWFrID0gbmV3IFdlYWtSZWYoZGF0YXNldCksIHdlbCA9IG5ldyBXZWFrUmVmKGVsZW1lbnQpO1xuICAgIGlmICh0eXBlb2YgZGF0YXNldCA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBkYXRhc2V0ID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAkZW50cmllcyhkYXRhc2V0KS5mb3JFYWNoKChbcHJvcCwgdmFsdWVdKT0+e1xuICAgICAgICAgICAgaGFuZGxlRGF0YXNldCh3ZWw/LmRlcmVmPy4oKSwgcHJvcCwgdmFsdWUpO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgdXN1YiA9IGFmZmVjdGVkKGRhdGFzZXQsICh2YWx1ZSwgcHJvcDogYW55KT0+e1xuICAgICAgICAgICAgaGFuZGxlRGF0YXNldCh3ZWw/LmRlcmVmPy4oKSwgcHJvcCwgdmFsdWUpO1xuICAgICAgICAgICAgYmluZEhhbmRsZXIod2VsPy5kZXJlZj8uKCksIHZhbHVlLCBwcm9wLCBoYW5kbGVEYXRhc2V0LCB3ZWFrKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFkZFRvQ2FsbENoYWluKGRhdGFzZXQsIFN5bWJvbC5kaXNwb3NlLCB1c3ViKTtcbiAgICAgICAgYWRkVG9DYWxsQ2hhaW4oZWxlbWVudCwgU3ltYm9sLmRpc3Bvc2UsIHVzdWIpO1xuICAgIH0gZWxzZVxuICAgIHsgY29uc29sZS53YXJuKFwiSW52YWxpZCBkYXRhc2V0IG9iamVjdDpcIiwgZGF0YXNldCk7IH07IHJldHVybiBlbGVtZW50O1xufVxuXG4vLyBUT0RPISBzdXBwb3J0IG9ic2VydmUgc3R5bGVzXG5leHBvcnQgY29uc3QgcmVmbGVjdFN0eWxlcyA9IChlbGVtZW50OiBIVE1MRWxlbWVudCwgc3R5bGVzOiBzdHJpbmd8YW55KT0+e1xuICAgIGlmICghc3R5bGVzKSByZXR1cm4gZWxlbWVudDtcbiAgICBpZiAodHlwZW9mIHN0eWxlcyA9PSBcInN0cmluZ1wiKSB7IGVsZW1lbnQuc3R5bGUuY3NzVGV4dCA9IHN0eWxlczsgfSBlbHNlXG4gICAgaWYgKHR5cGVvZiBzdHlsZXM/LnZhbHVlID09IFwic3RyaW5nXCIpIHsgYWZmZWN0ZWQoW3N0eWxlcywgXCJ2YWx1ZVwiXSwgKHZhbCkgPT4geyBlbGVtZW50LnN0eWxlLmNzc1RleHQgPSB2YWw7IH0pOyB9IGVsc2VcbiAgICBpZiAodHlwZW9mIHN0eWxlcyA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBzdHlsZXMgPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNvbnN0IHdlYWsgPSBuZXcgV2Vha1JlZihzdHlsZXMpLCB3ZWwgPSBuZXcgV2Vha1JlZihlbGVtZW50KTtcbiAgICAgICAgJGVudHJpZXMoc3R5bGVzKS5mb3JFYWNoKChbcHJvcCwgdmFsdWVdKT0+e1xuICAgICAgICAgICAgaGFuZGxlU3R5bGVDaGFuZ2Uod2VsPy5kZXJlZj8uKCksIHByb3AsIHZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHVzdWIgPSBhZmZlY3RlZChzdHlsZXMsICh2YWx1ZSwgcHJvcDogYW55KT0+e1xuICAgICAgICAgICAgaGFuZGxlU3R5bGVDaGFuZ2Uod2VsPy5kZXJlZj8uKCksIHByb3AsIHZhbHVlKTtcbiAgICAgICAgICAgIGJpbmRIYW5kbGVyKHdlbD8uZGVyZWY/LigpLCB2YWx1ZSwgcHJvcCwgaGFuZGxlU3R5bGVDaGFuZ2UsIHdlYWs/LmRlcmVmPy4oKSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGFkZFRvQ2FsbENoYWluKHN0eWxlcywgU3ltYm9sLmRpc3Bvc2UsIHVzdWIpO1xuICAgICAgICBhZGRUb0NhbGxDaGFpbihlbGVtZW50LCBTeW1ib2wuZGlzcG9zZSwgdXN1Yik7XG4gICAgfSBlbHNlXG4gICAgeyBjb25zb2xlLndhcm4oXCJJbnZhbGlkIHN0eWxlcyBvYmplY3Q6XCIsIHN0eWxlcyk7IH0gcmV0dXJuIGVsZW1lbnQ7XG59XG5cbi8vIG9uZS1zaG90IHVwZGF0ZVxuZXhwb3J0IGNvbnN0IHJlZmxlY3RXaXRoU3R5bGVSdWxlcyA9IGFzeW5jIChlbGVtZW50OiBIVE1MRWxlbWVudCwgcnVsZTogYW55KT0+eyBjb25zdCBzdHlsZXMgPSBhd2FpdCBydWxlPy4oZWxlbWVudCk7IHJldHVybiByZWZsZWN0U3R5bGVzKGVsZW1lbnQsIHN0eWxlcyk7IH1cbmV4cG9ydCBjb25zdCByZWZsZWN0UHJvcGVydGllcyA9IChlbGVtZW50OiBIVE1MRWxlbWVudCwgcHJvcGVydGllczogYW55KT0+e1xuICAgIGlmICghcHJvcGVydGllcykgcmV0dXJuIGVsZW1lbnQ7IGNvbnN0IHdlYWsgPSBuZXcgV2Vha1JlZihwcm9wZXJ0aWVzKSwgd2VsID0gbmV3IFdlYWtSZWYoZWxlbWVudCk7XG5cbiAgICAvL1xuICAgIGNvbnN0IG9uQ2hhbmdlID0gKGV2OiBhbnkpPT57XG4gICAgICAgIGNvbnN0IGlucHV0ID0gUShcImlucHV0XCIsIGV2Py50YXJnZXQpO1xuICAgICAgICBpZiAoaW5wdXQ/LnZhbHVlICE9IG51bGwgJiYgaXNOb3RFcXVhbChpbnB1dD8udmFsdWUsIHByb3BlcnRpZXM/LnZhbHVlKSkgcHJvcGVydGllcy52YWx1ZSA9IGlucHV0Py52YWx1ZTtcbiAgICAgICAgaWYgKGlucHV0Py52YWx1ZUFzTnVtYmVyICE9IG51bGwgJiYgaXNOb3RFcXVhbChpbnB1dD8udmFsdWVBc051bWJlciwgcHJvcGVydGllcz8udmFsdWVBc051bWJlcikpIHByb3BlcnRpZXMudmFsdWVBc051bWJlciA9IGlucHV0Py52YWx1ZUFzTnVtYmVyO1xuICAgICAgICBpZiAoaW5wdXQ/LmNoZWNrZWQgIT0gbnVsbCAmJiBpc05vdEVxdWFsKGlucHV0Py5jaGVja2VkLCBwcm9wZXJ0aWVzPy5jaGVja2VkKSkgcHJvcGVydGllcy5jaGVja2VkID0gaW5wdXQ/LmNoZWNrZWQ7XG4gICAgfTtcblxuICAgIC8vXG4gICAgJGVudHJpZXMocHJvcGVydGllcykuZm9yRWFjaCgoW3Byb3AsIHZhbHVlXSk9PntcbiAgICAgICAgaGFuZGxlUHJvcGVydHkod2VsPy5kZXJlZj8uKCksIHByb3AsIHZhbHVlKTtcbiAgICB9KTtcblxuICAgIC8vXG4gICAgY29uc3QgdXN1YiA9IGFmZmVjdGVkKHByb3BlcnRpZXMsICh2YWx1ZSwgcHJvcDogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IGVsID0gd2VsLmRlcmVmKCk7XG4gICAgICAgIGlmIChlbCkge1xuICAgICAgICAgICAgaWYgKHByb3AgPT0gXCJjaGVja2VkXCIpIHtcbiAgICAgICAgICAgICAgICBzZXRDaGVja2VkKGVsIGFzIEhUTUxJbnB1dEVsZW1lbnQsIHZhbHVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYmluZFdpdGgoZWwsIHByb3AsIHZhbHVlLCBoYW5kbGVQcm9wZXJ0eSwgd2Vhaz8uZGVyZWY/LigpLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy9cbiAgICBhZGRUb0NhbGxDaGFpbihwcm9wZXJ0aWVzLCBTeW1ib2wuZGlzcG9zZSwgdXN1Yik7IGFkZFRvQ2FsbENoYWluKGVsZW1lbnQsIFN5bWJvbC5kaXNwb3NlLCB1c3ViKTsgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwiY2hhbmdlXCIsIG9uQ2hhbmdlKTsgcmV0dXJuIGVsZW1lbnQ7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgcmVmbGVjdENsYXNzTGlzdCA9IChlbGVtZW50OiBIVE1MRWxlbWVudCwgY2xhc3NMaXN0PzogU2V0PHN0cmluZz4pPT57XG4gICAgaWYgKCFjbGFzc0xpc3QpIHJldHVybiBlbGVtZW50OyBjb25zdCB3ZWwgPSBuZXcgV2Vha1JlZihlbGVtZW50KTtcblxuICAgIC8vXG4gICAgJGVudHJpZXMoY2xhc3NMaXN0KS5mb3JFYWNoKChbcHJvcCwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGNvbnN0IGVsID0gZWxlbWVudDtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PSBcInVuZGVmaW5lZFwiIHx8IHZhbHVlID09IG51bGwpXG4gICAgICAgICAgICB7IGlmICggZWwuY2xhc3NMaXN0LmNvbnRhaW5zKHZhbHVlKSkgeyBlbC5jbGFzc0xpc3QucmVtb3ZlKHZhbHVlKTsgfSB9IGVsc2VcbiAgICAgICAgICAgIHsgaWYgKCFlbC5jbGFzc0xpc3QuY29udGFpbnModmFsdWUpKSB7IGVsLmNsYXNzTGlzdC5hZGQodmFsdWUpOyB9XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IHVzdWIgPSBpdGVyYXRlZChjbGFzc0xpc3QsICh2YWx1ZTogc3RyaW5nKT0+e1xuICAgICAgICBjb25zdCBlbCA9IHdlbD8uZGVyZWY/LigpO1xuICAgICAgICBpZiAoZWwpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gXCJ1bmRlZmluZWRcIiB8fCB2YWx1ZSA9PSBudWxsKVxuICAgICAgICAgICAgICAgIHsgaWYgKCBlbC5jbGFzc0xpc3QuY29udGFpbnModmFsdWUpKSB7IGVsLmNsYXNzTGlzdC5yZW1vdmUodmFsdWUpOyB9IH0gZWxzZVxuICAgICAgICAgICAgICAgIHsgaWYgKCFlbC5jbGFzc0xpc3QuY29udGFpbnModmFsdWUpKSB7IGVsLmNsYXNzTGlzdC5hZGQodmFsdWUpOyB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vXG4gICAgYWRkVG9DYWxsQ2hhaW4oY2xhc3NMaXN0LCBTeW1ib2wuZGlzcG9zZSwgdXN1Yik7XG4gICAgYWRkVG9DYWxsQ2hhaW4oZWxlbWVudCwgU3ltYm9sLmRpc3Bvc2UsIHVzdWIpOyByZXR1cm4gZWxlbWVudDtcbn1cbiJdfQ==
import { unwrap, affected } from "fest/object";
import { $virtual, $mapped } from "../core/Binding";
import { isElement, isValidParent } from "fest/dom";
import { hasValue, isNotEqual, isPrimitive } from "fest/core";
import C from "../node/Changeable";
import Q from "../node/Queried";
//
export const KIDNAP_WITHOUT_HANG = (el, requestor) => {
    return ((requestor && requestor != el && !el?.contains?.(requestor) && isValidParent(requestor)) ? el?.elementForPotentialParent?.(requestor) : null) ?? el?.element;
};
//
export const isElementValue = (el, requestor) => { return KIDNAP_WITHOUT_HANG(el, requestor) ?? (hasValue(el) && isElement(el?.value) ? el?.value : el); };
//
export const elMap = new WeakMap();
export const tmMap = new WeakMap();
//
const getMapped = (obj) => {
    if (isPrimitive(obj))
        return obj;
    if (hasValue(obj) && isPrimitive(obj?.value))
        return tmMap?.get(obj);
    return elMap?.get?.(obj);
};
//
const $promiseResolvedMap = new WeakMap();
const $makePromisePlaceholder = (promised, getNodeCb) => {
    if ($promiseResolvedMap?.has?.(promised)) {
        return $promiseResolvedMap?.get?.(promised);
    }
    //
    const comment = document.createComment(":PROMISE:");
    promised?.then?.((elem) => {
        const element = typeof getNodeCb == "function" ? getNodeCb(elem) : elem;
        $promiseResolvedMap?.set?.(promised, element);
        // avoid vain (not) replacement
        queueMicrotask(() => {
            try {
                if (typeof comment?.replaceWith == "function") {
                    if (!comment?.isConnected)
                        return;
                    if (isElement(element)) {
                        comment?.replaceWith?.(element);
                    }
                }
                else if (comment?.isConnected && isElement(element)) {
                    comment?.parentNode?.replaceChild?.(comment, element);
                }
            }
            catch (error) {
                if (!comment?.isConnected)
                    return;
                comment?.remove?.();
            }
        });
    });
    return comment;
};
//
export const $getBase = (el, mapper, index = -1, requestor) => {
    if (mapper != null) {
        return (el = $getBase(mapper?.(el, index), null, -1, requestor));
    }
    if (el instanceof WeakRef || typeof el?.deref == "function") {
        el = el.deref();
    } // promise unsupported
    if (el instanceof Promise || typeof el?.then == "function") {
        return $makePromisePlaceholder(el, (nd) => $getBase(nd, mapper, index, requestor));
    }
    ;
    if (isElement(el) && !el?.element) {
        return el;
    }
    else if (isElement(el?.element)) {
        return el;
    }
    else if (hasValue(el)) {
        return ((el instanceof HTMLElement) ? Q : C)(el);
    }
    else if (typeof el == "object" && el != null) {
        return getMapped(el);
    }
    else if (typeof el == "function") {
        return $getBase(el?.(), mapper, index, requestor);
    } // mapped arrays always empties after
    if (isPrimitive(el) && el != null)
        return T(el);
    return document.createComment(":NULL:");
};
//
export const isValidElement = (el) => {
    return (isValidParent(el) || (el instanceof DocumentFragment) || (el instanceof Text)) ? el : null;
};
//
export const $getLeaf = (el, requestor) => {
    return isElementValue(el, requestor) ?? isElement(el);
};
//
export const $getNode = (el, mapper, index = -1, requestor) => {
    if (mapper != null) {
        return (el = getNode(mapper?.(el, index), null, -1, requestor));
    }
    if (el instanceof WeakRef || typeof el?.deref == "function") {
        el = el.deref();
    } // promise unsupported
    if (el instanceof Promise || typeof el?.then == "function") {
        return $makePromisePlaceholder(el, (nd) => getNode(nd, mapper, index, requestor));
    }
    ;
    if (isElement(el) && !el?.element) {
        return el;
    }
    else if (isElement(el?.element)) {
        return isElementValue(el, requestor);
    }
    else if (hasValue(el)) {
        return ((el instanceof HTMLElement) ? Q : C)(el)?.element;
    }
    else if (typeof el == "object" && el != null) {
        return getMapped(el);
    }
    else if (typeof el == "function") {
        return getNode(el?.(), mapper, index, requestor);
    }
    else if (isPrimitive(el) && el != null)
        return T(el);
    return document.createComment(":NULL:");
};
//
const isWeakCompatible = (el) => {
    return (typeof el == "object" || typeof el == "function" || typeof el == "symbol") && el != null;
};
//
const __nodeGuard = new WeakSet();
const __getNode = (el, mapper, index = -1, requestor) => {
    if (el instanceof WeakRef || typeof el?.deref == "function") {
        el = el.deref();
    }
    if (el instanceof Promise || typeof el?.then == "function") {
        return $makePromisePlaceholder(el, (nd) => __getNode(nd, mapper, index, requestor));
    }
    ;
    if (isWeakCompatible(el) && !isElement(el)) {
        if (elMap.has(el)) {
            const obj = getMapped(el) ?? $getBase(el, mapper, index, requestor);
            return $getLeaf(obj instanceof WeakRef ? obj?.deref?.() : obj, requestor);
        }
        ;
        const $node = $getBase(el, mapper, index, requestor);
        if (!mapper && $node != null && $node != el && isWeakCompatible(el) && !isElement(el)) {
            elMap.set(el, $node);
        }
        return $getLeaf($node, requestor);
    }
    return $getNode(el, mapper, index, requestor);
};
// (obj instanceof WeakRef ? obj?.deref?.() : obj)
export const getNode = (el, mapper, index = -1, requestor) => {
    if (isWeakCompatible(el) && __nodeGuard.has(el)) {
        return getMapped(el) ?? isElement(el);
    }
    if (isWeakCompatible(el))
        __nodeGuard.add(el);
    const result = __getNode(el, mapper, index, requestor);
    if (isWeakCompatible(el))
        __nodeGuard.delete(el);
    return result;
};
/*
export const getNode = (el, mapper?: Function | null, index: number = -1, requestor?: any | null) => {
    return __getNode(el, mapper, index, requestor);
}*/
//
const appendOrEmplaceByIndex = (parent, child, index = -1) => {
    if (isElement(child) && child != null && child?.parentNode != parent) {
        if (Number.isInteger(index) && index >= 0 && index < parent?.childNodes?.length) {
            parent?.insertBefore?.(child, parent?.childNodes?.[index]);
        }
        else {
            parent?.append?.(child);
        }
    }
};
//
export const appendFix = (parent, child, index = -1) => {
    if (!isElement(child) || parent == child || child?.parentNode == parent)
        return;
    child = child?._onUpdate ? KIDNAP_WITHOUT_HANG(child, parent) : child;
    if (!child?.parentNode && isElement(child)) {
        appendOrEmplaceByIndex(parent, child, index);
        return;
    }
    ;
    if (parent?.parentNode == child?.parentNode) {
        return;
    }
    if (isElement(child)) {
        appendOrEmplaceByIndex(parent, child, index);
    }
    ;
};
//
const asArray = (children) => {
    if (children instanceof Map || children instanceof Set) {
        children = Array.from(children?.values?.());
    }
    return children;
};
//
export const appendArray = (parent, children, mapper, index = -1) => {
    const len = children?.length ?? 0;
    if (Array.isArray(unwrap(children)) || children instanceof Map || children instanceof Set) {
        const list = asArray(children)?.map?.((cl, I) => getNode(cl, mapper, I, parent))?.filter?.((el) => el != null);
        const frag = document.createDocumentFragment();
        list?.forEach?.((cl) => appendFix(frag, cl));
        appendFix(parent, frag, index);
    }
    else {
        const node = getNode(children, mapper, len, parent);
        if (node != null) {
            appendFix(parent, node, index);
        }
    }
};
//
export const appendChild = (element, cp, mapper, index = -1) => {
    if (mapper != null) {
        cp = mapper?.(cp, index);
    }
    // has children lists
    if (cp?.children && Array.isArray(unwrap(cp?.children)) && (cp?.[$virtual] || cp?.[$mapped])) {
        appendArray(element, cp?.children, null, index);
    }
    else {
        appendArray(element, cp, null, index);
    }
};
//
export const dePhantomNode = (parent, node, index = -1) => {
    if (!parent)
        return node;
    if (node?.parentNode == parent && node?.parentNode != null) {
        return node;
    }
    else if (node?.parentNode != parent && !isValidParent(node?.parentNode)) {
        if (Number.isInteger(index) && index >= 0 && Array.from(parent?.childNodes || [])?.length > index) {
            return parent.childNodes?.[index];
        }
    }
    return node;
};
//
export const replaceOrSwap = (parent, oldEl, newEl) => {
    if (oldEl?.parentNode) {
        if (oldEl?.parentNode == newEl?.parentNode) {
            parent = oldEl?.parentNode ?? parent;
            if (oldEl.nextSibling === newEl) {
                parent.insertBefore(newEl, oldEl);
            }
            else if (newEl.nextSibling === oldEl) {
                parent.insertBefore(oldEl, newEl);
            }
            else {
                const nextSiblingOfElement1 = oldEl.nextSibling;
                parent.replaceChild(newEl, oldEl);
                parent.insertBefore(oldEl, nextSiblingOfElement1);
            }
        }
        else {
            oldEl?.replaceWith?.(newEl);
        }
    }
};
// TODO: what exactly to replace, if has (i.e. object itself, not index)
export const replaceChildren = (element, cp, mapper, index = -1, old) => {
    if (mapper != null) {
        cp = mapper?.(cp, index);
    }
    ;
    if (!element)
        element = old?.parentNode;
    const cn = dePhantomNode(element, getNode(old, mapper, index), index);
    if (cn instanceof Text && typeof cp == "string") {
        cn.textContent = cp;
    }
    else if (cp != null) {
        const node = getNode(cp); // oldNode is always unknown and phantom
        if (cn?.parentNode == element && cn != node && (cn instanceof Text && node instanceof Text)) {
            if (cn?.textContent != node?.textContent) {
                cn.textContent = node?.textContent?.trim?.() ?? "";
            }
        }
        else if (cn?.parentNode == element && cn != node && cn != null && cn?.parentNode != null) {
            replaceOrSwap(element, cn, node);
        }
        else if (cn?.parentNode != element || cn?.parentNode == null) {
            appendChild(element, node, null, index);
        }
    }
};
//
export const removeChildDirectly = (element, node, _, index = -1) => {
    if (Array.from(element?.childNodes ?? [])?.length < 1)
        return;
    const whatToRemove = dePhantomNode(element, node, index);
    if (whatToRemove?.parentNode == element)
        whatToRemove?.remove?.();
    return element;
};
//
export const removeChild = (element, cp, mapper, index = -1) => {
    const $node = getNode(cp, mapper);
    if (!element)
        element = $node?.parentNode;
    if (Array.from(element?.childNodes ?? [])?.length < 1)
        return;
    const whatToRemove = dePhantomNode(element, $node, index);
    if (whatToRemove?.parentNode == element)
        whatToRemove?.remove?.();
    return element;
};
//
export const removeNotExists = (element, children, mapper) => {
    const list = Array.from(unwrap(children) || [])?.map?.((cp, index) => getNode(cp, mapper, index));
    Array.from(element.childNodes).forEach((nd) => { if (!list?.find?.((cp) => (!isNotEqual?.(cp, nd))))
        nd?.remove?.(); });
    return element;
};
//
export const T = (ref) => {
    if (isPrimitive(ref) && ref != null) {
        return document.createTextNode(ref);
    }
    if (ref == null)
        return document.createComment(":NULL:");
    // @ts-ignore
    return tmMap.getOrInsertComputed(ref, () => {
        const element = document.createTextNode(((hasValue(ref) ? ref?.value : ref) ?? "")?.trim?.() ?? "");
        //affected([ref, "value"], (val) => (element.textContent = (val?.innerText ?? val?.textContent ?? val ?? "")?.trim?.() ?? ""));
        affected([ref, "value"], (val) => {
            const untrimmed = "" + (val?.innerText ?? val?.textContent ?? val?.value ?? val ?? "");
            (element.textContent = untrimmed?.trim?.() ?? "");
        });
        return element;
    });
};
//
export default getNode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxTQUFTLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3BELE9BQU8sRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM5RCxPQUFPLENBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNuQyxPQUFPLENBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUVoQyxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxFQUFPLEVBQUUsU0FBcUIsRUFBRSxFQUFFO0lBQ2xFLE9BQU8sQ0FBQyxDQUFDLFNBQVMsSUFBSSxTQUFTLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUseUJBQXlCLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLE9BQU8sQ0FBQztBQUN6SyxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQUMsRUFBTyxFQUFFLFNBQXNCLEVBQUUsRUFBRSxHQUFHLE9BQU8sbUJBQW1CLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMs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LG1CQUFtQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUU7UUFDdkMsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3BHLCtIQUErSDtRQUMvSCxRQUFRLENBQUMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUM3QixNQUFNLFNBQVMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxHQUFHLEVBQUUsU0FBUyxJQUFJLEdBQUcsRUFBRSxXQUFXLElBQUksR0FBRyxFQUFFLEtBQUssSUFBSSxHQUFHLElBQUksRUFBRSxDQUFDLENBQUM7WUFDdkYsQ0FBQyxPQUFPLENBQUMsV0FBVyxHQUFHLFNBQVMsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsZUFBZSxPQUFPLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB1bndyYXAsIGFmZmVjdGVkIH0gZnJvbSBcImZlc3Qvb2JqZWN0XCI7XG5pbXBvcnQgeyAkdmlydHVhbCwgJG1hcHBlZCB9IGZyb20gXCIuLi9jb3JlL0JpbmRpbmdcIjtcbmltcG9ydCB7IGlzRWxlbWVudCwgaXNWYWxpZFBhcmVudCB9IGZyb20gXCJmZXN0L2RvbVwiO1xuaW1wb3J0IHsgaGFzVmFsdWUsIGlzTm90RXF1YWwsIGlzUHJpbWl0aXZlIH0gZnJvbSBcImZlc3QvY29yZVwiO1xuaW1wb3J0IEMgZnJvbSBcIi4uL25vZGUvQ2hhbmdlYWJsZVwiO1xuaW1wb3J0IFEgZnJvbSBcIi4uL25vZGUvUXVlcmllZFwiO1xuXG4vL1xuZXhwb3J0IGNvbnN0IEtJRE5BUF9XSVRIT1VUX0hBTkcgPSAoZWw6IGFueSwgcmVxdWVzdG9yOiBhbnkgfCBudWxsKSA9PiB7XG4gICAgcmV0dXJuICgocmVxdWVzdG9yICYmIHJlcXVlc3RvciAhPSBlbCAmJiAhZWw/LmNvbnRhaW5zPy4ocmVxdWVzdG9yKSAmJiBpc1ZhbGlkUGFyZW50KHJlcXVlc3RvcikpID8gZWw/LmVsZW1lbnRGb3JQb3RlbnRpYWxQYXJlbnQ/LihyZXF1ZXN0b3IpIDogbnVsbCkgPz8gZWw/LmVsZW1lbnQ7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgaXNFbGVtZW50VmFsdWUgPSAoZWw6IGFueSwgcmVxdWVzdG9yPzogYW55IHwgbnVsbCkgPT4geyByZXR1cm4gS0lETkFQX1dJVEhPVVRfSEFORyhlbCwgcmVxdWVzdG9yKSA/PyAoaGFzVmFsdWUoZWwpICYmIGlzRWxlbWVudChlbD8udmFsdWUpID8gZWw/LnZhbHVlIDogZWwpOyB9XG5cbi8vXG5leHBvcnQgY29uc3QgZWxNYXAgPSBuZXcgV2Vha01hcCgpO1xuZXhwb3J0IGNvbnN0IHRtTWFwID0gbmV3IFdlYWtNYXAoKTtcblxuLy9cbmNvbnN0IGdldE1hcHBlZCA9IChvYmo6IGFueSk9PntcbiAgICBpZiAoaXNQcmltaXRpdmUob2JqKSkgcmV0dXJuIG9iajtcbiAgICBpZiAoaGFzVmFsdWUob2JqKSAmJiBpc1ByaW1pdGl2ZShvYmo/LnZhbHVlKSkgcmV0dXJuIHRtTWFwPy5nZXQob2JqKTtcbiAgICByZXR1cm4gZWxNYXA/LmdldD8uKG9iaik7XG59XG5cbi8vXG5jb25zdCAkcHJvbWlzZVJlc29sdmVkTWFwID0gbmV3IFdlYWtNYXAoKTtcbmNvbnN0ICRtYWtlUHJvbWlzZVBsYWNlaG9sZGVyID0gKHByb21pc2VkLCBnZXROb2RlQ2IpPT57XG4gICAgaWYgKCRwcm9taXNlUmVzb2x2ZWRNYXA/Lmhhcz8uKHByb21pc2VkKSkge1xuICAgICAgICByZXR1cm4gJHByb21pc2VSZXNvbHZlZE1hcD8uZ2V0Py4ocHJvbWlzZWQpO1xuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3QgY29tbWVudCA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoXCI6UFJPTUlTRTpcIik7XG4gICAgcHJvbWlzZWQ/LnRoZW4/LigoZWxlbSk9PntcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHR5cGVvZiBnZXROb2RlQ2IgPT0gXCJmdW5jdGlvblwiID8gZ2V0Tm9kZUNiKGVsZW0pIDogZWxlbTtcbiAgICAgICAgJHByb21pc2VSZXNvbHZlZE1hcD8uc2V0Py4ocHJvbWlzZWQsIGVsZW1lbnQpO1xuXG4gICAgICAgIC8vIGF2b2lkIHZhaW4gKG5vdCkgcmVwbGFjZW1lbnRcbiAgICAgICAgcXVldWVNaWNyb3Rhc2soKCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbW1lbnQ/LnJlcGxhY2VXaXRoID09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbW1lbnQ/LmlzQ29ubmVjdGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0VsZW1lbnQoZWxlbWVudCkpIHsgY29tbWVudD8ucmVwbGFjZVdpdGg/LihlbGVtZW50KTsgfVxuICAgICAgICAgICAgICAgIH0gZWxzZVxuICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWVudD8uaXNDb25uZWN0ZWQgJiYgaXNFbGVtZW50KGVsZW1lbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb21tZW50Py5wYXJlbnROb2RlPy5yZXBsYWNlQ2hpbGQ/Lihjb21tZW50LCBlbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWNvbW1lbnQ/LmlzQ29ubmVjdGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgY29tbWVudD8ucmVtb3ZlPy4oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9KTtcbiAgICByZXR1cm4gY29tbWVudDtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCAkZ2V0QmFzZSA9IChlbCwgbWFwcGVyPzogRnVuY3Rpb24gfCBudWxsLCBpbmRleDogbnVtYmVyID0gLTEsIHJlcXVlc3Rvcj86IGFueSB8IG51bGwpPT57XG4gICAgaWYgKG1hcHBlciAhPSBudWxsKSB7IHJldHVybiAoZWwgPSAkZ2V0QmFzZShtYXBwZXI/LihlbCwgaW5kZXgpLCBudWxsLCAtMSwgcmVxdWVzdG9yKSk7IH1cbiAgICBpZiAoZWwgaW5zdGFuY2VvZiBXZWFrUmVmIHx8IHR5cGVvZiAoZWwgYXMgYW55KT8uZGVyZWYgPT0gXCJmdW5jdGlvblwiKSB7IGVsID0gZWwuZGVyZWYoKTsgfSAvLyBwcm9taXNlIHVuc3VwcG9ydGVkXG4gICAgaWYgKGVsIGluc3RhbmNlb2YgUHJvbWlzZSB8fCB0eXBlb2YgKGVsIGFzIGFueSk/LnRoZW4gPT0gXCJmdW5jdGlvblwiKSB7IHJldHVybiAkbWFrZVByb21pc2VQbGFjZWhvbGRlcihlbCwgKG5kKT0+JGdldEJhc2UobmQsIG1hcHBlciwgaW5kZXgsIHJlcXVlc3RvcikpOyB9O1xuICAgIGlmIChpc0VsZW1lbnQoZWwpICYmICFlbD8uZWxlbWVudCkgeyByZXR1cm4gZWw7IH0gZWxzZVxuICAgIGlmIChpc0VsZW1lbnQoZWw/LmVsZW1lbnQpKSB7IHJldHVybiBlbDsgfSBlbHNlXG4gICAgaWYgKGhhc1ZhbHVlKGVsKSkgeyByZXR1cm4gKChlbCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSA/IFEgOiBDKShlbCk7IH0gZWxzZVxuICAgIGlmICh0eXBlb2YgZWwgPT0gXCJvYmplY3RcIiAmJiBlbCAhPSBudWxsKSB7IHJldHVybiBnZXRNYXBwZWQoZWwpOyB9IGVsc2VcbiAgICBpZiAodHlwZW9mIGVsID09IFwiZnVuY3Rpb25cIikgeyByZXR1cm4gJGdldEJhc2UoZWw/LigpLCBtYXBwZXIsIGluZGV4LCByZXF1ZXN0b3IpOyB9ICAvLyBtYXBwZWQgYXJyYXlzIGFsd2F5cyBlbXB0aWVzIGFmdGVyXG4gICAgaWYgKGlzUHJpbWl0aXZlKGVsKSAmJiBlbCAhPSBudWxsKSByZXR1cm4gVChlbCk7XG4gICAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoXCI6TlVMTDpcIik7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgaXNWYWxpZEVsZW1lbnQgPSAoZWwpPT57XG4gICAgcmV0dXJuIChpc1ZhbGlkUGFyZW50KGVsKSB8fCAoZWwgaW5zdGFuY2VvZiBEb2N1bWVudEZyYWdtZW50KSB8fCAoZWwgaW5zdGFuY2VvZiBUZXh0KSkgPyBlbCA6IG51bGw7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgJGdldExlYWYgPSAoZWwsIHJlcXVlc3Rvcj86IGFueSB8IG51bGwpPT57XG4gICAgcmV0dXJuIGlzRWxlbWVudFZhbHVlKGVsLCByZXF1ZXN0b3IpID8/IGlzRWxlbWVudChlbCk7XG59XG5cbi8vXG5leHBvcnQgY29uc3QgJGdldE5vZGUgPSAoZWwsIG1hcHBlcj86IEZ1bmN0aW9uIHwgbnVsbCwgaW5kZXg6IG51bWJlciA9IC0xLCByZXF1ZXN0b3I/OiBhbnkgfCBudWxsKSA9PiB7XG4gICAgaWYgKG1hcHBlciAhPSBudWxsKSB7IHJldHVybiAoZWwgPSBnZXROb2RlKG1hcHBlcj8uKGVsLCBpbmRleCksIG51bGwsIC0xLCByZXF1ZXN0b3IpKTsgfVxuICAgIGlmIChlbCBpbnN0YW5jZW9mIFdlYWtSZWYgfHwgdHlwZW9mIChlbCBhcyBhbnkpPy5kZXJlZiA9PSBcImZ1bmN0aW9uXCIpIHsgZWwgPSBlbC5kZXJlZigpOyB9IC8vIHByb21pc2UgdW5zdXBwb3J0ZWRcbiAgICBpZiAoZWwgaW5zdGFuY2VvZiBQcm9taXNlIHx8IHR5cGVvZiAoZWwgYXMgYW55KT8udGhlbiA9PSBcImZ1bmN0aW9uXCIpIHsgcmV0dXJuICRtYWtlUHJvbWlzZVBsYWNlaG9sZGVyKGVsLCAobmQpPT5nZXROb2RlKG5kLCBtYXBwZXIsIGluZGV4LCByZXF1ZXN0b3IpKTsgfTtcbiAgICBpZiAoaXNFbGVtZW50KGVsKSAmJiAhZWw/LmVsZW1lbnQpIHsgcmV0dXJuIGVsOyB9IGVsc2VcbiAgICBpZiAoaXNFbGVtZW50KGVsPy5lbGVtZW50KSkgeyByZXR1cm4gaXNFbGVtZW50VmFsdWUoZWwsIHJlcXVlc3Rvcik7IH0gZWxzZVxuICAgIGlmIChoYXNWYWx1ZShlbCkpIHsgcmV0dXJuICgoZWwgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgPyBRIDogQykoZWwpPy5lbGVtZW50OyB9IGVsc2VcbiAgICBpZiAodHlwZW9mIGVsID09IFwib2JqZWN0XCIgJiYgZWwgIT0gbnVsbCkgeyByZXR1cm4gZ2V0TWFwcGVkKGVsKTsgfSBlbHNlXG4gICAgaWYgKHR5cGVvZiBlbCA9PSBcImZ1bmN0aW9uXCIpIHsgcmV0dXJuIGdldE5vZGUoZWw/LigpLCBtYXBwZXIsIGluZGV4LCByZXF1ZXN0b3IpOyB9IGVsc2VcbiAgICBpZiAoaXNQcmltaXRpdmUoZWwpICYmIGVsICE9IG51bGwpIHJldHVybiBUKGVsKTtcbiAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlQ29tbWVudChcIjpOVUxMOlwiKTtcbn07XG5cbi8vXG5jb25zdCBpc1dlYWtDb21wYXRpYmxlID0gKGVsOiBhbnkpPT57XG4gICAgcmV0dXJuICh0eXBlb2YgZWwgPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgZWwgPT0gXCJmdW5jdGlvblwiIHx8IHR5cGVvZiBlbCA9PSBcInN5bWJvbFwiKSAmJiBlbCAhPSBudWxsO1xufVxuXG4vL1xuY29uc3QgX19ub2RlR3VhcmQgPSBuZXcgV2Vha1NldDxhbnk+KCk7XG5jb25zdCBfX2dldE5vZGUgPSAoZWwsIG1hcHBlcj86IEZ1bmN0aW9uIHwgbnVsbCwgaW5kZXg6IG51bWJlciA9IC0xLCByZXF1ZXN0b3I/OiBhbnkgfCBudWxsKT0+e1xuICAgIGlmIChlbCBpbnN0YW5jZW9mIFdlYWtSZWYgfHwgdHlwZW9mIChlbCBhcyBhbnkpPy5kZXJlZiA9PSBcImZ1bmN0aW9uXCIpIHsgZWwgPSBlbC5kZXJlZigpOyB9XG4gICAgaWYgKGVsIGluc3RhbmNlb2YgUHJvbWlzZSB8fCB0eXBlb2YgKGVsIGFzIGFueSk/LnRoZW4gPT0gXCJmdW5jdGlvblwiKSB7IHJldHVybiAkbWFrZVByb21pc2VQbGFjZWhvbGRlcihlbCwgKG5kKT0+X19nZXROb2RlKG5kLCBtYXBwZXIsIGluZGV4LCByZXF1ZXN0b3IpKTsgfTtcbiAgICBpZiAoaXNXZWFrQ29tcGF0aWJsZShlbCkgJiYgIWlzRWxlbWVudChlbCkpIHtcbiAgICAgICAgaWYgKGVsTWFwLmhhcyhlbCkpIHtcbiAgICAgICAgICAgIGNvbnN0IG9iajogYW55ID0gZ2V0TWFwcGVkKGVsKSA/PyAkZ2V0QmFzZShlbCwgbWFwcGVyLCBpbmRleCwgcmVxdWVzdG9yKTtcbiAgICAgICAgICAgIHJldHVybiAkZ2V0TGVhZihvYmogaW5zdGFuY2VvZiBXZWFrUmVmID8gb2JqPy5kZXJlZj8uKCkgOiBvYmosIHJlcXVlc3Rvcik7XG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0ICRub2RlID0gJGdldEJhc2UoZWwsIG1hcHBlciwgaW5kZXgsIHJlcXVlc3Rvcik7XG4gICAgICAgIGlmICghbWFwcGVyICYmICRub2RlICE9IG51bGwgJiYgJG5vZGUgIT0gZWwgJiYgaXNXZWFrQ29tcGF0aWJsZShlbCkgJiYgIWlzRWxlbWVudChlbCkpIHsgZWxNYXAuc2V0KGVsLCAkbm9kZSk7IH1cbiAgICAgICAgcmV0dXJuICRnZXRMZWFmKCRub2RlLCByZXF1ZXN0b3IpO1xuICAgIH1cbiAgICByZXR1cm4gJGdldE5vZGUoZWwsIG1hcHBlciwgaW5kZXgsIHJlcXVlc3Rvcik7XG59XG5cbi8vIChvYmogaW5zdGFuY2VvZiBXZWFrUmVmID8gb2JqPy5kZXJlZj8uKCkgOiBvYmopXG5leHBvcnQgY29uc3QgZ2V0Tm9kZSA9IChlbCwgbWFwcGVyPzogRnVuY3Rpb24gfCBudWxsLCBpbmRleDogbnVtYmVyID0gLTEsIHJlcXVlc3Rvcj86IGFueSB8IG51bGwpID0+IHtcbiAgICBpZiAoaXNXZWFrQ29tcGF0aWJsZShlbCkgJiYgX19ub2RlR3VhcmQuaGFzKGVsKSkgeyByZXR1cm4gZ2V0TWFwcGVkKGVsKSA/PyBpc0VsZW1lbnQoZWwpOyB9XG4gICAgaWYgKGlzV2Vha0NvbXBhdGlibGUoZWwpKSBfX25vZGVHdWFyZC5hZGQoZWwpOyBjb25zdCByZXN1bHQgPSBfX2dldE5vZGUoZWwsIG1hcHBlciwgaW5kZXgsIHJlcXVlc3Rvcik7XG4gICAgaWYgKGlzV2Vha0NvbXBhdGlibGUoZWwpKSBfX25vZGVHdWFyZC5kZWxldGUoZWwpOyByZXR1cm4gcmVzdWx0O1xufVxuXG4vKlxuZXhwb3J0IGNvbnN0IGdldE5vZGUgPSAoZWwsIG1hcHBlcj86IEZ1bmN0aW9uIHwgbnVsbCwgaW5kZXg6IG51bWJlciA9IC0xLCByZXF1ZXN0b3I/OiBhbnkgfCBudWxsKSA9PiB7XG4gICAgcmV0dXJuIF9fZ2V0Tm9kZShlbCwgbWFwcGVyLCBpbmRleCwgcmVxdWVzdG9yKTtcbn0qL1xuXG4vL1xuY29uc3QgYXBwZW5kT3JFbXBsYWNlQnlJbmRleCA9IChwYXJlbnQ6IGFueSwgY2hpbGQ6IGFueSwgaW5kZXg6IG51bWJlciA9IC0xKSA9PiB7XG4gICAgaWYgKGlzRWxlbWVudChjaGlsZCkgJiYgY2hpbGQgIT0gbnVsbCAmJiBjaGlsZD8ucGFyZW50Tm9kZSAhPSBwYXJlbnQpIHtcbiAgICAgICAgaWYgKE51bWJlci5pc0ludGVnZXIoaW5kZXgpICYmIGluZGV4ID49IDAgJiYgaW5kZXggPCBwYXJlbnQ/LmNoaWxkTm9kZXM/Lmxlbmd0aCkge1xuICAgICAgICAgICAgcGFyZW50Py5pbnNlcnRCZWZvcmU/LihjaGlsZCwgcGFyZW50Py5jaGlsZE5vZGVzPy5baW5kZXhdKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBhcmVudD8uYXBwZW5kPy4oY2hpbGQpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGFwcGVuZEZpeCA9IChwYXJlbnQ6IGFueSwgY2hpbGQ6IGFueSwgaW5kZXg6IG51bWJlciA9IC0xKSA9PiB7XG4gICAgaWYgKCFpc0VsZW1lbnQoY2hpbGQpIHx8IHBhcmVudCA9PSBjaGlsZCB8fCBjaGlsZD8ucGFyZW50Tm9kZSA9PSBwYXJlbnQpIHJldHVybjtcbiAgICBjaGlsZCA9IChjaGlsZCBhcyBhbnkpPy5fb25VcGRhdGUgPyBLSUROQVBfV0lUSE9VVF9IQU5HKGNoaWxkLCBwYXJlbnQpIDogY2hpbGQ7XG4gICAgaWYgKCFjaGlsZD8ucGFyZW50Tm9kZSAmJiBpc0VsZW1lbnQoY2hpbGQpKSB7IGFwcGVuZE9yRW1wbGFjZUJ5SW5kZXgocGFyZW50LCBjaGlsZCwgaW5kZXgpOyByZXR1cm47IH07XG4gICAgaWYgKHBhcmVudD8ucGFyZW50Tm9kZSA9PSBjaGlsZD8ucGFyZW50Tm9kZSkgeyByZXR1cm47IH1cbiAgICBpZiAoaXNFbGVtZW50KGNoaWxkKSkgeyBhcHBlbmRPckVtcGxhY2VCeUluZGV4KHBhcmVudCwgY2hpbGQsIGluZGV4KTsgfTtcbn1cblxuLy9cbmNvbnN0IGFzQXJyYXkgPSAoY2hpbGRyZW4pPT57XG4gICAgaWYgKGNoaWxkcmVuIGluc3RhbmNlb2YgTWFwIHx8IGNoaWxkcmVuIGluc3RhbmNlb2YgU2V0KSB7XG4gICAgICAgIGNoaWxkcmVuID0gQXJyYXkuZnJvbShjaGlsZHJlbj8udmFsdWVzPy4oKSk7XG4gICAgfVxuICAgIHJldHVybiBjaGlsZHJlbjtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBhcHBlbmRBcnJheSA9IChwYXJlbnQ6IGFueSwgY2hpbGRyZW46IGFueVtdLCBtYXBwZXI/OiBGdW5jdGlvbiB8IG51bGwsIGluZGV4OiBudW1iZXIgPSAtMSkgPT4ge1xuICAgIGNvbnN0IGxlbiA9IGNoaWxkcmVuPy5sZW5ndGggPz8gMDtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh1bndyYXAoY2hpbGRyZW4pKSB8fCBjaGlsZHJlbiBpbnN0YW5jZW9mIE1hcCB8fCBjaGlsZHJlbiBpbnN0YW5jZW9mIFNldCkge1xuICAgICAgICBjb25zdCBsaXN0ID0gYXNBcnJheShjaGlsZHJlbik/Lm1hcD8uKChjbCwgSTogbnVtYmVyKSA9PiBnZXROb2RlKGNsLCBtYXBwZXIsIEksIHBhcmVudCkpPy5maWx0ZXI/LigoZWwpID0+IGVsICE9IG51bGwpXG4gICAgICAgIGNvbnN0IGZyYWcgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gICAgICAgIGxpc3Q/LmZvckVhY2g/LigoY2wpPT5hcHBlbmRGaXgoZnJhZywgY2wpKTtcbiAgICAgICAgYXBwZW5kRml4KHBhcmVudCwgZnJhZywgaW5kZXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG5vZGUgPSBnZXROb2RlKGNoaWxkcmVuLCBtYXBwZXIsIGxlbiwgcGFyZW50KTtcbiAgICAgICAgaWYgKG5vZGUgIT0gbnVsbCkgeyBhcHBlbmRGaXgocGFyZW50LCBub2RlLCBpbmRleCk7IH1cbiAgICB9XG59XG5cbi8vXG5leHBvcnQgY29uc3QgYXBwZW5kQ2hpbGQgPSAoZWxlbWVudCwgY3AsIG1hcHBlcj86IEZ1bmN0aW9uIHwgbnVsbCwgaW5kZXg6IG51bWJlciA9IC0xKSA9PiB7XG4gICAgaWYgKG1hcHBlciAhPSBudWxsKSB7IGNwID0gbWFwcGVyPy4oY3AsIGluZGV4KTsgfVxuXG4gICAgLy8gaGFzIGNoaWxkcmVuIGxpc3RzXG4gICAgaWYgKGNwPy5jaGlsZHJlbiAmJiBBcnJheS5pc0FycmF5KHVud3JhcChjcD8uY2hpbGRyZW4pKSAmJiAoY3A/LlskdmlydHVhbF0gfHwgY3A/LlskbWFwcGVkXSkpIHtcbiAgICAgICAgYXBwZW5kQXJyYXkoZWxlbWVudCwgY3A/LmNoaWxkcmVuLCBudWxsLCBpbmRleCk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgYXBwZW5kQXJyYXkoZWxlbWVudCwgY3AsIG51bGwsIGluZGV4KTtcbiAgICB9XG59XG5cblxuXG4vL1xuZXhwb3J0IGNvbnN0IGRlUGhhbnRvbU5vZGUgPSAocGFyZW50LCBub2RlLCBpbmRleDogbnVtYmVyID0gLTEpPT57XG4gICAgaWYgKCFwYXJlbnQpIHJldHVybiBub2RlO1xuICAgIGlmIChub2RlPy5wYXJlbnROb2RlID09IHBhcmVudCAmJiBub2RlPy5wYXJlbnROb2RlICE9IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIG5vZGU7XG4gICAgfSBlbHNlXG4gICAgaWYgKG5vZGU/LnBhcmVudE5vZGUgIT0gcGFyZW50ICYmICFpc1ZhbGlkUGFyZW50KG5vZGU/LnBhcmVudE5vZGUpKSB7XG4gICAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKGluZGV4KSAmJiBpbmRleCA+PSAwICYmIEFycmF5LmZyb20ocGFyZW50Py5jaGlsZE5vZGVzIHx8IFtdKT8ubGVuZ3RoID4gaW5kZXgpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJlbnQuY2hpbGROb2Rlcz8uW2luZGV4XTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbm9kZTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCByZXBsYWNlT3JTd2FwID0gKHBhcmVudCwgb2xkRWwsIG5ld0VsKSA9PiB7XG4gICAgaWYgKG9sZEVsPy5wYXJlbnROb2RlKSB7XG4gICAgICAgIGlmIChvbGRFbD8ucGFyZW50Tm9kZSA9PSBuZXdFbD8ucGFyZW50Tm9kZSkge1xuICAgICAgICAgICAgcGFyZW50ID0gb2xkRWw/LnBhcmVudE5vZGUgPz8gcGFyZW50O1xuICAgICAgICAgICAgaWYgKG9sZEVsLm5leHRTaWJsaW5nID09PSBuZXdFbCkgeyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5ld0VsLCBvbGRFbCk7IH0gZWxzZVxuICAgICAgICAgICAgaWYgKG5ld0VsLm5leHRTaWJsaW5nID09PSBvbGRFbCkgeyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG9sZEVsLCBuZXdFbCk7IH0gZWxzZVxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5leHRTaWJsaW5nT2ZFbGVtZW50MSA9IG9sZEVsLm5leHRTaWJsaW5nO1xuICAgICAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQobmV3RWwsIG9sZEVsKTtcbiAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKG9sZEVsLCBuZXh0U2libGluZ09mRWxlbWVudDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgb2xkRWw/LnJlcGxhY2VXaXRoPy4obmV3RWwpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5cblxuLy8gVE9ETzogd2hhdCBleGFjdGx5IHRvIHJlcGxhY2UsIGlmIGhhcyAoaS5lLiBvYmplY3QgaXRzZWxmLCBub3QgaW5kZXgpXG5leHBvcnQgY29uc3QgcmVwbGFjZUNoaWxkcmVuID0gKGVsZW1lbnQsIGNwLCBtYXBwZXI/OiBGdW5jdGlvbiB8IG51bGwsIGluZGV4OiBudW1iZXIgPSAtMSwgb2xkPzogYW55fG51bGwpID0+IHtcbiAgICBpZiAobWFwcGVyICE9IG51bGwpIHsgY3AgPSBtYXBwZXI/LihjcCwgaW5kZXgpOyB9OyBpZiAoIWVsZW1lbnQpIGVsZW1lbnQgPSBvbGQ/LnBhcmVudE5vZGU7XG4gICAgY29uc3QgY24gPSBkZVBoYW50b21Ob2RlKGVsZW1lbnQsIGdldE5vZGUob2xkLCBtYXBwZXIsIGluZGV4KSwgaW5kZXgpO1xuICAgIGlmIChjbiBpbnN0YW5jZW9mIFRleHQgJiYgdHlwZW9mIGNwID09IFwic3RyaW5nXCIpIHsgY24udGV4dENvbnRlbnQgPSBjcDsgfSBlbHNlXG4gICAgaWYgKGNwICE9IG51bGwpIHtcbiAgICAgICAgY29uc3Qgbm9kZSA9IGdldE5vZGUoY3ApOyAvLyBvbGROb2RlIGlzIGFsd2F5cyB1bmtub3duIGFuZCBwaGFudG9tXG5cbiAgICAgICAgaWYgKGNuPy5wYXJlbnROb2RlID09IGVsZW1lbnQgJiYgY24gIT0gbm9kZSAmJiAoY24gaW5zdGFuY2VvZiBUZXh0ICYmIG5vZGUgaW5zdGFuY2VvZiBUZXh0KSkge1xuICAgICAgICAgICAgaWYgKGNuPy50ZXh0Q29udGVudCAhPSBub2RlPy50ZXh0Q29udGVudCkgeyBjbi50ZXh0Q29udGVudCA9IG5vZGU/LnRleHRDb250ZW50Py50cmltPy4oKSA/PyBcIlwiOyB9XG4gICAgICAgIH0gZWxzZVxuICAgICAgICBpZiAoY24/LnBhcmVudE5vZGUgPT0gZWxlbWVudCAmJiBjbiAhPSBub2RlICYmIGNuICE9IG51bGwgJiYgY24/LnBhcmVudE5vZGUgIT0gbnVsbCkge1xuICAgICAgICAgICAgcmVwbGFjZU9yU3dhcChlbGVtZW50LCBjbiwgbm9kZSk7XG4gICAgICAgIH0gZWxzZVxuICAgICAgICBpZiAoY24/LnBhcmVudE5vZGUgIT0gZWxlbWVudCB8fCBjbj8ucGFyZW50Tm9kZSA9PSBudWxsKSB7XG4gICAgICAgICAgICBhcHBlbmRDaGlsZChlbGVtZW50LCBub2RlLCBudWxsLCBpbmRleCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8vXG5leHBvcnQgY29uc3QgcmVtb3ZlQ2hpbGREaXJlY3RseSA9IChlbGVtZW50LCBub2RlLCBfPzogRnVuY3Rpb24gfCBudWxsLCBpbmRleDogbnVtYmVyID0gLTEpID0+IHtcbiAgICBpZiAoQXJyYXkuZnJvbShlbGVtZW50Py5jaGlsZE5vZGVzID8/IFtdKT8ubGVuZ3RoIDwgMSkgcmV0dXJuO1xuICAgIGNvbnN0IHdoYXRUb1JlbW92ZSA9IGRlUGhhbnRvbU5vZGUoZWxlbWVudCwgbm9kZSwgaW5kZXgpO1xuICAgIGlmICh3aGF0VG9SZW1vdmU/LnBhcmVudE5vZGUgPT0gZWxlbWVudCkgd2hhdFRvUmVtb3ZlPy5yZW1vdmU/LigpO1xuICAgIHJldHVybiBlbGVtZW50O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHJlbW92ZUNoaWxkID0gKGVsZW1lbnQsIGNwLCBtYXBwZXI/OiBGdW5jdGlvbiB8IG51bGwsIGluZGV4OiBudW1iZXIgPSAtMSkgPT4ge1xuICAgIGNvbnN0ICRub2RlID0gZ2V0Tm9kZShjcCwgbWFwcGVyKTtcbiAgICBpZiAoIWVsZW1lbnQpIGVsZW1lbnQgPSAkbm9kZT8ucGFyZW50Tm9kZTtcbiAgICBpZiAoQXJyYXkuZnJvbShlbGVtZW50Py5jaGlsZE5vZGVzID8/IFtdKT8ubGVuZ3RoIDwgMSkgcmV0dXJuO1xuICAgIGNvbnN0IHdoYXRUb1JlbW92ZSA9IGRlUGhhbnRvbU5vZGUoZWxlbWVudCwgJG5vZGUsIGluZGV4KTtcbiAgICBpZiAod2hhdFRvUmVtb3ZlPy5wYXJlbnROb2RlID09IGVsZW1lbnQpIHdoYXRUb1JlbW92ZT8ucmVtb3ZlPy4oKTtcbiAgICByZXR1cm4gZWxlbWVudDtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCByZW1vdmVOb3RFeGlzdHMgPSAoZWxlbWVudCwgY2hpbGRyZW4sIG1hcHBlcj86IEZ1bmN0aW9uIHwgbnVsbCkgPT4ge1xuICAgIGNvbnN0IGxpc3QgPSBBcnJheS5mcm9tKHVud3JhcChjaGlsZHJlbikgfHwgW10pPy5tYXA/LigoY3AsIGluZGV4KSA9PiBnZXROb2RlKGNwLCBtYXBwZXIsIGluZGV4KSk7XG4gICAgQXJyYXkuZnJvbShlbGVtZW50LmNoaWxkTm9kZXMpLmZvckVhY2goKG5kOiBhbnkpID0+IHsgaWYgKCFsaXN0Py5maW5kPy4oKGNwKSA9PiAoIWlzTm90RXF1YWw/LihjcCwgbmQpKSkpIG5kPy5yZW1vdmU/LigpOyB9KTtcbiAgICByZXR1cm4gZWxlbWVudDtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBUID0gKHJlZikgPT4ge1xuICAgIGlmIChpc1ByaW1pdGl2ZShyZWYpICYmIHJlZiAhPSBudWxsKSB7IHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShyZWYpOyB9XG4gICAgaWYgKHJlZiA9PSBudWxsKSByZXR1cm4gZG9jdW1lbnQuY3JlYXRlQ29tbWVudChcIjpOVUxMOlwiKTtcblxuICAgIC8vIEB0cy1pZ25vcmVcbiAgICByZXR1cm4gdG1NYXAuZ2V0T3JJbnNlcnRDb21wdXRlZChyZWYsICgpID0+IHtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCgoaGFzVmFsdWUocmVmKSA/IHJlZj8udmFsdWUgOiByZWYpID8/IFwiXCIpPy50cmltPy4oKSA/PyBcIlwiKTtcbiAgICAgICAgLy9hZmZlY3RlZChbcmVmLCBcInZhbHVlXCJdLCAodmFsKSA9PiAoZWxlbWVudC50ZXh0Q29udGVudCA9ICh2YWw/LmlubmVyVGV4dCA/PyB2YWw/LnRleHRDb250ZW50ID8/IHZhbCA/PyBcIlwiKT8udHJpbT8uKCkgPz8gXCJcIikpO1xuICAgICAgICBhZmZlY3RlZChbcmVmLCBcInZhbHVlXCJdLCAodmFsKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB1bnRyaW1tZWQgPSBcIlwiICsgKHZhbD8uaW5uZXJUZXh0ID8/IHZhbD8udGV4dENvbnRlbnQgPz8gdmFsPy52YWx1ZSA/PyB2YWwgPz8gXCJcIik7XG4gICAgICAgICAgICAoZWxlbWVudC50ZXh0Q29udGVudCA9IHVudHJpbW1lZD8udHJpbT8uKCkgPz8gXCJcIik7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICB9KTtcbn1cblxuLy9cbmV4cG9ydCBkZWZhdWx0IGdldE5vZGU7XG4iXX0=
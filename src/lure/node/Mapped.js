import { iterated, ref } from "fest/object";
import { $mapped } from "../core/Binding";
import { getNode, removeChild, appendChild } from "../context/Utils";
import { makeUpdater, reformChildren } from "../context/ReflectChildren";
import { canBeInteger, isObservable, isPrimitive } from "fest/core";
import { isValidParent } from "fest/dom";
import C from "./Changeable";
//
const asArray = (children) => {
    if (children instanceof Map || children instanceof Set) {
        children = Array.from(children?.values?.());
    }
    return children;
};
//
class Mp {
    #observable;
    #fragments;
    #mapCb;
    #reMap;
    #pmMap;
    #updater = null;
    #internal = null;
    #options = {};
    #stub = document.createComment("");
    //
    #indexMap = new Map();
    //
    #boundParent = null;
    //
    makeUpdater(basisParent = null) {
        if (basisParent) {
            this.#internal?.();
            this.#internal = null;
            this.#updater = null;
            this.#updater ??= makeUpdater(basisParent, this.mapper.bind(this), Array.isArray(this.#observable));
            this.#internal ??= iterated?.(this.#observable, this._onUpdate.bind(this));
        }
    }
    //
    get boundParent() {
        return this.#boundParent;
    }
    //
    set boundParent(value) {
        if (value instanceof HTMLElement && isValidParent(value) && value != this.#boundParent) {
            this.#boundParent = value;
            this.makeUpdater(value);
            const element = this.element;
            //if (element && element instanceof DocumentFragment) { appendFix(this.#boundParent, element); };
        }
    }
    //
    constructor(observable, mapCb = (el) => el, options = null) {
        // swap arguments (JSX compatibility)
        if (isObservable(mapCb) && ((typeof observable == "function" || typeof observable == "object") && !isObservable(observable))) {
            [observable, mapCb] = [mapCb, observable];
        }
        // may be unified with options, if isn't exists (JSX compatibility)
        if (!options && (mapCb != null && typeof mapCb == "object") && !isObservable(mapCb)) {
            options = mapCb;
        }
        //
        this.#stub = document.createComment("");
        this.#reMap = new WeakMap();
        this.#pmMap = new Map(); // make 'mapper' compatible with React syntax ('mapper' property instead of function)
        this.#mapCb = (mapCb != null ? (typeof mapCb == "function" ? mapCb : (typeof mapCb == "object" ? mapCb?.mapper : null)) : null) ?? ((el) => el);
        this.#observable = (isObservable(observable) ? observable : (observable?.iterator ?? mapCb?.iterator ?? observable)) ?? [];
        this.#fragments = document.createDocumentFragment();
        //
        const $baseOptions = { removeNotExistsWhenHasPrimitives: true, uniquePrimitives: true, preMap: true };
        const $newOptions = (isValidParent(options) ? null : options) || {};
        this.#options = Object.assign($baseOptions, $newOptions);
        //
        this.boundParent = isValidParent(this.#options?.boundParent) ?? (isValidParent(options) ?? null);
        if (!this.boundParent) {
            if (this.#options.preMap) {
                reformChildren(this.#fragments, this.#observable, this.mapper.bind(this));
                if (this.#fragments.childNodes.length === 0) {
                    this.#fragments.appendChild(this.#stub);
                }
            }
        }
    }
    //
    get [$mapped]() { return true; }
    //
    elementForPotentialParent(requestor) {
        Promise.try(() => {
            const element = getNode(this.#observable?.[0], this.mapper.bind(this), 0);
            if (!element || !requestor || element?.contains?.(requestor) || requestor == element) {
                return;
            }
            if (requestor instanceof HTMLElement && isValidParent(requestor)) {
                if (Array.from(requestor?.children).find((node) => node === element)) {
                    this.boundParent = requestor;
                }
                else {
                    const observer = new MutationObserver((records) => {
                        for (const record of records) {
                            if (record.type === "childList") {
                                if (record.addedNodes.length > 0) {
                                    const connectedNode = Array.from(record.addedNodes || []).find((node) => node === element);
                                    if (connectedNode) {
                                        this.boundParent = requestor;
                                        observer.disconnect();
                                    }
                                }
                            }
                        }
                    });
                    observer.observe(requestor, { childList: true });
                }
            }
        })?.catch?.(console.warn.bind(console));
        //
        return this.element;
    }
    //
    get children() { return asArray(this.#observable); }
    //
    get self() {
        const existsNode = getNode(this.#observable?.[0], this.mapper.bind(this), 0);
        const theirParent = isValidParent(existsNode?.parentElement) ? existsNode?.parentElement : this.boundParent;
        this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        //
        queueMicrotask(() => {
            const theirParent = isValidParent(existsNode?.parentElement) ? existsNode?.parentElement : this.boundParent;
            this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        });
        //
        return (theirParent ?? this.boundParent ?? (reformChildren(this.#fragments, this.#observable, this.mapper.bind(this))));
    }
    //
    get element() {
        const children = this.#fragments?.childNodes?.length > 0 ? this.#fragments : getNode(this.#observable?.[0], this.mapper.bind(this), 0);
        const theirParent = isValidParent(children?.parentElement) ? children?.parentElement : this.boundParent;
        this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        //
        queueMicrotask(() => {
            const theirParent = isValidParent(children?.parentElement) ? children?.parentElement : this.boundParent;
            this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        });
        //
        return children;
    }
    //
    get mapper() {
        return (...args) => {
            if (args?.[0] == null) {
                return null;
            }
            //
            if (args?.[0] instanceof Node) {
                return args?.[0];
            }
            ;
            // unsupported
            if (args?.[0] instanceof Promise || typeof args?.[0]?.then == "function") {
                return null;
            }
            ;
            //
            if ((args?.[1] == null || args?.[1] < 0 || (typeof args?.[1] != "number" || !canBeInteger(args?.[1]))) &&
                (Array.isArray(this.#observable) || (this.#observable instanceof Set))) {
                return;
            }
            //
            if (args?.[0] != null && (typeof args?.[0] == "object" || typeof args?.[0] == "function" || typeof args?.[0] == "symbol")) // @ts-ignore
             {
                return this.#reMap.getOrInsert(args?.[0], this.#mapCb(...args));
            }
            // prevalence of Set typed
            if (args?.[0] != null && this.#observable instanceof Set) // @ts-ignore
             {
                return this.#pmMap.getOrInsert(args?.[0], this.#mapCb(...args));
            }
            // prevalence of Map typed
            if (args?.[0] != null && this.#observable instanceof Map) {
                // unique value in map
                if (typeof args?.[0] == "object" || typeof args?.[0] == "function" || typeof args?.[0] == "symbol") // @ts-ignore
                 {
                    return this.#reMap.getOrInsert(args?.[0], this.#mapCb(...args));
                }
                else 
                // unique key in map (objects)
                if (typeof args?.[1] == "object" || typeof args?.[1] == "function" || typeof args?.[1] == "symbol") // @ts-ignore
                 {
                    return this.#reMap.getOrInsert(args?.[1], this.#mapCb(...args));
                }
                else // @ts-ignore
                 {
                    return this.#pmMap.getOrInsert(args?.[1], this.#mapCb(...args));
                }
            }
            // array may has same values twice, no viable solution...
            if (args?.[0] != null) {
                if (this.#options?.uniquePrimitives && isPrimitive(args?.[0])) // @ts-ignore
                 {
                    return this.#pmMap.getOrInsert(args?.[0], this.#mapCb(...args));
                }
                else {
                    return this.#mapCb(...args);
                }
            }
        };
    }
    //
    _onUpdate(newEl, idx, oldEl, op = "") {
        //
        if (op == "@add" || (newEl != null && oldEl == null)) {
            if (this.#indexMap.has(idx)) {
                return;
            }
            const indexRef = ref(this.#observable, idx);
            const withElement = C(indexRef, (...args) => {
                if (args?.[1] == null || args?.[1] < 0) {
                    args[1] = idx ?? args?.[1];
                }
                ;
                return this.mapper(...args);
            });
            this.#indexMap.set(idx, withElement);
            appendChild(this.boundParent, withElement, null, idx);
        }
        //
        if (op == "@delete" || (newEl == null && oldEl != null)) {
            const withElement = this.#indexMap.get(idx);
            if (withElement) {
                removeChild(this.boundParent, withElement, null, idx);
            }
            this.#indexMap.delete(idx);
        }
    }
    // generator and iterator
    *[Symbol.iterator]() {
        let i = 0;
        if (this.#observable) {
            for (let el of this.#observable) {
                yield this.mapper(el, i++);
            }
        }
        return;
    }
}
//
export const M = (observable, mapCb, boundParent = null) => {
    return new Mp(observable, mapCb, boundParent);
};
//
export default M;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFwcGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWFwcGVkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsT0FBTyxFQUE4QixXQUFXLEVBQXVCLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3RILE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDekUsT0FBTyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFtQixNQUFNLFdBQVcsQ0FBQztBQUNyRixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3pDLE9BQU8sQ0FBQyxNQUFNLGNBQWMsQ0FBQztBQVU3QixFQUFFO0FBQ0YsTUFBTSxPQUFPLEdBQUcsQ0FBQyxRQUFRLEVBQUMsRUFBRTtJQUN4QixJQUFJLFFBQVEsWUFBWSxHQUFHLElBQUksUUFBUSxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3JELFFBQVEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUNELE9BQU8sUUFBUSxDQUFDO0FBQ3BCLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLEVBQUU7SUFDSixXQUFXLENBQVM7SUFDcEIsVUFBVSxDQUFtQjtJQUM3QixNQUFNLENBQU07SUFDWixNQUFNLENBQW9CO0lBQzFCLE1BQU0sQ0FBZ0I7SUFDdEIsUUFBUSxHQUFRLElBQUksQ0FBQztJQUNyQixTQUFTLEdBQVEsSUFBSSxDQUFDO0lBQ3RCLFFBQVEsR0FBa0IsRUFBbUIsQ0FBQztJQUM5QyxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FB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Q0FBQyxDQUFDO0FBQ2xELENBQUMsQ0FBQztBQUVGLEVBQUU7QUFDRixlQUFlLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGl0ZXJhdGVkLCByZWYgfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7ICRtYXBwZWQgfSBmcm9tIFwiLi4vY29yZS9CaW5kaW5nXCI7XG5pbXBvcnQgeyBnZXROb2RlLCBhcHBlbmRGaXgsIHJlbW92ZU5vdEV4aXN0cywgcmVtb3ZlQ2hpbGQsIHJlbW92ZUNoaWxkRGlyZWN0bHksIGFwcGVuZENoaWxkIH0gZnJvbSBcIi4uL2NvbnRleHQvVXRpbHNcIjtcbmltcG9ydCB7IG1ha2VVcGRhdGVyLCByZWZvcm1DaGlsZHJlbiB9IGZyb20gXCIuLi9jb250ZXh0L1JlZmxlY3RDaGlsZHJlblwiO1xuaW1wb3J0IHsgY2FuQmVJbnRlZ2VyLCBpc09ic2VydmFibGUsIGlzUHJpbWl0aXZlLCBpc0hhc1ByaW1pdGl2ZXMgfSBmcm9tIFwiZmVzdC9jb3JlXCI7XG5pbXBvcnQgeyBpc1ZhbGlkUGFyZW50IH0gZnJvbSBcImZlc3QvZG9tXCI7XG5pbXBvcnQgQyBmcm9tIFwiLi9DaGFuZ2VhYmxlXCI7XG5cbi8vXG5pbnRlcmZhY2UgTWFwcGVkT3B0aW9ucyB7XG4gICAgdW5pcXVlUHJpbWl0aXZlcz86IGJvb2xlYW47XG4gICAgcmVtb3ZlTm90RXhpc3RzV2hlbkhhc1ByaW1pdGl2ZXM/OiBib29sZWFuO1xuICAgIGJvdW5kUGFyZW50PzogTm9kZSB8IG51bGw7XG4gICAgcHJlTWFwPzogYm9vbGVhbjtcbn1cblxuLy9cbmNvbnN0IGFzQXJyYXkgPSAoY2hpbGRyZW4pPT57XG4gICAgaWYgKGNoaWxkcmVuIGluc3RhbmNlb2YgTWFwIHx8IGNoaWxkcmVuIGluc3RhbmNlb2YgU2V0KSB7XG4gICAgICAgIGNoaWxkcmVuID0gQXJyYXkuZnJvbShjaGlsZHJlbj8udmFsdWVzPy4oKSk7XG4gICAgfVxuICAgIHJldHVybiBjaGlsZHJlbjtcbn1cblxuLy9cbmNsYXNzIE1wIHtcbiAgICAjb2JzZXJ2YWJsZT86IGFueVtdO1xuICAgICNmcmFnbWVudHM6IERvY3VtZW50RnJhZ21lbnQ7XG4gICAgI21hcENiOiBhbnk7XG4gICAgI3JlTWFwOiBXZWFrTWFwPGFueSwgYW55PjtcbiAgICAjcG1NYXA6IE1hcDxhbnksIGFueT47XG4gICAgI3VwZGF0ZXI6IGFueSA9IG51bGw7XG4gICAgI2ludGVybmFsOiBhbnkgPSBudWxsO1xuICAgICNvcHRpb25zOiBNYXBwZWRPcHRpb25zID0ge30gYXMgTWFwcGVkT3B0aW9ucztcbiAgICAjc3R1YiA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoXCJcIik7XG5cbiAgICAvL1xuICAgICNpbmRleE1hcDogTWFwPGFueSwgYW55PiA9IG5ldyBNYXAoKTtcblxuICAgIC8vXG4gICAgI2JvdW5kUGFyZW50OiBOb2RlIHwgbnVsbCA9IG51bGw7XG5cbiAgICAvL1xuICAgIG1ha2VVcGRhdGVyKGJhc2lzUGFyZW50OiBOb2RlIHwgbnVsbCA9IG51bGwpIHtcbiAgICAgICAgaWYgKGJhc2lzUGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLiNpbnRlcm5hbD8uKCk7IHRoaXMuI2ludGVybmFsID0gbnVsbDsgdGhpcy4jdXBkYXRlciA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLiN1cGRhdGVyID8/PSBtYWtlVXBkYXRlcihiYXNpc1BhcmVudCwgdGhpcy5tYXBwZXIuYmluZCh0aGlzKSwgQXJyYXkuaXNBcnJheSh0aGlzLiNvYnNlcnZhYmxlKSk7XG4gICAgICAgICAgICB0aGlzLiNpbnRlcm5hbCA/Pz0gaXRlcmF0ZWQ/Lih0aGlzLiNvYnNlcnZhYmxlLCB0aGlzLl9vblVwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IGJvdW5kUGFyZW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy4jYm91bmRQYXJlbnQ7XG4gICAgfVxuXG4gICAgLy9cbiAgICBzZXQgYm91bmRQYXJlbnQodmFsdWU6IE5vZGUgfCBudWxsKSB7XG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIGlzVmFsaWRQYXJlbnQodmFsdWUpICYmIHZhbHVlICE9IHRoaXMuI2JvdW5kUGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLiNib3VuZFBhcmVudCA9IHZhbHVlOyB0aGlzLm1ha2VVcGRhdGVyKHZhbHVlKTsgY29uc3QgZWxlbWVudCA9IHRoaXMuZWxlbWVudDtcbiAgICAgICAgICAgIC8vaWYgKGVsZW1lbnQgJiYgZWxlbWVudCBpbnN0YW5jZW9mIERvY3VtZW50RnJhZ21lbnQpIHsgYXBwZW5kRml4KHRoaXMuI2JvdW5kUGFyZW50LCBlbGVtZW50KTsgfTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgY29uc3RydWN0b3Iob2JzZXJ2YWJsZSwgbWFwQ2I6IGFueSA9IChlbCkgPT4gZWwsIG9wdGlvbnM6IE5vZGUgfCBudWxsIHwgTWFwcGVkT3B0aW9ucyA9IC8qeyByZW1vdmVOb3RFeGlzdHNXaGVuSGFzUHJpbWl0aXZlczogdHJ1ZSwgdW5pcXVlUHJpbWl0aXZlczogdHJ1ZSwgcHJlTWFwOiB0cnVlIH0gYXMgTWFwcGVkT3B0aW9ucyovIG51bGwpIHtcbiAgICAgICAgLy8gc3dhcCBhcmd1bWVudHMgKEpTWCBjb21wYXRpYmlsaXR5KVxuICAgICAgICBpZiAoaXNPYnNlcnZhYmxlKG1hcENiKSAmJiAoKHR5cGVvZiBvYnNlcnZhYmxlID09IFwiZnVuY3Rpb25cIiB8fCB0eXBlb2Ygb2JzZXJ2YWJsZSA9PSBcIm9iamVjdFwiKSAmJiAhaXNPYnNlcnZhYmxlKG9ic2VydmFibGUpKSkge1xuICAgICAgICAgICAgW29ic2VydmFibGUsIG1hcENiXSA9IFttYXBDYiwgb2JzZXJ2YWJsZV0gYXMgW2FueSwgYW55XTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIG1heSBiZSB1bmlmaWVkIHdpdGggb3B0aW9ucywgaWYgaXNuJ3QgZXhpc3RzIChKU1ggY29tcGF0aWJpbGl0eSlcbiAgICAgICAgaWYgKCFvcHRpb25zICYmIChtYXBDYiAhPSBudWxsICYmIHR5cGVvZiBtYXBDYiA9PSBcIm9iamVjdFwiKSAmJiAhaXNPYnNlcnZhYmxlKG1hcENiKSkge1xuICAgICAgICAgICAgb3B0aW9ucyA9IG1hcENiIGFzIE1hcHBlZE9wdGlvbnM7XG4gICAgICAgIH1cblxuICAgICAgICAvL1xuICAgICAgICB0aGlzLiNzdHViID0gZG9jdW1lbnQuY3JlYXRlQ29tbWVudChcIlwiKTtcbiAgICAgICAgdGhpcy4jcmVNYXAgPSBuZXcgV2Vha01hcCgpO1xuICAgICAgICB0aGlzLiNwbU1hcCA9IG5ldyBNYXA8YW55LCBhbnk+KCk7IC8vIG1ha2UgJ21hcHBlcicgY29tcGF0aWJsZSB3aXRoIFJlYWN0IHN5bnRheCAoJ21hcHBlcicgcHJvcGVydHkgaW5zdGVhZCBvZiBmdW5jdGlvbilcbiAgICAgICAgdGhpcy4jbWFwQ2IgPSAobWFwQ2IgIT0gbnVsbCA/ICh0eXBlb2YgbWFwQ2IgPT0gXCJmdW5jdGlvblwiID8gbWFwQ2IgOiAodHlwZW9mIG1hcENiID09IFwib2JqZWN0XCIgPyBtYXBDYj8ubWFwcGVyIDogbnVsbCkpIDogbnVsbCkgPz8gKChlbCkgPT4gZWwpO1xuICAgICAgICB0aGlzLiNvYnNlcnZhYmxlID0gKGlzT2JzZXJ2YWJsZShvYnNlcnZhYmxlKSA/IG9ic2VydmFibGUgOiAob2JzZXJ2YWJsZT8uaXRlcmF0b3IgPz8gbWFwQ2I/Lml0ZXJhdG9yID8/IG9ic2VydmFibGUpKSA/PyBbXTtcbiAgICAgICAgdGhpcy4jZnJhZ21lbnRzID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGNvbnN0ICRiYXNlT3B0aW9ucyA9IHsgcmVtb3ZlTm90RXhpc3RzV2hlbkhhc1ByaW1pdGl2ZXM6IHRydWUsIHVuaXF1ZVByaW1pdGl2ZXM6IHRydWUsIHByZU1hcDogdHJ1ZSB9IGFzIE1hcHBlZE9wdGlvbnM7XG4gICAgICAgIGNvbnN0ICRuZXdPcHRpb25zID0gKGlzVmFsaWRQYXJlbnQob3B0aW9ucyBhcyBhbnkpID8gbnVsbCA6IChvcHRpb25zIGFzIE1hcHBlZE9wdGlvbnN8bnVsbCkpIHx8IHt9O1xuICAgICAgICB0aGlzLiNvcHRpb25zID0gT2JqZWN0LmFzc2lnbigkYmFzZU9wdGlvbnMsICRuZXdPcHRpb25zKTtcblxuICAgICAgICAvL1xuICAgICAgICB0aGlzLmJvdW5kUGFyZW50ID0gaXNWYWxpZFBhcmVudCh0aGlzLiNvcHRpb25zPy5ib3VuZFBhcmVudCBhcyBhbnkpID8/IChpc1ZhbGlkUGFyZW50KG9wdGlvbnMgYXMgYW55KSA/PyBudWxsKTtcbiAgICAgICAgaWYgKCF0aGlzLmJvdW5kUGFyZW50KSB7XG4gICAgICAgICAgICBpZiAodGhpcy4jb3B0aW9ucy5wcmVNYXApIHtcbiAgICAgICAgICAgICAgICByZWZvcm1DaGlsZHJlbihcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4jZnJhZ21lbnRzLCB0aGlzLiNvYnNlcnZhYmxlLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLm1hcHBlci5iaW5kKHRoaXMpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy4jZnJhZ21lbnRzLmNoaWxkTm9kZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuI2ZyYWdtZW50cy5hcHBlbmRDaGlsZCh0aGlzLiNzdHViKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBbJG1hcHBlZF0oKSB7IHJldHVybiB0cnVlOyB9XG5cbiAgICAvL1xuICAgIGVsZW1lbnRGb3JQb3RlbnRpYWxQYXJlbnQocmVxdWVzdG9yOiBhbnkpIHtcbiAgICAgICAgUHJvbWlzZS50cnkoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGdldE5vZGUodGhpcy4jb2JzZXJ2YWJsZT8uWzBdLCB0aGlzLm1hcHBlci5iaW5kKHRoaXMpLCAwKTtcbiAgICAgICAgICAgIGlmICghZWxlbWVudCB8fCAhcmVxdWVzdG9yIHx8IGVsZW1lbnQ/LmNvbnRhaW5zPy4ocmVxdWVzdG9yKSB8fCByZXF1ZXN0b3IgPT0gZWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXF1ZXN0b3IgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJiBpc1ZhbGlkUGFyZW50KHJlcXVlc3RvcikpIHtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuZnJvbShyZXF1ZXN0b3I/LmNoaWxkcmVuKS5maW5kKChub2RlKSA9PiBub2RlID09PSBlbGVtZW50KSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmJvdW5kUGFyZW50ID0gcmVxdWVzdG9yO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoKHJlY29yZHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIHJlY29yZHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjb3JkLnR5cGUgPT09IFwiY2hpbGRMaXN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC5hZGRlZE5vZGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbm5lY3RlZE5vZGUgPSBBcnJheS5mcm9tKChyZWNvcmQuYWRkZWROb2RlcyBhcyBhbnkpIHx8IFtdKS5maW5kKChub2RlKSA9PiBub2RlID09PSBlbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25uZWN0ZWROb2RlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA9IHJlcXVlc3RvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5vYnNlcnZlKHJlcXVlc3RvciwgeyBjaGlsZExpc3Q6IHRydWUgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KT8uY2F0Y2g/Lihjb25zb2xlLndhcm4uYmluZChjb25zb2xlKSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudDtcbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBjaGlsZHJlbigpIHsgcmV0dXJuIGFzQXJyYXkodGhpcy4jb2JzZXJ2YWJsZSk7IH1cblxuICAgIC8vXG4gICAgZ2V0IHNlbGYoKTogSFRNTEVsZW1lbnQgfCBEb2N1bWVudEZyYWdtZW50IHwgVGV4dCB8IG51bGwge1xuICAgICAgICBjb25zdCBleGlzdHNOb2RlID0gZ2V0Tm9kZSh0aGlzLiNvYnNlcnZhYmxlPy5bMF0sIHRoaXMubWFwcGVyLmJpbmQodGhpcyksIDApO1xuICAgICAgICBjb25zdCB0aGVpclBhcmVudCA9IGlzVmFsaWRQYXJlbnQoZXhpc3RzTm9kZT8ucGFyZW50RWxlbWVudCkgPyBleGlzdHNOb2RlPy5wYXJlbnRFbGVtZW50IDogdGhpcy5ib3VuZFBhcmVudDtcbiAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA/Pz0gaXNWYWxpZFBhcmVudCh0aGVpclBhcmVudCkgPz8gdGhpcy5ib3VuZFBhcmVudDtcblxuICAgICAgICAvL1xuICAgICAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0aGVpclBhcmVudCA9IGlzVmFsaWRQYXJlbnQoZXhpc3RzTm9kZT8ucGFyZW50RWxlbWVudCkgPyBleGlzdHNOb2RlPy5wYXJlbnRFbGVtZW50IDogdGhpcy5ib3VuZFBhcmVudDtcbiAgICAgICAgICAgIHRoaXMuYm91bmRQYXJlbnQgPz89IGlzVmFsaWRQYXJlbnQodGhlaXJQYXJlbnQpID8/IHRoaXMuYm91bmRQYXJlbnQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vXG4gICAgICAgIHJldHVybiAodGhlaXJQYXJlbnQgPz8gdGhpcy5ib3VuZFBhcmVudCA/PyAocmVmb3JtQ2hpbGRyZW4oXG4gICAgICAgICAgICB0aGlzLiNmcmFnbWVudHMsIHRoaXMuI29ic2VydmFibGUsXG4gICAgICAgICAgICB0aGlzLm1hcHBlci5iaW5kKHRoaXMpXG4gICAgICAgICkpKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBlbGVtZW50KCk6IEhUTUxFbGVtZW50IHwgRG9jdW1lbnRGcmFnbWVudCB8IFRleHQgfCBudWxsIHtcbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLiNmcmFnbWVudHM/LmNoaWxkTm9kZXM/Lmxlbmd0aCA+IDAgPyB0aGlzLiNmcmFnbWVudHMgOiBnZXROb2RlKHRoaXMuI29ic2VydmFibGU/LlswXSwgdGhpcy5tYXBwZXIuYmluZCh0aGlzKSwgMCk7XG4gICAgICAgIGNvbnN0IHRoZWlyUGFyZW50ID0gaXNWYWxpZFBhcmVudChjaGlsZHJlbj8ucGFyZW50RWxlbWVudCkgPyBjaGlsZHJlbj8ucGFyZW50RWxlbWVudCA6IHRoaXMuYm91bmRQYXJlbnQ7XG4gICAgICAgIHRoaXMuYm91bmRQYXJlbnQgPz89IGlzVmFsaWRQYXJlbnQodGhlaXJQYXJlbnQpID8/IHRoaXMuYm91bmRQYXJlbnQ7XG5cbiAgICAgICAgLy9cbiAgICAgICAgcXVldWVNaWNyb3Rhc2soKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGhlaXJQYXJlbnQgPSBpc1ZhbGlkUGFyZW50KGNoaWxkcmVuPy5wYXJlbnRFbGVtZW50KSA/IGNoaWxkcmVuPy5wYXJlbnRFbGVtZW50IDogdGhpcy5ib3VuZFBhcmVudDtcbiAgICAgICAgICAgIHRoaXMuYm91bmRQYXJlbnQgPz89IGlzVmFsaWRQYXJlbnQodGhlaXJQYXJlbnQpID8/IHRoaXMuYm91bmRQYXJlbnQ7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vXG4gICAgICAgIHJldHVybiBjaGlsZHJlbjtcbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBtYXBwZXIoKSB7XG4gICAgICAgIHJldHVybiAoLi4uYXJncykgPT4ge1xuICAgICAgICAgICAgaWYgKGFyZ3M/LlswXSA9PSBudWxsKSB7IHJldHVybiBudWxsOyB9XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBpZiAoYXJncz8uWzBdIGluc3RhbmNlb2YgTm9kZSkgeyByZXR1cm4gYXJncz8uWzBdOyB9O1xuXG4gICAgICAgICAgICAvLyB1bnN1cHBvcnRlZFxuICAgICAgICAgICAgaWYgKGFyZ3M/LlswXSBpbnN0YW5jZW9mIFByb21pc2UgfHwgdHlwZW9mIChhcmdzPy5bMF0gYXMgYW55KT8udGhlbiA9PSBcImZ1bmN0aW9uXCIpIHsgcmV0dXJuIG51bGw7IH07XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgKGFyZ3M/LlsxXSA9PSBudWxsIHx8IGFyZ3M/LlsxXSA8IDAgfHwgKHR5cGVvZiBhcmdzPy5bMV0gIT0gXCJudW1iZXJcIiB8fCAhY2FuQmVJbnRlZ2VyKGFyZ3M/LlsxXSBhcyBhbnkpKSkgJiZcbiAgICAgICAgICAgICAgICAoQXJyYXkuaXNBcnJheSh0aGlzLiNvYnNlcnZhYmxlKSB8fCAoKHRoaXMuI29ic2VydmFibGUgYXMgYW55KSBpbnN0YW5jZW9mIFNldCkpXG4gICAgICAgICAgICApIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgICBpZiAoYXJncz8uWzBdICE9IG51bGwgJiYgKHR5cGVvZiBhcmdzPy5bMF0gPT0gXCJvYmplY3RcIiB8fCB0eXBlb2YgYXJncz8uWzBdID09IFwiZnVuY3Rpb25cIiB8fCB0eXBlb2YgYXJncz8uWzBdID09IFwic3ltYm9sXCIpKSAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgeyByZXR1cm4gdGhpcy4jcmVNYXAuZ2V0T3JJbnNlcnQoYXJncz8uWzBdLCB0aGlzLiNtYXBDYiguLi5hcmdzKSk7IH1cblxuICAgICAgICAgICAgLy8gcHJldmFsZW5jZSBvZiBTZXQgdHlwZWRcbiAgICAgICAgICAgIGlmIChhcmdzPy5bMF0gIT0gbnVsbCAmJiB0aGlzLiNvYnNlcnZhYmxlIGluc3RhbmNlb2YgU2V0KSAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgeyByZXR1cm4gdGhpcy4jcG1NYXAuZ2V0T3JJbnNlcnQoYXJncz8uWzBdLCB0aGlzLiNtYXBDYiguLi5hcmdzKSk7IH1cblxuICAgICAgICAgICAgLy8gcHJldmFsZW5jZSBvZiBNYXAgdHlwZWRcbiAgICAgICAgICAgIGlmIChhcmdzPy5bMF0gIT0gbnVsbCAmJiB0aGlzLiNvYnNlcnZhYmxlIGluc3RhbmNlb2YgTWFwKSB7XG4gICAgICAgICAgICAgICAgLy8gdW5pcXVlIHZhbHVlIGluIG1hcFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJncz8uWzBdID09IFwib2JqZWN0XCIgfHwgdHlwZW9mIGFyZ3M/LlswXSA9PSBcImZ1bmN0aW9uXCIgfHwgdHlwZW9mIGFyZ3M/LlswXSA9PSBcInN5bWJvbFwiKSAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgIHsgcmV0dXJuIHRoaXMuI3JlTWFwLmdldE9ySW5zZXJ0KGFyZ3M/LlswXSwgdGhpcy4jbWFwQ2IoLi4uYXJncykpOyB9IGVsc2VcbiAgICAgICAgICAgICAgICAvLyB1bmlxdWUga2V5IGluIG1hcCAob2JqZWN0cylcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3M/LlsxXSA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiBhcmdzPy5bMV0gPT0gXCJmdW5jdGlvblwiIHx8IHR5cGVvZiBhcmdzPy5bMV0gPT0gXCJzeW1ib2xcIikgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICB7IHJldHVybiB0aGlzLiNyZU1hcC5nZXRPckluc2VydChhcmdzPy5bMV0sIHRoaXMuI21hcENiKC4uLmFyZ3MpKTsgfSBlbHNlIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgeyByZXR1cm4gdGhpcy4jcG1NYXAuZ2V0T3JJbnNlcnQoYXJncz8uWzFdLCB0aGlzLiNtYXBDYiguLi5hcmdzKSk7IH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gYXJyYXkgbWF5IGhhcyBzYW1lIHZhbHVlcyB0d2ljZSwgbm8gdmlhYmxlIHNvbHV0aW9uLi4uXG4gICAgICAgICAgICBpZiAoYXJncz8uWzBdICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy4jb3B0aW9ucz8udW5pcXVlUHJpbWl0aXZlcyAmJiBpc1ByaW1pdGl2ZShhcmdzPy5bMF0pKSAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgIHsgcmV0dXJuIHRoaXMuI3BtTWFwLmdldE9ySW5zZXJ0KGFyZ3M/LlswXSwgdGhpcy4jbWFwQ2IoLi4uYXJncykpOyB9IGVsc2VcbiAgICAgICAgICAgICAgICAgICAgeyByZXR1cm4gdGhpcy4jbWFwQ2IoLi4uYXJncyk7IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgX29uVXBkYXRlKG5ld0VsLCBpZHgsIG9sZEVsLCBvcDogc3RyaW5nIHwgbnVsbCA9IFwiXCIpIHtcbiAgICAgICAgLy9cbiAgICAgICAgaWYgKG9wID09IFwiQGFkZFwiIHx8IChuZXdFbCAhPSBudWxsICYmIG9sZEVsID09IG51bGwpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy4jaW5kZXhNYXAuaGFzKGlkeCkpIHsgcmV0dXJuOyB9XG4gICAgICAgICAgICBjb25zdCBpbmRleFJlZiA9IHJlZih0aGlzLiNvYnNlcnZhYmxlLCBpZHgpO1xuICAgICAgICAgICAgY29uc3Qgd2l0aEVsZW1lbnQgPSBDKGluZGV4UmVmLCAoLi4uYXJncykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChhcmdzPy5bMV0gPT0gbnVsbCB8fCBhcmdzPy5bMV0gPCAwKSB7IGFyZ3NbMV0gPSBpZHggPz8gYXJncz8uWzFdOyB9O1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1hcHBlciguLi5hcmdzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy4jaW5kZXhNYXAuc2V0KGlkeCwgd2l0aEVsZW1lbnQpO1xuICAgICAgICAgICAgYXBwZW5kQ2hpbGQodGhpcy5ib3VuZFBhcmVudCwgd2l0aEVsZW1lbnQsIG51bGwsIGlkeCk7XG4gICAgICAgIH1cblxuICAgICAgICAvL1xuICAgICAgICBpZiAob3AgPT0gXCJAZGVsZXRlXCIgfHwgKG5ld0VsID09IG51bGwgJiYgb2xkRWwgIT0gbnVsbCkpIHtcbiAgICAgICAgICAgIGNvbnN0IHdpdGhFbGVtZW50ID0gdGhpcy4jaW5kZXhNYXAuZ2V0KGlkeCk7XG4gICAgICAgICAgICBpZiAod2l0aEVsZW1lbnQpIHsgcmVtb3ZlQ2hpbGQodGhpcy5ib3VuZFBhcmVudCwgd2l0aEVsZW1lbnQsIG51bGwsIGlkeCk7IH1cbiAgICAgICAgICAgIHRoaXMuI2luZGV4TWFwLmRlbGV0ZShpZHgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gZ2VuZXJhdG9yIGFuZCBpdGVyYXRvclxuICAgICpbU3ltYm9sLml0ZXJhdG9yXSgpIHtcbiAgICAgICAgbGV0IGk9MDtcbiAgICAgICAgaWYgKHRoaXMuI29ic2VydmFibGUpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGVsIG9mIHRoaXMuI29ic2VydmFibGUpXG4gICAgICAgICAgICAgICAgeyB5aWVsZCB0aGlzLm1hcHBlcihlbCwgaSsrKTsgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICB9XG59XG5cbi8vXG5leHBvcnQgY29uc3QgTSA9IChvYnNlcnZhYmxlLCBtYXBDYj8sIGJvdW5kUGFyZW50OiBOb2RlIHwgbnVsbCB8IE1hcHBlZE9wdGlvbnMgPSBudWxsKSA9PiB7XG4gICAgcmV0dXJuIG5ldyBNcChvYnNlcnZhYmxlLCBtYXBDYiwgYm91bmRQYXJlbnQpO1xufTtcblxuLy9cbmV4cG9ydCBkZWZhdWx0IE07XG4iXX0=
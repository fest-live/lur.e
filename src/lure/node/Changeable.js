import { affected } from "fest/object";
import { elMap, getNode, T } from "../context/Utils";
import { makeUpdater } from "../context/ReflectChildren";
import { isPrimitive, hasValue } from "fest/core";
import { indexOf, isValidParent } from "fest/dom";
import { $mapped } from "../core/Binding";
import Q from "./Queried";
//
class Ch {
    #stub = document.createComment("");
    #valueRef;
    #fragments;
    #updater = null;
    #internal = null;
    #updating = false;
    #options = {};
    #oldNode; // in case, if '.value' is primitive, and can't be reused by maps
    #mapCb = null;
    //#reMap: WeakMap<any, any>; // reuse same object from value
    //
    #boundParent = null;
    //
    makeUpdater(basisParent = null) {
        if (basisParent) {
            this.#internal?.();
            this.#internal = null;
            this.#updater = null;
            this.#updater ??= makeUpdater(basisParent, null, false);
            this.#internal ??= affected?.([this.#valueRef, "value"], this._onUpdate.bind(this));
        }
    }
    //
    get boundParent() { return this.#boundParent; }
    set boundParent(value) {
        if (value instanceof HTMLElement && isValidParent(value) && value != this.#boundParent) {
            this.#boundParent = value;
            this.makeUpdater(value);
            if (this.#oldNode) {
                //this.#oldNode?.parentNode != null && this.#oldNode?.replaceWith?.(this.#stub); this.#oldNode = this.#stub;
                this.#oldNode?.parentNode != null && this.#oldNode?.remove?.();
                this.#oldNode = null;
            }
            ;
            //
            const element = this.element;
            //if (element) { appendFix(this.#boundParent, element); };
        }
    }
    //
    constructor(valueRef, mapCb = (el) => el, options = null) {
        this.#stub = document.createComment("");
        // swap arguments (JSX compatibility)
        if (hasValue(mapCb) && ((typeof valueRef == "function" || typeof valueRef == "object") && !hasValue(valueRef))) {
            [valueRef, mapCb] = [mapCb, valueRef];
        }
        // may be unified with options, if isn't exists (JSX compatibility)
        if (!options && (mapCb != null && typeof mapCb == "object") && !hasValue(mapCb)) {
            options = mapCb;
        }
        //
        this.#mapCb = (mapCb != null ? (typeof mapCb == "function" ? mapCb : (typeof mapCb == "object" ? mapCb?.mapper : null)) : null) ?? ((el) => el);
        this.#oldNode = null; //this.#stub;
        this.#valueRef = (!hasValue(valueRef) ? mapCb?.(valueRef, -1) : valueRef) ?? valueRef;
        this.#fragments = document.createDocumentFragment();
        //
        const $baseOptions = { removeNotExistsWhenHasPrimitives: true, uniquePrimitives: true, preMap: true };
        const $newOptions = (isValidParent(options) ? null : options) || {};
        this.#options = Object.assign($baseOptions, $newOptions);
        //
        this.boundParent = isValidParent(this.#options?.boundParent) ?? (isValidParent(options) ?? null);
    }
    //
    $getNodeBy(requestor, value) {
        const node = isPrimitive(hasValue(value) ? value?.value : value) ? T(value) : getNode(value, (value == requestor) ? null : this.#mapCb, -1, requestor);
        return node;
    }
    //
    $getNode(requestor, reassignOldNode = true) {
        // TODO: resolve somehow returning this.#valueRef as element...
        const node = isPrimitive(this.#valueRef?.value) ? T(this.#valueRef) : getNode(this.#valueRef?.value, (requestor == this.#valueRef?.value) ? null : this.#mapCb, -1, requestor);
        if (node != null && reassignOldNode) {
            this.#oldNode = node;
        }
        ;
        return node;
    }
    //
    get [$mapped]() { return true; }
    //
    elementForPotentialParent(requestor) {
        /*if (isValidParent(requestor)) {
            this.boundParent = requestor;
            this.#valueRef?.[$trigger]?.();
        }*/
        Promise.try(() => {
            const element = this.$getNode(requestor);
            if (!element || !requestor || element?.contains?.(requestor) || requestor == element) {
                return;
            }
            if (requestor instanceof HTMLElement && isValidParent(requestor)) {
                if (Array.from(requestor?.children).find((node) => node === element)) {
                    this.boundParent = requestor;
                }
                else {
                    const observer = new MutationObserver((records) => {
                        for (const record of records) {
                            if (record.type === "childList") {
                                if (record.addedNodes.length > 0) {
                                    const connectedNode = Array.from(record.addedNodes || []).find((node) => node === element);
                                    if (connectedNode) {
                                        this.boundParent = requestor;
                                        observer.disconnect();
                                    }
                                }
                            }
                        }
                    });
                    observer.observe(requestor, { childList: true });
                }
            }
        })?.catch?.(console.warn.bind(console));
        return this.element;
    }
    //
    get self() {
        const existsNode = this.$getNode(this.boundParent) ?? this.#stub;
        const theirParent = isValidParent(existsNode?.parentElement) ? existsNode?.parentElement : this.boundParent;
        this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        //
        queueMicrotask(() => {
            const theirParent = isValidParent(existsNode?.parentElement) ? existsNode?.parentElement : this.boundParent;
            this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        });
        //
        return (theirParent ?? this.boundParent ?? existsNode);
    }
    //
    get element() {
        const children = this.$getNode(this.boundParent) ?? this.#stub;
        const theirParent = isValidParent(children?.parentElement) ? children?.parentElement : this.boundParent;
        this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        //
        queueMicrotask(() => {
            const theirParent = isValidParent(children?.parentElement) ? children?.parentElement : this.boundParent;
            this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        });
        //
        return children;
    }
    //
    _onUpdate(newVal, idx, oldVal, op) {
        //if (this.#updating) { return; }
        if (isPrimitive(oldVal) && isPrimitive(newVal)) {
            return;
        }
        //
        let oldEl = (isPrimitive(oldVal) ? this.#oldNode : this.$getNodeBy(this.boundParent, oldVal)); //?? this.#oldNode;
        let newEl = this.$getNode(this.boundParent, false) ?? this.#stub;
        if ((oldEl && !oldEl?.parentNode) || this.#oldNode?.parentNode) {
            oldEl = this.#oldNode ?? oldEl;
        }
        ;
        //
        let updated = this.#updater?.(newEl, indexOf(this.boundParent, oldEl), oldEl, op, this.boundParent);
        if (newEl != null && newEl != this.#oldNode) {
            this.#oldNode = newEl;
        }
        else if (newEl == null && oldEl != this.#oldNode) {
            this.#oldNode = oldEl;
        }
        ;
        return updated;
    }
}
//
const isWeakCompatible = (key) => {
    return (typeof key == "object" || typeof key == "function" || typeof key == "symbol") && key != null;
};
//
export const C = (observable, mapCb, boundParent = null) => {
    if (observable instanceof HTMLElement) {
        return Q(observable);
    }
    if (observable == null)
        return document.createComment(":NULL:");
    const checkable = (typeof mapCb == "function" ? mapCb(observable, -1) : observable) ?? observable;
    if (isPrimitive(checkable)) {
        return T(checkable);
    }
    //
    if (checkable != null && hasValue(checkable)) {
        if (isPrimitive(checkable?.value)) {
            return checkable?.value != null ? T(checkable) : document.createComment(":NULL:");
        }
        else if (typeof checkable == "object" || typeof checkable == "function") {
            // @ts-ignore
            return elMap.getOrInsertComputed(isWeakCompatible(observable) ? observable : checkable, () => {
                return new Ch(observable, mapCb, boundParent);
            });
        }
    }
    //
    return getNode(checkable, null, -1, boundParent);
};
//
export default C;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhbmdlYWJsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNoYW5nZWFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN2QyxPQUFPLEVBQWEsS0FBSyxFQUFFLE9BQU8sRUFBTSxDQUFDLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sQ0FBQyxNQUFNLFdBQVcsQ0FBQztBQU8xQixFQUFFO0FBQ0YsTUFBTSxFQUFFO0lBQ0osS0FBSyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbkMsU0FBUyxDQUFrQjtJQUMzQixVQUFVLENBQW1CO0lBQzdCLFFBQVEsR0FBUSxJQUFJLENBQUM7SUFDckIsU0FBUyxHQUFRLElBQUksQ0FBQztJQUN0QixTQUFTLEdBQVksS0FBSyxDQUFDO0lBQzNCLFFBQVEsR0FBc0IsRUFBdUIsQ0FBQztJQUN0RCxRQUFRLENBQU0sQ0FBQyxpRUFBaUU7SUFDaEYsTUFBTSxHQUFRLElBQUksQ0FBQztJQUNuQiw0REFBNEQ7SUFFNUQsRUFBRTtJQUNGLFlBQVksR0FBZ0IsSUFBSSxDQUFDO0lBRWpDLEVBQUU7SUFDRixXQUFXLENBQUMsY0FBMkIsSUFBSTtRQUN2QyxJQUFJLFdBQVcsRUFBRSxDQUFDO1lBQ2QsSUFBSSxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUM7WUFBQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztZQUFDLElBQUksQ0FBQyxRQUFRLEdB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QUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQUMsQ0FBQztJQUVwRCxFQUFFO0lBQ0YsSUFBSSxTQUFTLElBQUksSUFBSSxJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1FBQzNDLElBQUksV0FBVyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ2hDLE9BQU8sU0FBUyxFQUFFLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RixDQUFDO2FBQ0QsSUFBSSxPQUFPLFNBQVMsSUFBSSxRQUFRLElBQUksT0FBTyxTQUFTLElBQUksVUFBVSxFQUFFLENBQUM7WUFDakUsYUFBYTtZQUNiLE9BQU8sS0FBSyxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUU7Z0JBQ3pGLE9BQU8sSUFBSSxFQUFFLENBQUMsVUFBVSxFQUFFLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztZQUNsRCxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUM7SUFDTCxDQUFDO0lBRUQsRUFBRTtJQUNGLE9BQU8sT0FBTyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUM7QUFDckQsQ0FBQyxDQUFDO0FBRUYsRUFBRTtBQUNGLGVBQWUsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYWZmZWN0ZWQgfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7IGFwcGVuZEZpeCwgZWxNYXAsIGdldE5vZGUsIFBzLCBUIH0gZnJvbSBcIi4uL2NvbnRleHQvVXRpbHNcIjtcbmltcG9ydCB7IG1ha2VVcGRhdGVyIH0gZnJvbSBcIi4uL2NvbnRleHQvUmVmbGVjdENoaWxkcmVuXCI7XG5pbXBvcnQgeyBpc1ByaW1pdGl2ZSwgaGFzVmFsdWUgfSBmcm9tIFwiZmVzdC9jb3JlXCI7XG5pbXBvcnQgeyBpbmRleE9mLCBpc1ZhbGlkUGFyZW50IH0gZnJvbSBcImZlc3QvZG9tXCI7XG5pbXBvcnQgeyAkbWFwcGVkIH0gZnJvbSBcIi4uL2NvcmUvQmluZGluZ1wiO1xuaW1wb3J0IFEgZnJvbSBcIi4vUXVlcmllZFwiO1xuXG4vL1xuaW50ZXJmYWNlIENoYW5nZWFibGVPcHRpb25zIHtcbiAgICBib3VuZFBhcmVudD86IE5vZGUgfCBudWxsO1xufVxuXG4vL1xuY2xhc3MgQ2gge1xuICAgICNzdHViID0gZG9jdW1lbnQuY3JlYXRlQ29tbWVudChcIlwiKTtcbiAgICAjdmFsdWVSZWY/OiB7IHZhbHVlOiBhbnkgfTtcbiAgICAjZnJhZ21lbnRzOiBEb2N1bWVudEZyYWdtZW50O1xuICAgICN1cGRhdGVyOiBhbnkgPSBudWxsO1xuICAgICNpbnRlcm5hbDogYW55ID0gbnVsbDtcbiAgICAjdXBkYXRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICAjb3B0aW9uczogQ2hhbmdlYWJsZU9wdGlvbnMgPSB7fSBhcyBDaGFuZ2VhYmxlT3B0aW9ucztcbiAgICAjb2xkTm9kZTogYW55OyAvLyBpbiBjYXNlLCBpZiAnLnZhbHVlJyBpcyBwcmltaXRpdmUsIGFuZCBjYW4ndCBiZSByZXVzZWQgYnkgbWFwc1xuICAgICNtYXBDYjogYW55ID0gbnVsbDtcbiAgICAvLyNyZU1hcDogV2Vha01hcDxhbnksIGFueT47IC8vIHJldXNlIHNhbWUgb2JqZWN0IGZyb20gdmFsdWVcblxuICAgIC8vXG4gICAgI2JvdW5kUGFyZW50OiBOb2RlIHwgbnVsbCA9IG51bGw7XG5cbiAgICAvL1xuICAgIG1ha2VVcGRhdGVyKGJhc2lzUGFyZW50OiBOb2RlIHwgbnVsbCA9IG51bGwpIHtcbiAgICAgICAgaWYgKGJhc2lzUGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLiNpbnRlcm5hbD8uKCk7IHRoaXMuI2ludGVybmFsID0gbnVsbDsgdGhpcy4jdXBkYXRlciA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLiN1cGRhdGVyID8/PSBtYWtlVXBkYXRlcihiYXNpc1BhcmVudCwgbnVsbCwgZmFsc2UpO1xuICAgICAgICAgICAgdGhpcy4jaW50ZXJuYWwgPz89IGFmZmVjdGVkPy4oW3RoaXMuI3ZhbHVlUmVmLCBcInZhbHVlXCJdLCB0aGlzLl9vblVwZGF0ZS5iaW5kKHRoaXMpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IGJvdW5kUGFyZW50KCkgeyByZXR1cm4gdGhpcy4jYm91bmRQYXJlbnQ7IH1cbiAgICBzZXQgYm91bmRQYXJlbnQodmFsdWU6IE5vZGUgfCBudWxsKSB7XG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIGlzVmFsaWRQYXJlbnQodmFsdWUpICYmIHZhbHVlICE9IHRoaXMuI2JvdW5kUGFyZW50KSB7XG4gICAgICAgICAgICB0aGlzLiNib3VuZFBhcmVudCA9IHZhbHVlOyB0aGlzLm1ha2VVcGRhdGVyKHZhbHVlKTtcbiAgICAgICAgICAgIGlmICh0aGlzLiNvbGROb2RlKSB7XG4gICAgICAgICAgICAgICAgLy90aGlzLiNvbGROb2RlPy5wYXJlbnROb2RlICE9IG51bGwgJiYgdGhpcy4jb2xkTm9kZT8ucmVwbGFjZVdpdGg/Lih0aGlzLiNzdHViKTsgdGhpcy4jb2xkTm9kZSA9IHRoaXMuI3N0dWI7XG4gICAgICAgICAgICAgICAgdGhpcy4jb2xkTm9kZT8ucGFyZW50Tm9kZSAhPSBudWxsICYmIHRoaXMuI29sZE5vZGU/LnJlbW92ZT8uKCk7IHRoaXMuI29sZE5vZGUgPSBudWxsO1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7XG4gICAgICAgICAgICAvL2lmIChlbGVtZW50KSB7IGFwcGVuZEZpeCh0aGlzLiNib3VuZFBhcmVudCwgZWxlbWVudCk7IH07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL1xuICAgIGNvbnN0cnVjdG9yKHZhbHVlUmVmLCBtYXBDYjogYW55ID0gKGVsKSA9PiBlbCwgb3B0aW9uczogTm9kZSB8IG51bGwgfCBDaGFuZ2VhYmxlT3B0aW9ucyA9IC8qeyByZW1vdmVOb3RFeGlzdHNXaGVuSGFzUHJpbWl0aXZlczogdHJ1ZSwgdW5pcXVlUHJpbWl0aXZlczogdHJ1ZSwgcHJlTWFwOiB0cnVlIH0gYXMgTWFwcGVkT3B0aW9ucyovIG51bGwpIHtcbiAgICAgICAgdGhpcy4jc3R1YiA9IGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoXCJcIik7XG5cbiAgICAgICAgLy8gc3dhcCBhcmd1bWVudHMgKEpTWCBjb21wYXRpYmlsaXR5KVxuICAgICAgICBpZiAoaGFzVmFsdWUobWFwQ2IpICYmICgodHlwZW9mIHZhbHVlUmVmID09IFwiZnVuY3Rpb25cIiB8fCB0eXBlb2YgdmFsdWVSZWYgPT0gXCJvYmplY3RcIikgJiYgIWhhc1ZhbHVlKHZhbHVlUmVmKSkpIHtcbiAgICAgICAgICAgIFt2YWx1ZVJlZiwgbWFwQ2JdID0gW21hcENiLCB2YWx1ZVJlZl0gYXMgW2FueSwgYW55XTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIG1heSBiZSB1bmlmaWVkIHdpdGggb3B0aW9ucywgaWYgaXNuJ3QgZXhpc3RzIChKU1ggY29tcGF0aWJpbGl0eSlcbiAgICAgICAgaWYgKCFvcHRpb25zICYmIChtYXBDYiAhPSBudWxsICYmIHR5cGVvZiBtYXBDYiA9PSBcIm9iamVjdFwiKSAmJiAhaGFzVmFsdWUobWFwQ2IpKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gbWFwQ2IgYXMgQ2hhbmdlYWJsZU9wdGlvbnM7XG4gICAgICAgIH1cblxuICAgICAgICAvL1xuICAgICAgICB0aGlzLiNtYXBDYiA9IChtYXBDYiAhPSBudWxsID8gKHR5cGVvZiBtYXBDYiA9PSBcImZ1bmN0aW9uXCIgPyBtYXBDYiA6ICh0eXBlb2YgbWFwQ2IgPT0gXCJvYmplY3RcIiA/IG1hcENiPy5tYXBwZXIgOiBudWxsKSkgOiBudWxsKSA/PyAoKGVsKSA9PiBlbCk7XG4gICAgICAgIHRoaXMuI29sZE5vZGUgPSBudWxsOy8vdGhpcy4jc3R1YjtcbiAgICAgICAgdGhpcy4jdmFsdWVSZWYgID0gKCFoYXNWYWx1ZSh2YWx1ZVJlZikgPyBtYXBDYj8uKHZhbHVlUmVmLCAtMSkgOiB2YWx1ZVJlZikgPz8gdmFsdWVSZWY7XG4gICAgICAgIHRoaXMuI2ZyYWdtZW50cyA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcblxuICAgICAgICAvL1xuICAgICAgICBjb25zdCAkYmFzZU9wdGlvbnMgPSB7IHJlbW92ZU5vdEV4aXN0c1doZW5IYXNQcmltaXRpdmVzOiB0cnVlLCB1bmlxdWVQcmltaXRpdmVzOiB0cnVlLCBwcmVNYXA6IHRydWUgfSBhcyBDaGFuZ2VhYmxlT3B0aW9ucztcbiAgICAgICAgY29uc3QgJG5ld09wdGlvbnMgPSAoaXNWYWxpZFBhcmVudChvcHRpb25zIGFzIGFueSkgPyBudWxsIDogKG9wdGlvbnMgYXMgQ2hhbmdlYWJsZU9wdGlvbnN8bnVsbCkpIHx8IHt9O1xuICAgICAgICB0aGlzLiNvcHRpb25zID0gT2JqZWN0LmFzc2lnbigkYmFzZU9wdGlvbnMsICRuZXdPcHRpb25zKTtcblxuICAgICAgICAvL1xuICAgICAgICB0aGlzLmJvdW5kUGFyZW50ID0gaXNWYWxpZFBhcmVudCh0aGlzLiNvcHRpb25zPy5ib3VuZFBhcmVudCBhcyBhbnkpID8/IChpc1ZhbGlkUGFyZW50KG9wdGlvbnMgYXMgYW55KSA/PyBudWxsKTtcbiAgICB9XG5cbiAgICAvL1xuICAgICRnZXROb2RlQnkocmVxdWVzdG9yPzogYW55LCB2YWx1ZT86IGFueSkge1xuICAgICAgICBjb25zdCBub2RlID0gaXNQcmltaXRpdmUoaGFzVmFsdWUodmFsdWUpID8gdmFsdWU/LnZhbHVlIDogdmFsdWUpID8gVCh2YWx1ZSkgOiBnZXROb2RlKHZhbHVlLCAodmFsdWUgPT0gcmVxdWVzdG9yKSA/IG51bGwgOiB0aGlzLiNtYXBDYiwgLTEsIHJlcXVlc3Rvcik7XG4gICAgICAgIHJldHVybiBub2RlO1xuICAgIH1cblxuICAgIC8vXG4gICAgJGdldE5vZGUocmVxdWVzdG9yPzogYW55LCByZWFzc2lnbk9sZE5vZGU6IGJvb2xlYW4gfCBudWxsID0gdHJ1ZSkge1xuICAgICAgICAvLyBUT0RPOiByZXNvbHZlIHNvbWVob3cgcmV0dXJuaW5nIHRoaXMuI3ZhbHVlUmVmIGFzIGVsZW1lbnQuLi5cbiAgICAgICAgY29uc3Qgbm9kZSA9IGlzUHJpbWl0aXZlKHRoaXMuI3ZhbHVlUmVmPy52YWx1ZSkgPyBUKHRoaXMuI3ZhbHVlUmVmKSA6IGdldE5vZGUodGhpcy4jdmFsdWVSZWY/LnZhbHVlLCAocmVxdWVzdG9yID09IHRoaXMuI3ZhbHVlUmVmPy52YWx1ZSkgPyBudWxsIDogdGhpcy4jbWFwQ2IsIC0xLCByZXF1ZXN0b3IpO1xuICAgICAgICBpZiAobm9kZSAhPSBudWxsICYmIHJlYXNzaWduT2xkTm9kZSkgeyB0aGlzLiNvbGROb2RlID0gbm9kZTsgfTtcbiAgICAgICAgcmV0dXJuIG5vZGU7XG4gICAgfVxuXG4gICAgLy9cbiAgICBnZXQgWyRtYXBwZWRdKCkgeyByZXR1cm4gdHJ1ZTsgfVxuXG4gICAgLy9cbiAgICBlbGVtZW50Rm9yUG90ZW50aWFsUGFyZW50KHJlcXVlc3RvcjogYW55KSB7XG4gICAgICAgIC8qaWYgKGlzVmFsaWRQYXJlbnQocmVxdWVzdG9yKSkge1xuICAgICAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA9IHJlcXVlc3RvcjtcbiAgICAgICAgICAgIHRoaXMuI3ZhbHVlUmVmPy5bJHRyaWdnZXJdPy4oKTtcbiAgICAgICAgfSovXG4gICAgICAgIFByb21pc2UudHJ5KCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLiRnZXROb2RlKHJlcXVlc3Rvcik7XG4gICAgICAgICAgICBpZiAoIWVsZW1lbnQgfHwgIXJlcXVlc3RvciB8fCBlbGVtZW50Py5jb250YWlucz8uKHJlcXVlc3RvcikgfHwgcmVxdWVzdG9yID09IGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocmVxdWVzdG9yIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgJiYgaXNWYWxpZFBhcmVudChyZXF1ZXN0b3IpKSB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmZyb20ocmVxdWVzdG9yPy5jaGlsZHJlbikuZmluZCgobm9kZSkgPT4gbm9kZSA9PT0gZWxlbWVudCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA9IHJlcXVlc3RvcjtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKChyZWNvcmRzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiByZWNvcmRzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlY29yZC50eXBlID09PSBcImNoaWxkTGlzdFwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNvcmQuYWRkZWROb2Rlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb25uZWN0ZWROb2RlID0gQXJyYXkuZnJvbSgocmVjb3JkLmFkZGVkTm9kZXMgYXMgYW55KSB8fCBbXSkuZmluZCgobm9kZSkgPT4gbm9kZSA9PT0gZWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29ubmVjdGVkTm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYm91bmRQYXJlbnQgPSByZXF1ZXN0b3I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZShyZXF1ZXN0b3IsIHsgY2hpbGRMaXN0OiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk/LmNhdGNoPy4oY29uc29sZS53YXJuLmJpbmQoY29uc29sZSkpO1xuICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50O1xuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IHNlbGYoKTogSFRNTEVsZW1lbnQgfCBEb2N1bWVudEZyYWdtZW50IHwgVGV4dCB8IG51bGwge1xuICAgICAgICBjb25zdCBleGlzdHNOb2RlID0gdGhpcy4kZ2V0Tm9kZSh0aGlzLmJvdW5kUGFyZW50KSA/PyB0aGlzLiNzdHViO1xuICAgICAgICBjb25zdCB0aGVpclBhcmVudCA9IGlzVmFsaWRQYXJlbnQoZXhpc3RzTm9kZT8ucGFyZW50RWxlbWVudCkgPyBleGlzdHNOb2RlPy5wYXJlbnRFbGVtZW50IDogdGhpcy5ib3VuZFBhcmVudDtcbiAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA/Pz0gaXNWYWxpZFBhcmVudCh0aGVpclBhcmVudCkgPz8gdGhpcy5ib3VuZFBhcmVudDtcblxuICAgICAgICAvL1xuICAgICAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0aGVpclBhcmVudCA9IGlzVmFsaWRQYXJlbnQoZXhpc3RzTm9kZT8ucGFyZW50RWxlbWVudCkgPyBleGlzdHNOb2RlPy5wYXJlbnRFbGVtZW50IDogdGhpcy5ib3VuZFBhcmVudDtcbiAgICAgICAgICAgIHRoaXMuYm91bmRQYXJlbnQgPz89IGlzVmFsaWRQYXJlbnQodGhlaXJQYXJlbnQpID8/IHRoaXMuYm91bmRQYXJlbnQ7XG4gICAgICAgIH0pXG5cbiAgICAgICAgLy9cbiAgICAgICAgcmV0dXJuICh0aGVpclBhcmVudCA/PyB0aGlzLmJvdW5kUGFyZW50ID8/IGV4aXN0c05vZGUpO1xuICAgIH1cblxuICAgIC8vXG4gICAgZ2V0IGVsZW1lbnQoKTogSFRNTEVsZW1lbnQgfCBEb2N1bWVudEZyYWdtZW50IHwgVGV4dCB8IG51bGwge1xuICAgICAgICBjb25zdCBjaGlsZHJlbiA9IHRoaXMuJGdldE5vZGUodGhpcy5ib3VuZFBhcmVudCkgPz8gdGhpcy4jc3R1YjtcbiAgICAgICAgY29uc3QgdGhlaXJQYXJlbnQgPSBpc1ZhbGlkUGFyZW50KGNoaWxkcmVuPy5wYXJlbnRFbGVtZW50KSA/IGNoaWxkcmVuPy5wYXJlbnRFbGVtZW50IDogdGhpcy5ib3VuZFBhcmVudDtcbiAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA/Pz0gaXNWYWxpZFBhcmVudCh0aGVpclBhcmVudCkgPz8gdGhpcy5ib3VuZFBhcmVudDtcblxuICAgICAgICAvL1xuICAgICAgICBxdWV1ZU1pY3JvdGFzaygoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0aGVpclBhcmVudCA9IGlzVmFsaWRQYXJlbnQoY2hpbGRyZW4/LnBhcmVudEVsZW1lbnQpID8gY2hpbGRyZW4/LnBhcmVudEVsZW1lbnQgOiB0aGlzLmJvdW5kUGFyZW50O1xuICAgICAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA/Pz0gaXNWYWxpZFBhcmVudCh0aGVpclBhcmVudCkgPz8gdGhpcy5ib3VuZFBhcmVudDtcbiAgICAgICAgfSlcblxuICAgICAgICAvL1xuICAgICAgICByZXR1cm4gY2hpbGRyZW47XG4gICAgfVxuXG4gICAgLy9cbiAgICBfb25VcGRhdGUobmV3VmFsLCBpZHgsIG9sZFZhbCwgb3ApIHtcbiAgICAgICAgLy9pZiAodGhpcy4jdXBkYXRpbmcpIHsgcmV0dXJuOyB9XG4gICAgICAgIGlmIChpc1ByaW1pdGl2ZShvbGRWYWwpICYmIGlzUHJpbWl0aXZlKG5ld1ZhbCkpIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgbGV0IG9sZEVsID0gKGlzUHJpbWl0aXZlKG9sZFZhbCkgPyB0aGlzLiNvbGROb2RlIDogdGhpcy4kZ2V0Tm9kZUJ5KHRoaXMuYm91bmRQYXJlbnQsIG9sZFZhbCkpOyAvLz8/IHRoaXMuI29sZE5vZGU7XG4gICAgICAgIGxldCBuZXdFbCA9IHRoaXMuJGdldE5vZGUodGhpcy5ib3VuZFBhcmVudCwgZmFsc2UpID8/IHRoaXMuI3N0dWI7XG4gICAgICAgIGlmICgob2xkRWwgJiYgIW9sZEVsPy5wYXJlbnROb2RlKSB8fCB0aGlzLiNvbGROb2RlPy5wYXJlbnROb2RlKSB7IG9sZEVsID0gdGhpcy4jb2xkTm9kZSA/PyBvbGRFbDsgfTtcblxuICAgICAgICAvL1xuICAgICAgICBsZXQgdXBkYXRlZDogYW55ID0gdGhpcy4jdXBkYXRlcj8uKG5ld0VsLCBpbmRleE9mKHRoaXMuYm91bmRQYXJlbnQsIG9sZEVsKSwgb2xkRWwsIG9wLCB0aGlzLmJvdW5kUGFyZW50KTtcbiAgICAgICAgaWYgKG5ld0VsICE9IG51bGwgJiYgbmV3RWwgIT0gdGhpcy4jb2xkTm9kZSkgeyB0aGlzLiNvbGROb2RlID0gbmV3RWw7IH0gZWxzZVxuICAgICAgICBpZiAobmV3RWwgPT0gbnVsbCAmJiBvbGRFbCAhPSB0aGlzLiNvbGROb2RlKSB7IHRoaXMuI29sZE5vZGUgPSBvbGRFbDsgfTtcbiAgICAgICAgcmV0dXJuIHVwZGF0ZWQ7XG4gICAgfVxufVxuXG4vL1xuY29uc3QgaXNXZWFrQ29tcGF0aWJsZSA9IChrZXk6IGFueSkgPT4geyBcbiAgICByZXR1cm4gKHR5cGVvZiBrZXkgPT0gXCJvYmplY3RcIiB8fCB0eXBlb2Yga2V5ID09IFwiZnVuY3Rpb25cIiB8fCB0eXBlb2Yga2V5ID09IFwic3ltYm9sXCIpICYmIGtleSAhPSBudWxsO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IEMgPSAob2JzZXJ2YWJsZSwgbWFwQ2I/LCBib3VuZFBhcmVudDogTm9kZSB8IG51bGwgfCBDaGFuZ2VhYmxlT3B0aW9ucyA9IG51bGwpID0+IHtcbiAgICBpZiAob2JzZXJ2YWJsZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7IHJldHVybiBRKG9ic2VydmFibGUpOyB9XG4gICAgaWYgKG9ic2VydmFibGUgPT0gbnVsbCkgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoXCI6TlVMTDpcIik7XG4gICAgY29uc3QgY2hlY2thYmxlID0gKHR5cGVvZiBtYXBDYiA9PSBcImZ1bmN0aW9uXCIgPyBtYXBDYihvYnNlcnZhYmxlLCAtMSkgOiBvYnNlcnZhYmxlKSA/PyBvYnNlcnZhYmxlO1xuICAgIGlmIChpc1ByaW1pdGl2ZShjaGVja2FibGUpKSB7IHJldHVybiBUKGNoZWNrYWJsZSk7IH1cblxuICAgIC8vXG4gICAgaWYgKGNoZWNrYWJsZSAhPSBudWxsICYmIGhhc1ZhbHVlKGNoZWNrYWJsZSkpIHtcbiAgICAgICAgaWYgKGlzUHJpbWl0aXZlKGNoZWNrYWJsZT8udmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gY2hlY2thYmxlPy52YWx1ZSAhPSBudWxsID8gVChjaGVja2FibGUpIDogZG9jdW1lbnQuY3JlYXRlQ29tbWVudChcIjpOVUxMOlwiKTtcbiAgICAgICAgfSBlbHNlXG4gICAgICAgIGlmICh0eXBlb2YgY2hlY2thYmxlID09IFwib2JqZWN0XCIgfHwgdHlwZW9mIGNoZWNrYWJsZSA9PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgIHJldHVybiBlbE1hcC5nZXRPckluc2VydENvbXB1dGVkKGlzV2Vha0NvbXBhdGlibGUob2JzZXJ2YWJsZSkgPyBvYnNlcnZhYmxlIDogY2hlY2thYmxlLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDaChvYnNlcnZhYmxlLCBtYXBDYiwgYm91bmRQYXJlbnQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvL1xuICAgIHJldHVybiBnZXROb2RlKGNoZWNrYWJsZSwgbnVsbCwgLTEsIGJvdW5kUGFyZW50KTtcbn07XG5cbi8vXG5leHBvcnQgZGVmYXVsdCBDO1xuIl19
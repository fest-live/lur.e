import { addToCallChain, affected, $trigger } from "fest/object";
import { appendFix, getNode, removeChild, replaceOrSwap } from "../context/Utils";
import { contextify, isNotEqual, inProxy } from "fest/core";
import { isElement, isValidParent } from "fest/dom";
//
const $getFromMapped = (mapped, value) => {
    if ((typeof value == "number" && value < 0) || (typeof value == "string" && !value) || value == null)
        return { element: "" };
    if (mapped instanceof Map || typeof mapped?.get == "function") {
        return mapped.get(value);
    }
    if (mapped instanceof Set || typeof mapped?.has == "function") {
        return mapped.has(value) ? value : null;
    }
    return mapped?.[value] ?? { element: "" };
};
//
const getFromMapped = (mapped, value, requestor = null) => {
    return getNode($getFromMapped(mapped, value), null, -1, requestor);
};
//
export class SwM {
    #stub = document.createComment("");
    current;
    mapped;
    boundParent = null;
    //
    constructor(params, mapped) {
        this.#stub = document.createComment("");
        this.current = params?.current ?? { value: -1 };
        this.mapped = params?.mapped ?? mapped ?? [];
        //
        const us = affected([params?.current, "value"], (newVal, prop, oldVal) => this._onUpdate(newVal, prop, oldVal));
        if (us)
            addToCallChain(this, Symbol.dispose, us);
    }
    //
    get element() {
        const element = getFromMapped(this.mapped, this.current?.value ?? -1, this.boundParent) ?? this.#stub;
        const theirParent = isValidParent(element?.parentElement) ? element?.parentElement : this.boundParent;
        this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        //
        if (element != null && (element?.parentNode != this.boundParent || !element?.parentNode)) {
            if (this.boundParent) {
                appendFix(this.boundParent, element);
            }
            ;
        }
        //
        queueMicrotask(() => {
            const theirParent = isValidParent(element?.parentElement) ? element?.parentElement : this.boundParent;
            this.boundParent ??= isValidParent(theirParent) ?? this.boundParent;
        });
        //
        return element;
    }
    //
    elementForPotentialParent(requestor) {
        if (isValidParent(requestor)) {
            this.boundParent = requestor;
        }
        //
        this.current?.[$trigger]?.();
        return this.element;
    }
    //
    _onUpdate(newVal, prop, oldVal) {
        const idx = newVal ?? this.current?.value;
        if (oldVal ? isNotEqual(idx, oldVal /*this.current?.value*/) : true) {
            const old = oldVal ?? this.current?.value;
            if (this.current)
                this.current.value = idx ?? -1;
            // Find parent and new/old nodes
            const parent = getFromMapped(this.mapped, old ?? idx ?? -1)?.parentNode ?? this.boundParent;
            this.boundParent = parent ?? this.boundParent;
            const newNode = getFromMapped(this.mapped, idx ?? -1, parent) ?? this.#stub;
            const oldNode = getFromMapped(this.mapped, old ?? -1, parent);
            // Update DOM nodes accordingly
            if (isElement(parent)) {
                if (isElement(newNode)) {
                    if (isElement(oldNode)) {
                        try {
                            replaceOrSwap(parent, oldNode, newNode);
                        }
                        catch (e) {
                            console.warn(e);
                        }
                    }
                    else {
                        appendFix(parent, newNode);
                    }
                }
                else if (oldNode && !newNode) {
                    removeChild(parent, oldNode);
                }
            }
        }
    }
}
//
class SwHandler {
    constructor() { }
    //
    set(params, name, val) { return Reflect.set(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, name, val); }
    has(params, name) { return Reflect.has(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, name); }
    get(params, name, ctx) {
        if (name == "elementForPotentialParent" && (name in params || params?.[name] != null)) {
            return params?.elementForPotentialParent?.bind(params);
        }
        ;
        if (name == "element" && (name in params || params?.[name] != null)) {
            return params?.element;
        }
        ;
        if (name == "_onUpdate" && (name in params || params?.[name] != null)) {
            return params?._onUpdate?.bind(params);
        }
        ;
        return contextify(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, name);
    }
    //
    ownKeys(params) { return Reflect.ownKeys(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params); }
    apply(params, thisArg, args) { return Reflect.apply(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, thisArg, args); }
    deleteProperty(params, name) { return Reflect.deleteProperty(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, name); }
    setPrototypeOf(params, proto) { return Reflect.setPrototypeOf(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, proto); }
    getPrototypeOf(params) { return Reflect.getPrototypeOf(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params); }
    defineProperty(params, name, desc) { return Reflect.defineProperty(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, name, desc); }
    getOwnPropertyDescriptor(params, name) { return Reflect.getOwnPropertyDescriptor(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params, name); }
    preventExtensions(params) { return Reflect.preventExtensions(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params); }
    isExtensible(params) { return Reflect.isExtensible(getFromMapped(params?.mapped, params?.current?.value ?? -1) ?? params); }
}
//
export const I = (params, mapped) => {
    return inProxy?.getOrInsertComputed?.(params, () => {
        const px = new Proxy(params instanceof SwM ? params : new SwM(params, mapped), new SwHandler());
        return px;
    });
};
//
export default I;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3dpdGNoZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJTd2l0Y2hlZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakUsT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2xGLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQVFwRCxFQUFFO0FBQ0YsTUFBTSxjQUFjLEdBQUcsQ0FBQyxNQUFXLEVBQUUsS0FBbUMsRUFBRSxFQUFFO0lBQ3hFLElBQUksQ0FBQyxPQUFPLEtBQUssSUFBSSxRQUFRLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxLQUFLLElBQUksUUFBUSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxJQUFJLElBQUk7UUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBQzdILElBQUksTUFBTSxZQUFZLEdBQUcsSUFBSSxPQUFPLE1BQU0sRUFBRSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7UUFBQyxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFBQyxDQUFDO0lBQzVGLElBQUksTUFBTSxZQUFZLEdBQUcsSUFBSSxPQUFPLE1BQU0sRUFBRSxHQUFHLElBQUksVUFBVSxFQUFFLENBQUM7UUFBQyxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQUMsQ0FBQztJQUMzRyxPQUFPLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxDQUFDO0FBQzlDLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLGFBQWEsR0FBRyxDQUFDLE1BQVcsRUFBRSxLQUFtQyxFQUFFLFlBQXdCLElBQUksRUFBRSxFQUFFO0lBQ3JHLE9BQU8sT0FBTyxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQ3ZFLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLE9BQU8sR0FBRztJQUNaLEtBQUssR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLE9BQU8sQ0FBb0M7SUFDM0MsTUFBTSxDQUF5QztJQUMvQyxXQUFXLEdBQWdCLElBQUksQ0FBQztJQUVoQyxFQUFFO0lBQ0YsWUFBWSxNQUE0QixFQUFFLE1BQThDO1FBQ3BGLElBQUksQ0FBQyxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sRUFBRSxPQUFPLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNoRCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sRUFBRSxNQUFNLElBQUksTUFBTSxJQUFJLEVBQUUsQ0FBQztRQUU3QyxFQUFFO1FBQ0YsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBRSxJQUFZLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUN6SCxJQUFJLEVBQUU7WUFBRSxjQUFjLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELEVBQUU7SUFDRixJQUFJLE9BQU87UUFDUCxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN0RyxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQ3RHLElBQUksQ0FBQyxXQUFXLEtBQUssYUFBYSxDQUFDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUM7UUFFcEUsRUFBRTtRQUNGLElBQUksT0FBTyxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRSxVQUFVLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQ3ZGLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQUMsQ0FBQztZQUFBLENBQUM7UUFDcEUsQ0FBQztRQUVELEVBQUU7UUFDRixjQUFjLENBQUMsR0FBRyxFQUFFO1lBQ2hCLE1BQU0sV0FBVyxHQUFHLGFBQWEsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDdEcsSUFBSSxDQUFDLFdBQVcsS0FBSyxhQUFhLENBQUMsV0FBVyxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUN4RSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUU7UUFDRixPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0lBRUQsRUFBRTtJQUNGLHlCQUF5QixDQUFDLFNBQWM7UUFDcEMsSUFBSSxhQUFhLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsV0FBVyxHQUFHLFNBQVMsQ0FBQztRQUNqQyxDQUFDO1FBRUQsRUFBRTtRQUNGLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDN0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxFQUFFO0lBQ0YsU0FBUyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsTUFBTTtRQUMxQixNQUFNLEdBQUcsR0FBRyxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUM7UUFDMUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFBLHVCQUF1QixDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2pFLE1BQU0sR0FBRyxHQUFHLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQztZQUMxQyxJQUFJLElBQUksQ0FBQyxPQUFPO2dCQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUVqRCxnQ0FBZ0M7WUFDaEMsTUFBTSxNQUFNLEdBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLFVBQVUsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDO1lBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxNQUFNLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUM1SSxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQztZQUM1RSxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFOUQsK0JBQStCO1lBQy9CLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7Z0JBQ3BCLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7b0JBQ3JCLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUNsQixDQUFDO3dCQUFDLElBQUksQ0FBQzs0QkFBQyxhQUFhLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQzt3QkFBQyxDQUFDO3dCQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7NEJBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFBQyxDQUFDO29CQUFDLENBQUM7eUJBQ25GLENBQUM7d0JBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztvQkFBQyxDQUFDO2dCQUN2QyxDQUFDO3FCQUNELElBQUksT0FBTyxJQUFJLENBQUMsT0FBTyxFQUNuQixDQUFDO29CQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQUMsQ0FBQztZQUN6QyxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7Q0FDSjtBQUVELEVBQUU7QUFDRixNQUFNLFNBQVM7SUFDWCxnQkFBZSxDQUFDO0lBRWhCLEVBQUU7SUFDRixHQUFHLENBQUMsTUFBc0IsRUFBRSxJQUFJLEVBQUUsR0FBRyxJQUFJLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hKLEdBQUcsQ0FBQyxNQUFzQixFQUFFLElBQUksSUFBSSxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RJLEdBQUcsQ0FBQyxNQUFzQixFQUFFLElBQUksRUFBRSxHQUFHO1FBQ2pDLElBQUksSUFBSSxJQUFJLDJCQUEyQixJQUFJLENBQUMsSUFBSSxJQUFJLE1BQU0sSUFBSSxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQUMsT0FBUSxNQUFjLEVBQUUseUJBQXlCLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQUMsQ0FBQztRQUFBLENBQUM7UUFDNUosSUFBSSxJQUFJLElBQUksU0FBUyxJQUFJLENBQUMsSUFBSSxJQUFJLE1BQU0sSUFBSSxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQUMsT0FBUSxNQUFjLEVBQUUsT0FBTyxDQUFDO1FBQUMsQ0FBQztRQUFBLENBQUM7UUFDMUcsSUFBSSxJQUFJLElBQUksV0FBVyxJQUFJLENBQUMsSUFBSSxJQUFJLE1BQU0sSUFBSSxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQUMsT0FBUSxNQUFjLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUFDLENBQUM7UUFBQSxDQUFDO1FBQzVILE9BQU8sVUFBVSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ25HLENBQUM7SUFFRCxFQUFFO0lBQ0YsT0FBTyxDQUFDLE1BQXNCLElBQUksT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xJLEtBQUssQ0FBQyxNQUFzQixFQUFFLE9BQU8sRUFBRSxJQUFJLElBQUksT0FBTyxPQUFPLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUosY0FBYyxDQUFDLE1BQXNCLEVBQUUsSUFBSSxJQUFJLE9BQU8sT0FBTyxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUosY0FBYyxDQUFDLE1BQXNCLEVBQUUsS0FBSyxJQUFJLE9BQU8sT0FBTyxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUosY0FBYyxDQUFDLE1BQXNCLElBQUksT0FBTyxPQUFPLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hKLGNBQWMsQ0FBQyxNQUFzQixFQUFFLElBQUksRUFBRSxJQUFJLElBQUksT0FBTyxPQUFPLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEssd0JBQXdCLENBQUMsTUFBc0IsRUFBRSxJQUFJLElBQUksT0FBTyxPQUFPLENBQUMsd0JBQXdCLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hMLGlCQUFpQixDQUFDLE1BQXNCLElBQUksT0FBTyxPQUFPLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDdEosWUFBWSxDQUFDLE1BQXNCLElBQUksT0FBTyxPQUFPLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0NBQy9JO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQXNCLEVBQUUsTUFBOEMsRUFBRSxFQUFFO0lBQ3hGLE9BQU8sT0FBTyxFQUFFLG1CQUFtQixFQUFFLENBQUMsTUFBTSxFQUFFLEdBQUUsRUFBRTtRQUM5QyxNQUFNLEVBQUUsR0FBRyxJQUFJLEtBQUssQ0FBQyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsRUFBRSxJQUFJLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDaEcsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixlQUFlLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkZFRvQ2FsbENoYWluLCBhZmZlY3RlZCwgJHRyaWdnZXIgfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7IGFwcGVuZEZpeCwgZ2V0Tm9kZSwgcmVtb3ZlQ2hpbGQsIHJlcGxhY2VPclN3YXAgfSBmcm9tIFwiLi4vY29udGV4dC9VdGlsc1wiO1xuaW1wb3J0IHsgY29udGV4dGlmeSwgaXNOb3RFcXVhbCwgaW5Qcm94eSB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB7IGlzRWxlbWVudCwgaXNWYWxpZFBhcmVudCB9IGZyb20gXCJmZXN0L2RvbVwiO1xuXG4vL1xuZXhwb3J0IGludGVyZmFjZSBTd2l0Y2hlZFBhcmFtcyB7XG4gICAgY3VycmVudD86IHsgdmFsdWU6IHN0cmluZyB8IG51bWJlcjsgfXxudWxsOyAvLyBjYW5kaWRhdGVzXG4gICAgbWFwcGVkPzogYW55W118YW55fE1hcDxhbnksIGFueT58U2V0PGFueT58bnVsbDtcbn1cblxuLy9cbmNvbnN0ICRnZXRGcm9tTWFwcGVkID0gKG1hcHBlZDogYW55LCB2YWx1ZTogbnVtYmVyfHN0cmluZ3xudWxsfHVuZGVmaW5lZCkgPT4ge1xuICAgIGlmICgodHlwZW9mIHZhbHVlID09IFwibnVtYmVyXCIgJiYgdmFsdWUgPCAwKSB8fCAodHlwZW9mIHZhbHVlID09IFwic3RyaW5nXCIgJiYgIXZhbHVlKSB8fCB2YWx1ZSA9PSBudWxsKSByZXR1cm4geyBlbGVtZW50OiBcIlwiIH07XG4gICAgaWYgKG1hcHBlZCBpbnN0YW5jZW9mIE1hcCB8fCB0eXBlb2YgbWFwcGVkPy5nZXQgPT0gXCJmdW5jdGlvblwiKSB7IHJldHVybiBtYXBwZWQuZ2V0KHZhbHVlKTsgfVxuICAgIGlmIChtYXBwZWQgaW5zdGFuY2VvZiBTZXQgfHwgdHlwZW9mIG1hcHBlZD8uaGFzID09IFwiZnVuY3Rpb25cIikgeyByZXR1cm4gbWFwcGVkLmhhcyh2YWx1ZSkgPyB2YWx1ZSA6IG51bGw7IH1cbiAgICByZXR1cm4gbWFwcGVkPy5bdmFsdWVdID8/IHsgZWxlbWVudDogXCJcIiB9O1xufVxuXG4vL1xuY29uc3QgZ2V0RnJvbU1hcHBlZCA9IChtYXBwZWQ6IGFueSwgdmFsdWU6IG51bWJlcnxzdHJpbmd8bnVsbHx1bmRlZmluZWQsIHJlcXVlc3RvcjogYW55IHwgbnVsbCA9IG51bGwpID0+IHtcbiAgICByZXR1cm4gZ2V0Tm9kZSgkZ2V0RnJvbU1hcHBlZChtYXBwZWQsIHZhbHVlKSwgbnVsbCwgLTEsIHJlcXVlc3Rvcik7XG59XG5cbi8vXG5leHBvcnQgY2xhc3MgU3dNIGltcGxlbWVudHMgU3dpdGNoZWRQYXJhbXMge1xuICAgICNzdHViID0gZG9jdW1lbnQuY3JlYXRlQ29tbWVudChcIlwiKTtcbiAgICBjdXJyZW50PzogeyB2YWx1ZTogc3RyaW5nIHwgbnVtYmVyOyB9fG51bGw7XG4gICAgbWFwcGVkPzogYW55W118YW55fE1hcDxhbnksIGFueT58U2V0PGFueT58bnVsbDtcbiAgICBib3VuZFBhcmVudDogTm9kZSB8IG51bGwgPSBudWxsO1xuXG4gICAgLy9cbiAgICBjb25zdHJ1Y3RvcihwYXJhbXM/OiBTd2l0Y2hlZFBhcmFtc3xudWxsLCBtYXBwZWQ/OiBhbnlbXXxhbnl8TWFwPGFueSwgYW55PnxTZXQ8YW55PnxudWxsKSB7XG4gICAgICAgIHRoaXMuI3N0dWIgPSBkb2N1bWVudC5jcmVhdGVDb21tZW50KFwiXCIpO1xuICAgICAgICB0aGlzLmN1cnJlbnQgPSBwYXJhbXM/LmN1cnJlbnQgPz8geyB2YWx1ZTogLTEgfTtcbiAgICAgICAgdGhpcy5tYXBwZWQgPSBwYXJhbXM/Lm1hcHBlZCA/PyBtYXBwZWQgPz8gW107XG5cbiAgICAgICAgLy9cbiAgICAgICAgY29uc3QgdXMgPSBhZmZlY3RlZChbcGFyYW1zPy5jdXJyZW50LCBcInZhbHVlXCJdLCAobmV3VmFsLCBwcm9wLCBvbGRWYWwpID0+ICh0aGlzIGFzIGFueSkuX29uVXBkYXRlKG5ld1ZhbCwgcHJvcCwgb2xkVmFsKSk7XG4gICAgICAgIGlmICh1cykgYWRkVG9DYWxsQ2hhaW4odGhpcywgU3ltYm9sLmRpc3Bvc2UsIHVzKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIGdldCBlbGVtZW50KCk6IE5vZGUge1xuICAgICAgICBjb25zdCBlbGVtZW50ID0gZ2V0RnJvbU1hcHBlZCh0aGlzLm1hcHBlZCwgdGhpcy5jdXJyZW50Py52YWx1ZSA/PyAtMSwgdGhpcy5ib3VuZFBhcmVudCkgPz8gdGhpcy4jc3R1YjtcbiAgICAgICAgY29uc3QgdGhlaXJQYXJlbnQgPSBpc1ZhbGlkUGFyZW50KGVsZW1lbnQ/LnBhcmVudEVsZW1lbnQpID8gZWxlbWVudD8ucGFyZW50RWxlbWVudCA6IHRoaXMuYm91bmRQYXJlbnQ7XG4gICAgICAgIHRoaXMuYm91bmRQYXJlbnQgPz89IGlzVmFsaWRQYXJlbnQodGhlaXJQYXJlbnQpID8/IHRoaXMuYm91bmRQYXJlbnQ7XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYgKGVsZW1lbnQgIT0gbnVsbCAmJiAoZWxlbWVudD8ucGFyZW50Tm9kZSAhPSB0aGlzLmJvdW5kUGFyZW50IHx8ICFlbGVtZW50Py5wYXJlbnROb2RlKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuYm91bmRQYXJlbnQpIHsgYXBwZW5kRml4KHRoaXMuYm91bmRQYXJlbnQsIGVsZW1lbnQpOyB9O1xuICAgICAgICB9XG5cbiAgICAgICAgLy9cbiAgICAgICAgcXVldWVNaWNyb3Rhc2soKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGhlaXJQYXJlbnQgPSBpc1ZhbGlkUGFyZW50KGVsZW1lbnQ/LnBhcmVudEVsZW1lbnQpID8gZWxlbWVudD8ucGFyZW50RWxlbWVudCA6IHRoaXMuYm91bmRQYXJlbnQ7XG4gICAgICAgICAgICB0aGlzLmJvdW5kUGFyZW50ID8/PSBpc1ZhbGlkUGFyZW50KHRoZWlyUGFyZW50KSA/PyB0aGlzLmJvdW5kUGFyZW50O1xuICAgICAgICB9KTtcblxuICAgICAgICAvL1xuICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICB9XG5cbiAgICAvL1xuICAgIGVsZW1lbnRGb3JQb3RlbnRpYWxQYXJlbnQocmVxdWVzdG9yOiBhbnkpIHtcbiAgICAgICAgaWYgKGlzVmFsaWRQYXJlbnQocmVxdWVzdG9yKSkge1xuICAgICAgICAgICAgdGhpcy5ib3VuZFBhcmVudCA9IHJlcXVlc3RvcjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vXG4gICAgICAgIHRoaXMuY3VycmVudD8uWyR0cmlnZ2VyXT8uKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmVsZW1lbnQ7XG4gICAgfVxuXG4gICAgLy9cbiAgICBfb25VcGRhdGUobmV3VmFsLCBwcm9wLCBvbGRWYWwpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgaWR4ID0gbmV3VmFsID8/IHRoaXMuY3VycmVudD8udmFsdWU7XG4gICAgICAgIGlmIChvbGRWYWwgPyBpc05vdEVxdWFsKGlkeCwgb2xkVmFsLyp0aGlzLmN1cnJlbnQ/LnZhbHVlKi8pIDogdHJ1ZSkge1xuICAgICAgICAgICAgY29uc3Qgb2xkID0gb2xkVmFsID8/IHRoaXMuY3VycmVudD8udmFsdWU7XG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50KSB0aGlzLmN1cnJlbnQudmFsdWUgPSBpZHggPz8gLTE7XG5cbiAgICAgICAgICAgIC8vIEZpbmQgcGFyZW50IGFuZCBuZXcvb2xkIG5vZGVzXG4gICAgICAgICAgICBjb25zdCBwYXJlbnQgID0gZ2V0RnJvbU1hcHBlZCh0aGlzLm1hcHBlZCwgb2xkID8/IGlkeCA/PyAtMSk/LnBhcmVudE5vZGUgPz8gdGhpcy5ib3VuZFBhcmVudDsgdGhpcy5ib3VuZFBhcmVudCA9IHBhcmVudCA/PyB0aGlzLmJvdW5kUGFyZW50O1xuICAgICAgICAgICAgY29uc3QgbmV3Tm9kZSA9IGdldEZyb21NYXBwZWQodGhpcy5tYXBwZWQsIGlkeCA/PyAtMSwgcGFyZW50KSA/PyB0aGlzLiNzdHViO1xuICAgICAgICAgICAgY29uc3Qgb2xkTm9kZSA9IGdldEZyb21NYXBwZWQodGhpcy5tYXBwZWQsIG9sZCA/PyAtMSwgcGFyZW50KTtcblxuICAgICAgICAgICAgLy8gVXBkYXRlIERPTSBub2RlcyBhY2NvcmRpbmdseVxuICAgICAgICAgICAgaWYgKGlzRWxlbWVudChwYXJlbnQpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGlzRWxlbWVudChuZXdOb2RlKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNFbGVtZW50KG9sZE5vZGUpKVxuICAgICAgICAgICAgICAgICAgICAgICAgeyB0cnkgeyByZXBsYWNlT3JTd2FwKHBhcmVudCwgb2xkTm9kZSwgbmV3Tm9kZSk7IH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKGUpOyB9IH0gZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgeyBhcHBlbmRGaXgocGFyZW50LCBuZXdOb2RlKTsgfVxuICAgICAgICAgICAgICAgIH0gZWxzZVxuICAgICAgICAgICAgICAgIGlmIChvbGROb2RlICYmICFuZXdOb2RlKVxuICAgICAgICAgICAgICAgICAgICB7IHJlbW92ZUNoaWxkKHBhcmVudCwgb2xkTm9kZSk7IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cblxuLy9cbmNsYXNzIFN3SGFuZGxlciBpbXBsZW1lbnRzIFByb3h5SGFuZGxlcjxTd2l0Y2hlZFBhcmFtcz4ge1xuICAgIGNvbnN0cnVjdG9yKCkge31cblxuICAgIC8vXG4gICAgc2V0KHBhcmFtczogU3dpdGNoZWRQYXJhbXMsIG5hbWUsIHZhbCkgeyByZXR1cm4gUmVmbGVjdC5zZXQoZ2V0RnJvbU1hcHBlZChwYXJhbXM/Lm1hcHBlZCwgcGFyYW1zPy5jdXJyZW50Py52YWx1ZSA/PyAtMSkgPz8gcGFyYW1zLCBuYW1lLCB2YWwpOyB9XG4gICAgaGFzKHBhcmFtczogU3dpdGNoZWRQYXJhbXMsIG5hbWUpIHsgcmV0dXJuIFJlZmxlY3QuaGFzKGdldEZyb21NYXBwZWQocGFyYW1zPy5tYXBwZWQsIHBhcmFtcz8uY3VycmVudD8udmFsdWUgPz8gLTEpID8/IHBhcmFtcywgbmFtZSk7IH1cbiAgICBnZXQocGFyYW1zOiBTd2l0Y2hlZFBhcmFtcywgbmFtZSwgY3R4KSB7XG4gICAgICAgIGlmIChuYW1lID09IFwiZWxlbWVudEZvclBvdGVudGlhbFBhcmVudFwiICYmIChuYW1lIGluIHBhcmFtcyB8fCBwYXJhbXM/LltuYW1lXSAhPSBudWxsKSkgeyByZXR1cm4gKHBhcmFtcyBhcyBTd00pPy5lbGVtZW50Rm9yUG90ZW50aWFsUGFyZW50Py5iaW5kKHBhcmFtcyk7IH07XG4gICAgICAgIGlmIChuYW1lID09IFwiZWxlbWVudFwiICYmIChuYW1lIGluIHBhcmFtcyB8fCBwYXJhbXM/LltuYW1lXSAhPSBudWxsKSkgeyByZXR1cm4gKHBhcmFtcyBhcyBTd00pPy5lbGVtZW50OyB9O1xuICAgICAgICBpZiAobmFtZSA9PSBcIl9vblVwZGF0ZVwiICYmIChuYW1lIGluIHBhcmFtcyB8fCBwYXJhbXM/LltuYW1lXSAhPSBudWxsKSkgeyByZXR1cm4gKHBhcmFtcyBhcyBTd00pPy5fb25VcGRhdGU/LmJpbmQocGFyYW1zKTsgfTtcbiAgICAgICAgcmV0dXJuIGNvbnRleHRpZnkoZ2V0RnJvbU1hcHBlZChwYXJhbXM/Lm1hcHBlZCwgcGFyYW1zPy5jdXJyZW50Py52YWx1ZSA/PyAtMSkgPz8gcGFyYW1zLCBuYW1lKTtcbiAgICB9XG5cbiAgICAvL1xuICAgIG93bktleXMocGFyYW1zOiBTd2l0Y2hlZFBhcmFtcykgeyByZXR1cm4gUmVmbGVjdC5vd25LZXlzKGdldEZyb21NYXBwZWQocGFyYW1zPy5tYXBwZWQsIHBhcmFtcz8uY3VycmVudD8udmFsdWUgPz8gLTEpID8/IHBhcmFtcyk7IH1cbiAgICBhcHBseShwYXJhbXM6IFN3aXRjaGVkUGFyYW1zLCB0aGlzQXJnLCBhcmdzKSB7IHJldHVybiBSZWZsZWN0LmFwcGx5KGdldEZyb21NYXBwZWQocGFyYW1zPy5tYXBwZWQsIHBhcmFtcz8uY3VycmVudD8udmFsdWUgPz8gLTEpID8/IHBhcmFtcywgdGhpc0FyZywgYXJncyk7IH1cbiAgICBkZWxldGVQcm9wZXJ0eShwYXJhbXM6IFN3aXRjaGVkUGFyYW1zLCBuYW1lKSB7IHJldHVybiBSZWZsZWN0LmRlbGV0ZVByb3BlcnR5KGdldEZyb21NYXBwZWQocGFyYW1zPy5tYXBwZWQsIHBhcmFtcz8uY3VycmVudD8udmFsdWUgPz8gLTEpID8/IHBhcmFtcywgbmFtZSk7IH1cbiAgICBzZXRQcm90b3R5cGVPZihwYXJhbXM6IFN3aXRjaGVkUGFyYW1zLCBwcm90bykgeyByZXR1cm4gUmVmbGVjdC5zZXRQcm90b3R5cGVPZihnZXRGcm9tTWFwcGVkKHBhcmFtcz8ubWFwcGVkLCBwYXJhbXM/LmN1cnJlbnQ/LnZhbHVlID8/IC0xKSA/PyBwYXJhbXMsIHByb3RvKTsgfVxuICAgIGdldFByb3RvdHlwZU9mKHBhcmFtczogU3dpdGNoZWRQYXJhbXMpIHsgcmV0dXJuIFJlZmxlY3QuZ2V0UHJvdG90eXBlT2YoZ2V0RnJvbU1hcHBlZChwYXJhbXM/Lm1hcHBlZCwgcGFyYW1zPy5jdXJyZW50Py52YWx1ZSA/PyAtMSkgPz8gcGFyYW1zKTsgfVxuICAgIGRlZmluZVByb3BlcnR5KHBhcmFtczogU3dpdGNoZWRQYXJhbXMsIG5hbWUsIGRlc2MpIHsgcmV0dXJuIFJlZmxlY3QuZGVmaW5lUHJvcGVydHkoZ2V0RnJvbU1hcHBlZChwYXJhbXM/Lm1hcHBlZCwgcGFyYW1zPy5jdXJyZW50Py52YWx1ZSA/PyAtMSkgPz8gcGFyYW1zLCBuYW1lLCBkZXNjKTsgfVxuICAgIGdldE93blByb3BlcnR5RGVzY3JpcHRvcihwYXJhbXM6IFN3aXRjaGVkUGFyYW1zLCBuYW1lKSB7IHJldHVybiBSZWZsZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihnZXRGcm9tTWFwcGVkKHBhcmFtcz8ubWFwcGVkLCBwYXJhbXM/LmN1cnJlbnQ/LnZhbHVlID8/IC0xKSA/PyBwYXJhbXMsIG5hbWUpOyB9XG4gICAgcHJldmVudEV4dGVuc2lvbnMocGFyYW1zOiBTd2l0Y2hlZFBhcmFtcykgeyByZXR1cm4gUmVmbGVjdC5wcmV2ZW50RXh0ZW5zaW9ucyhnZXRGcm9tTWFwcGVkKHBhcmFtcz8ubWFwcGVkLCBwYXJhbXM/LmN1cnJlbnQ/LnZhbHVlID8/IC0xKSA/PyBwYXJhbXMpOyB9XG4gICAgaXNFeHRlbnNpYmxlKHBhcmFtczogU3dpdGNoZWRQYXJhbXMpIHsgcmV0dXJuIFJlZmxlY3QuaXNFeHRlbnNpYmxlKGdldEZyb21NYXBwZWQocGFyYW1zPy5tYXBwZWQsIHBhcmFtcz8uY3VycmVudD8udmFsdWUgPz8gLTEpID8/IHBhcmFtcyk7IH1cbn1cblxuLy9cbmV4cG9ydCBjb25zdCBJID0gKHBhcmFtczogU3dpdGNoZWRQYXJhbXMsIG1hcHBlZD86IGFueVtdfGFueXxNYXA8YW55LCBhbnk+fFNldDxhbnk+fG51bGwpID0+IHsgLy8gQHRzLWlnbm9yZVxuICAgIHJldHVybiBpblByb3h5Py5nZXRPckluc2VydENvbXB1dGVkPy4ocGFyYW1zLCAoKT0+e1xuICAgICAgICBjb25zdCBweCA9IG5ldyBQcm94eShwYXJhbXMgaW5zdGFuY2VvZiBTd00gPyBwYXJhbXMgOiBuZXcgU3dNKHBhcmFtcywgbWFwcGVkKSwgbmV3IFN3SGFuZGxlcigpKTtcbiAgICAgICAgcmV0dXJuIHB4O1xuICAgIH0pO1xufVxuXG4vL1xuZXhwb3J0IGRlZmF1bHQgSTtcbiJdfQ==
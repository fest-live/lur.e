import { boundBehaviors, getCorrectOrientation, orientationNumberMap, whenAnyScreenChanges, handleHidden, handleAttribute, getPadding } from "fest/dom";
import { observe, booleanRef, numberRef, affected, stringRef, ref } from "fest/object";
import { isNotEqual, isValueRef, $avoidTrigger, isObject, getValue, isPrimitive, normalizePrimitive, $getValue, deref, hasValue } from "fest/core";
import { checkboxCtrl, numberCtrl, valueCtrl } from "./Control";
import { bindCtrl, bindWith } from "./Binding";
import { setChecked } from "fest/dom";
import { getIgnoreNextPopState, setIgnoreNextPopState } from "../../extension/tasking/BackNavigation";
//
export const localStorageLinkMap = new Map();
export const localStorageLink = (existsStorage, exists, key, initial) => {
    if (key == null)
        return;
    // de-assign local storage link for key
    if (localStorageLinkMap.has(key)) {
        localStorageLinkMap.get(key)?.[0]?.();
        localStorageLinkMap.delete(key);
    }
    // @ts-ignore // assign new local storage link for key
    return localStorageLinkMap.getOrInsertComputed?.(key, () => {
        const def = (existsStorage ?? localStorage).getItem(key) ?? (initial?.value ?? initial);
        const ref = isValueRef(exists) ? exists : stringRef(def); /*if (typeof ref == "object" || typeof ref == "function")*/
        ref.value ??= def;
        const $val = new WeakRef(ref);
        const unsb = affected([ref, "value"], (val) => {
            $avoidTrigger($val?.deref?.(), () => {
                (existsStorage ?? localStorage).setItem(key, val);
            });
        });
        const list = (ev) => {
            if (ev.storageArea == (existsStorage ?? localStorage) && ev.key == key) {
                if (isNotEqual(ref.value, ev.newValue)) {
                    ref.value = ev.newValue;
                }
                ;
            }
        };
        addEventListener("storage", list);
        return [() => { unsb?.(); removeEventListener("storage", list); }, ref];
    });
};
//
const normalizeHash = (hash, withHashCharacter = true) => {
    if (hash == null)
        return (withHashCharacter ? "#" : "");
    if (!withHashCharacter && hash?.startsWith?.("#")) {
        return (hash?.replace?.("#", "") || "");
    }
    ;
    if (withHashCharacter && !hash?.startsWith?.("#")) {
        return `#${hash || ""}`;
    }
    ;
    return (withHashCharacter ? (hash?.startsWith?.("#") ? hash : `#${hash || ""}`) : hash?.replace?.("#", "")) || "";
};
//
export const hashTargetLink = (_, exists, initial, withHashCharacter = false) => {
    const locationHash = normalizeHash(normalizeHash(location?.hash || "", false) || normalizeHash(initial || "", false) || "", withHashCharacter) || "";
    //
    const ref = isValueRef(exists) ? exists : stringRef(locationHash);
    if (isObject(ref))
        ref.value ||= locationHash;
    //
    let processingStateChange = false;
    let nanoThrottle = 0;
    const evf = (ev) => {
        if (getIgnoreNextPopState())
            return;
        if (nanoThrottle <= 0) {
            nanoThrottle = 1;
            setTimeout(() => {
                const normalizedLocationHash = normalizeHash(location?.hash, false);
                const newValue = normalizeHash(normalizedLocationHash || normalizeHash(ref.value || "", false), withHashCharacter) || "";
                if (normalizeHash(ref.value, false) !== normalizeHash(newValue, false)) {
                    if (!processingStateChange) {
                        processingStateChange = true;
                        ref.value = newValue;
                        setTimeout(() => (processingStateChange = false), 0);
                    }
                }
                nanoThrottle = 0;
            }, 0);
        }
    };
    //
    const $val = new WeakRef(ref);
    const usb = affected([ref, "value"], (val) => {
        const newHash = normalizeHash(normalizeHash($getValue($val?.deref?.()) || val, false) || normalizeHash(location?.hash, false), true);
        if (newHash != location.hash) {
            $avoidTrigger($val?.deref?.(), () => {
                if (!processingStateChange) {
                    setIgnoreNextPopState(true);
                    //location.hash = `#${(newHash || location.hash)?.replace?.(/^#/, "")?.trim?.()?.replace?.(/^#/, "")?.trim?.() || ""}`;
                    history.pushState("", "", newHash || location.hash);
                    setTimeout(() => setIgnoreNextPopState(false), 0);
                }
            });
        }
    });
    //
    addEventListener("popstate", evf);
    addEventListener("hashchange", evf);
    return () => {
        usb?.();
        removeEventListener("popstate", evf);
        removeEventListener("hashchange", evf);
    };
};
//
export const matchMediaLink = (existsMedia, exists, condition) => {
    if (condition == null)
        return;
    const med = existsMedia ?? matchMedia(condition), def = med?.matches || false;
    const ref = isValueRef(exists) ? exists : booleanRef(def);
    ref.value ??= def;
    const evf = (ev) => (ref.value = ev.matches);
    med?.addEventListener?.("change", evf);
    return () => { med?.removeEventListener?.("change", evf); };
};
//
export const visibleLink = (element, exists, initial) => {
    if (element == null)
        return;
    const def = (initial?.value ?? (typeof initial != "object" ? initial : null)) ?? (element?.getAttribute?.("data-hidden") == null);
    const val = isValueRef(exists) ? exists : booleanRef(!!def);
    const usb = bindWith(element, "data-hidden", val, handleHidden);
    const evf = [(ev) => { val.value = ev?.type == "u2-hidden" ? false : true; }, { passive: true }], wel = new WeakRef(element);
    element?.addEventListener?.("u2-hidden", ...evf);
    element?.addEventListener?.("u2-appear", ...evf);
    return () => {
        const element = wel?.deref?.();
        usb?.();
        element?.removeEventListener?.("u2-hidden", ...evf);
        element?.removeEventListener?.("u2-appear", ...evf);
    };
};
//
export const attrLink = (element, exists, attribute, initial) => {
    const def = element?.getAttribute?.(attribute) ?? (typeof initial == "boolean" ? (initial ? "" : null) : getValue(initial));
    if (!element)
        return;
    const val = isValueRef(exists) ? exists : stringRef(def);
    if (isObject(val) && !normalizePrimitive(val.value))
        val.value = normalizePrimitive(def) ?? val.value ?? "";
    return bindWith(element, attribute, val, handleAttribute, null, true);
};
//
export const sizeLink = (element, exists, axis, box) => {
    const def = box == "border-box" ? element?.[axis == "inline" ? "offsetWidth" : "offsetHeight"] : (element?.[axis == "inline" ? "clientWidth" : "clientHeight"] - getPadding(element, axis));
    const val = isValueRef(exists) ? exists : numberRef(def);
    if (isObject(val))
        val.value ||= (def ?? val.value) || 1;
    const obs = new ResizeObserver((entries) => {
        if (isObject(val)) {
            if (box == "border-box") {
                val.value = axis == "inline" ? entries[0].borderBoxSize[0].inlineSize : entries[0].borderBoxSize[0].blockSize;
            }
            ;
            if (box == "content-box") {
                val.value = axis == "inline" ? entries[0].contentBoxSize[0].inlineSize : entries[0].contentBoxSize[0].blockSize;
            }
            ;
            if (box == "device-pixel-content-box") {
                val.value = axis == "inline" ? entries[0].devicePixelContentBoxSize[0].inlineSize : entries[0].devicePixelContentBoxSize[0].blockSize;
            }
            ;
        }
    });
    if ((element?.element ?? element?.self ?? element) instanceof HTMLElement) {
        obs?.observe?.(element?.element ?? element?.self ?? element, { box });
    }
    ;
    return () => obs?.disconnect?.();
};
//
export const scrollLink = (element, exists, axis, initial) => {
    const wel = element instanceof WeakRef ? element : new WeakRef(element);
    if (initial != null && typeof (initial?.value ?? initial) == "number") {
        element?.scrollTo?.({ [axis == "block" ? "top" : "left"]: (initial?.value ?? initial) });
    }
    ;
    const def = element?.[axis == "block" ? "scrollTop" : "scrollLeft"];
    const val = isValueRef(exists) ? exists : numberRef(def || 0);
    if (isObject(val))
        val.value ||= (def ?? val.value) || 1;
    val.value ||= (def ?? val.value) || 0;
    const usb = affected([val, "value"], (v) => { if (Math.abs((axis == "block" ? element?.scrollTop : element?.scrollLeft) - (val?.value ?? val)) > 0.001)
        element?.scrollTo?.({ [axis == "block" ? "top" : "left"]: (val?.value ?? val) }); });
    const scb = [(ev) => { val.value = (axis == "block" ? wel?.deref?.()?.scrollTop : wel?.deref?.()?.scrollLeft) || 0; }, { passive: true }];
    element?.addEventListener?.("scroll", ...scb);
    return () => { wel?.deref?.()?.removeEventListener?.("scroll", ...scb); usb?.(); };
};
//
export const checkedLink = (element, exists) => {
    const def = (!!element?.checked) || false;
    const val = isValueRef(exists) ? exists : booleanRef(def);
    if (isObject(val))
        val.value ??= def;
    const dbf = bindCtrl(element, checkboxCtrl(val));
    const usb = affected([val, "value"], (v) => {
        if (element && element?.checked != v) {
            setChecked(element, v);
        }
    });
    return () => { usb?.(); dbf?.(); };
};
//
export const valueLink = (element, exists) => {
    if (isPrimitive(element))
        return;
    if (!element || !(element instanceof Node || element?.element instanceof Node))
        return;
    //
    const def = element?.value ?? "";
    const val = isValueRef(exists) ? exists : stringRef(def);
    if (isObject(val))
        val.value ??= def;
    const dbf = bindCtrl(element, valueCtrl(val));
    const $val = new WeakRef(val);
    const usb = affected([val, "value"], (v) => {
        if (element && isNotEqual(element?.value, (v?.value ?? v))) {
            $avoidTrigger(deref($val), () => {
                element.value = $getValue(deref($val)) ?? $getValue(v);
                element?.dispatchEvent?.(new Event("change", { bubbles: true }));
            });
        }
    });
    return () => { usb?.(); dbf?.(); };
};
//
export const valueAsNumberLink = (element, exists) => {
    if (isPrimitive(element))
        return;
    if (!element || !(element instanceof Node || element?.element instanceof Node))
        return;
    //
    const def = Number(element?.valueAsNumber) || 0;
    const val = isValueRef(exists) ? exists : numberRef(def);
    if (isObject(val))
        val.value ??= def;
    const dbf = bindCtrl(element, numberCtrl(val));
    const usb = affected([val, "value"], (v) => {
        if (element && (element.type == "range" || element.type == "number") && typeof element?.valueAsNumber == "number" && isNotEqual(element?.valueAsNumber, v)) {
            element.valueAsNumber = Number(v);
            element?.dispatchEvent?.(new Event("change", { bubbles: true }));
        }
    });
    return () => { usb?.(); dbf?.(); };
};
//
export const observeSizeLink = (element, exists, box, styles) => {
    if (isPrimitive(element))
        return;
    if (!element || !(element instanceof Node || element?.element instanceof Node))
        return;
    //
    if (!styles)
        styles = isValueRef(exists) ? exists : observe({});
    let obs = null;
    (obs = new ResizeObserver((mut) => {
        if (box == "border-box") {
            styles.inlineSize = `${mut[0].borderBoxSize[0].inlineSize}px`;
            styles.blockSize = `${mut[0].borderBoxSize[0].blockSize}px`;
        }
        if (box == "content-box") {
            styles.inlineSize = `${mut[0].contentBoxSize[0].inlineSize}px`;
            styles.blockSize = `${mut[0].contentBoxSize[0].blockSize}px`;
        }
        if (box == "device-pixel-content-box") {
            styles.inlineSize = `${mut[0].devicePixelContentBoxSize[0].inlineSize}px`;
            styles.blockSize = `${mut[0].devicePixelContentBoxSize[0].blockSize}px`;
        }
    })).observe(element?.element ?? element?.self ?? element, { box });
    return () => { obs?.disconnect?.(); };
};
//
export const refCtl = (value) => {
    if (isPrimitive(value))
        return;
    //
    let self = null, ctl = ref(value, self = ([val, prop, old], [weak, ctl, valMap]) => boundBehaviors?.get?.(weak?.deref?.())?.values?.()?.forEach?.((beh) => {
        (beh != self ? beh : null)?.([val, prop, old], [weak, ctl, valMap]);
    }));
    return ctl;
};
//
export const orientLink = (host, exists) => {
    const orient = orientationNumberMap?.[getCorrectOrientation()] || 0;
    const def = Number(orient) || 0;
    const val = isValueRef(exists) ? exists : numberRef(def);
    if (hasValue(val))
        val.value = def;
    // !Change orientation? You are seious?!
    //affected([exists, "value"], (orient)=>{ // pickup name...
    //screen?.orientation?.lock?.($NAME$?.(orient));
    //});
    return whenAnyScreenChanges(() => {
        val.value = orientationNumberMap?.[getCorrectOrientation()] || 0;
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTGlua3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJMaW5rcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLHFCQUFxQixFQUFFLG9CQUFvQixFQUFFLG9CQUFvQixFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUErQixNQUFNLFVBQVUsQ0FBQztBQUNyTCxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkYsT0FBTyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLGtCQUFrQixFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25KLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNoRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUMvQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBRXRHLEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLEdBQUcsRUFBZSxDQUFDO0FBQzFELE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFHLENBQUMsYUFBd0IsRUFBRSxNQUFpQixFQUFFLEdBQVksRUFBRSxPQUFrQixFQUFFLEVBQUU7SUFDOUcsSUFBSSxHQUFHLElBQUksSUFBSTtRQUFFLE9BQU87SUFDeEIsdUNBQXVDO0lBQ3ZDLElBQUksbUJBQW1CLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDL0IsbUJBQW1CLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsc0RBQXNEO0lBQ3RELE9BQU8sbUJBQW1CLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRSxFQUFFO1FBQ3RELE1BQU0sR0FBRyxHQUFJLENBQUMsYUFBYSxJQUFJLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLElBQUksT0FBTyxDQUFDLENBQUM7UUFDekYsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLDJEQUEyRDtRQUFDLEdBQUcsQ0FBQyxLQUFLLEtBQUssR0FBRyxDQUFDO1FBQ3hJLE1BQU0sSUFBSSxHQUFHLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQzFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxHQUFFLEVBQUU7Z0JBQy9CLENBQUMsYUFBYSxJQUFJLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEQsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sSUFBSSxHQUFHLENBQUMsRUFBRSxFQUFFLEVBQUU7WUFBRyxJQUFJLEVBQUUsQ0FBQyxXQUFXLElBQUksQ0FBQyxhQUFhLElBQUksWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDNUYsSUFBSSxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztvQkFBQyxHQUFHLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0JBQUMsQ0FBQztnQkFBQSxDQUFDO1lBQ3pFLENBQUM7UUFBQyxDQUFDLENBQUM7UUFDSixnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDNUUsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxhQUFhLEdBQUcsQ0FBQyxJQUFtQixFQUFFLG9CQUE2QixJQUFJLEVBQUUsRUFBRTtJQUM3RSxJQUFJLElBQUksSUFBSSxJQUFJO1FBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hELElBQUksQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQUMsQ0FBQztJQUFBLENBQUM7SUFDaEcsSUFBSSxpQkFBaUIsSUFBSSxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQUMsT0FBTyxJQUFJLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQztJQUFDLENBQUM7SUFBQSxDQUFDO0lBQ2hGLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUN0SCxDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQUMsQ0FBWSxFQUFFLE1BQWlCLEVBQUUsT0FBa0IsRUFBRSxvQkFBNkIsS0FBSyxFQUFDLEVBQUU7SUFDckgsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxJQUFJLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxhQUFhLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLEVBQUUsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUM7SUFFckosRUFBRTtJQUNGLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDbEUsSUFBSSxRQUFRLENBQUMsR0FBRyxDQUFDO1FBQUUsR0FBRyxDQUFDLEtBQUssS0FBSyxZQUFZLENBQUM7SUFFOUMsRUFBRTtJQUNGLElBQUkscUJBQXFCLEdBQUcsS0FBSyxDQUFDO0lBQ2xDLElBQUksWUFBWSxHQUFHLENBQUMsQ0FBQztJQUNyQixNQUFNLEdBQUcsR0FBRyxDQUFDLEVBQUUsRUFBRSxFQUFFO1FBQ2YsSUFBSSxxQkFBcUIsRUFBRTtZQUFFLE9BQU87UUFDcEMsSUFBSSxZQUFZLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDcEIsWUFBWSxHQUFHLENBQUMsQ0FBQztZQUNqQixVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNaLE1BQU0sc0JBQXNCLEdBQUcsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ3BFLE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxzQkFBc0IsSUFBSSxhQUFhLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxFQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUUsaUJBQWlCLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3pILElBQUksYUFBYSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssYUFBYSxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDO29CQUNyRSxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQzt3QkFDekIscUJBQXFCLEdBQUcsSUFBSSxDQUFDO3dCQUM3QixHQUFHLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQzt3QkFDckIsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMscUJBQXFCLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ3pELENBQUM7Z0JBQ0wsQ0FBQztnQkFDRCxZQUFZLEdBQUcsQ0FBQyxDQUFDO1lBQ3JCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNWLENBQUM7SUFDTCxDQUFDLENBQUM7SUFFRixFQUFFO0lBQ0YsTUFBTSxJQUFJLEdBQUcsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUIsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7UUFDekMsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDckksSUFBSSxPQUFPLElBQUksUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzNCLGFBQWEsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUU7Z0JBQ2hDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO29CQUN6QixxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDNUIsdUhBQXVIO29CQUN2SCxPQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsT0FBTyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDcEQsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxFQUFFO0lBQ0YsZ0JBQWdCLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2xDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNwQyxPQUFPLEdBQUcsRUFBRTtRQUFHLEdBQUcsRUFBRSxFQUFFLENBQUM7UUFDbkIsbUJBQW1CLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3JDLG1CQUFtQixDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzQyxDQUFDLENBQUM7QUFDTixDQUFDLENBQUE7QUFFRCxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQUMsV0FBc0IsRUFBRSxNQUFpQixFQUFFLFNBQWtCLEVBQUUsRUFBRTtJQUM1RixJQUFJLFNBQVMsSUFBSSxJQUFJO1FBQUUsT0FBTztJQUM5QixNQUFNLEdBQUcsR0FBRyxXQUFXLElBQUksVUFBVSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEdBQUcsR0FBRyxHQUFHLEVBQUUsT0FBTyxJQUFJLEtBQUssQ0FBQztJQUM5RSxNQUFNLEdBQUcsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQUMsR0FBRyxDQUFDLEtBQUssS0FBSyxHQUFHLENBQUM7SUFDN0UsTUFBTSxHQUFHLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUM7SUFBQyxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDckYsT0FBTyxHQUFHLEVBQUUsR0FBRyxHQUFHLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDaEUsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLE9BQWtCLEVBQUUsTUFBaUIsRUFBRSxPQUFrQixFQUFFLEVBQUU7SUFDckYsSUFBSSxPQUFPLElBQUksSUFBSTtRQUFFLE9BQU87SUFDNUIsTUFBTSxHQUFHLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxJQUFJLENBQUMsT0FBTyxPQUFPLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUMsYUFBYSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUM7SUFDbEksTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDNUQsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLE9BQU8sRUFBRSxhQUFhLEVBQUUsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ2hFLE1BQU0sR0FBRyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxHQUFHLEdBQUcsQ0FBQyxLQUFLLEdBQUcsRUFBRSxFQUFFLElBQUksSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzdILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLFdBQVcsRUFBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQ2xELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLFdBQVcsRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQ2pELE9BQU8sR0FBRyxFQUFFO1FBQ1IsTUFBTSxPQUFPLEdBQUcsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7UUFBQyxHQUFHLEVBQUUsRUFBRSxDQUFDO1FBQ3hDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxDQUFDLFdBQVcsRUFBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQ3JELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxDQUFDLFdBQVcsRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQ3hELENBQUMsQ0FBQztBQUNOLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUcsQ0FBQyxPQUFrQixFQUFFLE1BQWlCLEVBQUUsU0FBa0IsRUFBRSxPQUFrQixFQUFFLEVBQUU7SUFDdEcsTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxPQUFPLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDNUgsSUFBSSxDQUFDLE9BQU87UUFBRSxPQUFPO0lBQUMsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvRSxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUM7UUFBRSxHQUFHLENBQUMsS0FBSyxHQUFHLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO0lBQzVHLE9BQU8sUUFBUSxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLGVBQWUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDMUUsQ0FBQyxDQUFBO0FBRUQsRUFBRTtBQUNGLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRyxDQUFDLE9BQWtCLEVBQUUsTUFBaUIsRUFBRSxJQUF5QixFQUFFLEdBQThCLEVBQUUsRUFBRTtJQUN6SCxNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksWUFBWSxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksSUFBSSxRQUFRLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLEdBQUcsVUFBVSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVMLE1BQU0sR0FBRyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7SUFBQyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUM7UUFBRSxHQUFHLENBQUMsS0FBSyxLQUFLLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbkgsTUFBTSxHQUFHLEdBQUcsSUFBSSxjQUFjLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtRQUN2QyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ2hCLElBQUksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO2dCQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsSUFBSSxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFBO1lBQUMsQ0FBQztZQUFBLENBQUM7WUFDM0ksSUFBSSxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7Z0JBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxJQUFJLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUE7WUFBQyxDQUFDO1lBQUEsQ0FBQztZQUM5SSxJQUFJLEdBQUcsSUFBSSwwQkFBMEIsRUFBRSxDQUFDO2dCQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsSUFBSSxJQUFJLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQTtZQUFDLENBQUM7WUFBQSxDQUFDO1FBQ3JMLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILElBQUksQ0FBQyxPQUFPLEVBQUUsT0FBTyxJQUFJLE9BQU8sRUFBRSxJQUFJLElBQUksT0FBTyxDQUFDLFlBQVksV0FBVyxFQUFFLENBQUM7UUFBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLENBQUMsT0FBTyxFQUFFLE9BQU8sSUFBSSxPQUFPLEVBQUUsSUFBSSxJQUFJLE9BQU8sRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFBQyxDQUFDO0lBQUEsQ0FBQztJQUN0SixPQUFPLEdBQUUsRUFBRSxDQUFBLEdBQUcsRUFBRSxVQUFVLEVBQUUsRUFBRSxDQUFDO0FBQ25DLENBQUMsQ0FBQTtBQUVELEVBQUU7QUFDRixNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxPQUFrQixFQUFFLE1BQWlCLEVBQUUsSUFBeUIsRUFBRSxPQUFrQixFQUFFLEVBQUU7SUFDL0csTUFBTSxHQUFHLEdBQUcsT0FBTyxZQUFZLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN4RSxJQUFJLE9BQU8sSUFBSSxJQUFJLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxLQUFLLElBQUksT0FBTyxDQUFDLElBQUksUUFBUSxFQUFFLENBQUM7UUFBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsS0FBSyxJQUFJLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUFDLENBQUM7SUFBQSxDQUFDO0lBQ3JLLE1BQU0sR0FBRyxHQUFHLE9BQU8sRUFBRSxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDcEUsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7SUFBQyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUM7UUFBRSxHQUFHLENBQUMsS0FBSyxLQUFLLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFBQyxHQUFHLENBQUMsS0FBSyxLQUFLLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0osTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsS0FBSztRQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxLQUFLLElBQUksR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFBLENBQUEsQ0FBQyxDQUFDLENBQUM7SUFDM08sTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLEdBQUcsR0FBRyxDQUFDLEtBQUssR0FBRyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDMUksT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFB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LDJEQUEyRDtJQUN2RCxnREFBZ0Q7SUFDcEQsS0FBSztJQUVMLE9BQU8sb0JBQW9CLENBQUMsR0FBRSxFQUFFO1FBQzVCLEdBQUcsQ0FBQyxLQUFLLEdBQUcsb0JBQW9CLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JFLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYm91bmRCZWhhdmlvcnMsIGdldENvcnJlY3RPcmllbnRhdGlvbiwgb3JpZW50YXRpb25OdW1iZXJNYXAsIHdoZW5BbnlTY3JlZW5DaGFuZ2VzLCBoYW5kbGVIaWRkZW4sIGhhbmRsZUF0dHJpYnV0ZSwgZ2V0UGFkZGluZywgYWRkRXZlbnQsIGl0ZXJhdGVDb250ZW50Qm94IH0gZnJvbSBcImZlc3QvZG9tXCI7XG5pbXBvcnQgeyBvYnNlcnZlLCBib29sZWFuUmVmLCBudW1iZXJSZWYsIGFmZmVjdGVkLCBzdHJpbmdSZWYsIHJlZiB9IGZyb20gXCJmZXN0L29iamVjdFwiO1xuaW1wb3J0IHsgaXNOb3RFcXVhbCwgaXNWYWx1ZVJlZiwgJGF2b2lkVHJpZ2dlciwgaXNPYmplY3QsIGdldFZhbHVlLCBpc1ByaW1pdGl2ZSwgbm9ybWFsaXplUHJpbWl0aXZlLCAkZ2V0VmFsdWUsIGRlcmVmLCBoYXNWYWx1ZSB9IGZyb20gXCJmZXN0L2NvcmVcIjtcbmltcG9ydCB7IGNoZWNrYm94Q3RybCwgbnVtYmVyQ3RybCwgdmFsdWVDdHJsIH0gZnJvbSBcIi4vQ29udHJvbFwiO1xuaW1wb3J0IHsgYmluZEN0cmwsIGJpbmRXaXRoIH0gZnJvbSBcIi4vQmluZGluZ1wiO1xuaW1wb3J0IHsgc2V0Q2hlY2tlZCB9IGZyb20gXCJmZXN0L2RvbVwiO1xuaW1wb3J0IHsgZ2V0SWdub3JlTmV4dFBvcFN0YXRlLCBzZXRJZ25vcmVOZXh0UG9wU3RhdGUgfSBmcm9tIFwiLi4vLi4vZXh0ZW5zaW9uL3Rhc2tpbmcvQmFja05hdmlnYXRpb25cIjtcblxuLy9cbmV4cG9ydCBjb25zdCBsb2NhbFN0b3JhZ2VMaW5rTWFwID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbmV4cG9ydCBjb25zdCBsb2NhbFN0b3JhZ2VMaW5rID0gKGV4aXN0c1N0b3JhZ2U/OiBhbnl8bnVsbCwgZXhpc3RzPzogYW55fG51bGwsIGtleT86IHN0cmluZywgaW5pdGlhbD86IGFueXxudWxsKSA9PiB7XG4gICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm47XG4gICAgLy8gZGUtYXNzaWduIGxvY2FsIHN0b3JhZ2UgbGluayBmb3Iga2V5XG4gICAgaWYgKGxvY2FsU3RvcmFnZUxpbmtNYXAuaGFzKGtleSkpIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlTGlua01hcC5nZXQoa2V5KT8uWzBdPy4oKTtcbiAgICAgICAgbG9jYWxTdG9yYWdlTGlua01hcC5kZWxldGUoa2V5KTtcbiAgICB9XG5cbiAgICAvLyBAdHMtaWdub3JlIC8vIGFzc2lnbiBuZXcgbG9jYWwgc3RvcmFnZSBsaW5rIGZvciBrZXlcbiAgICByZXR1cm4gbG9jYWxTdG9yYWdlTGlua01hcC5nZXRPckluc2VydENvbXB1dGVkPy4oa2V5LCAoKT0+e1xuICAgICAgICBjb25zdCBkZWYgID0gKGV4aXN0c1N0b3JhZ2UgPz8gbG9jYWxTdG9yYWdlKS5nZXRJdGVtKGtleSkgPz8gKGluaXRpYWw/LnZhbHVlID8/IGluaXRpYWwpO1xuICAgICAgICBjb25zdCByZWYgPSBpc1ZhbHVlUmVmKGV4aXN0cykgPyBleGlzdHMgOiBzdHJpbmdSZWYoZGVmKTsgLyppZiAodHlwZW9mIHJlZiA9PSBcIm9iamVjdFwiIHx8IHR5cGVvZiByZWYgPT0gXCJmdW5jdGlvblwiKSovIHJlZi52YWx1ZSA/Pz0gZGVmO1xuICAgICAgICBjb25zdCAkdmFsID0gbmV3IFdlYWtSZWYocmVmKTtcbiAgICAgICAgY29uc3QgdW5zYiA9IGFmZmVjdGVkKFtyZWYsIFwidmFsdWVcIl0sICh2YWwpID0+IHtcbiAgICAgICAgICAgICRhdm9pZFRyaWdnZXIoJHZhbD8uZGVyZWY/LigpLCAoKT0+e1xuICAgICAgICAgICAgICAgIChleGlzdHNTdG9yYWdlID8/IGxvY2FsU3RvcmFnZSkuc2V0SXRlbShrZXksIHZhbCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGxpc3QgPSAoZXYpID0+IHsgaWYgKGV2LnN0b3JhZ2VBcmVhID09IChleGlzdHNTdG9yYWdlID8/IGxvY2FsU3RvcmFnZSkgJiYgZXYua2V5ID09IGtleSkge1xuICAgICAgICAgICAgaWYgKGlzTm90RXF1YWwocmVmLnZhbHVlLCBldi5uZXdWYWx1ZSkpIHsgcmVmLnZhbHVlID0gZXYubmV3VmFsdWU7IH07XG4gICAgICAgIH0gfTtcbiAgICAgICAgYWRkRXZlbnRMaXN0ZW5lcihcInN0b3JhZ2VcIiwgbGlzdCk7XG4gICAgICAgIHJldHVybiBbKCkgPT4geyB1bnNiPy4oKTsgcmVtb3ZlRXZlbnRMaXN0ZW5lcihcInN0b3JhZ2VcIiwgbGlzdCk7IH0sIHJlZl07XG4gICAgfSk7XG59XG5cbi8vXG5jb25zdCBub3JtYWxpemVIYXNoID0gKGhhc2g6IHN0cmluZyB8IG51bGwsIHdpdGhIYXNoQ2hhcmFjdGVyOiBib29sZWFuID0gdHJ1ZSkgPT4ge1xuICAgIGlmIChoYXNoID09IG51bGwpIHJldHVybiAod2l0aEhhc2hDaGFyYWN0ZXIgPyBcIiNcIiA6IFwiXCIpO1xuICAgIGlmICghd2l0aEhhc2hDaGFyYWN0ZXIgJiYgaGFzaD8uc3RhcnRzV2l0aD8uKFwiI1wiKSkgeyByZXR1cm4gKGhhc2g/LnJlcGxhY2U/LihcIiNcIiwgXCJcIikgfHwgXCJcIik7IH07XG4gICAgaWYgKHdpdGhIYXNoQ2hhcmFjdGVyICYmICFoYXNoPy5zdGFydHNXaXRoPy4oXCIjXCIpKSB7IHJldHVybiBgIyR7aGFzaCB8fCBcIlwifWA7IH07XG4gICAgcmV0dXJuICh3aXRoSGFzaENoYXJhY3RlciA/IChoYXNoPy5zdGFydHNXaXRoPy4oXCIjXCIpID8gaGFzaCA6IGAjJHtoYXNoIHx8IFwiXCJ9YCkgOiBoYXNoPy5yZXBsYWNlPy4oXCIjXCIsIFwiXCIpKSB8fCBcIlwiO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IGhhc2hUYXJnZXRMaW5rID0gKF8/OiBhbnl8bnVsbCwgZXhpc3RzPzogYW55fG51bGwsIGluaXRpYWw/OiBhbnl8bnVsbCwgd2l0aEhhc2hDaGFyYWN0ZXI6IGJvb2xlYW4gPSBmYWxzZSk9PntcbiAgICBjb25zdCBsb2NhdGlvbkhhc2ggPSBub3JtYWxpemVIYXNoKG5vcm1hbGl6ZUhhc2gobG9jYXRpb24/Lmhhc2ggfHwgXCJcIiwgZmFsc2UpIHx8IG5vcm1hbGl6ZUhhc2goaW5pdGlhbCB8fCBcIlwiLCBmYWxzZSkgfHwgXCJcIiwgd2l0aEhhc2hDaGFyYWN0ZXIpIHx8IFwiXCI7XG5cbiAgICAvL1xuICAgIGNvbnN0IHJlZiA9IGlzVmFsdWVSZWYoZXhpc3RzKSA/IGV4aXN0cyA6IHN0cmluZ1JlZihsb2NhdGlvbkhhc2gpO1xuICAgIGlmIChpc09iamVjdChyZWYpKSByZWYudmFsdWUgfHw9IGxvY2F0aW9uSGFzaDtcblxuICAgIC8vXG4gICAgbGV0IHByb2Nlc3NpbmdTdGF0ZUNoYW5nZSA9IGZhbHNlO1xuICAgIGxldCBuYW5vVGhyb3R0bGUgPSAwO1xuICAgIGNvbnN0IGV2ZiA9IChldikgPT4ge1xuICAgICAgICBpZiAoZ2V0SWdub3JlTmV4dFBvcFN0YXRlKCkpIHJldHVybjtcbiAgICAgICAgaWYgKG5hbm9UaHJvdHRsZSA8PSAwKSB7XG4gICAgICAgICAgICBuYW5vVGhyb3R0bGUgPSAxO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZExvY2F0aW9uSGFzaCA9IG5vcm1hbGl6ZUhhc2gobG9jYXRpb24/Lmhhc2gsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWx1ZSA9IG5vcm1hbGl6ZUhhc2gobm9ybWFsaXplZExvY2F0aW9uSGFzaCB8fCBub3JtYWxpemVIYXNoKHJlZi52YWx1ZSB8fCBcIlwiLCBmYWxzZSksIHdpdGhIYXNoQ2hhcmFjdGVyKSB8fCBcIlwiO1xuICAgICAgICAgICAgICAgIGlmIChub3JtYWxpemVIYXNoKHJlZi52YWx1ZSwgZmFsc2UpICE9PSBub3JtYWxpemVIYXNoKG5ld1ZhbHVlLCBmYWxzZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwcm9jZXNzaW5nU3RhdGVDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NpbmdTdGF0ZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWYudmFsdWUgPSBuZXdWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gKHByb2Nlc3NpbmdTdGF0ZUNoYW5nZSA9IGZhbHNlKSwgMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmFub1Rocm90dGxlID0gMDtcbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIC8vXG4gICAgY29uc3QgJHZhbCA9IG5ldyBXZWFrUmVmKHJlZik7XG4gICAgY29uc3QgdXNiID0gYWZmZWN0ZWQoW3JlZiwgXCJ2YWx1ZVwiXSwgKHZhbCkgPT4ge1xuICAgICAgICBjb25zdCBuZXdIYXNoID0gbm9ybWFsaXplSGFzaChub3JtYWxpemVIYXNoKCRnZXRWYWx1ZSgkdmFsPy5kZXJlZj8uKCkpIHx8IHZhbCwgZmFsc2UpIHx8IG5vcm1hbGl6ZUhhc2gobG9jYXRpb24/Lmhhc2gsIGZhbHNlKSwgdHJ1ZSk7XG4gICAgICAgIGlmIChuZXdIYXNoICE9IGxvY2F0aW9uLmhhc2gpIHtcbiAgICAgICAgICAgICRhdm9pZFRyaWdnZXIoJHZhbD8uZGVyZWY/LigpLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFwcm9jZXNzaW5nU3RhdGVDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0SWdub3JlTmV4dFBvcFN0YXRlKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAvL2xvY2F0aW9uLmhhc2ggPSBgIyR7KG5ld0hhc2ggfHwgbG9jYXRpb24uaGFzaCk/LnJlcGxhY2U/LigvXiMvLCBcIlwiKT8udHJpbT8uKCk/LnJlcGxhY2U/LigvXiMvLCBcIlwiKT8udHJpbT8uKCkgfHwgXCJcIn1gO1xuICAgICAgICAgICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShcIlwiLCBcIlwiLCBuZXdIYXNoIHx8IGxvY2F0aW9uLmhhc2gpO1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHNldElnbm9yZU5leHRQb3BTdGF0ZShmYWxzZSksIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICAvL1xuICAgIGFkZEV2ZW50TGlzdGVuZXIoXCJwb3BzdGF0ZVwiLCBldmYpO1xuICAgIGFkZEV2ZW50TGlzdGVuZXIoXCJoYXNoY2hhbmdlXCIsIGV2Zik7XG4gICAgcmV0dXJuICgpID0+IHsgdXNiPy4oKTtcbiAgICAgICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcihcInBvcHN0YXRlXCIsIGV2Zik7XG4gICAgICAgIHJlbW92ZUV2ZW50TGlzdGVuZXIoXCJoYXNoY2hhbmdlXCIsIGV2Zik7XG4gICAgfTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBtYXRjaE1lZGlhTGluayA9IChleGlzdHNNZWRpYT86IGFueXxudWxsLCBleGlzdHM/OiBhbnl8bnVsbCwgY29uZGl0aW9uPzogc3RyaW5nKSA9PiB7XG4gICAgaWYgKGNvbmRpdGlvbiA9PSBudWxsKSByZXR1cm47XG4gICAgY29uc3QgbWVkID0gZXhpc3RzTWVkaWEgPz8gbWF0Y2hNZWRpYShjb25kaXRpb24pLCBkZWYgPSBtZWQ/Lm1hdGNoZXMgfHwgZmFsc2U7XG4gICAgY29uc3QgcmVmID0gaXNWYWx1ZVJlZihleGlzdHMpID8gZXhpc3RzIDogYm9vbGVhblJlZihkZWYpOyByZWYudmFsdWUgPz89IGRlZjtcbiAgICBjb25zdCBldmYgPSAoZXYpID0+IChyZWYudmFsdWUgPSBldi5tYXRjaGVzKTsgbWVkPy5hZGRFdmVudExpc3RlbmVyPy4oXCJjaGFuZ2VcIiwgZXZmKTtcbiAgICByZXR1cm4gKCkgPT4geyBtZWQ/LnJlbW92ZUV2ZW50TGlzdGVuZXI/LihcImNoYW5nZVwiLCBldmYpOyB9O1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHZpc2libGVMaW5rID0gKGVsZW1lbnQ/OiBhbnl8bnVsbCwgZXhpc3RzPzogYW55fG51bGwsIGluaXRpYWw/OiBhbnl8bnVsbCkgPT4ge1xuICAgIGlmIChlbGVtZW50ID09IG51bGwpIHJldHVybjtcbiAgICBjb25zdCBkZWYgPSAoaW5pdGlhbD8udmFsdWUgPz8gKHR5cGVvZiBpbml0aWFsICE9IFwib2JqZWN0XCIgPyBpbml0aWFsIDogbnVsbCkpID8/IChlbGVtZW50Py5nZXRBdHRyaWJ1dGU/LihcImRhdGEtaGlkZGVuXCIpID09IG51bGwpO1xuICAgIGNvbnN0IHZhbCA9IGlzVmFsdWVSZWYoZXhpc3RzKSA/IGV4aXN0cyA6IGJvb2xlYW5SZWYoISFkZWYpO1xuICAgIGNvbnN0IHVzYiA9IGJpbmRXaXRoKGVsZW1lbnQsIFwiZGF0YS1oaWRkZW5cIiwgdmFsLCBoYW5kbGVIaWRkZW4pO1xuICAgIGNvbnN0IGV2ZiA9IFsoZXYpID0+IHsgdmFsLnZhbHVlID0gZXY/LnR5cGUgPT0gXCJ1Mi1oaWRkZW5cIiA/IGZhbHNlIDogdHJ1ZTsgfSwgeyBwYXNzaXZlOiB0cnVlIH1dLCB3ZWwgPSBuZXcgV2Vha1JlZihlbGVtZW50KTtcbiAgICBlbGVtZW50Py5hZGRFdmVudExpc3RlbmVyPy4oXCJ1Mi1oaWRkZW5cIiAsIC4uLmV2Zik7XG4gICAgZWxlbWVudD8uYWRkRXZlbnRMaXN0ZW5lcj8uKFwidTItYXBwZWFyXCIsIC4uLmV2Zik7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IHdlbD8uZGVyZWY/LigpOyB1c2I/LigpO1xuICAgICAgICBlbGVtZW50Py5yZW1vdmVFdmVudExpc3RlbmVyPy4oXCJ1Mi1oaWRkZW5cIiAsIC4uLmV2Zik7XG4gICAgICAgIGVsZW1lbnQ/LnJlbW92ZUV2ZW50TGlzdGVuZXI/LihcInUyLWFwcGVhclwiLCAuLi5ldmYpO1xuICAgIH07XG59XG5cbi8vXG5leHBvcnQgY29uc3QgYXR0ckxpbmsgPSAoZWxlbWVudD86IGFueXxudWxsLCBleGlzdHM/OiBhbnl8bnVsbCwgYXR0cmlidXRlPzogc3RyaW5nLCBpbml0aWFsPzogYW55fG51bGwpID0+IHtcbiAgICBjb25zdCBkZWYgPSBlbGVtZW50Py5nZXRBdHRyaWJ1dGU/LihhdHRyaWJ1dGUpID8/ICh0eXBlb2YgaW5pdGlhbCA9PSBcImJvb2xlYW5cIiA/IChpbml0aWFsID8gXCJcIiA6IG51bGwpIDogZ2V0VmFsdWUoaW5pdGlhbCkpO1xuICAgIGlmICghZWxlbWVudCkgcmV0dXJuOyBjb25zdCB2YWwgPSBpc1ZhbHVlUmVmKGV4aXN0cykgPyBleGlzdHMgOiBzdHJpbmdSZWYoZGVmKTtcbiAgICBpZiAoaXNPYmplY3QodmFsKSAmJiAhbm9ybWFsaXplUHJpbWl0aXZlKHZhbC52YWx1ZSkpIHZhbC52YWx1ZSA9IG5vcm1hbGl6ZVByaW1pdGl2ZShkZWYpID8/IHZhbC52YWx1ZSA/PyBcIlwiO1xuICAgIHJldHVybiBiaW5kV2l0aChlbGVtZW50LCBhdHRyaWJ1dGUsIHZhbCwgaGFuZGxlQXR0cmlidXRlLCBudWxsLCB0cnVlKTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBzaXplTGluayA9IChlbGVtZW50PzogYW55fG51bGwsIGV4aXN0cz86IGFueXxudWxsLCBheGlzPzogXCJpbmxpbmVcIiB8IFwiYmxvY2tcIiwgYm94PzogUmVzaXplT2JzZXJ2ZXJCb3hPcHRpb25zKSA9PiB7XG4gICAgY29uc3QgZGVmID0gYm94ID09IFwiYm9yZGVyLWJveFwiID8gZWxlbWVudD8uW2F4aXMgPT0gXCJpbmxpbmVcIiA/IFwib2Zmc2V0V2lkdGhcIiA6IFwib2Zmc2V0SGVpZ2h0XCJdIDogKGVsZW1lbnQ/LltheGlzID09IFwiaW5saW5lXCIgPyBcImNsaWVudFdpZHRoXCIgOiBcImNsaWVudEhlaWdodFwiXSAtIGdldFBhZGRpbmcoZWxlbWVudCwgYXhpcykpO1xuICAgIGNvbnN0IHZhbCA9IGlzVmFsdWVSZWYoZXhpc3RzKSA/IGV4aXN0cyA6IG51bWJlclJlZihkZWYpOyBpZiAoaXNPYmplY3QodmFsKSkgdmFsLnZhbHVlIHx8PSAoZGVmID8/IHZhbC52YWx1ZSkgfHwgMTtcbiAgICBjb25zdCBvYnMgPSBuZXcgUmVzaXplT2JzZXJ2ZXIoKGVudHJpZXMpID0+IHtcbiAgICAgICAgaWYgKGlzT2JqZWN0KHZhbCkpIHtcbiAgICAgICAgICAgIGlmIChib3ggPT0gXCJib3JkZXItYm94XCIpIHsgdmFsLnZhbHVlID0gYXhpcyA9PSBcImlubGluZVwiID8gZW50cmllc1swXS5ib3JkZXJCb3hTaXplWzBdLmlubGluZVNpemUgOiBlbnRyaWVzWzBdLmJvcmRlckJveFNpemVbMF0uYmxvY2tTaXplIH07XG4gICAgICAgICAgICBpZiAoYm94ID09IFwiY29udGVudC1ib3hcIikgeyB2YWwudmFsdWUgPSBheGlzID09IFwiaW5saW5lXCIgPyBlbnRyaWVzWzBdLmNvbnRlbnRCb3hTaXplWzBdLmlubGluZVNpemUgOiBlbnRyaWVzWzBdLmNvbnRlbnRCb3hTaXplWzBdLmJsb2NrU2l6ZSB9O1xuICAgICAgICAgICAgaWYgKGJveCA9PSBcImRldmljZS1waXhlbC1jb250ZW50LWJveFwiKSB7IHZhbC52YWx1ZSA9IGF4aXMgPT0gXCJpbmxpbmVcIiA/IGVudHJpZXNbMF0uZGV2aWNlUGl4ZWxDb250ZW50Qm94U2l6ZVswXS5pbmxpbmVTaXplIDogZW50cmllc1swXS5kZXZpY2VQaXhlbENvbnRlbnRCb3hTaXplWzBdLmJsb2NrU2l6ZSB9O1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgaWYgKChlbGVtZW50Py5lbGVtZW50ID8/IGVsZW1lbnQ/LnNlbGYgPz8gZWxlbWVudCkgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgeyBvYnM/Lm9ic2VydmU/LihlbGVtZW50Py5lbGVtZW50ID8/IGVsZW1lbnQ/LnNlbGYgPz8gZWxlbWVudCwgeyBib3ggfSk7IH07XG4gICAgcmV0dXJuICgpPT5vYnM/LmRpc2Nvbm5lY3Q/LigpO1xufVxuXG4vL1xuZXhwb3J0IGNvbnN0IHNjcm9sbExpbmsgPSAoZWxlbWVudD86IGFueXxudWxsLCBleGlzdHM/OiBhbnl8bnVsbCwgYXhpcz86IFwiaW5saW5lXCIgfCBcImJsb2NrXCIsIGluaXRpYWw/OiBhbnl8bnVsbCkgPT4ge1xuICAgIGNvbnN0IHdlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBXZWFrUmVmID8gZWxlbWVudCA6IG5ldyBXZWFrUmVmKGVsZW1lbnQpO1xuICAgIGlmIChpbml0aWFsICE9IG51bGwgJiYgdHlwZW9mIChpbml0aWFsPy52YWx1ZSA/PyBpbml0aWFsKSA9PSBcIm51bWJlclwiKSB7IGVsZW1lbnQ/LnNjcm9sbFRvPy4oeyBbYXhpcyA9PSBcImJsb2NrXCIgPyBcInRvcFwiIDogXCJsZWZ0XCJdOiAoaW5pdGlhbD8udmFsdWUgPz8gaW5pdGlhbCkgfSk7IH07XG4gICAgY29uc3QgZGVmID0gZWxlbWVudD8uW2F4aXMgPT0gXCJibG9ja1wiID8gXCJzY3JvbGxUb3BcIiA6IFwic2Nyb2xsTGVmdFwiXTtcbiAgICBjb25zdCB2YWwgPSBpc1ZhbHVlUmVmKGV4aXN0cykgPyBleGlzdHMgOiBudW1iZXJSZWYoZGVmIHx8IDApOyBpZiAoaXNPYmplY3QodmFsKSkgdmFsLnZhbHVlIHx8PSAoZGVmID8/IHZhbC52YWx1ZSkgfHwgMTsgdmFsLnZhbHVlIHx8PSAoZGVmID8/IHZhbC52YWx1ZSkgfHwgMDtcbiAgICBjb25zdCB1c2IgPSBhZmZlY3RlZChbdmFsLCBcInZhbHVlXCJdLCAodikgPT4geyBpZiAoTWF0aC5hYnMoKGF4aXMgPT0gXCJibG9ja1wiID8gZWxlbWVudD8uc2Nyb2xsVG9wIDogZWxlbWVudD8uc2Nyb2xsTGVmdCkgLSAodmFsPy52YWx1ZSA/PyB2YWwpKSA+IDAuMDAxKSBlbGVtZW50Py5zY3JvbGxUbz8uKHsgW2F4aXMgPT0gXCJibG9ja1wiID8gXCJ0b3BcIiA6IFwibGVmdFwiXTogKHZhbD8udmFsdWUgPz8gdmFsKSB9KX0pO1xuICAgIGNvbnN0IHNjYiA9IFsoZXYpID0+IHsgdmFsLnZhbHVlID0gKGF4aXMgPT0gXCJibG9ja1wiID8gd2VsPy5kZXJlZj8uKCk/LnNjcm9sbFRvcCA6IHdlbD8uZGVyZWY/LigpPy5zY3JvbGxMZWZ0KSB8fCAwOyB9LCB7IHBhc3NpdmU6IHRydWUgfV07XG4gICAgZWxlbWVudD8uYWRkRXZlbnRMaXN0ZW5lcj8uKFwic2Nyb2xsXCIsIC4uLnNjYik7IHJldHVybiAoKT0+eyB3ZWw/LmRlcmVmPy4oKT8ucmVtb3ZlRXZlbnRMaXN0ZW5lcj8uKFwic2Nyb2xsXCIsIC4uLnNjYik7IHVzYj8uKCk7IH07XG59XG5cbi8vXG5leHBvcnQgY29uc3QgY2hlY2tlZExpbmsgPSAoZWxlbWVudD86IGFueXxudWxsLCBleGlzdHM/OiBhbnl8bnVsbCkgPT4ge1xuICAgIGNvbnN0IGRlZiA9ICghIWVsZW1lbnQ/LmNoZWNrZWQpIHx8IGZhbHNlO1xuICAgIGNvbnN0IHZhbCA9IGlzVmFsdWVSZWYoZXhpc3RzKSA/IGV4aXN0cyA6IGJvb2xlYW5SZWYoZGVmKTsgaWYgKGlzT2JqZWN0KHZhbCkpIHZhbC52YWx1ZSA/Pz0gZGVmO1xuICAgIGNvbnN0IGRiZiA9IGJpbmRDdHJsKGVsZW1lbnQsIGNoZWNrYm94Q3RybCh2YWwpKTtcbiAgICBjb25zdCB1c2IgPSBhZmZlY3RlZChbdmFsLCBcInZhbHVlXCJdLCAodikgPT4ge1xuICAgICAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50Py5jaGVja2VkICE9IHYpIHtcbiAgICAgICAgICAgIHNldENoZWNrZWQoZWxlbWVudCwgdik7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gKCk9PnsgdXNiPy4oKTsgZGJmPy4oKTsgfTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCB2YWx1ZUxpbmsgPSAoZWxlbWVudD86IGFueXxudWxsLCBleGlzdHM/OiBhbnl8bnVsbCkgPT4ge1xuICAgIGlmIChpc1ByaW1pdGl2ZShlbGVtZW50KSkgcmV0dXJuO1xuICAgIGlmICghZWxlbWVudCB8fCAhKGVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlIHx8IGVsZW1lbnQ/LmVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSkgcmV0dXJuO1xuXG4gICAgLy9cbiAgICBjb25zdCBkZWYgPSBlbGVtZW50Py52YWx1ZSA/PyBcIlwiO1xuICAgIGNvbnN0IHZhbCA9IGlzVmFsdWVSZWYoZXhpc3RzKSA/IGV4aXN0cyA6IHN0cmluZ1JlZihkZWYpOyBpZiAoaXNPYmplY3QodmFsKSkgdmFsLnZhbHVlID8/PSBkZWY7XG4gICAgY29uc3QgZGJmID0gYmluZEN0cmwoZWxlbWVudCwgdmFsdWVDdHJsKHZhbCkpO1xuICAgIGNvbnN0ICR2YWwgPSBuZXcgV2Vha1JlZih2YWwpO1xuICAgIGNvbnN0IHVzYiA9IGFmZmVjdGVkKFt2YWwsIFwidmFsdWVcIl0sICh2KSA9PiB7XG4gICAgICAgIGlmIChlbGVtZW50ICYmIGlzTm90RXF1YWwoZWxlbWVudD8udmFsdWUsICh2Py52YWx1ZSA/PyB2KSkpIHtcbiAgICAgICAgICAgICRhdm9pZFRyaWdnZXIoZGVyZWYoJHZhbCksICgpPT57XG4gICAgICAgICAgICAgICAgZWxlbWVudC52YWx1ZSA9ICRnZXRWYWx1ZShkZXJlZigkdmFsKSkgPz8gJGdldFZhbHVlKHYpO1xuICAgICAgICAgICAgICAgIGVsZW1lbnQ/LmRpc3BhdGNoRXZlbnQ/LihuZXcgRXZlbnQoXCJjaGFuZ2VcIiwgeyBidWJibGVzOiB0cnVlIH0pKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuICgpPT57IHVzYj8uKCk7IGRiZj8uKCk7IH07XG59XG5cbi8vXG5leHBvcnQgY29uc3QgdmFsdWVBc051bWJlckxpbmsgPSAoZWxlbWVudD86IGFueXxudWxsLCBleGlzdHM/OiBhbnl8bnVsbCkgPT4ge1xuICAgIGlmIChpc1ByaW1pdGl2ZShlbGVtZW50KSkgcmV0dXJuO1xuICAgIGlmICghZWxlbWVudCB8fCAhKGVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlIHx8IGVsZW1lbnQ/LmVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSkgcmV0dXJuO1xuXG4gICAgLy9cbiAgICBjb25zdCBkZWYgPSBOdW1iZXIoZWxlbWVudD8udmFsdWVBc051bWJlcikgfHwgMDtcbiAgICBjb25zdCB2YWwgPSBpc1ZhbHVlUmVmKGV4aXN0cykgPyBleGlzdHMgOiBudW1iZXJSZWYoZGVmKTsgaWYgKGlzT2JqZWN0KHZhbCkpIHZhbC52YWx1ZSA/Pz0gZGVmO1xuICAgIGNvbnN0IGRiZiA9IGJpbmRDdHJsKGVsZW1lbnQsIG51bWJlckN0cmwodmFsKSk7XG4gICAgY29uc3QgdXNiID0gYWZmZWN0ZWQoW3ZhbCwgXCJ2YWx1ZVwiXSwgKHYpID0+IHtcbiAgICAgICAgaWYgKGVsZW1lbnQgJiYgKGVsZW1lbnQudHlwZSA9PSBcInJhbmdlXCIgfHwgZWxlbWVudC50eXBlID09IFwibnVtYmVyXCIpICYmIHR5cGVvZiBlbGVtZW50Py52YWx1ZUFzTnVtYmVyID09IFwibnVtYmVyXCIgJiYgaXNOb3RFcXVhbChlbGVtZW50Py52YWx1ZUFzTnVtYmVyLCB2KSkge1xuICAgICAgICAgICAgZWxlbWVudC52YWx1ZUFzTnVtYmVyID0gTnVtYmVyKHYpO1xuICAgICAgICAgICAgZWxlbWVudD8uZGlzcGF0Y2hFdmVudD8uKG5ldyBFdmVudChcImNoYW5nZVwiLCB7IGJ1YmJsZXM6IHRydWUgfSkpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuICgpPT57IHVzYj8uKCk7IGRiZj8uKCk7IH07XG59XG5cbi8vXG5leHBvcnQgY29uc3Qgb2JzZXJ2ZVNpemVMaW5rID0gKGVsZW1lbnQ/OiBhbnl8bnVsbCwgZXhpc3RzPzogYW55fG51bGwsIGJveD86IGFueXxudWxsLCBzdHlsZXM/OiBhbnl8bnVsbCkgPT4ge1xuICAgIGlmIChpc1ByaW1pdGl2ZShlbGVtZW50KSkgcmV0dXJuO1xuICAgIGlmICghZWxlbWVudCB8fCAhKGVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlIHx8IGVsZW1lbnQ/LmVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSkgcmV0dXJuO1xuXG4gICAgLy9cbiAgICBpZiAoIXN0eWxlcykgc3R5bGVzID0gaXNWYWx1ZVJlZihleGlzdHMpID8gZXhpc3RzIDogb2JzZXJ2ZSh7fSk7IGxldCBvYnM6IGFueSA9IG51bGw7XG4gICAgKG9icyA9IG5ldyBSZXNpemVPYnNlcnZlcigobXV0KSA9PiB7XG4gICAgICAgIGlmIChib3ggPT0gXCJib3JkZXItYm94XCIpIHtcbiAgICAgICAgICAgIHN0eWxlcy5pbmxpbmVTaXplID0gYCR7bXV0WzBdLmJvcmRlckJveFNpemVbMF0uaW5saW5lU2l6ZX1weGA7XG4gICAgICAgICAgICBzdHlsZXMuYmxvY2tTaXplICA9IGAke211dFswXS5ib3JkZXJCb3hTaXplWzBdLmJsb2NrU2l6ZX1weGA7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGJveCA9PSBcImNvbnRlbnQtYm94XCIpIHtcbiAgICAgICAgICAgIHN0eWxlcy5pbmxpbmVTaXplID0gYCR7bXV0WzBdLmNvbnRlbnRCb3hTaXplWzBdLmlubGluZVNpemV9cHhgO1xuICAgICAgICAgICAgc3R5bGVzLmJsb2NrU2l6ZSAgPSBgJHttdXRbMF0uY29udGVudEJveFNpemVbMF0uYmxvY2tTaXplfXB4YDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYm94ID09IFwiZGV2aWNlLXBpeGVsLWNvbnRlbnQtYm94XCIpIHtcbiAgICAgICAgICAgIHN0eWxlcy5pbmxpbmVTaXplID0gYCR7bXV0WzBdLmRldmljZVBpeGVsQ29udGVudEJveFNpemVbMF0uaW5saW5lU2l6ZX1weGA7XG4gICAgICAgICAgICBzdHlsZXMuYmxvY2tTaXplICA9IGAke211dFswXS5kZXZpY2VQaXhlbENvbnRlbnRCb3hTaXplWzBdLmJsb2NrU2l6ZX1weGA7XG4gICAgICAgIH1cbiAgICB9KSkub2JzZXJ2ZShlbGVtZW50Py5lbGVtZW50ID8/IGVsZW1lbnQ/LnNlbGYgPz8gZWxlbWVudCwgeyBib3ggfSk7XG4gICAgcmV0dXJuICgpID0+IHsgb2JzPy5kaXNjb25uZWN0Py4oKTsgfTtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCByZWZDdGwgPSAodmFsdWU/OiBhbnl8bnVsbCkgPT4ge1xuICAgIGlmIChpc1ByaW1pdGl2ZSh2YWx1ZSkpIHJldHVybjtcblxuICAgIC8vXG4gICAgbGV0IHNlbGY6IGFueSA9IG51bGwsIGN0bCA9IHJlZih2YWx1ZSwgc2VsZiA9IChbdmFsLCBwcm9wLCBvbGRdLCBbd2VhaywgY3RsLCB2YWxNYXBdKSA9PiBib3VuZEJlaGF2aW9ycz8uZ2V0Py4od2Vhaz8uZGVyZWY/LigpKT8udmFsdWVzPy4oKT8uZm9yRWFjaD8uKChiZWgpID0+IHtcbiAgICAgICAgKGJlaCAhPSBzZWxmID8gYmVoIDogbnVsbCk/LihbdmFsLCBwcm9wLCBvbGRdLCBbd2VhaywgY3RsLCB2YWxNYXBdKTtcbiAgICB9KSk7IHJldHVybiBjdGw7XG59XG5cbi8vXG5leHBvcnQgY29uc3Qgb3JpZW50TGluayA9IChob3N0PzogYW55fG51bGwsIGV4aXN0cz86IGFueXxudWxsKT0+e1xuICAgIGNvbnN0IG9yaWVudCA9IG9yaWVudGF0aW9uTnVtYmVyTWFwPy5bZ2V0Q29ycmVjdE9yaWVudGF0aW9uKCldIHx8IDA7XG4gICAgY29uc3QgZGVmID0gTnVtYmVyKG9yaWVudCkgfHwgMDtcbiAgICBjb25zdCB2YWwgPSBpc1ZhbHVlUmVmKGV4aXN0cykgPyBleGlzdHMgOiBudW1iZXJSZWYoZGVmKTtcbiAgICBpZiAoaGFzVmFsdWUodmFsKSkgdmFsLnZhbHVlID0gZGVmO1xuXG4gICAgLy8gIUNoYW5nZSBvcmllbnRhdGlvbj8gWW91IGFyZSBzZWlvdXM/IVxuICAgIC8vYWZmZWN0ZWQoW2V4aXN0cywgXCJ2YWx1ZVwiXSwgKG9yaWVudCk9PnsgLy8gcGlja3VwIG5hbWUuLi5cbiAgICAgICAgLy9zY3JlZW4/Lm9yaWVudGF0aW9uPy5sb2NrPy4oJE5BTUUkPy4ob3JpZW50KSk7XG4gICAgLy99KTtcblxuICAgIHJldHVybiB3aGVuQW55U2NyZWVuQ2hhbmdlcygoKT0+e1xuICAgICAgICB2YWwudmFsdWUgPSBvcmllbnRhdGlvbk51bWJlck1hcD8uW2dldENvcnJlY3RPcmllbnRhdGlvbigpXSB8fCAwO1xuICAgIH0pO1xufVxuIl19
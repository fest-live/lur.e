import { stringRef, numberRef, booleanRef, deref, observe, addToCallChain, affected, computed, $trigger, ref } from "fest/object";
import { attrLink, valueLink, checkedLink, valueAsNumberLink, localStorageLink, sizeLink, scrollLink, visibleLink, matchMediaLink, orientLink, localStorageLinkMap, hashTargetLink } from "./Links";
import { addEvent, getPadding, handleAttribute } from "fest/dom";
import { elMap } from "./Binding";
import { isValidObj, WRef } from "fest/core";
import { operated } from "fest/lure";
//
export const makeRef = (host, type, link, ...args) => {
    if (link == attrLink || link == handleAttribute) {
        const exists = elMap?.get?.(host)?.get?.(handleAttribute)?.get?.(args[0])?.[0];
        if (exists) {
            return exists;
        }
        ;
    }
    const rf = (type ?? ref)?.(null), usub = link?.(host, rf, ...args);
    if (usub && rf)
        addToCallChain(rf, Symbol.dispose, usub);
    return rf;
};
//
export const orientRef = (host, ...args) => makeRef(host, numberRef, orientLink, ...args);
export const attrRef = (host, ...args) => makeRef(host, stringRef, attrLink, ...args);
export const valueRef = (host, ...args) => makeRef(host, stringRef, valueLink, ...args);
export const valueAsNumberRef = (host, ...args) => makeRef(host, numberRef, valueAsNumberLink, ...args);
export const localStorageRef = (...args) => {
    if (localStorageLinkMap.has(args[0]))
        return localStorageLinkMap.get(args[0])?.[1];
    const link = localStorageLink, type = stringRef;
    const rf = (type ?? ref)?.(null), pair = link?.(null, rf, ...args);
    const [usub, _] = pair;
    if (usub && rf)
        addToCallChain(rf, Symbol.dispose, usub);
    /*localStorageLinkMap.set(args[0], pair);*/ return rf;
};
//
export const sizeRef = (host, ...args) => makeRef(host, numberRef, sizeLink, ...args);
export const checkedRef = (host, ...args) => makeRef(host, booleanRef, checkedLink, ...args);
export const scrollRef = (host, ...args) => makeRef(host, numberRef, scrollLink, ...args);
export const visibleRef = (host, ...args) => makeRef(host, booleanRef, visibleLink, ...args);
export const matchMediaRef = (...args) => makeRef(null, booleanRef, matchMediaLink, ...args);
export const hashTargetRef = (...args) => makeRef(null, stringRef, hashTargetLink, ...args);
//
export const makeWeakRef = (/*host?: any,*/ initial, behavior) => {
    const obj = deref(initial);
    return isValidObj(obj) ? observe(WRef(obj)) : ref(obj, behavior);
};
//
export const scrollSize = (source, axis = 0, inputChange) => {
    const target = toRef(source);
    const compute = (vl) => ((deref(target)?.[['scrollWidth', 'scrollHeight'][axis] || 'scrollWidth'] - 1) || 1);
    const scroll = scrollRef(source, ["inline", "block"][axis]);
    const conRef = sizeRef(source, ["inline", "block"][axis], "content-box");
    const percent = computed(scroll, compute);
    const recompute = () => { scroll?.[$trigger]?.(); percent?.[$trigger]?.(); };
    //
    affected(conRef, (vl) => { recompute?.(); });
    addEvent(inputChange || source, "input", () => { recompute?.(); });
    addEvent(inputChange || source, "change", () => { recompute?.(); });
    queueMicrotask(() => { recompute?.(); });
    return percent;
};
// Enhanced reactive scrollbar sizing with CSS calc integration
export const reactiveScrollbarSize = (source, axis, contentSize) => {
    const containerSize = axis === 0
        ? operated([], () => source.clientWidth)
        : operated([], () => source.clientHeight);
    return operated([containerSize, contentSize], () => {
        const ratio = containerSize.value / contentSize.value;
        const minSize = 20; // Minimum thumb size in pixels
        return Math.max(minSize, ratio * containerSize.value);
    });
};
// All classes are exported above when declared
export const paddingBoxSize = (source, axis, inputChange) => {
    const target = asWeak(source);
    const scroll = scrollRef(source, ["inline", "block"][axis]);
    const conRef = sizeRef(source, ["inline", "block"][axis], "content-box");
    const content = computed(conRef, (v) => (v + (getPadding(source, ["inline", "block"][axis]) || 0)));
    const recompute = () => { conRef?.[$trigger]?.(); content?.[$trigger]?.(); };
    //
    affected(scroll, (vl) => { recompute?.(); });
    addEvent(inputChange || source, "input", () => { recompute?.(); });
    addEvent(inputChange || source, "change", () => { recompute?.(); });
    queueMicrotask(() => { recompute?.(); });
    return content;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVmcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlJlZnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNsSSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLFVBQVUsRUFBRSxtQkFBbUIsRUFBRSxjQUFjLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDcE0sT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDN0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUVyQyxFQUFFO0FBQ0YsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLENBQUMsSUFBVSxFQUFFLElBQVUsRUFBRSxJQUFVLEVBQUUsR0FBRyxJQUFJLEVBQUMsRUFBRTtJQUNsRSxJQUFJLElBQUksSUFBSSxRQUFRLElBQUksSUFBSSxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBQzlDLE1BQU0sTUFBTSxHQUFHLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxlQUFlLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9FLElBQUksTUFBTSxFQUFF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RUFBQyxFQUFFLENBQUEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFHLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBeUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoSSxNQUFNLFNBQVMsR0FBRyxHQUFFLEVBQUUsR0FBRSxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFFMUUsRUFBRTtJQUNGLFFBQVEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFPLEVBQUMsRUFBRSxHQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRCxRQUFRLENBQUMsV0FBVyxJQUFJLE1BQU0sRUFBRSxPQUFPLEVBQUcsR0FBRSxFQUFFLEdBQUUsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLFFBQVEsQ0FBQyxXQUFXLElBQUksTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFFLEVBQUUsR0FBRSxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbEUsY0FBYyxDQUFDLEdBQUUsRUFBRSxHQUFFLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2QyxPQUFPLE9BQU8sQ0FBQztBQUNuQixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzdHJpbmdSZWYsIG51bWJlclJlZiwgYm9vbGVhblJlZiwgZGVyZWYsIG9ic2VydmUsIGFkZFRvQ2FsbENoYWluLCBhZmZlY3RlZCwgY29tcHV0ZWQsICR0cmlnZ2VyLCByZWYgfSBmcm9tIFwiZmVzdC9vYmplY3RcIjtcbmltcG9ydCB7IGF0dHJMaW5rLCB2YWx1ZUxpbmssIGNoZWNrZWRMaW5rLCB2YWx1ZUFzTnVtYmVyTGluaywgbG9jYWxTdG9yYWdlTGluaywgc2l6ZUxpbmssIHNjcm9sbExpbmssIHZpc2libGVMaW5rLCBtYXRjaE1lZGlhTGluaywgb3JpZW50TGluaywgbG9jYWxTdG9yYWdlTGlua01hcCwgaGFzaFRhcmdldExpbmsgfSBmcm9tIFwiLi9MaW5rc1wiO1xuaW1wb3J0IHsgYWRkRXZlbnQsIGdldFBhZGRpbmcsIGhhbmRsZUF0dHJpYnV0ZSB9IGZyb20gXCJmZXN0L2RvbVwiO1xuaW1wb3J0IHsgZWxNYXAgfSBmcm9tIFwiLi9CaW5kaW5nXCI7XG5pbXBvcnQgeyBpc1ZhbGlkT2JqLCBXUmVmIH0gZnJvbSBcImZlc3QvY29yZVwiO1xuaW1wb3J0IHsgb3BlcmF0ZWQgfSBmcm9tIFwiZmVzdC9sdXJlXCI7XG5cbi8vXG5leHBvcnQgY29uc3QgbWFrZVJlZiA9IChob3N0PzogYW55LCB0eXBlPzogYW55LCBsaW5rPzogYW55LCAuLi5hcmdzKT0+e1xuICAgIGlmIChsaW5rID09IGF0dHJMaW5rIHx8IGxpbmsgPT0gaGFuZGxlQXR0cmlidXRlKSB7XG4gICAgICAgIGNvbnN0IGV4aXN0cyA9IGVsTWFwPy5nZXQ/Lihob3N0KT8uZ2V0Py4oaGFuZGxlQXR0cmlidXRlKT8uZ2V0Py4oYXJnc1swXSk/LlswXTtcbiAgICAgICAgaWYgKGV4aXN0cykgeyByZXR1cm4gZXhpc3RzOyB9O1xuICAgIH1cbiAgICBjb25zdCByZiA9ICh0eXBlID8/IHJlZik/LihudWxsKSwgdXN1YiA9IGxpbms/Lihob3N0LCByZiwgLi4uYXJncyk7XG4gICAgaWYgKHVzdWIgJiYgcmYpIGFkZFRvQ2FsbENoYWluKHJmLCBTeW1ib2wuZGlzcG9zZSwgdXN1Yik7IHJldHVybiByZjtcbn1cblxuLy9cbmV4cG9ydCBjb25zdCBvcmllbnRSZWYgPSAoaG9zdD86IGFueSwgLi4uYXJncyk9Pm1ha2VSZWYoaG9zdCwgbnVtYmVyUmVmLCBvcmllbnRMaW5rLCAuLi5hcmdzKTtcbmV4cG9ydCBjb25zdCBhdHRyUmVmID0gKGhvc3Q/OiBhbnksIC4uLmFyZ3MpPT5tYWtlUmVmKGhvc3QsIHN0cmluZ1JlZiwgYXR0ckxpbmssIC4uLmFyZ3MpO1xuZXhwb3J0IGNvbnN0IHZhbHVlUmVmID0gKGhvc3Q/OiBhbnksIC4uLmFyZ3MpPT5tYWtlUmVmKGhvc3QsIHN0cmluZ1JlZiwgdmFsdWVMaW5rLCAuLi5hcmdzKTtcbmV4cG9ydCBjb25zdCB2YWx1ZUFzTnVtYmVyUmVmID0gKGhvc3Q/OiBhbnksIC4uLmFyZ3MpPT5tYWtlUmVmKGhvc3QsIG51bWJlclJlZiwgdmFsdWVBc051bWJlckxpbmssIC4uLmFyZ3MpO1xuZXhwb3J0IGNvbnN0IGxvY2FsU3RvcmFnZVJlZiA9ICguLi5hcmdzKT0+e1xuICAgIGlmIChsb2NhbFN0b3JhZ2VMaW5rTWFwLmhhcyhhcmdzWzBdKSkgcmV0dXJuIGxvY2FsU3RvcmFnZUxpbmtNYXAuZ2V0KGFyZ3NbMF0pPy5bMV07XG4gICAgY29uc3QgbGluazogYW55ID0gbG9jYWxTdG9yYWdlTGluaywgdHlwZTogYW55ID0gc3RyaW5nUmVmO1xuICAgIGNvbnN0IHJmID0gKHR5cGUgPz8gcmVmKT8uKG51bGwpLCBwYWlyID0gbGluaz8uKG51bGwsIHJmLCAuLi5hcmdzKTtcbiAgICBjb25zdCBbdXN1YiwgX10gPSBwYWlyO1xuICAgIGlmICh1c3ViICYmIHJmKSBhZGRUb0NhbGxDaGFpbihyZiwgU3ltYm9sLmRpc3Bvc2UsIHVzdWIpO1xuICAgIC8qbG9jYWxTdG9yYWdlTGlua01hcC5zZXQoYXJnc1swXSwgcGFpcik7Ki8gcmV0dXJuIHJmO1xufTtcblxuLy9cbmV4cG9ydCBjb25zdCBzaXplUmVmID0gKGhvc3Q/OiBhbnksIC4uLmFyZ3MpPT5tYWtlUmVmKGhvc3QsIG51bWJlclJlZiwgc2l6ZUxpbmssIC4uLmFyZ3MpO1xuZXhwb3J0IGNvbnN0IGNoZWNrZWRSZWYgPSAoaG9zdD86IGFueSwgLi4uYXJncyk9Pm1ha2VSZWYoaG9zdCwgYm9vbGVhblJlZiwgY2hlY2tlZExpbmssIC4uLmFyZ3MpO1xuZXhwb3J0IGNvbnN0IHNjcm9sbFJlZiA9IChob3N0PzogYW55LCAuLi5hcmdzKT0+bWFrZVJlZihob3N0LCBudW1iZXJSZWYsIHNjcm9sbExpbmssIC4uLmFyZ3MpO1xuZXhwb3J0IGNvbnN0IHZpc2libGVSZWYgPSAoaG9zdD86IGFueSwgLi4uYXJncyk9Pm1ha2VSZWYoaG9zdCwgYm9vbGVhblJlZiwgdmlzaWJsZUxpbmssIC4uLmFyZ3MpO1xuZXhwb3J0IGNvbnN0IG1hdGNoTWVkaWFSZWYgPSAoLi4uYXJncyk9Pm1ha2VSZWYobnVsbCwgYm9vbGVhblJlZiwgbWF0Y2hNZWRpYUxpbmssIC4uLmFyZ3MpO1xuZXhwb3J0IGNvbnN0IGhhc2hUYXJnZXRSZWYgPSAoLi4uYXJncyk9Pm1ha2VSZWYobnVsbCwgc3RyaW5nUmVmLCBoYXNoVGFyZ2V0TGluaywgLi4uYXJncyk7XG5cbi8vXG5leHBvcnQgY29uc3QgbWFrZVdlYWtSZWYgPSAoLypob3N0PzogYW55LCovIGluaXRpYWw/OiBhbnksIGJlaGF2aW9yPzogYW55KT0+e1xuICAgIGNvbnN0IG9iaiA9IGRlcmVmKGluaXRpYWwpO1xuICAgIHJldHVybiBpc1ZhbGlkT2JqKG9iaikgPyBvYnNlcnZlKFdSZWYob2JqKSkgOiByZWYob2JqLCBiZWhhdmlvcik7XG59O1xuXG4vL1xuZXhwb3J0IGNvbnN0IHNjcm9sbFNpemUgID0gKHNvdXJjZTogSFRNTEVsZW1lbnQsIGF4aXM6IG51bWJlciA9IDAsIGlucHV0Q2hhbmdlPzogYW55fG51bGwpPT57IC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCB0YXJnZXQgID0gdG9SZWYoc291cmNlKTtcbiAgICBjb25zdCBjb21wdXRlID0gKHZsOiBhbnkpPT4oKGRlcmVmKHRhcmdldCk/LltbJ3Njcm9sbFdpZHRoJywgJ3Njcm9sbEhlaWdodCddW2F4aXNdIHx8ICdzY3JvbGxXaWR0aCddIC0gMSkgfHwgMSk7XG4gICAgY29uc3Qgc2Nyb2xsICA9IHNjcm9sbFJlZihzb3VyY2UsIChbXCJpbmxpbmVcIiwgXCJibG9ja1wiXSBhcyBbXCJpbmxpbmVcIiwgXCJibG9ja1wiXSlbYXhpc10pO1xuICAgIGNvbnN0IGNvblJlZiAgPSBzaXplUmVmKHNvdXJjZSwgKFtcImlubGluZVwiLCBcImJsb2NrXCJdIGFzIFtcImlubGluZVwiLCBcImJsb2NrXCJdKVtheGlzXSwgXCJjb250ZW50LWJveFwiKTtcbiAgICBjb25zdCBwZXJjZW50ID0gY29tcHV0ZWQoc2Nyb2xsLCBjb21wdXRlKTtcbiAgICBjb25zdCByZWNvbXB1dGUgPSAoKT0+eyBzY3JvbGw/LlskdHJpZ2dlcl0/LigpOyBwZXJjZW50Py5bJHRyaWdnZXJdPy4oKTsgfVxuXG4gICAgLy9cbiAgICBhZmZlY3RlZChjb25SZWYsICh2bDogYW55KT0+eyByZWNvbXB1dGU/LigpOyB9KTtcbiAgICBhZGRFdmVudChpbnB1dENoYW5nZSB8fCBzb3VyY2UsIFwiaW5wdXRcIiAsICgpPT57IHJlY29tcHV0ZT8uKCk7IH0pO1xuICAgIGFkZEV2ZW50KGlucHV0Q2hhbmdlIHx8IHNvdXJjZSwgXCJjaGFuZ2VcIiwgKCk9PnsgcmVjb21wdXRlPy4oKTsgfSk7XG4gICAgcXVldWVNaWNyb3Rhc2soKCk9PnsgcmVjb21wdXRlPy4oKTsgfSk7XG4gICAgcmV0dXJuIHBlcmNlbnQ7XG59XG5cbi8vIEVuaGFuY2VkIHJlYWN0aXZlIHNjcm9sbGJhciBzaXppbmcgd2l0aCBDU1MgY2FsYyBpbnRlZ3JhdGlvblxuZXhwb3J0IGNvbnN0IHJlYWN0aXZlU2Nyb2xsYmFyU2l6ZSA9IChzb3VyY2U6IEhUTUxFbGVtZW50LCBheGlzOiBudW1iZXIsIGNvbnRlbnRTaXplOiBSZXR1cm5UeXBlPHR5cGVvZiBudW1iZXJSZWY+KSA9PiB7XG4gICAgY29uc3QgY29udGFpbmVyU2l6ZSA9IGF4aXMgPT09IDBcbiAgICAgICAgPyBvcGVyYXRlZChbXSwgKCkgPT4gc291cmNlLmNsaWVudFdpZHRoKVxuICAgICAgICA6IG9wZXJhdGVkKFtdLCAoKSA9PiBzb3VyY2UuY2xpZW50SGVpZ2h0KTtcblxuICAgIHJldHVybiBvcGVyYXRlZChbY29udGFpbmVyU2l6ZSwgY29udGVudFNpemVdLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJhdGlvID0gY29udGFpbmVyU2l6ZS52YWx1ZSAvIGNvbnRlbnRTaXplLnZhbHVlO1xuICAgICAgICBjb25zdCBtaW5TaXplID0gMjA7IC8vIE1pbmltdW0gdGh1bWIgc2l6ZSBpbiBwaXhlbHNcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KG1pblNpemUsIHJhdGlvICogY29udGFpbmVyU2l6ZS52YWx1ZSk7XG4gICAgfSk7XG59O1xuXG4vLyBBbGwgY2xhc3NlcyBhcmUgZXhwb3J0ZWQgYWJvdmUgd2hlbiBkZWNsYXJlZFxuZXhwb3J0IGNvbnN0IHBhZGRpbmdCb3hTaXplICA9IChzb3VyY2U6IEhUTUxFbGVtZW50LCBheGlzOiBudW1iZXIsIGlucHV0Q2hhbmdlPzogYW55fG51bGwpPT57IC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCB0YXJnZXQgID0gYXNXZWFrKHNvdXJjZSk7XG4gICAgY29uc3Qgc2Nyb2xsICA9IHNjcm9sbFJlZihzb3VyY2UsIChbXCJpbmxpbmVcIiwgXCJibG9ja1wiXSBhcyBbXCJpbmxpbmVcIiwgXCJibG9ja1wiXSlbYXhpc10pO1xuICAgIGNvbnN0IGNvblJlZiAgPSBzaXplUmVmKHNvdXJjZSwgKFtcImlubGluZVwiLCBcImJsb2NrXCJdIGFzIFtcImlubGluZVwiLCBcImJsb2NrXCJdKVtheGlzXSwgXCJjb250ZW50LWJveFwiKTtcbiAgICBjb25zdCBjb250ZW50ID0gY29tcHV0ZWQoY29uUmVmLCAodjogYW55KT0+KHYgKyAoZ2V0UGFkZGluZyhzb3VyY2UsIChbXCJpbmxpbmVcIiwgXCJibG9ja1wiXSBhcyBbXCJpbmxpbmVcIiwgXCJibG9ja1wiXSlbYXhpc10pIHx8IDApKSk7XG4gICAgY29uc3QgcmVjb21wdXRlID0gKCk9PnsgY29uUmVmPy5bJHRyaWdnZXJdPy4oKTsgY29udGVudD8uWyR0cmlnZ2VyXT8uKCk7IH1cblxuICAgIC8vXG4gICAgYWZmZWN0ZWQoc2Nyb2xsLCAodmw6IGFueSk9PnsgcmVjb21wdXRlPy4oKTsgfSk7XG4gICAgYWRkRXZlbnQoaW5wdXRDaGFuZ2UgfHwgc291cmNlLCBcImlucHV0XCIgLCAoKT0+eyByZWNvbXB1dGU/LigpOyB9KTtcbiAgICBhZGRFdmVudChpbnB1dENoYW5nZSB8fCBzb3VyY2UsIFwiY2hhbmdlXCIsICgpPT57IHJlY29tcHV0ZT8uKCk7IH0pO1xuICAgIHF1ZXVlTWljcm90YXNrKCgpPT57IHJlY29tcHV0ZT8uKCk7IH0pO1xuICAgIHJldHVybiBjb250ZW50O1xufVxuIl19